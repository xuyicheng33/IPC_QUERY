import{r as s,g as se,a as ae,u as ie,e as Me,b as re,j as t,d as Q,f as we,M as ne,B as Fe,R as je,c as Ee,A as Oe}from"./chunks/AppProviders.js";import{u as Be,l as xe,n as De,P as ve,e as Z,g as le,h as Y,m as ce,o as Le,q as Ce,r as J,j as Ie,C as me,t as Pe,k as ee,f as q,v as ge}from"./chunks/urlState.js";import{D as We,C as ze}from"./chunks/Card.js";import{T as Ue,E as He,A as Je}from"./chunks/EmptyState.js";import{g as Ke,o as he,F as ke,M as Xe,B as Ge,G as qe,T as Ye,I as ye}from"./chunks/Input.js";function Se(e){return e.substring(2).toLowerCase()}function Ve(e,n){return n.documentElement.clientWidth<e.clientX||n.documentElement.clientHeight<e.clientY}function Qe(e){const{children:n,disableReactTree:u=!1,mouseEvent:p="onClick",onClickAway:y,touchEvent:v="onTouchEnd"}=e,k=s.useRef(!1),d=s.useRef(null),b=s.useRef(!1),A=s.useRef(!1);s.useEffect(()=>(setTimeout(()=>{b.current=!0},0),()=>{b.current=!1}),[]);const g=Be(Ke(n),d),$=xe(P=>{const N=A.current;A.current=!1;const D=he(d.current);if(!b.current||!d.current||"clientX"in P&&Ve(P,D))return;if(k.current){k.current=!1;return}let o;P.composedPath?o=P.composedPath().includes(d.current):o=!D.documentElement.contains(P.target)||d.current.contains(P.target),!o&&(u||!N)&&y(P)}),_=P=>N=>{A.current=!0;const D=n.props[P];D&&D(N)},E={ref:g};return v!==!1&&(E[v]=_(v)),s.useEffect(()=>{if(v!==!1){const P=Se(v),N=he(d.current),D=()=>{k.current=!0};return N.addEventListener(P,$),N.addEventListener("touchmove",D),()=>{N.removeEventListener(P,$),N.removeEventListener("touchmove",D)}}},[$,v]),p!==!1&&(E[p]=_(p)),s.useEffect(()=>{if(p!==!1){const P=Se(p),N=he(d.current);return N.addEventListener(P,$),()=>{N.removeEventListener(P,$)}}},[$,p]),s.cloneElement(n,E)}function Ze(e){return se("MuiDialog",e)}const be=ae("MuiDialog",["root","backdrop","scrollPaper","scrollBody","container","paper","paperScrollPaper","paperScrollBody","paperWidthFalse","paperWidthXs","paperWidthSm","paperWidthMd","paperWidthLg","paperWidthXl","paperFullWidth","paperFullScreen"]),$e=s.createContext({}),et=Y(Ge,{name:"MuiDialog",slot:"Backdrop"})({zIndex:-1}),tt=e=>{const{classes:n,scroll:u,maxWidth:p,fullWidth:y,fullScreen:v}=e,k={root:["root"],backdrop:["backdrop"],container:["container",`scroll${Q(u)}`],paper:["paper",`paperScroll${Q(u)}`,`paperWidth${Q(String(p))}`,y&&"paperFullWidth",v&&"paperFullScreen"]};return le(k,Ze,n)},nt=Y(Xe,{name:"MuiDialog",slot:"Root"})({"@media print":{position:"absolute !important"}}),ot=Y("div",{name:"MuiDialog",slot:"Container",overridesResolver:(e,n)=>{const{ownerState:u}=e;return[n.container,n[`scroll${Q(u.scroll)}`]]}})({height:"100%","@media print":{height:"auto"},outline:0,variants:[{props:{scroll:"paper"},style:{display:"flex",justifyContent:"center",alignItems:"center"}},{props:{scroll:"body"},style:{overflowY:"auto",overflowX:"hidden",textAlign:"center","&::after":{content:'""',display:"inline-block",verticalAlign:"middle",height:"100%",width:"0"}}}]}),rt=Y(ve,{name:"MuiDialog",slot:"Paper",overridesResolver:(e,n)=>{const{ownerState:u}=e;return[n.paper,n[`scrollPaper${Q(u.scroll)}`],n[`paperWidth${Q(String(u.maxWidth))}`],u.fullWidth&&n.paperFullWidth,u.fullScreen&&n.paperFullScreen]}})(ce(({theme:e})=>({margin:32,position:"relative",overflowY:"auto","@media print":{overflowY:"visible",boxShadow:"none"},variants:[{props:{scroll:"paper"},style:{display:"flex",flexDirection:"column",maxHeight:"calc(100% - 64px)"}},{props:{scroll:"body"},style:{display:"inline-block",verticalAlign:"middle",textAlign:"initial"}},{props:({ownerState:n})=>!n.maxWidth,style:{maxWidth:"calc(100% - 64px)"}},{props:{maxWidth:"xs"},style:{maxWidth:e.breakpoints.unit==="px"?Math.max(e.breakpoints.values.xs,444):`max(${e.breakpoints.values.xs}${e.breakpoints.unit}, 444px)`,[`&.${be.paperScrollBody}`]:{[e.breakpoints.down(Math.max(e.breakpoints.values.xs,444)+64)]:{maxWidth:"calc(100% - 64px)"}}}},...Object.keys(e.breakpoints.values).filter(n=>n!=="xs").map(n=>({props:{maxWidth:n},style:{maxWidth:`${e.breakpoints.values[n]}${e.breakpoints.unit}`,[`&.${be.paperScrollBody}`]:{[e.breakpoints.down(e.breakpoints.values[n]+64)]:{maxWidth:"calc(100% - 64px)"}}}})),{props:({ownerState:n})=>n.fullWidth,style:{width:"calc(100% - 64px)"}},{props:({ownerState:n})=>n.fullScreen,style:{margin:0,width:"100%",maxWidth:"100%",height:"100%",maxHeight:"none",borderRadius:0,[`&.${be.paperScrollBody}`]:{margin:0,maxWidth:"100%"}}}]}))),Ne=s.forwardRef(function(n,u){const p=ie({props:n,name:"MuiDialog"}),y=De(),v={enter:y.transitions.duration.enteringScreen,exit:y.transitions.duration.leavingScreen},{"aria-describedby":k,"aria-labelledby":d,"aria-modal":b=!0,BackdropComponent:A,BackdropProps:g,children:$,className:_,disableEscapeKeyDown:E=!1,fullScreen:P=!1,fullWidth:N=!1,maxWidth:D="sm",onClick:o,onClose:C,open:w,PaperComponent:T=ve,PaperProps:m={},scroll:F="paper",slots:j={},slotProps:M={},TransitionComponent:U=ke,transitionDuration:H=v,TransitionProps:I,...R}=p,x={...p,disableEscapeKeyDown:E,fullScreen:P,fullWidth:N,maxWidth:D,scroll:F},l=tt(x),h=s.useRef(),O=K=>{h.current=K.target===K.currentTarget},B=K=>{o&&o(K),h.current&&(h.current=null,C&&C(K,"backdropClick"))},i=Me(d),a=s.useMemo(()=>({titleId:i}),[i]),f={transition:U,...j},r={transition:I,paper:m,backdrop:g,...M},S={slots:f,slotProps:r},[L,z]=Z("root",{elementType:nt,shouldForwardComponentProp:!0,externalForwardedProps:S,ownerState:x,className:re(l.root,_),ref:u}),[X,W]=Z("backdrop",{elementType:et,shouldForwardComponentProp:!0,externalForwardedProps:S,ownerState:x,className:l.backdrop}),[V,c]=Z("paper",{elementType:rt,shouldForwardComponentProp:!0,externalForwardedProps:S,ownerState:x,className:re(l.paper,m.className)}),[de,ue]=Z("container",{elementType:ot,externalForwardedProps:S,ownerState:x,className:l.container}),[pe,fe]=Z("transition",{elementType:ke,externalForwardedProps:S,ownerState:x,additionalProps:{appear:!0,in:w,timeout:H,role:"presentation"}});return t.jsx(L,{closeAfterTransition:!0,slots:{backdrop:X},slotProps:{backdrop:{transitionDuration:H,as:A,...W}},disableEscapeKeyDown:E,onClose:C,open:w,onClick:B,...z,...R,children:t.jsx(pe,{...fe,children:t.jsx(de,{onMouseDown:O,...ue,children:t.jsx(V,{as:T,elevation:24,role:"dialog","aria-describedby":k,"aria-labelledby":i,"aria-modal":b,...c,children:t.jsx($e.Provider,{value:a,children:$})})})})})});function st(e){return se("MuiDialogActions",e)}ae("MuiDialogActions",["root","spacing"]);const at=e=>{const{classes:n,disableSpacing:u}=e;return le({root:["root",!u&&"spacing"]},st,n)},it=Y("div",{name:"MuiDialogActions",slot:"Root",overridesResolver:(e,n)=>{const{ownerState:u}=e;return[n.root,!u.disableSpacing&&n.spacing]}})({display:"flex",alignItems:"center",padding:8,justifyContent:"flex-end",flex:"0 0 auto",variants:[{props:({ownerState:e})=>!e.disableSpacing,style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),Te=s.forwardRef(function(n,u){const p=ie({props:n,name:"MuiDialogActions"}),{className:y,disableSpacing:v=!1,...k}=p,d={...p,disableSpacing:v},b=at(d);return t.jsx(it,{className:re(b.root,y),ownerState:d,ref:u,...k})});function lt(e){return se("MuiDialogContent",e)}ae("MuiDialogContent",["root","dividers"]);function ct(e){return se("MuiDialogTitle",e)}const dt=ae("MuiDialogTitle",["root"]),ut=e=>{const{classes:n,dividers:u}=e;return le({root:["root",u&&"dividers"]},lt,n)},pt=Y("div",{name:"MuiDialogContent",slot:"Root",overridesResolver:(e,n)=>{const{ownerState:u}=e;return[n.root,u.dividers&&n.dividers]}})(ce(({theme:e})=>({flex:"1 1 auto",WebkitOverflowScrolling:"touch",overflowY:"auto",padding:"20px 24px",variants:[{props:({ownerState:n})=>n.dividers,style:{padding:"16px 24px",borderTop:`1px solid ${(e.vars||e).palette.divider}`,borderBottom:`1px solid ${(e.vars||e).palette.divider}`}},{props:({ownerState:n})=>!n.dividers,style:{[`.${dt.root} + &`]:{paddingTop:0}}}]}))),Ae=s.forwardRef(function(n,u){const p=ie({props:n,name:"MuiDialogContent"}),{className:y,dividers:v=!1,...k}=p,d={...p,dividers:v},b=ut(d);return t.jsx(pt,{className:re(b.root,y),ownerState:d,ref:u,...k})}),ft=e=>{const{classes:n}=e;return le({root:["root"]},ct,n)},mt=Y(Ue,{name:"MuiDialogTitle",slot:"Root"})({padding:"16px 24px",flex:"0 0 auto"}),_e=s.forwardRef(function(n,u){const p=ie({props:n,name:"MuiDialogTitle"}),{className:y,id:v,...k}=p,d=p,b=ft(d),{titleId:A=v}=s.useContext($e);return t.jsx(mt,{component:"h2",className:re(b.root,y),ownerState:d,ref:u,variant:"h6",id:v??A,...k})});function gt(e={}){const{autoHideDuration:n=null,disableWindowBlurListener:u=!1,onClose:p,open:y,resumeHideDuration:v}=e,k=Le();s.useEffect(()=>{if(!y)return;function o(C){C.defaultPrevented||C.key==="Escape"&&p?.(C,"escapeKeyDown")}return document.addEventListener("keydown",o),()=>{document.removeEventListener("keydown",o)}},[y,p]);const d=xe((o,C)=>{p?.(o,C)}),b=xe(o=>{!p||o==null||k.start(o,()=>{d(null,"timeout")})});s.useEffect(()=>(y&&b(n),k.clear),[y,n,b,k]);const A=o=>{p?.(o,"clickaway")},g=k.clear,$=s.useCallback(()=>{n!=null&&b(v??n*.5)},[n,v,b]),_=o=>C=>{const w=o.onBlur;w?.(C),$()},E=o=>C=>{const w=o.onFocus;w?.(C),g()},P=o=>C=>{const w=o.onMouseEnter;w?.(C),g()},N=o=>C=>{const w=o.onMouseLeave;w?.(C),$()};return s.useEffect(()=>{if(!u&&y)return window.addEventListener("focus",$),window.addEventListener("blur",g),()=>{window.removeEventListener("focus",$),window.removeEventListener("blur",g)}},[u,y,$,g]),{getRootProps:(o={})=>{const C={...Ce(e),...Ce(o)};return{role:"presentation",...o,...C,onBlur:_(C),onFocus:E(C),onMouseEnter:P(C),onMouseLeave:N(C)}},onClickAway:A}}function ht(e){return se("MuiSnackbarContent",e)}ae("MuiSnackbarContent",["root","message","action"]);const bt=e=>{const{classes:n}=e;return le({root:["root"],action:["action"],message:["message"]},ht,n)},xt=Y(ve,{name:"MuiSnackbarContent",slot:"Root"})(ce(({theme:e})=>{const n=e.palette.mode==="light"?.8:.98;return{...e.typography.body2,color:e.vars?e.vars.palette.SnackbarContent.color:e.palette.getContrastText(we(e.palette.background.default,n)),backgroundColor:e.vars?e.vars.palette.SnackbarContent.bg:we(e.palette.background.default,n),display:"flex",alignItems:"center",flexWrap:"wrap",padding:"6px 16px",flexGrow:1,[e.breakpoints.up("sm")]:{flexGrow:"initial",minWidth:288}}})),yt=Y("div",{name:"MuiSnackbarContent",slot:"Message"})({padding:"8px 0"}),vt=Y("div",{name:"MuiSnackbarContent",slot:"Action"})({display:"flex",alignItems:"center",marginLeft:"auto",paddingLeft:16,marginRight:-8}),wt=s.forwardRef(function(n,u){const p=ie({props:n,name:"MuiSnackbarContent"}),{action:y,className:v,message:k,role:d="alert",...b}=p,A=p,g=bt(A);return t.jsxs(xt,{role:d,elevation:6,className:re(g.root,v),ownerState:A,ref:u,...b,children:[t.jsx(yt,{className:g.message,ownerState:A,children:k}),y?t.jsx(vt,{className:g.action,ownerState:A,children:y}):null]})});function Ct(e){return se("MuiSnackbar",e)}ae("MuiSnackbar",["root","anchorOriginTopCenter","anchorOriginBottomCenter","anchorOriginTopRight","anchorOriginBottomRight","anchorOriginTopLeft","anchorOriginBottomLeft"]);const kt=e=>{const{classes:n,anchorOrigin:u}=e,p={root:["root",`anchorOrigin${Q(u.vertical)}${Q(u.horizontal)}`]};return le(p,Ct,n)},St=Y("div",{name:"MuiSnackbar",slot:"Root",overridesResolver:(e,n)=>{const{ownerState:u}=e;return[n.root,n[`anchorOrigin${Q(u.anchorOrigin.vertical)}${Q(u.anchorOrigin.horizontal)}`]]}})(ce(({theme:e})=>({zIndex:(e.vars||e).zIndex.snackbar,position:"fixed",display:"flex",left:8,right:8,justifyContent:"center",alignItems:"center",variants:[{props:({ownerState:n})=>n.anchorOrigin.vertical==="top",style:{top:8,[e.breakpoints.up("sm")]:{top:24}}},{props:({ownerState:n})=>n.anchorOrigin.vertical!=="top",style:{bottom:8,[e.breakpoints.up("sm")]:{bottom:24}}},{props:({ownerState:n})=>n.anchorOrigin.horizontal==="left",style:{justifyContent:"flex-start",[e.breakpoints.up("sm")]:{left:24,right:"auto"}}},{props:({ownerState:n})=>n.anchorOrigin.horizontal==="right",style:{justifyContent:"flex-end",[e.breakpoints.up("sm")]:{right:24,left:"auto"}}},{props:({ownerState:n})=>n.anchorOrigin.horizontal==="center",style:{[e.breakpoints.up("sm")]:{left:"50%",right:"auto",transform:"translateX(-50%)"}}}]}))),jt=s.forwardRef(function(n,u){const p=ie({props:n,name:"MuiSnackbar"}),y=De(),v={enter:y.transitions.duration.enteringScreen,exit:y.transitions.duration.leavingScreen},{action:k,anchorOrigin:{vertical:d,horizontal:b}={vertical:"bottom",horizontal:"left"},autoHideDuration:A=null,children:g,className:$,ClickAwayListenerProps:_,ContentProps:E,disableWindowBlurListener:P=!1,message:N,onBlur:D,onClose:o,onFocus:C,onMouseEnter:w,onMouseLeave:T,open:m,resumeHideDuration:F,slots:j={},slotProps:M={},TransitionComponent:U,transitionDuration:H=v,TransitionProps:{onEnter:I,onExited:R,...x}={},...l}=p,h={...p,anchorOrigin:{vertical:d,horizontal:b},autoHideDuration:A,disableWindowBlurListener:P,TransitionComponent:U,transitionDuration:H},O=kt(h),{getRootProps:B,onClickAway:i}=gt(h),[a,f]=s.useState(!0),r=K=>{f(!0),R&&R(K)},S=(K,G)=>{f(!1),I&&I(K,G)},L={slots:{transition:U,...j},slotProps:{content:E,clickAwayListener:_,transition:x,...M}},[z,X]=Z("root",{ref:u,className:[O.root,$],elementType:St,getSlotProps:B,externalForwardedProps:{...L,...l},ownerState:h}),[W,{ownerState:V,...c}]=Z("clickAwayListener",{elementType:Qe,externalForwardedProps:L,getSlotProps:K=>({onClickAway:(...G)=>{const Re=G[0];K.onClickAway?.(...G),!Re?.defaultMuiPrevented&&i(...G)}}),ownerState:h}),[de,ue]=Z("content",{elementType:wt,shouldForwardComponentProp:!0,externalForwardedProps:L,additionalProps:{message:N,action:k},ownerState:h}),[pe,fe]=Z("transition",{elementType:qe,externalForwardedProps:L,getSlotProps:K=>({onEnter:(...G)=>{K.onEnter?.(...G),S(...G)},onExited:(...G)=>{K.onExited?.(...G),r(...G)}}),additionalProps:{appear:!0,in:m,timeout:H,direction:d==="top"?"down":"up"},ownerState:h});return!m&&a?null:t.jsx(W,{...c,...j.clickAwayListener&&{ownerState:V},children:t.jsx(z,{...X,children:t.jsx(pe,{...fe,children:g||t.jsx(de,{...ue})})})})});function Dt({className:e,children:n,SelectProps:u,"aria-label":p,sx:y,...v}){const k={native:!0,...u||{},inputProps:{...u?.inputProps||{},...p?{"aria-label":p}:{}}};return t.jsx(Ye,{className:e,variant:"outlined",size:"small",select:!0,SelectProps:k,sx:[{"& .MuiOutlinedInput-root":{minHeight:40,borderRadius:999,backgroundColor:"var(--surface)","& fieldset":{borderColor:"var(--border)"},"&:hover fieldset":{borderColor:"var(--accent)"},"&.Mui-focused fieldset":{borderColor:"var(--accent)",boxShadow:"0 0 0 3px rgba(0,99,155,0.18)"}}},...Array.isArray(y)?y:y?[y]:[]],...v,children:n})}function Pt({items:e,selectedPaths:n,onSelectionChange:u,knownDirectories:p,capabilitiesImportEnabled:y,importDisabledReason:v,getRowActionState:k,onSetRowActionState:d,onClearRowActionState:b,onBeginRename:A,onBeginMove:g,onApplyRename:$,onApplyMove:_,onDeleteSingle:E,onOpenDirectory:P,onBeginDirectoryRename:N,onApplyDirectoryRename:D,onDeleteDirectory:o}){const[C,w]=s.useState(""),[T,m]=s.useState(""),F=s.useMemo(()=>e.filter(x=>!x.is_dir).map(x=>J(x.relative_path||x.name||"")).filter(Boolean),[e]),j=s.useMemo(()=>e.filter(x=>x.is_dir).map(x=>J(x.relative_path||x.name||"")).filter(Boolean),[e]);s.useEffect(()=>{T&&(j.includes(T)||m(""))},[T,j]);const M=x=>{u(F.filter(l=>x.has(l)))},U=(x,l)=>{if(!x)return;const h=new Set(n);if(l.shift){const O=F.indexOf(x),B=F.indexOf(C||x);if(O>=0&&B>=0){const[i,a]=B<=O?[B,O]:[O,B];h.clear();for(let f=i;f<=a;f+=1)h.add(F[f])}else h.clear(),h.add(x);w(x),M(h);return}h.has(x)?h.delete(x):h.add(x),w(x),M(h)};if(e.length===0)return t.jsx(He,{title:"空目录"});const H="pointer-events-none flex items-center justify-end gap-3 text-xs text-muted opacity-0 transition-opacity duration-150 group-hover:pointer-events-auto group-hover:opacity-100 group-focus-within:pointer-events-auto group-focus-within:opacity-100",I="whitespace-nowrap bg-transparent p-0 text-xs text-muted hover:text-accent focus-visible:outline-none focus-visible:text-accent disabled:cursor-not-allowed disabled:text-muted/60",R="text-border";return t.jsx("div",{className:"overflow-hidden rounded-md border border-border bg-surface",children:t.jsx("div",{role:"list","aria-label":"数据库文件列表",children:e.map(x=>{const l=J(x.relative_path||x.name||""),h=k(l),O=J(h.value||""),B=new URLSearchParams;B.set("pdf",l),B.set("page","1"),B.set("return_to",Ie(`${window.location.pathname}${window.location.search}`));const i=`/viewer.html?${B.toString()}`,a=h.phase==="pending",f=x.is_dir,r=!f&&n.has(l),S=f&&T===l,L=String(x.name||l||"-"),z=!!(l&&l!==L),X="w-[180px] md:w-[332px]",W=c=>{c.preventDefault(),c.stopPropagation()},V=c=>{c.preventDefault(),c.stopPropagation()};return t.jsxs("div",{role:f?"button":"listitem","aria-label":f?`目录 ${L}${S?"（已选）":""}`:`${L}${r?"（已选）":""}`,tabIndex:f?0:-1,className:`group grid grid-cols-[36px_28px_minmax(0,1fr)_180px] items-center gap-2 border-b border-border px-3 py-2 last:border-b-0 focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent md:grid-cols-[36px_28px_minmax(0,1fr)_332px] ${r||S?"bg-accent-soft":"hover:bg-surface-soft"}`,onClick:c=>{f&&(c.preventDefault(),m(l))},onKeyDown:c=>{if(f){c.key==="Enter"?(c.preventDefault(),P(l)):c.key===" "&&(c.preventDefault(),m(l));return}},children:[t.jsx("div",{className:"flex w-9 items-center justify-center",children:f?t.jsx("span",{className:"h-4 w-4"}):t.jsx("input",{type:"checkbox",checked:r,"aria-label":`${L}${r?"已选中":"未选中"}`,className:"h-4 w-4",style:{accentColor:"var(--color-accent)"},onClick:c=>{c.preventDefault(),W(c),h.mode==="normal"&&U(l,{shift:c.shiftKey})},onChange:()=>{}})}),t.jsx("div",{className:"flex w-7 items-center justify-center",children:t.jsx(ne,{name:f?"folder":"description",size:20,className:f?"text-accent":"text-muted"})}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsx("div",{className:"truncate text-sm font-medium text-text",children:L}),z?t.jsx("div",{className:"truncate font-mono text-xs text-muted",children:l}):null]}),t.jsx("div",{className:X,children:f?h.mode==="renaming"?t.jsxs("div",{className:"grid w-full gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ye,{name:`rename-dir-${l}`,value:h.value,onChange:c=>d(l,{...h,value:c.target.value,error:"",phase:"idle"}),onFocus:c=>{c.target.select()},onKeyDown:c=>{c.key==="Enter"?(V(c),D(l)):c.key==="Escape"&&(V(c),b(l))},className:"h-8",placeholder:"新目录名",disabled:a,autoFocus:!0}),t.jsx("button",{type:"button",className:I,onClick:c=>{W(c),D(l)},disabled:a,"aria-label":a?"正在改名":"确认改名",title:a?"正在改名":"确认改名",children:a?t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx(me,{size:12}),"处理中"]}):"确认"}),t.jsx("button",{type:"button",className:I,onClick:c=>{W(c),b(l)},disabled:a,"aria-label":"取消改名",title:"取消改名",children:"取消"})]}),h.error?t.jsx("div",{className:"text-xs text-danger",children:h.error}):null]}):t.jsxs("div",{className:H,children:[t.jsx("button",{type:"button",className:I,disabled:!l,onClick:c=>{W(c),l&&P(l)},children:"进入"}),t.jsx("span",{className:R,children:"|"}),t.jsx("button",{type:"button",className:I,disabled:!l||!y,title:y?void 0:v,onClick:c=>{W(c),N(l)},children:"改名"}),t.jsx("span",{className:R,children:"|"}),t.jsx("button",{type:"button",className:I,disabled:!l||!y,title:y?void 0:v,onClick:c=>{W(c),o(l)},children:"删除"})]}):h.mode==="renaming"?t.jsxs("div",{className:"grid w-full gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ye,{name:`rename-${l}`,value:h.value,onChange:c=>d(l,{...h,value:c.target.value,error:"",phase:"idle"}),onFocus:c=>{c.target.select()},onKeyDown:c=>{c.key==="Enter"?(V(c),$(l)):c.key==="Escape"&&(V(c),b(l))},className:"h-8",placeholder:"新文件名，如 b.pdf",disabled:a,autoFocus:!0}),t.jsx("button",{type:"button",className:I,onClick:c=>{W(c),$(l)},disabled:a,"aria-label":a?"正在改名":"确认改名",title:a?"正在改名":"确认改名",children:a?t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx(me,{size:12}),"处理中"]}):"确认"}),t.jsx("button",{type:"button",className:I,onClick:c=>{W(c),b(l)},disabled:a,"aria-label":"取消改名",title:"取消改名",children:"取消"})]}),h.error?t.jsx("div",{className:"text-xs text-danger",children:h.error}):null]}):h.mode==="moving"?t.jsxs("div",{className:"grid w-full gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Dt,{name:`move-${l}`,value:O,className:"h-8",onChange:c=>d(l,{...h,value:J(c.target.value),error:"",phase:"idle"}),onKeyDown:c=>{c.key==="Enter"?(V(c),_(l)):c.key==="Escape"&&(V(c),b(l))},disabled:a,autoFocus:!0,children:p.map(c=>t.jsx("option",{value:c,children:c||"/"},c||"root"))}),t.jsx("button",{type:"button",className:I,onClick:c=>{W(c),_(l)},disabled:a,"aria-label":a?"正在移动":"确认移动",title:a?"正在移动":"确认移动",children:a?t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx(me,{size:12}),"处理中"]}):"确认"}),t.jsx("button",{type:"button",className:I,onClick:c=>{W(c),b(l)},disabled:a,"aria-label":"取消移动",title:"取消移动",children:"取消"})]}),h.error?t.jsx("div",{className:"text-xs text-danger",children:h.error}):null]}):t.jsxs("div",{className:H,children:[t.jsx("button",{type:"button",className:I,disabled:!l,onClick:c=>{W(c),l&&window.open(i,"_blank","noopener,noreferrer")},children:"预览"}),t.jsx("span",{className:R,children:"|"}),t.jsx("button",{type:"button",className:I,disabled:!l||!y,title:y?void 0:v,onClick:c=>{W(c),A(l)},children:"改名"}),t.jsx("span",{className:R,children:"|"}),t.jsx("button",{type:"button",className:I,disabled:!l||!y,title:y?void 0:v,onClick:c=>{W(c),g(l)},children:"移动"}),t.jsx("span",{className:R,children:"|"}),t.jsx("button",{type:"button",className:I,disabled:!l||!y,title:y?void 0:v,onClick:c=>{W(c),E(l)},children:"删除"})]})})]},l||x.name)})})})}function $t({currentPath:e,breadcrumbParts:n,directoryCount:u,status:p,selectedCount:y,fileCount:v,folderName:k,onFolderNameChange:d,capabilities:b,importDisabledReason:A,onNavigate:g,onUploadFiles:$,onDeleteSelected:_,onRefresh:E,onCreateFolder:P}){const N=s.useRef(null),[D,o]=s.useState(!1),C=!b.import_enabled||e!=="",w=b.import_enabled&&y>0,T=b.import_enabled?e?"仅支持在根目录创建子目录":"":A,m=!C&&!!k.trim(),F=j=>{j.preventDefault(),m&&(P(),o(!1))};return t.jsxs("div",{className:"grid gap-3",children:[t.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-start lg:justify-between",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsxs(Fe,{className:"flex flex-wrap items-center gap-2 text-sm text-text",children:[t.jsxs("a",{href:"/db.html",onClick:j=>{j.preventDefault(),g("")},className:"inline-flex items-center gap-1 rounded-sm px-1 py-0.5 hover:bg-surface-soft focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent",children:[t.jsx(ne,{name:"folder",size:16}),"根目录"]}),n.map((j,M)=>{const U=n.slice(0,M+1).join("/");return t.jsxs(je.Fragment,{children:[t.jsx(ne,{name:"chevron_right",size:14,className:"text-muted"}),t.jsx("a",{href:Pe(U),onClick:H=>{H.preventDefault(),g(U)},className:"inline-flex items-center rounded-sm px-1 py-0.5 hover:bg-surface-soft focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent",children:j})]},U)})]}),t.jsxs("div",{className:"mt-1 text-xs text-muted",children:["目录 ",u," · 文件 ",v,` · 已选 ${y}`]})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 lg:justify-end",children:[t.jsx(ee,{variant:"primary",className:"h-10 gap-1.5 px-4",disabled:!b.import_enabled,title:b.import_enabled?"上传 PDF":A,startIcon:t.jsx(ne,{name:"upload_file",size:16}),onClick:()=>N.current?.click(),children:"上传 PDF"}),t.jsx("input",{ref:N,type:"file",accept:".pdf,application/pdf",multiple:!0,className:"hidden",onChange:j=>{$(Array.from(j.target.files||[])),j.currentTarget.value=""}}),t.jsx(ee,{variant:"ghost",type:"button",className:"h-10 gap-1.5 px-4",disabled:C,title:T||"创建子目录",startIcon:t.jsx(ne,{name:"create_new_folder",size:16}),onClick:()=>o(!0),children:"创建子目录"}),t.jsxs(ee,{variant:"danger",className:"h-10 gap-1.5 px-4",disabled:!w,title:b.import_enabled?void 0:A,startIcon:t.jsx(ne,{name:"delete",size:16}),onClick:_,children:["删除所选",y>0?` (${y})`:""]}),t.jsx(ee,{variant:"ghost",className:"h-10 gap-1.5 px-4",startIcon:t.jsx(ne,{name:"refresh",size:16}),onClick:E,children:"刷新"})]})]}),p?t.jsx("div",{className:"rounded-md border border-border bg-surface-soft px-3 py-2 text-xs text-muted",children:p}):null,t.jsx(Ne,{open:D,onClose:()=>o(!1),fullWidth:!0,maxWidth:"xs","aria-labelledby":"db-create-folder-title",children:t.jsxs("form",{onSubmit:F,children:[t.jsx(_e,{id:"db-create-folder-title",children:"新建子目录"}),t.jsxs(Ae,{children:[t.jsx(ye,{id:"db-folder-name",name:"folder_name",value:k,onChange:j=>d(j.target.value),placeholder:"填写新建子目录名称",className:"mt-2 w-full",disabled:C,"aria-label":"新建子目录名称",autoFocus:!0}),T?t.jsx("p",{className:"mt-2 text-xs text-muted",children:T}):null]}),t.jsxs(Te,{sx:{px:3,pb:2.5},children:[t.jsx(ee,{variant:"ghost",type:"button",onClick:()=>o(!1),children:"取消"}),t.jsx(ee,{variant:"ghost",type:"submit",disabled:!m,children:"创建"})]})]})})]})}function oe(e){const n=J(e||"");return n&&n.split("/")[0]||""}function Nt({initialPath:e}){const[n,u]=s.useState(()=>oe(e||"")),[p,y]=s.useState(()=>new Map),[v,k]=s.useState(()=>new Set([""])),[d,b]=s.useState([]),[A,g]=s.useState([]),[$,_]=s.useState(()=>new Set),[E,P]=s.useState(""),N=s.useRef(p),D=s.useRef(0),o=s.useMemo(()=>{const R=new Set([""]),x=p.get("");for(const l of x?.directories||[])R.add(oe(l.path||""));return Array.from(R.values()).sort((l,h)=>l.localeCompare(h))},[p]),C=$.size,w=n?n.split("/"):[],T=s.useCallback(async(R,x=!1)=>{const l=oe(R||""),h=N.current.get(l);if(!x&&h)return h;const O=await q(`/api/docs/tree?path=${encodeURIComponent(l)}`),B={path:J(O.path||l),directories:Array.isArray(O.directories)?O.directories:[],files:Array.isArray(O.files)?O.files:[]};return y(i=>{const a=new Map(i);return a.set(B.path,B),B.path!==l&&a.set(l,B),N.current=a,a}),B},[]),m=s.useCallback(async(R,x=!1)=>{const l=oe(R||"");await T("",x),l&&await T(l,x)},[T]),F=s.useCallback(R=>{const x=new Set(R.map(l=>J(l.relative_path||l.name||"")));_(l=>{const h=new Set;for(const O of l)x.has(O)&&h.add(O);return h})},[]),j=s.useCallback(async(R,x)=>{const l=D.current+1;D.current=l;const h=!!x?.push,O=!!x?.force,B=oe(R||"");P("加载中...");try{await m(B,O);const i=await T(B,O);if(l!==D.current)return;const a=oe(i.path||B);u(a),b(a?[]:i.directories||[]),g(i.files||[]),F(i.files||[]),k(f=>{const r=new Set(f);return r.add(""),a&&r.add(a),r}),h&&history.pushState({},"",Pe(a)),P("")}catch(i){if(l!==D.current)return;P(`加载失败：${String(i?.message||i)}`),b([]),g([])}},[T,m,F]),M=s.useCallback(async()=>{await j(n,{force:!0,push:!1})},[n,j]),U=s.useCallback(R=>{const x=new Set;for(const l of R){const h=J(l||"");h&&x.add(h)}_(x)},[]),H=s.useCallback(()=>{_(new Set)},[]),I=s.useCallback((R,x)=>{k(l=>{const h=new Set(l);return x?h.add(R):h.delete(R),h})},[]);return{currentPath:n,treeCache:p,expandedDirs:v,directories:d,files:A,selectedPaths:$,status:E,knownDirectories:o,selectedCount:C,breadcrumbParts:w,setStatus:P,setSelection:U,loadDirectory:j,refreshCurrentDirectory:M,ensureTreeNode:T,toggleExpandDir:I,clearSelection:H}}function Tt(e){return e==="success"?"success":e==="failed"?"failed":e==="running"?"running":"queued"}function At({onAllJobsSettled:e,pollIntervalMs:n=1500}={}){const[u,p]=s.useState([]),[y,v]=s.useState(()=>new Map),k=s.useRef(new Set),d=s.useRef(""),b=s.useRef(null),A=s.useRef(!1),g=s.useCallback((D,o)=>{const C=Tt(D.status),w=D,T=String(w.relative_path||w.filename||w.path||"-"),m=String(D.error||""),F=String(D.job_id||`${o}-${Date.now()}`);o==="import"&&T&&T!=="-"&&v(j=>{const M=new Map(j);return M.set(T,C),M}),p(j=>{const M=`${o}-${F}`,U=j.filter(H=>H.rowId!==M);return U.unshift({rowId:M,kind:o,status:C,pathText:T,error:m,updatedAt:Date.now()}),U.slice(0,80)})},[]),$=s.useCallback(()=>{b.current!==null&&(window.clearInterval(b.current),b.current=null)},[]),_=s.useCallback(async()=>{if(!A.current){A.current=!0;try{const D=[];for(const o of k.current.values())try{const C=await q(`/api/import/${encodeURIComponent(o)}`);g(C,"import"),["success","failed"].includes(String(C.status||""))&&D.push(o)}catch{D.push(o)}if(D.forEach(o=>k.current.delete(o)),d.current)try{const o=await q(`/api/scan/${encodeURIComponent(d.current)}`);g(o,"scan"),["success","failed"].includes(String(o.status||""))&&(d.current="")}catch{d.current=""}k.current.size===0&&!d.current&&($(),e&&await e())}finally{A.current=!1}}},[e,$,g]),E=s.useCallback(()=>{b.current===null&&(b.current=window.setInterval(()=>{_()},n))},[n,_]),P=s.useCallback(D=>{const o=String(D||"").trim();o&&(k.current.add(o),E())},[E]),N=s.useCallback(D=>{const o=String(D||"").trim();o&&(d.current=o,E())},[E]);return s.useEffect(()=>()=>{$()},[$]),{jobs:u,jobStatusByPath:y,upsertJob:g,startImportJob:P,startScanJob:N,stopAllPolling:$}}function _t(){const e=Date.now();return{upload:{phase:"idle",message:"",updatedAt:e},batchDelete:{phase:"idle",message:"",updatedAt:e},rescan:{phase:"idle",message:"",updatedAt:e},createFolder:{phase:"idle",message:"",updatedAt:e}}}function te(e,n=""){return{mode:e,value:n,error:"",phase:"idle"}}function Rt({currentPath:e,visiblePaths:n,capabilities:u,importDisabledReason:p,scanDisabledReason:y,refreshCurrentDirectory:v,clearSelection:k,setStatus:d,upsertJob:b,startImportJob:A,startScanJob:g}){const[$,_]=s.useState({}),[E,P]=s.useState(()=>_t()),[N,D]=s.useState(null);s.useEffect(()=>{const i=new Set(n.map(a=>J(a||"")).filter(Boolean));_(a=>{const f={};for(const[r,S]of Object.entries(a))i.has(r)&&(f[r]=S);return f})},[n]);const o=s.useCallback((i,a,f,r)=>{P(S=>({...S,[i]:{phase:a,message:f,updatedAt:Date.now(),...r?{error:r}:{}}})),D(f?{phase:a,message:f}:null)},[]),C=s.useCallback(i=>$[i]||te("normal"),[$]),w=s.useCallback((i,a)=>{_(f=>({...f,[i]:a}))},[]),T=s.useCallback(i=>{_(a=>{const f={...a};return delete f[i],f})},[]),m=s.useCallback(i=>{const a=(i.results||[]).filter(f=>!f.ok);return a.length===0?"":a.slice(0,3).map(f=>{const r=String(f.path||"-");if(String(f.error_code||"").toUpperCase()==="CONFLICT"){const L=Array.isArray(f.details?.candidates)?f.details.candidates.slice(0,3).join(", "):"";return L?`${r}: 命名冲突，请使用完整相对路径，候选: ${L}`:`${r}: 命名冲突，请使用完整相对路径`}return`${r}: ${String(f.error||"unknown error")}`}).join(" | ")},[]),F=s.useCallback(async i=>{if(!u.import_enabled){const r=p||"导入服务不可用";o("batchDelete","error",`删除不可用：${r}`,r),d(`删除不可用：${r}`);return}const a=i.map(r=>J(r||"")).filter(Boolean);if(a.length===0)return;const f=`正在删除 ${a.length} 个文件...`;o("batchDelete","pending",f),d(f);try{const r=await q("/api/docs/batch-delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paths:a})}),S=m(r),L=S?`删除完成：成功 ${r.deleted}/${r.total}，失败 ${r.failed}（${S}）`:`删除完成：成功 ${r.deleted}/${r.total}，失败 ${r.failed}`,z=r.failed>0?"error":"success";o("batchDelete",z,L,r.failed>0?S||"partial failed":void 0),d(L),k(),await v()}catch(r){const S=String(r?.message||r);o("batchDelete","error",`删除失败：${S}`,S),d(`删除失败：${S}`)}},[u.import_enabled,k,m,p,v,d,o]),j=s.useCallback(async i=>{if(!u.import_enabled){const z=p||"导入服务不可用";o("upload","error",`上传不可用：${z}`,z),d(`上传不可用：${z}`);return}if(i.length===0){d("请选择 PDF 文件");return}const a=`准备上传 ${i.length} 个文件...`;o("upload","pending",a),d(a);let f=0,r=0;for(const z of i)try{const X=await fetch(`/api/import?filename=${encodeURIComponent(z.name)}&target_dir=${encodeURIComponent(e)}`,{method:"POST",headers:{Accept:"application/json","Content-Type":z.type||"application/pdf","X-File-Name":z.name,"X-Target-Dir":e},body:z}),W=await X.json().catch(()=>({}));if(!X.ok)throw new Error(String(W.message||`${X.status} ${X.statusText}`));f+=1,b(W,"import"),A(String(W.job_id||""))}catch(X){r+=1,b({job_id:`error-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,filename:z.name,status:"failed",error:String(X?.message||X)},"import")}const S=`上传提交完成：成功 ${f}/${i.length}，失败 ${r}`,L=r>0?"error":"success";o("upload",L,S,r>0?"partial failed":void 0),d(S)},[u.import_enabled,e,p,d,A,o,b]),M=s.useCallback(async(i,a)=>{if(!u.import_enabled){const r=p||"导入服务不可用";o("createFolder","error",`创建目录不可用：${r}`,r),d(`创建目录不可用：${r}`);return}const f=i.trim();if(!f){o("createFolder","error","创建失败：请输入目录名","missing folder name");return}if(J(e)!==""){const r="仅支持在根目录创建子目录";o("createFolder","error",r,"root-only"),d(r);return}o("createFolder","pending",`正在创建目录：${f}`);try{await q("/api/folders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e,name:f})}),a?.(),await v();const r=`创建目录成功：${J(e)||"/"} / ${f}`;o("createFolder","success",r),d("")}catch(r){const S=String(r?.message||r);o("createFolder","error",`创建失败：${S}`,S),d(`创建失败：${S}`)}},[u.import_enabled,e,p,v,d,o]),U=s.useCallback(i=>{const a=J(i).split("/").pop()||i;w(i,te("renaming",a))},[w]),H=s.useCallback(async i=>{if(!u.import_enabled){const r=p||"导入服务不可用";w(i,{...te("renaming"),error:r,phase:"error"});return}const a=C(i),f=a.value.trim();if(!f){w(i,{...a,error:"请输入新目录名",phase:"error"});return}if(f.includes("/")||f==="."||f===".."){w(i,{...a,error:"目录名不合法",phase:"error"});return}w(i,{...a,error:"",phase:"pending"});try{const r=await q("/api/folders/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:i,new_name:f})});w(i,{...a,phase:"success"}),T(i),d(`目录改名成功：${r.old_path} -> ${r.new_path}`),await v()}catch(r){const S=String(r?.message||r);w(i,{...a,error:S,phase:"error"})}},[u.import_enabled,T,C,p,v,w,d]),I=s.useCallback(async i=>{if(!u.import_enabled){const r=p||"导入服务不可用";o("batchDelete","error",`删除不可用：${r}`,r),d(`删除不可用：${r}`);return}const a=i.map(r=>J(r||"")).filter(Boolean);if(a.length===0)return;const f=`正在删除 ${a.length} 个目录...`;o("batchDelete","pending",f),d(f);try{const r=await q("/api/folders/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paths:a,recursive:!0})}),S=m(r),L=S?`目录删除完成：成功 ${r.deleted}/${r.total}，失败 ${r.failed}（${S}）`:`目录删除完成：成功 ${r.deleted}/${r.total}，失败 ${r.failed}`,z=r.failed>0?"error":"success";o("batchDelete",z,L,r.failed>0?S||"partial failed":void 0),d(L),await v()}catch(r){const S=String(r?.message||r);o("batchDelete","error",`目录删除失败：${S}`,S),d(`目录删除失败：${S}`)}},[u.import_enabled,m,p,v,d,o]),R=s.useCallback(async()=>{if(!u.scan_enabled){const i=y||"重扫服务不可用";o("rescan","error",`重扫不可用：${i}`,i),d(`重扫不可用：${i}`);return}o("rescan","pending",`正在提交重扫任务：${J(e)||"/"}`);try{const i=await q(`/api/scan?path=${encodeURIComponent(e)}`,{method:"POST"}),a=String(i.job_id||"");if(!a)throw new Error("scan job id missing");b(i,"scan"),g(a);const f=`重扫任务已提交：${a}`;o("rescan","success",f),d(f)}catch(i){const a=String(i?.message||i);o("rescan","error",`触发重扫失败：${a}`,a),d(`触发重扫失败：${a}`)}},[u.scan_enabled,e,y,d,g,o,b]),x=s.useCallback(i=>{const a=i.split("/").pop()||i;w(i,te("renaming",a))},[w]),l=s.useCallback(i=>{w(i,te("moving",e))},[e,w]),h=s.useCallback(async i=>{if(!u.import_enabled){const r=p||"导入服务不可用";w(i,{...te("renaming"),error:r,phase:"error"});return}const a=C(i),f=a.value.trim();if(!f){w(i,{...a,error:"请输入新文件名",phase:"error"});return}w(i,{...a,error:"",phase:"pending"});try{const r=await q("/api/docs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:i,new_name:f})});w(i,{...a,phase:"success"}),T(i),d(`改名成功：${r.old_path} -> ${r.new_path}`),await v()}catch(r){const S=String(r?.message||r);w(i,{...a,error:S,phase:"error"})}},[u.import_enabled,T,C,p,v,w,d]),O=s.useCallback(async i=>{if(!u.import_enabled){const r=p||"导入服务不可用";w(i,{...te("moving"),error:r,phase:"error"});return}const a=C(i),f=J(a.value||"");w(i,{...a,error:"",phase:"pending"});try{const r=await q("/api/docs/move",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:i,target_dir:f})});w(i,{...a,phase:"success"}),T(i),d(`移动成功：${r.old_path} -> ${r.new_path}`),await v()}catch(r){const S=String(r?.message||r);w(i,{...a,error:S,phase:"error"})}},[u.import_enabled,T,C,p,v,w,d]),B=s.useMemo(()=>({getRowActionState:C,setRowActionState:w,clearRowActionState:T,beginRename:x,beginFolderRename:U,beginMove:l,applyRename:h,applyFolderRename:H,applyMove:O}),[H,O,h,U,l,x,T,C,w]);return{globalActionState:E,actionFeedback:N,rowActions:B,deleteSelected:F,deleteFolders:I,submitUploads:j,createFolder:M,triggerRescan:R}}function Mt(){const[e,n]=s.useState(""),[u,p]=s.useState(!1),[y,v]=s.useState(!1),[k,d]=s.useState([]),[b,A]=s.useState({import_enabled:!0,scan_enabled:!0,import_reason:"",scan_reason:""}),g=Nt({initialPath:ge(window.location.search)}),$=g.setStatus,_=b.import_enabled?"":String(b.import_reason||"导入服务不可用"),E=b.scan_enabled?"":String(b.scan_reason||"重扫服务不可用"),P=s.useCallback(async()=>{try{const m=await q("/api/capabilities");A({import_enabled:!!m.import_enabled,scan_enabled:!!m.scan_enabled,import_reason:String(m.import_reason||""),scan_reason:String(m.scan_reason||"")})}catch(m){const F=String(m?.message||m);$(`加载能力信息失败：${F}`)}},[$]),N=At({onAllJobsSettled:async()=>{await g.refreshCurrentDirectory()}}),D=s.useMemo(()=>{const m=g.directories.map(j=>({name:String(j.name||j.path||"").split("/").pop()||j.path||"-",relative_path:j.path,indexed:!0,is_dir:!0})),F=g.files.map(j=>({...j,is_dir:!1}));return[...m,...F]},[g.directories,g.files]),o=Rt({currentPath:g.currentPath,visiblePaths:D.map(m=>m.relative_path),capabilities:b,importDisabledReason:_,scanDisabledReason:E,refreshCurrentDirectory:g.refreshCurrentDirectory,clearSelection:g.clearSelection,setStatus:g.setStatus,upsertJob:N.upsertJob,startImportJob:N.startImportJob,startScanJob:N.startScanJob}),C=s.useCallback(m=>{const F=m.map(j=>({path:String(j.path||"").trim(),kind:j.kind})).filter(j=>!!j.path);F.length!==0&&(d(F),v(!0))},[]),w=s.useCallback(()=>{v(!1),d([])},[]),T=s.useCallback(async()=>{const m=[...k];if(w(),m.length===0)return;const F=m.filter(M=>M.kind==="file").map(M=>M.path),j=m.filter(M=>M.kind==="directory").map(M=>M.path);F.length>0&&await o.deleteSelected(F),j.length>0&&await o.deleteFolders(j)},[w,k,o]);return s.useEffect(()=>{o.actionFeedback?.message&&p(!0)},[o.actionFeedback]),s.useEffect(()=>{const m=()=>{g.loadDirectory(ge(window.location.search),{push:!1,force:!1})};return window.addEventListener("popstate",m),P(),g.loadDirectory(ge(window.location.search),{push:!1,force:!0}),()=>{window.removeEventListener("popstate",m),N.stopAllPolling()}},[]),t.jsxs(We,{actions:[{href:"/search.html",label:"搜索"}],hideHeaderTitle:!0,backHref:g.currentPath?"/db.html":"/",children:[t.jsx("div",{className:"grid gap-4",children:t.jsxs(ze,{className:"grid min-w-0 gap-4 p-4",children:[t.jsx($t,{currentPath:g.currentPath,breadcrumbParts:g.breadcrumbParts,directoryCount:g.directories.length,status:g.status,selectedCount:g.selectedCount,fileCount:g.files.length,folderName:e,onFolderNameChange:n,capabilities:b,importDisabledReason:_,onNavigate:m=>{g.loadDirectory(m,{push:!0,force:!1})},onUploadFiles:m=>{o.submitUploads(m)},onDeleteSelected:()=>C(Array.from(g.selectedPaths).map(m=>({path:m,kind:"file"}))),onRefresh:()=>{g.refreshCurrentDirectory()},onCreateFolder:()=>{o.createFolder(e,()=>{n("")})}}),t.jsx(Pt,{items:D,selectedPaths:g.selectedPaths,onSelectionChange:g.setSelection,knownDirectories:g.knownDirectories,capabilitiesImportEnabled:b.import_enabled,importDisabledReason:_,getRowActionState:o.rowActions.getRowActionState,onSetRowActionState:o.rowActions.setRowActionState,onClearRowActionState:o.rowActions.clearRowActionState,onBeginRename:o.rowActions.beginRename,onBeginMove:o.rowActions.beginMove,onApplyRename:m=>{o.rowActions.applyRename(m)},onBeginDirectoryRename:o.rowActions.beginFolderRename,onApplyDirectoryRename:m=>{o.rowActions.applyFolderRename(m)},onApplyMove:m=>{o.rowActions.applyMove(m)},onDeleteSingle:m=>C([{path:m,kind:"file"}]),onDeleteDirectory:m=>C([{path:m,kind:"directory"}]),onOpenDirectory:m=>{g.loadDirectory(m,{push:!0,force:!1})}})]})}),t.jsxs(Ne,{open:y,onClose:w,fullWidth:!0,maxWidth:"sm","aria-labelledby":"db-delete-dialog-title",children:[t.jsx(_e,{id:"db-delete-dialog-title",children:"确认删除"}),t.jsx(Ae,{children:t.jsxs("div",{className:"mt-1 text-sm text-text",children:["将删除 ",k.length," 个条目（目录会递归删除），对应数据库记录和磁盘文件都会被移除。"]})}),t.jsxs(Te,{sx:{px:3,pb:2.5},children:[t.jsx(ee,{variant:"ghost",onClick:w,children:"取消"}),t.jsx(ee,{variant:"danger",onClick:()=>{T()},children:"确认删除"})]})]}),t.jsx(jt,{open:u,autoHideDuration:2800,onClose:()=>p(!1),anchorOrigin:{vertical:"top",horizontal:"right"},children:t.jsx(Je,{onClose:()=>p(!1),severity:o.actionFeedback?.phase==="error"?"error":o.actionFeedback?.phase==="pending"?"info":"success",variant:"filled",children:o.actionFeedback?.message||"操作完成"})})]})}Ee.createRoot(document.getElementById("root")).render(t.jsx(je.StrictMode,{children:t.jsx(Oe,{children:t.jsx(Mt,{})})}));
