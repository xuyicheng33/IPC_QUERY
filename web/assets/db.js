import{r as s,g as Z,a as ee,u as te,e as Re,b as Q,j as o,d as G,f as we,M as z,B as ke,R as je,c as Ne,A as _e}from"./chunks/AppProviders.js";import{D as Me,C as Ee}from"./chunks/Card.js";import{T as Fe,E as Ie,f as Y,A as Be}from"./chunks/api.js";import{u as Oe,k as xe,l as De,P as be,e as q,f as oe,g as X,m as re,n as Le,o as ve,q as H,i as ze,j as U,C as ye,r as Pe,t as me}from"./chunks/urlState.js";import{g as We,o as ge,F as Ce,M as Ue,B as He,G as Je,I as $e,S as Ke}from"./chunks/Select.js";function Se(e){return e.substring(2).toLowerCase()}function Xe(e,t){return t.documentElement.clientWidth<e.clientX||t.documentElement.clientHeight<e.clientY}function Ge(e){const{children:t,disableReactTree:c=!1,mouseEvent:u="onClick",onClickAway:h,touchEvent:w="onTouchEnd"}=e,d=s.useRef(!1),l=s.useRef(null),x=s.useRef(!1),$=s.useRef(!1);s.useEffect(()=>(setTimeout(()=>{x.current=!0},0),()=>{x.current=!1}),[]);const T=Oe(We(t),l),D=xe(p=>{const A=$.current;$.current=!1;const C=ge(l.current);if(!x.current||!l.current||"clientX"in p&&Xe(p,C))return;if(d.current){d.current=!1;return}let n;p.composedPath?n=p.composedPath().includes(l.current):n=!C.documentElement.contains(p.target)||l.current.contains(p.target),!n&&(c||!A)&&h(p)}),S=p=>A=>{$.current=!0;const C=t.props[p];C&&C(A)},I={ref:T};return w!==!1&&(I[w]=S(w)),s.useEffect(()=>{if(w!==!1){const p=Se(w),A=ge(l.current),C=()=>{d.current=!0};return A.addEventListener(p,D),A.addEventListener("touchmove",C),()=>{A.removeEventListener(p,D),A.removeEventListener("touchmove",C)}}},[D,w]),u!==!1&&(I[u]=S(u)),s.useEffect(()=>{if(u!==!1){const p=Se(u),A=ge(l.current);return A.addEventListener(p,D),()=>{A.removeEventListener(p,D)}}},[D,u]),s.cloneElement(t,I)}function Ye(e){return Z("MuiDialog",e)}const he=ee("MuiDialog",["root","backdrop","scrollPaper","scrollBody","container","paper","paperScrollPaper","paperScrollBody","paperWidthFalse","paperWidthXs","paperWidthSm","paperWidthMd","paperWidthLg","paperWidthXl","paperFullWidth","paperFullScreen"]),Te=s.createContext({}),qe=X(He,{name:"MuiDialog",slot:"Backdrop"})({zIndex:-1}),Ve=e=>{const{classes:t,scroll:c,maxWidth:u,fullWidth:h,fullScreen:w}=e,d={root:["root"],backdrop:["backdrop"],container:["container",`scroll${G(c)}`],paper:["paper",`paperScroll${G(c)}`,`paperWidth${G(String(u))}`,h&&"paperFullWidth",w&&"paperFullScreen"]};return oe(d,Ye,t)},Qe=X(Ue,{name:"MuiDialog",slot:"Root"})({"@media print":{position:"absolute !important"}}),Ze=X("div",{name:"MuiDialog",slot:"Container",overridesResolver:(e,t)=>{const{ownerState:c}=e;return[t.container,t[`scroll${G(c.scroll)}`]]}})({height:"100%","@media print":{height:"auto"},outline:0,variants:[{props:{scroll:"paper"},style:{display:"flex",justifyContent:"center",alignItems:"center"}},{props:{scroll:"body"},style:{overflowY:"auto",overflowX:"hidden",textAlign:"center","&::after":{content:'""',display:"inline-block",verticalAlign:"middle",height:"100%",width:"0"}}}]}),et=X(be,{name:"MuiDialog",slot:"Paper",overridesResolver:(e,t)=>{const{ownerState:c}=e;return[t.paper,t[`scrollPaper${G(c.scroll)}`],t[`paperWidth${G(String(c.maxWidth))}`],c.fullWidth&&t.paperFullWidth,c.fullScreen&&t.paperFullScreen]}})(re(({theme:e})=>({margin:32,position:"relative",overflowY:"auto","@media print":{overflowY:"visible",boxShadow:"none"},variants:[{props:{scroll:"paper"},style:{display:"flex",flexDirection:"column",maxHeight:"calc(100% - 64px)"}},{props:{scroll:"body"},style:{display:"inline-block",verticalAlign:"middle",textAlign:"initial"}},{props:({ownerState:t})=>!t.maxWidth,style:{maxWidth:"calc(100% - 64px)"}},{props:{maxWidth:"xs"},style:{maxWidth:e.breakpoints.unit==="px"?Math.max(e.breakpoints.values.xs,444):`max(${e.breakpoints.values.xs}${e.breakpoints.unit}, 444px)`,[`&.${he.paperScrollBody}`]:{[e.breakpoints.down(Math.max(e.breakpoints.values.xs,444)+64)]:{maxWidth:"calc(100% - 64px)"}}}},...Object.keys(e.breakpoints.values).filter(t=>t!=="xs").map(t=>({props:{maxWidth:t},style:{maxWidth:`${e.breakpoints.values[t]}${e.breakpoints.unit}`,[`&.${he.paperScrollBody}`]:{[e.breakpoints.down(e.breakpoints.values[t]+64)]:{maxWidth:"calc(100% - 64px)"}}}})),{props:({ownerState:t})=>t.fullWidth,style:{width:"calc(100% - 64px)"}},{props:({ownerState:t})=>t.fullScreen,style:{margin:0,width:"100%",maxWidth:"100%",height:"100%",maxHeight:"none",borderRadius:0,[`&.${he.paperScrollBody}`]:{margin:0,maxWidth:"100%"}}}]}))),tt=s.forwardRef(function(t,c){const u=te({props:t,name:"MuiDialog"}),h=De(),w={enter:h.transitions.duration.enteringScreen,exit:h.transitions.duration.leavingScreen},{"aria-describedby":d,"aria-labelledby":l,"aria-modal":x=!0,BackdropComponent:$,BackdropProps:T,children:D,className:S,disableEscapeKeyDown:I=!1,fullScreen:p=!1,fullWidth:A=!1,maxWidth:C="sm",onClick:n,onClose:b,open:y,PaperComponent:v=be,PaperProps:m={},scroll:j="paper",slots:N={},slotProps:B={},TransitionComponent:L=Ce,transitionDuration:_=w,TransitionProps:P,...E}=u,k={...u,disableEscapeKeyDown:I,fullScreen:p,fullWidth:A,maxWidth:C,scroll:j},M=Ve(k),r=s.useRef(),a=W=>{r.current=W.target===W.currentTarget},g=W=>{n&&n(W),r.current&&(r.current=null,b&&b(W,"backdropClick"))},f=Re(l),F=s.useMemo(()=>({titleId:f}),[f]),i={transition:L,...N},R={transition:P,paper:m,backdrop:T,...B},O={slots:i,slotProps:R},[J,ne]=q("root",{elementType:Qe,shouldForwardComponentProp:!0,externalForwardedProps:O,ownerState:k,className:Q(M.root,S),ref:c}),[ae,ie]=q("backdrop",{elementType:qe,shouldForwardComponentProp:!0,externalForwardedProps:O,ownerState:k,className:M.backdrop}),[le,ce]=q("paper",{elementType:et,shouldForwardComponentProp:!0,externalForwardedProps:O,ownerState:k,className:Q(M.paper,m.className)}),[de,ue]=q("container",{elementType:Ze,externalForwardedProps:O,ownerState:k,className:M.container}),[pe,fe]=q("transition",{elementType:Ce,externalForwardedProps:O,ownerState:k,additionalProps:{appear:!0,in:y,timeout:_,role:"presentation"}});return o.jsx(J,{closeAfterTransition:!0,slots:{backdrop:ae},slotProps:{backdrop:{transitionDuration:_,as:$,...ie}},disableEscapeKeyDown:I,onClose:b,open:y,onClick:g,...ne,...E,children:o.jsx(pe,{...fe,children:o.jsx(de,{onMouseDown:a,...ue,children:o.jsx(le,{as:v,elevation:24,role:"dialog","aria-describedby":d,"aria-labelledby":f,"aria-modal":x,...ce,children:o.jsx(Te.Provider,{value:F,children:D})})})})})});function ot(e){return Z("MuiDialogActions",e)}ee("MuiDialogActions",["root","spacing"]);const nt=e=>{const{classes:t,disableSpacing:c}=e;return oe({root:["root",!c&&"spacing"]},ot,t)},st=X("div",{name:"MuiDialogActions",slot:"Root",overridesResolver:(e,t)=>{const{ownerState:c}=e;return[t.root,!c.disableSpacing&&t.spacing]}})({display:"flex",alignItems:"center",padding:8,justifyContent:"flex-end",flex:"0 0 auto",variants:[{props:({ownerState:e})=>!e.disableSpacing,style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),rt=s.forwardRef(function(t,c){const u=te({props:t,name:"MuiDialogActions"}),{className:h,disableSpacing:w=!1,...d}=u,l={...u,disableSpacing:w},x=nt(l);return o.jsx(st,{className:Q(x.root,h),ownerState:l,ref:c,...d})});function at(e){return Z("MuiDialogContent",e)}ee("MuiDialogContent",["root","dividers"]);function it(e){return Z("MuiDialogTitle",e)}const lt=ee("MuiDialogTitle",["root"]),ct=e=>{const{classes:t,dividers:c}=e;return oe({root:["root",c&&"dividers"]},at,t)},dt=X("div",{name:"MuiDialogContent",slot:"Root",overridesResolver:(e,t)=>{const{ownerState:c}=e;return[t.root,c.dividers&&t.dividers]}})(re(({theme:e})=>({flex:"1 1 auto",WebkitOverflowScrolling:"touch",overflowY:"auto",padding:"20px 24px",variants:[{props:({ownerState:t})=>t.dividers,style:{padding:"16px 24px",borderTop:`1px solid ${(e.vars||e).palette.divider}`,borderBottom:`1px solid ${(e.vars||e).palette.divider}`}},{props:({ownerState:t})=>!t.dividers,style:{[`.${lt.root} + &`]:{paddingTop:0}}}]}))),ut=s.forwardRef(function(t,c){const u=te({props:t,name:"MuiDialogContent"}),{className:h,dividers:w=!1,...d}=u,l={...u,dividers:w},x=ct(l);return o.jsx(dt,{className:Q(x.root,h),ownerState:l,ref:c,...d})}),pt=e=>{const{classes:t}=e;return oe({root:["root"]},it,t)},ft=X(Fe,{name:"MuiDialogTitle",slot:"Root"})({padding:"16px 24px",flex:"0 0 auto"}),mt=s.forwardRef(function(t,c){const u=te({props:t,name:"MuiDialogTitle"}),{className:h,id:w,...d}=u,l=u,x=pt(l),{titleId:$=w}=s.useContext(Te);return o.jsx(ft,{component:"h2",className:Q(x.root,h),ownerState:l,ref:c,variant:"h6",id:w??$,...d})});function gt(e={}){const{autoHideDuration:t=null,disableWindowBlurListener:c=!1,onClose:u,open:h,resumeHideDuration:w}=e,d=Le();s.useEffect(()=>{if(!h)return;function n(b){b.defaultPrevented||b.key==="Escape"&&u?.(b,"escapeKeyDown")}return document.addEventListener("keydown",n),()=>{document.removeEventListener("keydown",n)}},[h,u]);const l=xe((n,b)=>{u?.(n,b)}),x=xe(n=>{!u||n==null||d.start(n,()=>{l(null,"timeout")})});s.useEffect(()=>(h&&x(t),d.clear),[h,t,x,d]);const $=n=>{u?.(n,"clickaway")},T=d.clear,D=s.useCallback(()=>{t!=null&&x(w??t*.5)},[t,w,x]),S=n=>b=>{const y=n.onBlur;y?.(b),D()},I=n=>b=>{const y=n.onFocus;y?.(b),T()},p=n=>b=>{const y=n.onMouseEnter;y?.(b),T()},A=n=>b=>{const y=n.onMouseLeave;y?.(b),D()};return s.useEffect(()=>{if(!c&&h)return window.addEventListener("focus",D),window.addEventListener("blur",T),()=>{window.removeEventListener("focus",D),window.removeEventListener("blur",T)}},[c,h,D,T]),{getRootProps:(n={})=>{const b={...ve(e),...ve(n)};return{role:"presentation",...n,...b,onBlur:S(b),onFocus:I(b),onMouseEnter:p(b),onMouseLeave:A(b)}},onClickAway:$}}function ht(e){return Z("MuiSnackbarContent",e)}ee("MuiSnackbarContent",["root","message","action"]);const xt=e=>{const{classes:t}=e;return oe({root:["root"],action:["action"],message:["message"]},ht,t)},bt=X(be,{name:"MuiSnackbarContent",slot:"Root"})(re(({theme:e})=>{const t=e.palette.mode==="light"?.8:.98;return{...e.typography.body2,color:e.vars?e.vars.palette.SnackbarContent.color:e.palette.getContrastText(we(e.palette.background.default,t)),backgroundColor:e.vars?e.vars.palette.SnackbarContent.bg:we(e.palette.background.default,t),display:"flex",alignItems:"center",flexWrap:"wrap",padding:"6px 16px",flexGrow:1,[e.breakpoints.up("sm")]:{flexGrow:"initial",minWidth:288}}})),wt=X("div",{name:"MuiSnackbarContent",slot:"Message"})({padding:"8px 0"}),vt=X("div",{name:"MuiSnackbarContent",slot:"Action"})({display:"flex",alignItems:"center",marginLeft:"auto",paddingLeft:16,marginRight:-8}),yt=s.forwardRef(function(t,c){const u=te({props:t,name:"MuiSnackbarContent"}),{action:h,className:w,message:d,role:l="alert",...x}=u,$=u,T=xt($);return o.jsxs(bt,{role:l,elevation:6,className:Q(T.root,w),ownerState:$,ref:c,...x,children:[o.jsx(wt,{className:T.message,ownerState:$,children:d}),h?o.jsx(vt,{className:T.action,ownerState:$,children:h}):null]})});function Ct(e){return Z("MuiSnackbar",e)}ee("MuiSnackbar",["root","anchorOriginTopCenter","anchorOriginBottomCenter","anchorOriginTopRight","anchorOriginBottomRight","anchorOriginTopLeft","anchorOriginBottomLeft"]);const St=e=>{const{classes:t,anchorOrigin:c}=e,u={root:["root",`anchorOrigin${G(c.vertical)}${G(c.horizontal)}`]};return oe(u,Ct,t)},kt=X("div",{name:"MuiSnackbar",slot:"Root",overridesResolver:(e,t)=>{const{ownerState:c}=e;return[t.root,t[`anchorOrigin${G(c.anchorOrigin.vertical)}${G(c.anchorOrigin.horizontal)}`]]}})(re(({theme:e})=>({zIndex:(e.vars||e).zIndex.snackbar,position:"fixed",display:"flex",left:8,right:8,justifyContent:"center",alignItems:"center",variants:[{props:({ownerState:t})=>t.anchorOrigin.vertical==="top",style:{top:8,[e.breakpoints.up("sm")]:{top:24}}},{props:({ownerState:t})=>t.anchorOrigin.vertical!=="top",style:{bottom:8,[e.breakpoints.up("sm")]:{bottom:24}}},{props:({ownerState:t})=>t.anchorOrigin.horizontal==="left",style:{justifyContent:"flex-start",[e.breakpoints.up("sm")]:{left:24,right:"auto"}}},{props:({ownerState:t})=>t.anchorOrigin.horizontal==="right",style:{justifyContent:"flex-end",[e.breakpoints.up("sm")]:{right:24,left:"auto"}}},{props:({ownerState:t})=>t.anchorOrigin.horizontal==="center",style:{[e.breakpoints.up("sm")]:{left:"50%",right:"auto",transform:"translateX(-50%)"}}}]}))),jt=s.forwardRef(function(t,c){const u=te({props:t,name:"MuiSnackbar"}),h=De(),w={enter:h.transitions.duration.enteringScreen,exit:h.transitions.duration.leavingScreen},{action:d,anchorOrigin:{vertical:l,horizontal:x}={vertical:"bottom",horizontal:"left"},autoHideDuration:$=null,children:T,className:D,ClickAwayListenerProps:S,ContentProps:I,disableWindowBlurListener:p=!1,message:A,onBlur:C,onClose:n,onFocus:b,onMouseEnter:y,onMouseLeave:v,open:m,resumeHideDuration:j,slots:N={},slotProps:B={},TransitionComponent:L,transitionDuration:_=w,TransitionProps:{onEnter:P,onExited:E,...k}={},...M}=u,r={...u,anchorOrigin:{vertical:l,horizontal:x},autoHideDuration:$,disableWindowBlurListener:p,TransitionComponent:L,transitionDuration:_},a=St(r),{getRootProps:g,onClickAway:f}=gt(r),[F,i]=s.useState(!0),R=W=>{i(!0),E&&E(W)},O=(W,K)=>{i(!1),P&&P(W,K)},J={slots:{transition:L,...N},slotProps:{content:I,clickAwayListener:S,transition:k,...B}},[ne,ae]=q("root",{ref:c,className:[a.root,D],elementType:kt,getSlotProps:g,externalForwardedProps:{...J,...M},ownerState:r}),[ie,{ownerState:le,...ce}]=q("clickAwayListener",{elementType:Ge,externalForwardedProps:J,getSlotProps:W=>({onClickAway:(...K)=>{const Ae=K[0];W.onClickAway?.(...K),!Ae?.defaultMuiPrevented&&f(...K)}}),ownerState:r}),[de,ue]=q("content",{elementType:yt,shouldForwardComponentProp:!0,externalForwardedProps:J,additionalProps:{message:A,action:d},ownerState:r}),[pe,fe]=q("transition",{elementType:Je,externalForwardedProps:J,getSlotProps:W=>({onEnter:(...K)=>{W.onEnter?.(...K),O(...K)},onExited:(...K)=>{W.onExited?.(...K),R(...K)}}),additionalProps:{appear:!0,in:m,timeout:_,direction:l==="top"?"down":"up"},ownerState:r});return!m&&F?null:o.jsx(ie,{...ce,...N.clickAwayListener&&{ownerState:le},children:o.jsx(ne,{...ae,children:o.jsx(pe,{...fe,children:T||o.jsx(de,{...ue})})})})});function Dt({items:e,selectedPaths:t,onSelectionChange:c,knownDirectories:u,capabilitiesImportEnabled:h,importDisabledReason:w,getRowActionState:d,onSetRowActionState:l,onClearRowActionState:x,onBeginRename:$,onBeginMove:T,onApplyRename:D,onApplyMove:S,onDeleteSingle:I,onOpenDirectory:p}){const[A,C]=s.useState(""),n=s.useMemo(()=>e.filter(v=>!v.is_dir).map(v=>H(v.relative_path||v.name||"")).filter(Boolean),[e]),b=v=>{c(n.filter(m=>v.has(m)))},y=(v,m)=>{if(!v)return;const j=new Set(t);if(m.shift){const N=n.indexOf(v),B=n.indexOf(A||v);if(N>=0&&B>=0){const[L,_]=B<=N?[B,N]:[N,B];j.clear();for(let P=L;P<=_;P+=1)j.add(n[P])}else j.clear(),j.add(v);C(v),b(j);return}if(m.toggle){j.has(v)?j.delete(v):j.add(v),C(v),b(j);return}j.clear(),j.add(v),C(v),b(j)};return e.length===0?o.jsx(Ie,{title:"空目录"}):o.jsx("div",{className:"overflow-hidden rounded-md border border-border bg-surface",children:o.jsx("div",{role:"list","aria-label":"数据库文件列表",children:e.map(v=>{const m=H(v.relative_path||v.name||""),j=d(m),N=H(j.value||""),B=new URLSearchParams;B.set("pdf",m),B.set("page","1"),B.set("return_to",ze(`${window.location.pathname}${window.location.search}`));const L=`/viewer.html?${B.toString()}`,_=j.phase==="pending",P=v.is_dir,E=!P&&t.has(m),k=String(v.name||m||"-"),M=!!(m&&m!==k),r="w-[180px] md:w-[332px]",a=i=>{i.preventDefault(),i.stopPropagation()},g=i=>{i.preventDefault(),i.stopPropagation()},f=i=>{j.mode==="normal"&&y(m,{shift:i.shiftKey,toggle:i.metaKey||i.ctrlKey})},F=i=>{j.mode==="normal"&&(i.key===" "||i.key==="Enter")&&(i.preventDefault(),y(m,{shift:i.shiftKey,toggle:i.metaKey||i.ctrlKey}))};return o.jsxs("div",{role:P?"button":void 0,"aria-label":P?`目录 ${k}`:`${k}${E?"（已选）":""}`,tabIndex:0,className:`group grid cursor-pointer grid-cols-[28px_minmax(0,1fr)_180px] items-center gap-2 border-b border-border px-3 py-2 last:border-b-0 focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent md:grid-cols-[28px_minmax(0,1fr)_332px] ${E?"bg-accent-soft":"hover:bg-surface-soft"}`,onClick:i=>{if(P){p(m);return}f(i)},onKeyDown:i=>{if(P){(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),p(m));return}F(i)},children:[o.jsx("div",{className:"flex w-7 items-center justify-center",children:o.jsx(z,{name:P?"folder":"description",size:20,className:P?"text-accent":"text-muted"})}),o.jsxs("div",{className:"min-w-0 flex-1",children:[o.jsx("div",{className:"truncate text-sm font-medium text-text",children:k}),M?o.jsx("div",{className:"truncate font-mono text-xs text-muted",children:m}):null]}),o.jsx("div",{className:r,children:P?o.jsxs("div",{className:"flex h-8 items-center justify-end gap-1 px-2.5 text-xs font-medium text-muted",children:[o.jsx("span",{children:"进入"}),o.jsx(z,{name:"chevron_right",size:16})]}):j.mode==="renaming"?o.jsxs("div",{className:"grid w-full gap-1",children:[o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx($e,{name:`rename-${m}`,value:j.value,onChange:i=>l(m,{...j,value:i.target.value,error:"",phase:"idle"}),onFocus:i=>{i.target.select()},onKeyDown:i=>{i.key==="Enter"?(g(i),D(m)):i.key==="Escape"&&(g(i),x(m))},className:"h-8",placeholder:"新文件名，如 b.pdf",disabled:_,autoFocus:!0}),o.jsx(U,{variant:"ghost",className:"h-8 min-w-8 px-2 text-xs",onClick:i=>{a(i),D(m)},disabled:_,"aria-label":_?"正在改名":"确认改名",title:_?"正在改名":"确认改名",startIcon:_?o.jsx(ye,{size:14}):o.jsx(z,{name:"check",size:16})}),o.jsx(U,{variant:"ghost",className:"h-8 min-w-8 px-2 text-xs",onClick:i=>{a(i),x(m)},disabled:_,"aria-label":"取消改名",title:"取消改名",startIcon:o.jsx(z,{name:"close",size:16})})]}),j.error?o.jsx("div",{className:"text-xs text-danger",children:j.error}):null]}):j.mode==="moving"?o.jsxs("div",{className:"grid w-full gap-1",children:[o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx(Ke,{name:`move-${m}`,value:N,className:"h-8",onChange:i=>l(m,{...j,value:H(i.target.value),error:"",phase:"idle"}),onKeyDown:i=>{i.key==="Enter"?(g(i),S(m)):i.key==="Escape"&&(g(i),x(m))},disabled:_,autoFocus:!0,children:u.map(i=>o.jsx("option",{value:i,children:i||"/"},i||"root"))}),o.jsx(U,{variant:"ghost",className:"h-8 min-w-8 px-2 text-xs",onClick:i=>{a(i),S(m)},disabled:_,"aria-label":_?"正在移动":"确认移动",title:_?"正在移动":"确认移动",startIcon:_?o.jsx(ye,{size:14}):o.jsx(z,{name:"check",size:16})}),o.jsx(U,{variant:"ghost",className:"h-8 min-w-8 px-2 text-xs",onClick:i=>{a(i),x(m)},disabled:_,"aria-label":"取消移动",title:"取消移动",startIcon:o.jsx(z,{name:"close",size:16})})]}),j.error?o.jsx("div",{className:"text-xs text-danger",children:j.error}):null]}):o.jsxs(ke,{display:"flex",justifyContent:"flex-end",alignItems:"center",flexWrap:"nowrap",gap:.5,className:"w-full opacity-100 transition-opacity md:opacity-0 md:group-hover:opacity-100 md:group-focus-within:opacity-100",children:[o.jsx(U,{variant:"ghost",className:"h-8 gap-1 px-2.5 text-xs",disabled:!m,startIcon:o.jsx(z,{name:"open_in_new",size:16}),onClick:i=>{a(i),m&&window.open(L,"_blank","noopener,noreferrer")},children:"预览"}),o.jsx(U,{variant:"ghost",className:"h-8 gap-1 px-2.5 text-xs",disabled:!m||!h,title:h?void 0:w,startIcon:o.jsx(z,{name:"edit",size:16}),onClick:i=>{a(i),$(m)},children:"改名"}),o.jsx(U,{variant:"ghost",className:"h-8 gap-1 px-2.5 text-xs",disabled:!m||!h,title:h?void 0:w,startIcon:o.jsx(z,{name:"drive_file_move",size:16}),onClick:i=>{a(i),T(m)},children:"移动"}),o.jsx(U,{variant:"ghost",className:"h-8 gap-1 border-danger px-2.5 text-xs text-danger hover:bg-[#fff5f5]",disabled:!m||!h,title:h?void 0:w,startIcon:o.jsx(z,{name:"delete",size:16}),onClick:i=>{a(i),I(m)},children:"删除"})]})})]},m||v.name)})})})}function Pt({currentPath:e,breadcrumbParts:t,directoryCount:c,status:u,selectedCount:h,fileCount:w,folderName:d,onFolderNameChange:l,capabilities:x,importDisabledReason:$,onNavigate:T,onUploadFiles:D,onDeleteSelected:S,onRefresh:I,onCreateFolder:p}){const A=s.useRef(null),[C,n]=s.useState(!1),b=!x.import_enabled||e!=="",y=x.import_enabled&&h>0,v=x.import_enabled?e?"仅支持在根目录创建子目录":"":$,m=!b&&!!d.trim(),j=N=>{N.preventDefault(),m&&(p(),n(!1))};return o.jsxs("div",{className:"grid gap-3",children:[o.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-start lg:justify-between",children:[o.jsxs("div",{className:"min-w-0",children:[o.jsxs(ke,{className:"flex flex-wrap items-center gap-2 text-sm text-text",children:[o.jsxs("a",{href:"/db.html",onClick:N=>{N.preventDefault(),T("")},className:"inline-flex items-center gap-1 rounded-sm px-1 py-0.5 hover:bg-surface-soft focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent",children:[o.jsx(z,{name:"folder",size:16}),"根目录"]}),t.map((N,B)=>{const L=t.slice(0,B+1).join("/");return o.jsxs(je.Fragment,{children:[o.jsx(z,{name:"chevron_right",size:14,className:"text-muted"}),o.jsx("a",{href:Pe(L),onClick:_=>{_.preventDefault(),T(L)},className:"inline-flex items-center rounded-sm px-1 py-0.5 hover:bg-surface-soft focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent",children:N})]},L)})]}),o.jsxs("div",{className:"mt-1 text-xs text-muted",children:["目录 ",c," · 文件 ",w,` · 已选 ${h}`]})]}),o.jsxs("div",{className:"flex flex-wrap items-center gap-2 lg:justify-end",children:[o.jsx(U,{variant:"ghost",className:"h-10 gap-1.5 px-4",disabled:!x.import_enabled,title:x.import_enabled?"上传 PDF":$,startIcon:o.jsx(z,{name:"upload_file",size:16}),onClick:()=>A.current?.click(),children:"上传 PDF"}),o.jsx("input",{ref:A,type:"file",accept:".pdf,application/pdf",multiple:!0,className:"hidden",onChange:N=>{D(Array.from(N.target.files||[])),N.currentTarget.value=""}}),o.jsx(U,{variant:"ghost",type:"button",className:"h-10 gap-1.5 px-4",disabled:b,title:v||"创建子目录",startIcon:o.jsx(z,{name:"create_new_folder",size:16}),onClick:()=>n(!0),children:"创建子目录"}),o.jsxs(U,{variant:"ghost",className:"h-10 gap-1.5 border-danger px-4 text-danger hover:bg-[#fff5f5]",disabled:!y,title:x.import_enabled?void 0:$,startIcon:o.jsx(z,{name:"delete",size:16}),onClick:S,children:["删除所选",h>0?` (${h})`:""]}),o.jsx(U,{variant:"ghost",className:"h-10 gap-1.5 px-4",startIcon:o.jsx(z,{name:"refresh",size:16}),onClick:I,children:"刷新"})]})]}),u?o.jsx("div",{className:"rounded-md border border-border bg-surface-soft px-3 py-2 text-xs text-muted",children:u}):null,o.jsx("p",{className:"text-xs text-muted",children:"提示：目录支持单击进入；文件支持 Shift / Cmd(Ctrl) 多选。"}),o.jsx(tt,{open:C,onClose:()=>n(!1),fullWidth:!0,maxWidth:"xs","aria-labelledby":"db-create-folder-title",BackdropProps:{sx:{backgroundColor:"transparent"}},children:o.jsxs("form",{onSubmit:j,children:[o.jsx(mt,{id:"db-create-folder-title",children:"新建子目录"}),o.jsxs(ut,{children:[o.jsx($e,{id:"db-folder-name",name:"folder_name",value:d,onChange:N=>l(N.target.value),placeholder:"填写新建子目录名称",className:"mt-2 w-full",disabled:b,"aria-label":"新建子目录名称",autoFocus:!0}),v?o.jsx("p",{className:"mt-2 text-xs text-muted",children:v}):null]}),o.jsxs(rt,{sx:{px:3,pb:2.5},children:[o.jsx(U,{variant:"ghost",type:"button",onClick:()=>n(!1),children:"取消"}),o.jsx(U,{variant:"ghost",type:"submit",disabled:!m,children:"创建"})]})]})})]})}function V(e){const t=H(e||"");return t&&t.split("/")[0]||""}function $t({initialPath:e}){const[t,c]=s.useState(()=>V(e||"")),[u,h]=s.useState(()=>new Map),[w,d]=s.useState(()=>new Set([""])),[l,x]=s.useState([]),[$,T]=s.useState([]),[D,S]=s.useState(()=>new Set),[I,p]=s.useState(""),A=s.useRef(u),C=s.useMemo(()=>{const P=new Set([""]),E=u.get("");for(const k of E?.directories||[])P.add(V(k.path||""));return Array.from(P.values()).sort((k,M)=>k.localeCompare(M))},[u]),n=D.size,b=t?t.split("/"):[],y=s.useCallback(async(P,E=!1)=>{const k=V(P||""),M=A.current.get(k);if(!E&&M)return M;const r=await Y(`/api/docs/tree?path=${encodeURIComponent(k)}`),a={path:H(r.path||k),directories:Array.isArray(r.directories)?r.directories:[],files:Array.isArray(r.files)?r.files:[]};return h(g=>{const f=new Map(g);return f.set(a.path,a),a.path!==k&&f.set(k,a),A.current=f,f}),a},[]),v=s.useCallback(async(P,E=!1)=>{const k=V(P||"");await y("",E),k&&await y(k,E)},[y]),m=s.useCallback(P=>{const E=new Set(P.map(k=>H(k.relative_path||k.name||"")));S(k=>{const M=new Set;for(const r of k)E.has(r)&&M.add(r);return M})},[]),j=s.useCallback(async(P,E)=>{const k=!!E?.push,M=!!E?.force,r=V(P||"");p("加载中...");try{await v(r,M);const a=await y(r,M),g=V(a.path||r);c(g),x(g?[]:a.directories||[]),T(a.files||[]),m(a.files||[]),d(f=>{const F=new Set(f);return F.add(""),g&&F.add(g),F}),k&&history.pushState({},"",Pe(g)),p("")}catch(a){p(`加载失败：${String(a?.message||a)}`),x([]),T([])}},[y,v,m]),N=s.useCallback(async()=>{await j(t,{force:!0,push:!1})},[t,j]),B=s.useCallback(P=>{const E=new Set;for(const k of P){const M=H(k||"");M&&E.add(M)}S(E)},[]),L=s.useCallback(()=>{S(new Set)},[]),_=s.useCallback((P,E)=>{d(k=>{const M=new Set(k);return E?M.add(P):M.delete(P),M})},[]);return{currentPath:t,treeCache:u,expandedDirs:w,directories:l,files:$,selectedPaths:D,status:I,knownDirectories:C,selectedCount:n,breadcrumbParts:b,setStatus:p,setSelection:B,loadDirectory:j,refreshCurrentDirectory:N,ensureTreeNode:y,toggleExpandDir:_,clearSelection:L}}function Tt(e){return e==="success"?"success":e==="failed"?"failed":e==="running"?"running":"queued"}function At({onAllJobsSettled:e,pollIntervalMs:t=1500}={}){const[c,u]=s.useState([]),[h,w]=s.useState(()=>new Map),d=s.useRef(new Set),l=s.useRef(""),x=s.useRef(null),$=s.useRef(!1),T=s.useCallback((C,n)=>{const b=Tt(C.status),y=C,v=String(y.relative_path||y.filename||y.path||"-"),m=String(C.error||""),j=String(C.job_id||`${n}-${Date.now()}`);n==="import"&&v&&v!=="-"&&w(N=>{const B=new Map(N);return B.set(v,b),B}),u(N=>{const B=`${n}-${j}`,L=N.filter(_=>_.rowId!==B);return L.unshift({rowId:B,kind:n,status:b,pathText:v,error:m,updatedAt:Date.now()}),L.slice(0,80)})},[]),D=s.useCallback(()=>{x.current!==null&&(window.clearInterval(x.current),x.current=null)},[]),S=s.useCallback(async()=>{if(!$.current){$.current=!0;try{const C=[];for(const n of d.current.values())try{const b=await Y(`/api/import/${encodeURIComponent(n)}`);T(b,"import"),["success","failed"].includes(String(b.status||""))&&C.push(n)}catch{C.push(n)}if(C.forEach(n=>d.current.delete(n)),l.current)try{const n=await Y(`/api/scan/${encodeURIComponent(l.current)}`);T(n,"scan"),["success","failed"].includes(String(n.status||""))&&(l.current="")}catch{l.current=""}d.current.size===0&&!l.current&&(D(),e&&await e())}finally{$.current=!1}}},[e,D,T]),I=s.useCallback(()=>{x.current===null&&(x.current=window.setInterval(()=>{S()},t))},[t,S]),p=s.useCallback(C=>{const n=String(C||"").trim();n&&(d.current.add(n),I())},[I]),A=s.useCallback(C=>{const n=String(C||"").trim();n&&(l.current=n,I())},[I]);return s.useEffect(()=>()=>{D()},[D]),{jobs:c,jobStatusByPath:h,upsertJob:T,startImportJob:p,startScanJob:A,stopAllPolling:D}}function Rt(){const e=Date.now();return{upload:{phase:"idle",message:"",updatedAt:e},batchDelete:{phase:"idle",message:"",updatedAt:e},rescan:{phase:"idle",message:"",updatedAt:e},createFolder:{phase:"idle",message:"",updatedAt:e}}}function se(e,t=""){return{mode:e,value:t,error:"",phase:"idle"}}function Nt({currentPath:e,visibleFiles:t,capabilities:c,importDisabledReason:u,scanDisabledReason:h,refreshCurrentDirectory:w,clearSelection:d,setStatus:l,upsertJob:x,startImportJob:$,startScanJob:T}){const[D,S]=s.useState({}),[I,p]=s.useState(()=>Rt()),[A,C]=s.useState(null);s.useEffect(()=>{const r=new Set(t.map(a=>H(a.relative_path||a.name||"")));S(a=>{const g={};for(const[f,F]of Object.entries(a))r.has(f)&&(g[f]=F);return g})},[t]);const n=s.useCallback((r,a,g,f)=>{p(F=>({...F,[r]:{phase:a,message:g,updatedAt:Date.now(),...f?{error:f}:{}}})),C(g?{phase:a,message:g}:null)},[]),b=s.useCallback(r=>D[r]||se("normal"),[D]),y=s.useCallback((r,a)=>{S(g=>({...g,[r]:a}))},[]),v=s.useCallback(r=>{S(a=>{const g={...a};return delete g[r],g})},[]),m=s.useCallback(r=>{const a=(r.results||[]).filter(g=>!g.ok);return a.length===0?"":a.slice(0,3).map(g=>{const f=String(g.path||"-");if(String(g.error_code||"").toUpperCase()==="CONFLICT"){const i=Array.isArray(g.details?.candidates)?g.details.candidates.slice(0,3).join(", "):"";return i?`${f}: 命名冲突，请使用完整相对路径，候选: ${i}`:`${f}: 命名冲突，请使用完整相对路径`}return`${f}: ${String(g.error||"unknown error")}`}).join(" | ")},[]),j=s.useCallback(async r=>{if(!c.import_enabled){const R=u||"导入服务不可用";n("batchDelete","error",`删除不可用：${R}`,R),l(`删除不可用：${R}`);return}const a=r.map(R=>H(R||"")).filter(Boolean);if(a.length===0)return;const g=a.slice(0,5).join(`
`),f=a.length>5?`
...`:"";if(!window.confirm(`确认删除 ${a.length} 个文件？
将删除数据库记录和磁盘文件。

示例路径：
${g}${f}`))return;const i=`正在删除 ${a.length} 个文件...`;n("batchDelete","pending",i),l(i);try{const R=await Y("/api/docs/batch-delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paths:a})}),O=m(R),J=O?`删除完成：成功 ${R.deleted}/${R.total}，失败 ${R.failed}（${O}）`:`删除完成：成功 ${R.deleted}/${R.total}，失败 ${R.failed}`,ne=R.failed>0?"error":"success";n("batchDelete",ne,J,R.failed>0?O||"partial failed":void 0),l(J),d(),await w()}catch(R){const O=String(R?.message||R);n("batchDelete","error",`删除失败：${O}`,O),l(`删除失败：${O}`)}},[c.import_enabled,d,m,u,w,l,n]),N=s.useCallback(async r=>{if(!c.import_enabled){const R=u||"导入服务不可用";n("upload","error",`上传不可用：${R}`,R),l(`上传不可用：${R}`);return}if(r.length===0){l("请选择 PDF 文件");return}const a=`准备上传 ${r.length} 个文件...`;n("upload","pending",a),l(a);let g=0,f=0;for(const R of r)try{const O=await fetch(`/api/import?filename=${encodeURIComponent(R.name)}&target_dir=${encodeURIComponent(e)}`,{method:"POST",headers:{Accept:"application/json","Content-Type":R.type||"application/pdf","X-File-Name":R.name,"X-Target-Dir":e},body:R}),J=await O.json().catch(()=>({}));if(!O.ok)throw new Error(String(J.message||`${O.status} ${O.statusText}`));g+=1,x(J,"import"),$(String(J.job_id||""))}catch(O){f+=1,x({job_id:`error-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,filename:R.name,status:"failed",error:String(O?.message||O)},"import")}const F=`上传提交完成：成功 ${g}/${r.length}，失败 ${f}`,i=f>0?"error":"success";n("upload",i,F,f>0?"partial failed":void 0),l(F)},[c.import_enabled,e,u,l,$,n,x]),B=s.useCallback(async(r,a)=>{if(!c.import_enabled){const f=u||"导入服务不可用";n("createFolder","error",`创建目录不可用：${f}`,f),l(`创建目录不可用：${f}`);return}const g=r.trim();if(!g){n("createFolder","error","创建失败：请输入目录名","missing folder name");return}if(H(e)!==""){const f="仅支持在根目录创建子目录";n("createFolder","error",f,"root-only"),l(f);return}n("createFolder","pending",`正在创建目录：${g}`);try{await Y("/api/folders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e,name:g})}),a?.(),await w();const f=`创建目录成功：${H(e)||"/"} / ${g}`;n("createFolder","success",f),l(f)}catch(f){const F=String(f?.message||f);n("createFolder","error",`创建失败：${F}`,F),l(`创建失败：${F}`)}},[c.import_enabled,e,u,w,l,n]),L=s.useCallback(async()=>{if(!c.scan_enabled){const r=h||"重扫服务不可用";n("rescan","error",`重扫不可用：${r}`,r),l(`重扫不可用：${r}`);return}n("rescan","pending",`正在提交重扫任务：${H(e)||"/"}`);try{const r=await Y(`/api/scan?path=${encodeURIComponent(e)}`,{method:"POST"}),a=String(r.job_id||"");if(!a)throw new Error("scan job id missing");x(r,"scan"),T(a);const g=`重扫任务已提交：${a}`;n("rescan","success",g),l(g)}catch(r){const a=String(r?.message||r);n("rescan","error",`触发重扫失败：${a}`,a),l(`触发重扫失败：${a}`)}},[c.scan_enabled,e,h,l,T,n,x]),_=s.useCallback(r=>{const a=r.split("/").pop()||r;y(r,se("renaming",a))},[y]),P=s.useCallback(r=>{y(r,se("moving",e))},[e,y]),E=s.useCallback(async r=>{if(!c.import_enabled){const f=u||"导入服务不可用";y(r,{...se("renaming"),error:f,phase:"error"});return}const a=b(r),g=a.value.trim();if(!g){y(r,{...a,error:"请输入新文件名",phase:"error"});return}y(r,{...a,error:"",phase:"pending"});try{const f=await Y("/api/docs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:r,new_name:g})});y(r,{...a,phase:"success"}),v(r),l(`改名成功：${f.old_path} -> ${f.new_path}`),await w()}catch(f){const F=String(f?.message||f);y(r,{...a,error:F,phase:"error"})}},[c.import_enabled,v,b,u,w,y,l]),k=s.useCallback(async r=>{if(!c.import_enabled){const f=u||"导入服务不可用";y(r,{...se("moving"),error:f,phase:"error"});return}const a=b(r),g=H(a.value||"");y(r,{...a,error:"",phase:"pending"});try{const f=await Y("/api/docs/move",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:r,target_dir:g})});y(r,{...a,phase:"success"}),v(r),l(`移动成功：${f.old_path} -> ${f.new_path}`),await w()}catch(f){const F=String(f?.message||f);y(r,{...a,error:F,phase:"error"})}},[c.import_enabled,v,b,u,w,y,l]),M=s.useMemo(()=>({getRowActionState:b,setRowActionState:y,clearRowActionState:v,beginRename:_,beginMove:P,applyRename:E,applyMove:k}),[k,E,P,_,v,b,y]);return{globalActionState:I,actionFeedback:A,rowActions:M,deleteSelected:j,submitUploads:N,createFolder:B,triggerRescan:L}}function _t(){const[e,t]=s.useState(""),[c,u]=s.useState(!1),[h,w]=s.useState({import_enabled:!0,scan_enabled:!0,import_reason:"",scan_reason:""}),d=$t({initialPath:me(window.location.search)}),l=d.setStatus,x=h.import_enabled?"":String(h.import_reason||"导入服务不可用"),$=h.scan_enabled?"":String(h.scan_reason||"重扫服务不可用"),T=s.useCallback(async()=>{try{const p=await Y("/api/capabilities");w({import_enabled:!!p.import_enabled,scan_enabled:!!p.scan_enabled,import_reason:String(p.import_reason||""),scan_reason:String(p.scan_reason||"")})}catch(p){const A=String(p?.message||p);l(`加载能力信息失败：${A}`)}},[l]),D=At({onAllJobsSettled:async()=>{await d.refreshCurrentDirectory()}}),S=Nt({currentPath:d.currentPath,visibleFiles:d.files,capabilities:h,importDisabledReason:x,scanDisabledReason:$,refreshCurrentDirectory:d.refreshCurrentDirectory,clearSelection:d.clearSelection,setStatus:d.setStatus,upsertJob:D.upsertJob,startImportJob:D.startImportJob,startScanJob:D.startScanJob}),I=s.useMemo(()=>{const p=d.directories.map(C=>({name:String(C.name||C.path||"").split("/").pop()||C.path||"-",relative_path:C.path,indexed:!0,is_dir:!0})),A=d.files.map(C=>({...C,is_dir:!1}));return[...p,...A]},[d.directories,d.files]);return s.useEffect(()=>{S.actionFeedback?.message&&u(!0)},[S.actionFeedback]),s.useEffect(()=>{const p=()=>{d.loadDirectory(me(window.location.search),{push:!1,force:!1})};return window.addEventListener("popstate",p),T(),d.loadDirectory(me(window.location.search),{push:!1,force:!0}),()=>{window.removeEventListener("popstate",p),D.stopAllPolling()}},[]),o.jsxs(Me,{actions:[{href:"/search.html",label:"搜索"}],hideHeaderTitle:!0,children:[o.jsx("div",{className:"grid gap-4",children:o.jsxs(Ee,{className:"grid min-w-0 gap-4 p-4",children:[o.jsx(Pt,{currentPath:d.currentPath,breadcrumbParts:d.breadcrumbParts,directoryCount:d.directories.length,status:d.status,selectedCount:d.selectedCount,fileCount:d.files.length,folderName:e,onFolderNameChange:t,capabilities:h,importDisabledReason:x,onNavigate:p=>{d.loadDirectory(p,{push:!0,force:!1})},onUploadFiles:p=>{S.submitUploads(p)},onDeleteSelected:()=>{S.deleteSelected(Array.from(d.selectedPaths))},onRefresh:()=>{d.refreshCurrentDirectory()},onCreateFolder:()=>{S.createFolder(e,()=>{t("")})}}),o.jsx(Dt,{items:I,selectedPaths:d.selectedPaths,onSelectionChange:d.setSelection,knownDirectories:d.knownDirectories,capabilitiesImportEnabled:h.import_enabled,importDisabledReason:x,getRowActionState:S.rowActions.getRowActionState,onSetRowActionState:S.rowActions.setRowActionState,onClearRowActionState:S.rowActions.clearRowActionState,onBeginRename:S.rowActions.beginRename,onBeginMove:S.rowActions.beginMove,onApplyRename:p=>{S.rowActions.applyRename(p)},onApplyMove:p=>{S.rowActions.applyMove(p)},onDeleteSingle:p=>{S.deleteSelected([p])},onOpenDirectory:p=>{d.loadDirectory(p,{push:!0,force:!1})}})]})}),o.jsx(jt,{open:c,autoHideDuration:2800,onClose:()=>u(!1),anchorOrigin:{vertical:"top",horizontal:"right"},children:o.jsx(Be,{onClose:()=>u(!1),severity:S.actionFeedback?.phase==="error"?"error":S.actionFeedback?.phase==="pending"?"info":"success",variant:"filled",children:S.actionFeedback?.message||"操作完成"})})]})}Ne.createRoot(document.getElementById("root")).render(o.jsx(je.StrictMode,{children:o.jsx(_e,{children:o.jsx(_t,{})})}));
