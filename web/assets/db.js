import{j as e,C as ee,a as W,B,M as T,b as Y,r as a,c as ae,R as re,A as oe}from"./chunks/AppProviders.js";import{T as H,A as ce}from"./chunks/AppShell.js";import{n as _,E as le,B as Z,d as te,A as ie,f as L,e as Q}from"./chunks/urlState.js";import{I as se}from"./chunks/Input.js";import{S as de}from"./chunks/Select.js";import{T as pe,a as ue,b as X,c as V}from"./chunks/Table.js";function me({currentPath:l,treeCache:u,expandedDirs:g,onRefresh:C,onLoadDirectory:d,onToggleExpand:m,onEnsureTreeNode:k}){const o=(b,v)=>{const h=u.get(b);return h?(h.directories||[]).map(p=>{const w=_(p.path||""),D=g.has(w);return e.jsxs(W,{display:"flex",flexDirection:"column",children:[e.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:.5,borderRadius:2,px:.5,py:.5,pl:`${v*14}px`,bgcolor:w===l?"action.selected":"transparent","&:hover":{bgcolor:"action.hover"}},children:[e.jsx("button",{type:"button",className:"inline-flex h-6 w-6 items-center justify-center rounded border border-border bg-surface hover:bg-surface-soft",onClick:async()=>{if(D){m(w,!1);return}m(w,!0),await k(w)},"aria-label":D?"收起目录":"展开目录",children:e.jsx(T,{name:D?"expand_more":"chevron_right",size:16})}),e.jsxs("button",{type:"button",className:"flex flex-1 items-center gap-1.5 rounded px-1 py-1 text-left font-mono text-xs hover:bg-surface",onClick:()=>d(w),children:[e.jsx(T,{name:"folder",size:16,sx:{color:"text.secondary"}}),p.name||w||"-"]})]}),D?e.jsxs(e.Fragment,{children:[(u.get(w)?.files||[]).map(M=>e.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:.5,py:.5,pl:`${(v+1)*14}px`,fontSize:12,color:"text.secondary"},children:[e.jsx(T,{name:"description",size:16}),e.jsx("span",{className:"font-mono",children:M.relative_path||M.name||"-"})]},`file-${M.relative_path}`)),o(w,v+1)]}):null]},`dir-${w}`)}):null};return e.jsxs(ee,{className:"grid gap-3",children:[e.jsxs(W,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(H,{variant:"body2",fontWeight:600,children:"目录树"}),e.jsx(B,{variant:"ghost",className:"h-9 gap-2 px-3",onClick:C,startIcon:e.jsx(T,{name:"refresh",size:16}),children:"刷新树"})]}),e.jsxs(W,{className:"min-h-[500px] rounded-md border border-border bg-surface p-2",children:[e.jsx("div",{className:`mb-1 flex items-center rounded-md px-1 py-1 ${l===""?"bg-accent-soft":""}`,children:e.jsxs("button",{type:"button",className:"flex flex-1 items-center gap-1.5 rounded px-1 py-1 text-left font-mono text-xs hover:bg-surface-soft",onClick:()=>d(""),children:[e.jsx(T,{name:"folder",size:16,sx:{color:"text.secondary"}}),"/"]})}),(u.get("")?.files||[]).map(b=>e.jsxs("div",{className:"flex items-center gap-1.5 py-1 pl-4 text-xs text-muted",children:[e.jsx(T,{name:"description",size:16}),e.jsx("span",{className:"font-mono",children:b.relative_path||b.name||"-"})]},`root-file-${b.relative_path}`)),o("",1)]})]})}function he({files:l,selectedPaths:u,selectAllChecked:g,knownDirectories:C,jobStatusByPath:d,capabilitiesImportEnabled:m,importDisabledReason:k,getRowActionState:o,onSetRowActionState:b,onClearRowActionState:v,onToggleSelect:h,onToggleSelectAll:p,onBeginRename:w,onBeginMove:D,onApplyRename:M,onApplyMove:O,onDeleteSingle:N}){return l.length===0?e.jsx(le,{title:"无 PDF 文件"}):e.jsxs(pe,{children:[e.jsxs(ue,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(X,{className:"w-[48px]",children:e.jsx("input",{type:"checkbox","aria-label":"全选文件",checked:g,onChange:n=>p(n.target.checked)})}),e.jsx(X,{children:"文件名"}),e.jsx(X,{children:"入库状态"}),e.jsx(X,{children:"任务状态"}),e.jsx(X,{children:"操作"})]})}),e.jsx("tbody",{children:l.map(n=>{const i=_(n.relative_path||n.name||""),x=!!n.indexed,A=d.get(i)||"queued",U=u.has(i),P=o(i),G=_(P.value||""),J=`/viewer.html?pdf=${encodeURIComponent(i)}&page=1`,z=P.phase==="pending";return e.jsxs("tr",{className:"group",children:[e.jsx(V,{children:e.jsx("input",{type:"checkbox",checked:U,disabled:!i,onChange:()=>h(i)})}),e.jsx(V,{className:"font-mono text-xs break-all",children:i||"-"}),e.jsx(V,{children:e.jsx(Z,{variant:x?"ok":"neutral",children:x?"indexed":"pending"})}),e.jsx(V,{children:e.jsx(Z,{variant:A==="success"?"ok":A==="failed"?"bad":"neutral",children:A})}),e.jsx(V,{className:"min-w-[360px]",children:P.mode==="renaming"?e.jsxs("div",{className:"grid gap-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{value:P.value,onChange:F=>b(i,{...P,value:F.target.value,error:"",phase:"idle"}),className:"h-8",placeholder:"新文件名，如 b.pdf",disabled:z}),e.jsx(B,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:()=>M(i),disabled:z,startIcon:z?e.jsx(Y,{size:14}):e.jsx(T,{name:"check",size:16})}),e.jsx(B,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:()=>v(i),disabled:z,startIcon:e.jsx(T,{name:"close",size:16})})]}),P.error?e.jsx("div",{className:"text-xs text-danger",children:P.error}):null]}):P.mode==="moving"?e.jsxs("div",{className:"grid gap-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(de,{value:G,className:"h-8",onChange:F=>b(i,{...P,value:_(F.target.value),error:"",phase:"idle"}),disabled:z,children:C.map(F=>e.jsx("option",{value:F,children:F||"/"},F||"root"))}),e.jsx(B,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:()=>O(i),disabled:z,startIcon:z?e.jsx(Y,{size:14}):e.jsx(T,{name:"check",size:16})}),e.jsx(B,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:()=>v(i),disabled:z,startIcon:e.jsx(T,{name:"close",size:16})})]}),P.error?e.jsx("div",{className:"text-xs text-danger",children:P.error}):null]}):e.jsxs(W,{display:"flex",alignItems:"center",gap:.5,className:"opacity-100 transition-opacity md:opacity-0 md:group-hover:opacity-100 md:group-focus-within:opacity-100",children:[e.jsx("a",{href:J,target:"_blank",rel:"noreferrer",children:e.jsx(B,{variant:"ghost",className:"h-8 gap-1.5 px-2",disabled:!i,startIcon:e.jsx(T,{name:"open_in_new",size:16}),children:"预览"})}),e.jsx(B,{variant:"ghost",className:"h-8 gap-1.5 px-2",disabled:!i||!m,title:m?void 0:k,startIcon:e.jsx(T,{name:"edit",size:16}),onClick:()=>w(i),children:"改名"}),e.jsx(B,{variant:"ghost",className:"h-8 gap-1.5 px-2",disabled:!i||!m,title:m?void 0:k,startIcon:e.jsx(T,{name:"drive_file_move",size:16}),onClick:()=>D(i),children:"移动"}),e.jsx(B,{variant:"ghost",className:"h-8 gap-1.5 px-2 text-danger",disabled:!i||!m,title:m?void 0:k,startIcon:e.jsx(T,{name:"delete",size:16}),onClick:()=>N(i),children:"删除"})]})})]},i||n.name)})})]}),e.jsx(H,{variant:"caption",color:"text.secondary",sx:{px:2,py:1,display:"block"},children:"行操作状态机：idle → pending → success/error"})]})}function ge({jobs:l}){return e.jsxs(ee,{className:"grid gap-2",children:[e.jsx(H,{variant:"body2",fontWeight:600,children:"任务状态"}),l.length===0?e.jsx(H,{variant:"body2",color:"text.secondary",children:"暂无任务"}):e.jsx("div",{className:"grid gap-2",children:l.slice(0,20).map(u=>e.jsxs(W,{className:"flex items-center justify-between gap-3 rounded-md border border-border bg-surface p-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate font-mono text-xs text-text",children:u.pathText}),e.jsxs("div",{className:"text-xs text-muted",children:[u.kind," · ",u.status]}),u.error?e.jsx("div",{className:"truncate text-xs text-danger",children:u.error}):null]}),e.jsxs(Z,{variant:u.status==="success"?"ok":u.status==="failed"?"bad":"neutral",children:[u.status==="running"?e.jsx(Y,{size:12,sx:{mr:.5}}):null,u.status]})]},u.rowId))})]})}function xe({breadcrumbParts:l,status:u,selectedCount:g,folderName:C,onFolderNameChange:d,capabilities:m,importDisabledReason:k,scanDisabledReason:o,actionFeedback:b,onNavigate:v,onUploadFiles:h,onDeleteSelected:p,onTriggerRescan:w,onRefresh:D,onCreateFolder:M}){const O=a.useRef(null),N=n=>{n.preventDefault(),M()};return e.jsxs(e.Fragment,{children:[e.jsxs(W,{display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"space-between",gap:1,children:[e.jsxs(W,{className:"font-mono text-xs",children:[e.jsx("a",{href:"/db",onClick:n=>{n.preventDefault(),v("")},className:"text-accent",children:"/"}),l.map((n,i)=>{const x=l.slice(0,i+1).join("/");return e.jsxs("span",{children:["/"," ",e.jsx("a",{href:te(x),onClick:A=>{A.preventDefault(),v(x)},className:"text-accent",children:n})]},x)})]}),e.jsx(H,{variant:"body2",color:"text.secondary",children:u})]}),e.jsxs(W,{display:"flex",flexWrap:"wrap",alignItems:"center",gap:1,children:[e.jsx(B,{variant:"primary",className:"h-10 gap-2",disabled:!m.import_enabled,title:m.import_enabled?"上传 PDF":k,startIcon:e.jsx(T,{name:"upload_file",size:18}),onClick:()=>O.current?.click(),children:"上传 PDF"}),e.jsx("input",{ref:O,type:"file",accept:".pdf,application/pdf",multiple:!0,className:"hidden",onChange:n=>{h(Array.from(n.target.files||[])),n.currentTarget.value=""}}),e.jsxs(B,{variant:"danger",className:"h-10 gap-2",disabled:!m.import_enabled||g===0,title:m.import_enabled?void 0:k,startIcon:e.jsx(T,{name:"delete",size:18}),onClick:p,children:["删除所选",g>0?` (${g})`:""]}),e.jsx(B,{variant:"ghost",className:"h-10 gap-2",disabled:!m.scan_enabled,title:m.scan_enabled?void 0:o,startIcon:e.jsx(T,{name:"scan",size:18}),onClick:w,children:"重扫当前目录"}),e.jsx(B,{variant:"ghost",className:"h-10 gap-2",startIcon:e.jsx(T,{name:"refresh",size:18}),onClick:D,children:"刷新"})]}),e.jsxs("form",{className:"flex flex-wrap items-center gap-2",onSubmit:N,children:[e.jsx(H,{variant:"body2",color:"text.secondary",children:"创建子目录"}),e.jsx(se,{value:C,onChange:n=>d(n.target.value),placeholder:"例如：engine",className:"max-w-[260px]",disabled:!m.import_enabled}),e.jsx(B,{variant:"ghost",type:"submit",className:"h-10 gap-2",disabled:!m.import_enabled,title:m.import_enabled?void 0:k,startIcon:e.jsx(T,{name:"create_new_folder",size:18}),children:"创建"})]}),b?e.jsx(ie,{severity:b.phase==="error"?"error":b.phase==="pending"?"info":"success",variant:"outlined",children:b.message}):null]})}function fe({initialPath:l}){const[u,g]=a.useState(()=>_(l||"")),[C,d]=a.useState(()=>new Map),[m,k]=a.useState(()=>new Set([""])),[o,b]=a.useState([]),[v,h]=a.useState(()=>new Set),[p,w]=a.useState("加载中..."),D=a.useRef(C),M=a.useMemo(()=>o.length===0?!1:o.every($=>v.has(_($.relative_path||$.name||""))),[o,v]),O=a.useMemo(()=>{const $=new Set([""]);for(const[S,j]of C.entries()){$.add(_(S||""));for(const y of j.directories||[])$.add(_(y.path||""))}return Array.from($.values()).sort((S,j)=>S.localeCompare(j))},[C]),N=v.size,n=u?u.split("/"):[],i=a.useCallback(async($,S=!1)=>{const j=_($||""),y=D.current.get(j);if(!S&&y)return y;const t=await L(`/api/docs/tree?path=${encodeURIComponent(j)}`),s={path:_(t.path||j),directories:Array.isArray(t.directories)?t.directories:[],files:Array.isArray(t.files)?t.files:[]};return d(c=>{const r=new Map(c);return r.set(s.path,s),s.path!==j&&r.set(j,s),D.current=r,r}),s},[]),x=a.useCallback(async($,S=!1)=>{const j=_($||"");if(await i("",S),!j)return;let y="";for(const t of j.split("/"))y=y?`${y}/${t}`:t,await i(y,S)},[i]),A=a.useCallback($=>{const S=new Set($.map(j=>_(j.relative_path||j.name||"")));h(j=>{const y=new Set;for(const t of j)S.has(t)&&y.add(t);return y})},[]),U=a.useCallback(async($,S)=>{const j=!!S?.push,y=!!S?.force,t=_($||"");w("加载中...");try{await x(t,y);const s=await i(t,y),c=_(s.path||t);g(c),b(s.files||[]),A(s.files||[]),k(r=>{const I=new Set(r);if(I.add(""),c){let E="";for(const f of c.split("/"))E=E?`${E}/${f}`:f,I.add(E)}return I}),j&&history.pushState({},"",te(c)),w(`目录 ${c||"/"} · 文件 ${(s.files||[]).length}`)}catch(s){w(`加载失败：${String(s?.message||s)}`),b([])}},[i,x,A]),P=a.useCallback(async()=>{await U(u,{force:!0,push:!1})},[u,U]),G=a.useCallback($=>{const S=_($||"");S&&h(j=>{const y=new Set(j);return y.has(S)?y.delete(S):y.add(S),y})},[]),J=a.useCallback($=>{if(!$){h(new Set);return}const S=new Set;o.forEach(j=>{const y=_(j.relative_path||j.name||"");y&&S.add(y)}),h(S)},[o]),z=a.useCallback(()=>{h(new Set)},[]),F=a.useCallback(($,S)=>{k(j=>{const y=new Set(j);return S?y.add($):y.delete($),y})},[]);return{currentPath:u,treeCache:C,expandedDirs:m,files:o,selectedPaths:v,status:p,selectAllChecked:M,knownDirectories:O,selectedCount:N,breadcrumbParts:n,setStatus:w,loadDirectory:U,refreshCurrentDirectory:P,ensureTreeNode:i,toggleExpandDir:F,toggleSelect:G,toggleSelectAll:J,clearSelection:z}}function be(l){return l==="success"?"success":l==="failed"?"failed":l==="running"?"running":"queued"}function je({onAllJobsSettled:l,pollIntervalMs:u=1500}={}){const[g,C]=a.useState([]),[d,m]=a.useState(()=>new Map),k=a.useRef(new Set),o=a.useRef(""),b=a.useRef(null),v=a.useRef(!1),h=a.useCallback((N,n)=>{const i=be(N.status),x=N,A=String(x.relative_path||x.filename||x.path||"-"),U=String(N.error||""),P=String(N.job_id||`${n}-${Date.now()}`);n==="import"&&A&&A!=="-"&&m(G=>{const J=new Map(G);return J.set(A,i),J}),C(G=>{const J=`${n}-${P}`,z=G.filter(F=>F.rowId!==J);return z.unshift({rowId:J,kind:n,status:i,pathText:A,error:U,updatedAt:Date.now()}),z.slice(0,80)})},[]),p=a.useCallback(()=>{b.current!==null&&(window.clearInterval(b.current),b.current=null)},[]),w=a.useCallback(async()=>{if(!v.current){v.current=!0;try{const N=[];for(const n of k.current.values())try{const i=await L(`/api/import/${encodeURIComponent(n)}`);h(i,"import"),["success","failed"].includes(String(i.status||""))&&N.push(n)}catch{N.push(n)}if(N.forEach(n=>k.current.delete(n)),o.current)try{const n=await L(`/api/scan/${encodeURIComponent(o.current)}`);h(n,"scan"),["success","failed"].includes(String(n.status||""))&&(o.current="")}catch{o.current=""}k.current.size===0&&!o.current&&(p(),l&&await l())}finally{v.current=!1}}},[l,p,h]),D=a.useCallback(()=>{b.current===null&&(b.current=window.setInterval(()=>{w()},u))},[u,w]),M=a.useCallback(N=>{const n=String(N||"").trim();n&&(k.current.add(n),D())},[D]),O=a.useCallback(N=>{const n=String(N||"").trim();n&&(o.current=n,D())},[D]);return a.useEffect(()=>()=>{p()},[p]),{jobs:g,jobStatusByPath:d,upsertJob:h,startImportJob:M,startScanJob:O,stopAllPolling:p}}function ye(){const l=Date.now();return{upload:{phase:"idle",message:"",updatedAt:l},batchDelete:{phase:"idle",message:"",updatedAt:l},rescan:{phase:"idle",message:"",updatedAt:l},createFolder:{phase:"idle",message:"",updatedAt:l}}}function K(l,u=""){return{mode:l,value:u,error:"",phase:"idle"}}function ve({currentPath:l,visibleFiles:u,capabilities:g,importDisabledReason:C,scanDisabledReason:d,refreshCurrentDirectory:m,clearSelection:k,setStatus:o,upsertJob:b,startImportJob:v,startScanJob:h}){const[p,w]=a.useState({}),[D,M]=a.useState(()=>ye()),[O,N]=a.useState(null);a.useEffect(()=>{const t=new Set(u.map(s=>_(s.relative_path||s.name||"")));w(s=>{const c={};for(const[r,I]of Object.entries(s))t.has(r)&&(c[r]=I);return c})},[u]);const n=a.useCallback((t,s,c,r)=>{M(I=>({...I,[t]:{phase:s,message:c,updatedAt:Date.now(),...r?{error:r}:{}}})),N(c?{phase:s,message:c}:null)},[]),i=a.useCallback(t=>p[t]||K("normal"),[p]),x=a.useCallback((t,s)=>{w(c=>({...c,[t]:s}))},[]),A=a.useCallback(t=>{w(s=>{const c={...s};return delete c[t],c})},[]),U=a.useCallback(t=>{const s=(t.results||[]).filter(c=>!c.ok);return s.length===0?"":s.slice(0,3).map(c=>{const r=String(c.path||"-");if(String(c.error_code||"").toUpperCase()==="CONFLICT"){const E=Array.isArray(c.details?.candidates)?c.details.candidates.slice(0,3).join(", "):"";return E?`${r}: 命名冲突，请使用完整相对路径，候选: ${E}`:`${r}: 命名冲突，请使用完整相对路径`}return`${r}: ${String(c.error||"unknown error")}`}).join(" | ")},[]),P=a.useCallback(async t=>{if(!g.import_enabled){const f=C||"导入服务不可用";n("batchDelete","error",`删除不可用：${f}`,f),o(`删除不可用：${f}`);return}const s=t.map(f=>_(f||"")).filter(Boolean);if(s.length===0)return;const c=s.slice(0,5).join(`
`),r=s.length>5?`
...`:"";if(!window.confirm(`确认删除 ${s.length} 个文件？
将删除数据库记录和磁盘文件。

示例路径：
${c}${r}`))return;const E=`正在删除 ${s.length} 个文件...`;n("batchDelete","pending",E),o(E);try{const f=await L("/api/docs/batch-delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paths:s})}),R=U(f),q=R?`删除完成：成功 ${f.deleted}/${f.total}，失败 ${f.failed}（${R}）`:`删除完成：成功 ${f.deleted}/${f.total}，失败 ${f.failed}`,ne=f.failed>0?"error":"success";n("batchDelete",ne,q,f.failed>0?R||"partial failed":void 0),o(q),k(),await m()}catch(f){const R=String(f?.message||f);n("batchDelete","error",`删除失败：${R}`,R),o(`删除失败：${R}`)}},[g.import_enabled,k,U,C,m,o,n]),G=a.useCallback(async t=>{if(!g.import_enabled){const f=C||"导入服务不可用";n("upload","error",`上传不可用：${f}`,f),o(`上传不可用：${f}`);return}if(t.length===0){o("请选择 PDF 文件");return}const s=`准备上传 ${t.length} 个文件...`;n("upload","pending",s),o(s);let c=0,r=0;for(const f of t)try{const R=await fetch(`/api/import?filename=${encodeURIComponent(f.name)}&target_dir=${encodeURIComponent(l)}`,{method:"POST",headers:{Accept:"application/json","Content-Type":f.type||"application/pdf","X-File-Name":f.name,"X-Target-Dir":l},body:f}),q=await R.json().catch(()=>({}));if(!R.ok)throw new Error(String(q.message||`${R.status} ${R.statusText}`));c+=1,b(q,"import"),v(String(q.job_id||""))}catch(R){r+=1,b({job_id:`error-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,filename:f.name,status:"failed",error:String(R?.message||R)},"import")}const I=`上传提交完成：成功 ${c}/${t.length}，失败 ${r}`,E=r>0?"error":"success";n("upload",E,I,r>0?"partial failed":void 0),o(I)},[g.import_enabled,l,C,o,v,n,b]),J=a.useCallback(async(t,s)=>{if(!g.import_enabled){const r=C||"导入服务不可用";n("createFolder","error",`创建目录不可用：${r}`,r),o(`创建目录不可用：${r}`);return}const c=t.trim();if(!c){n("createFolder","error","创建失败：请输入目录名","missing folder name");return}n("createFolder","pending",`正在创建目录：${c}`);try{await L("/api/folders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:l,name:c})}),s?.(),await m();const r=`创建目录成功：${_(l)||"/"} / ${c}`;n("createFolder","success",r),o(r)}catch(r){const I=String(r?.message||r);n("createFolder","error",`创建失败：${I}`,I),o(`创建失败：${I}`)}},[g.import_enabled,l,C,m,o,n]),z=a.useCallback(async()=>{if(!g.scan_enabled){const t=d||"重扫服务不可用";n("rescan","error",`重扫不可用：${t}`,t),o(`重扫不可用：${t}`);return}n("rescan","pending",`正在提交重扫任务：${_(l)||"/"}`);try{const t=await L(`/api/scan?path=${encodeURIComponent(l)}`,{method:"POST"}),s=String(t.job_id||"");if(!s)throw new Error("scan job id missing");b(t,"scan"),h(s);const c=`重扫任务已提交：${s}`;n("rescan","success",c),o(c)}catch(t){const s=String(t?.message||t);n("rescan","error",`触发重扫失败：${s}`,s),o(`触发重扫失败：${s}`)}},[g.scan_enabled,l,d,o,h,n,b]),F=a.useCallback(t=>{const s=t.split("/").pop()||t;x(t,K("renaming",s))},[x]),$=a.useCallback(t=>{x(t,K("moving",l))},[l,x]),S=a.useCallback(async t=>{if(!g.import_enabled){const r=C||"导入服务不可用";x(t,{...K("renaming"),error:r,phase:"error"});return}const s=i(t),c=s.value.trim();if(!c){x(t,{...s,error:"请输入新文件名",phase:"error"});return}x(t,{...s,error:"",phase:"pending"});try{const r=await L("/api/docs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:t,new_name:c})});x(t,{...s,phase:"success"}),A(t),o(`改名成功：${r.old_path} -> ${r.new_path}`),await m()}catch(r){const I=String(r?.message||r);x(t,{...s,error:I,phase:"error"})}},[g.import_enabled,A,i,C,m,x,o]),j=a.useCallback(async t=>{if(!g.import_enabled){const r=C||"导入服务不可用";x(t,{...K("moving"),error:r,phase:"error"});return}const s=i(t),c=_(s.value||"");x(t,{...s,error:"",phase:"pending"});try{const r=await L("/api/docs/move",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:t,target_dir:c})});x(t,{...s,phase:"success"}),A(t),o(`移动成功：${r.old_path} -> ${r.new_path}`),await m()}catch(r){const I=String(r?.message||r);x(t,{...s,error:I,phase:"error"})}},[g.import_enabled,A,i,C,m,x,o]),y=a.useMemo(()=>({getRowActionState:i,setRowActionState:x,clearRowActionState:A,beginRename:F,beginMove:$,applyRename:S,applyMove:j}),[j,S,$,F,A,i,x]);return{globalActionState:D,actionFeedback:O,rowActions:y,deleteSelected:P,submitUploads:G,createFolder:J,triggerRescan:z}}function we(){const[l,u]=a.useState(""),[g,C]=a.useState({import_enabled:!0,scan_enabled:!0,import_reason:"",scan_reason:""}),d=fe({initialPath:Q(window.location.search)}),m=d.setStatus,k=g.import_enabled?"":String(g.import_reason||"导入服务不可用"),o=g.scan_enabled?"":String(g.scan_reason||"重扫服务不可用"),b=a.useCallback(async()=>{try{const p=await L("/api/capabilities");C({import_enabled:!!p.import_enabled,scan_enabled:!!p.scan_enabled,import_reason:String(p.import_reason||""),scan_reason:String(p.scan_reason||"")})}catch(p){const w=String(p?.message||p);m(`加载能力信息失败：${w}`)}},[m]),v=je({onAllJobsSettled:async()=>{await d.refreshCurrentDirectory()}}),h=ve({currentPath:d.currentPath,visibleFiles:d.files,capabilities:g,importDisabledReason:k,scanDisabledReason:o,refreshCurrentDirectory:d.refreshCurrentDirectory,clearSelection:d.clearSelection,setStatus:d.setStatus,upsertJob:v.upsertJob,startImportJob:v.startImportJob,startScanJob:v.startScanJob});return a.useEffect(()=>{const p=()=>{d.loadDirectory(Q(window.location.search),{push:!1,force:!1})};return window.addEventListener("popstate",p),b(),d.loadDirectory(Q(window.location.search),{push:!1,force:!0}),()=>{window.removeEventListener("popstate",p),v.stopAllPolling()}},[]),e.jsx(ce,{actions:[{href:"/search",label:"搜索",icon:e.jsx(T,{name:"search",size:18})}],children:e.jsxs("div",{className:"grid gap-4 xl:grid-cols-[320px_minmax(0,1fr)]",children:[e.jsx(me,{currentPath:d.currentPath,treeCache:d.treeCache,expandedDirs:d.expandedDirs,onRefresh:()=>{d.refreshCurrentDirectory()},onLoadDirectory:p=>{d.loadDirectory(p,{push:!0,force:!1})},onToggleExpand:d.toggleExpandDir,onEnsureTreeNode:async p=>{await d.ensureTreeNode(p)}}),e.jsxs("div",{className:"grid min-w-0 gap-3",children:[e.jsxs(ee,{className:"grid min-w-0 gap-3",children:[e.jsx(xe,{breadcrumbParts:d.breadcrumbParts,status:d.status,selectedCount:d.selectedCount,folderName:l,onFolderNameChange:u,capabilities:g,importDisabledReason:k,scanDisabledReason:o,actionFeedback:h.actionFeedback,onNavigate:p=>{d.loadDirectory(p,{push:!0,force:!1})},onUploadFiles:p=>{h.submitUploads(p)},onDeleteSelected:()=>{h.deleteSelected(Array.from(d.selectedPaths))},onTriggerRescan:()=>{h.triggerRescan()},onRefresh:()=>{d.refreshCurrentDirectory()},onCreateFolder:()=>{h.createFolder(l,()=>{u("")})}}),e.jsx(he,{files:d.files,selectedPaths:d.selectedPaths,selectAllChecked:d.selectAllChecked,knownDirectories:d.knownDirectories,jobStatusByPath:v.jobStatusByPath,capabilitiesImportEnabled:g.import_enabled,importDisabledReason:k,getRowActionState:h.rowActions.getRowActionState,onSetRowActionState:h.rowActions.setRowActionState,onClearRowActionState:h.rowActions.clearRowActionState,onToggleSelect:d.toggleSelect,onToggleSelectAll:d.toggleSelectAll,onBeginRename:h.rowActions.beginRename,onBeginMove:h.rowActions.beginMove,onApplyRename:p=>{h.rowActions.applyRename(p)},onApplyMove:p=>{h.rowActions.applyMove(p)},onDeleteSingle:p=>{h.deleteSelected([p])}})]}),e.jsx(ge,{jobs:v.jobs})]})]})})}ae.createRoot(document.getElementById("root")).render(e.jsx(re.StrictMode,{children:e.jsx(oe,{children:e.jsx(we,{})})}));
