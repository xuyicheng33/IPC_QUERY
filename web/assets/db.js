import{c as j,r as i,j as e,C as Z,B as g,a as ge,R as je}from"./chunks/Card.js";import{d as W,n as h,A as ve,e as G}from"./chunks/urlState.js";import{E as ye,B as E,f as y}from"./chunks/api.js";import{I as we}from"./chunks/Input.js";import{T as Ne,a as be,b as C,c as _}from"./chunks/Table.js";import{R as K,F as Q}from"./chunks/refresh-cw.js";import{C as Se}from"./chunks/chevron-right.js";const $e=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],ke=j("chevron-down",$e);const Ce=[["path",{d:"M12 10v6",key:"1bos4e"}],["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],_e=j("folder-plus",Ce);const Re=[["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],Y=j("folder",Re);const Te=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],Ie=j("loader-circle",Te);const Pe=[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}],["path",{d:"m16 16-1.9-1.9",key:"1dq9hf"}]],Me=j("scan-search",Pe);const Ae=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],De=j("trash-2",Ae);const Ee=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],Fe=j("upload",Ee);function Ue(l){return l==="success"?"success":l==="failed"?"failed":l==="running"?"running":"queued"}function Be(){const[l,ee]=i.useState(()=>W(window.location.search)),[w,te]=i.useState(()=>new Map),[se,A]=i.useState(()=>new Set([""])),[v,F]=i.useState([]),[N,b]=i.useState(()=>new Set),[U,ae]=i.useState([]),[ne,p]=i.useState("加载中..."),[B,re]=i.useState(""),[ce,oe]=i.useState(!1),[z,J]=i.useState(""),R=i.useRef(null),T=i.useRef(new Set),m=i.useRef(""),L=i.useRef(new Map),S=i.useRef(null),ie=i.useMemo(()=>v.length===0?!1:v.every(t=>N.has(h(t.relative_path||t.name||""))),[v,N]),D=N.size,$=(t,s)=>{const a=Ue(t.status),n=t,c=String(n.relative_path||n.filename||n.path||"-"),r=String(t.error||""),o=String(t.job_id||`${s}-${Date.now()}`);s==="import"&&c&&c!=="-"&&L.current.set(c,a),ae(u=>{const d=`${s}-${o}`,x=u.filter(M=>M.rowId!==d);return x.unshift({rowId:d,kind:s,status:a,pathText:c,error:r,updatedAt:Date.now()}),x.slice(0,80)})},I=async(t,s=!1)=>{const a=h(t||"");if(!s&&w.has(a))return w.get(a);const n=await y(`/api/docs/tree?path=${encodeURIComponent(a)}`),c={path:h(n.path||a),directories:Array.isArray(n.directories)?n.directories:[],files:Array.isArray(n.files)?n.files:[]};return te(r=>{const o=new Map(r);return o.set(c.path,c),c.path!==a&&o.set(a,c),o}),c},le=async(t,s=!1)=>{const a=h(t||"");if(await I("",s),!a)return;let n="";for(const c of a.split("/"))n=n?`${n}/${c}`:c,await I(n,s)},P=(t,s=!1)=>{re(t),oe(s)},de=t=>{const s=new Set(t.map(a=>h(a.relative_path||a.name||"")));b(a=>{const n=new Set;for(const c of a)s.has(c)&&n.add(c);return n})},f=async(t,s)=>{const a=!!s?.push,n=!!s?.force,c=h(t||"");p("加载中...");try{await le(c,n);const r=await I(c,n),o=h(r.path||c);ee(o),F(r.files||[]),de(r.files||[]),A(u=>{const d=new Set(u);if(d.add(""),o){let x="";for(const M of o.split("/"))x=x?`${x}/${M}`:M,d.add(x)}return d}),a&&history.pushState({},"",G(o)),p(`目录 ${o||"/"} · 文件 ${(r.files||[]).length}`)}catch(r){p(`加载失败：${String(r?.message||r)}`),F([])}},k=async()=>{await f(l,{force:!0,push:!1})},q=()=>{S.current!==null&&(window.clearInterval(S.current),S.current=null)},O=()=>{S.current===null&&(S.current=window.setInterval(async()=>{const t=[];for(const s of T.current.values())try{const a=await y(`/api/import/${encodeURIComponent(s)}`);$(a,"import"),["success","failed"].includes(String(a.status||""))&&t.push(s)}catch{t.push(s)}if(t.forEach(s=>T.current.delete(s)),m.current)try{const s=await y(`/api/scan/${encodeURIComponent(m.current)}`);$(s,"scan"),["success","failed"].includes(String(s.status||""))&&(m.current="")}catch{m.current=""}T.current.size===0&&!m.current&&(q(),await k())},1500))},he=t=>{const s=(t.results||[]).filter(a=>!a.ok);return s.length===0?"":s.slice(0,3).map(a=>{const n=String(a.path||"-");if(String(a.error_code||"").toUpperCase()==="CONFLICT"){const r=Array.isArray(a.details?.candidates)?a.details.candidates.slice(0,3).join(", "):"";return r?`${n}: 命名冲突，请使用完整相对路径，候选: ${r}`:`${n}: 命名冲突，请使用完整相对路径`}return`${n}: ${String(a.error||"unknown error")}`}).join(" | ")},H=async t=>{const s=t.map(r=>h(r||"")).filter(Boolean);if(s.length===0)return;const a=s.slice(0,5).join(`
`),n=s.length>5?`
...`:"";if(window.confirm(`确认删除 ${s.length} 个文件？
将删除数据库记录和磁盘文件。

示例路径：
${a}${n}`)){P(""),p(`正在删除 ${s.length} 个文件...`);try{const r=await y("/api/docs/batch-delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paths:s})}),o=he(r);P(o?`删除完成：成功 ${r.deleted}/${r.total}，失败 ${r.failed}（${o}）`:`删除完成：成功 ${r.deleted}/${r.total}，失败 ${r.failed}`),b(new Set),await k()}catch(r){const o=String(r?.message||r);P(`删除失败：${o}`,!0),p(`删除失败：${o}`)}}},ue=async t=>{if(t.length===0){p("请选择 PDF 文件");return}p(`准备上传 ${t.length} 个文件...`),P("");for(const s of t)try{const a=await fetch(`/api/import?filename=${encodeURIComponent(s.name)}&target_dir=${encodeURIComponent(l)}`,{method:"POST",headers:{Accept:"application/json","Content-Type":s.type||"application/pdf","X-File-Name":s.name,"X-Target-Dir":l},body:s}),n=await a.json().catch(()=>({}));if(!a.ok)throw new Error(String(n.message||`${a.status} ${a.statusText}`));T.current.add(String(n.job_id)),$(n,"import")}catch(a){$({job_id:`error-${Date.now()}`,filename:s.name,status:"failed",error:String(a?.message||a)},"import")}R.current&&(R.current.value=""),O()},pe=async t=>{t.preventDefault();const s=z.trim();if(s)try{await y("/api/folders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:l,name:s})}),J(""),await k()}catch(a){p(`创建失败：${String(a?.message||a)}`)}},me=async()=>{try{const t=await y(`/api/scan?path=${encodeURIComponent(l)}`,{method:"POST"});m.current=String(t.job_id||""),m.current&&($(t,"scan"),O())}catch(t){p(`触发重扫失败：${String(t?.message||t)}`)}};i.useEffect(()=>{const t=()=>{f(W(window.location.search),{push:!1,force:!1})};return window.addEventListener("popstate",t),f(l,{push:!1,force:!0}),()=>{window.removeEventListener("popstate",t),q()}},[]);const fe=t=>{const s=h(t||"");s&&b(a=>{const n=new Set(a);return n.has(s)?n.delete(s):n.add(s),n})},xe=t=>{if(!t){b(new Set);return}const s=new Set;v.forEach(a=>{const n=h(a.relative_path||a.name||"");n&&s.add(n)}),b(s)},V=(t,s)=>{const a=w.get(t);if(!a)return null;const n=[];for(const c of a.directories||[]){const r=h(c.path||""),o=se.has(r);n.push(e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:`flex items-center gap-1 rounded-md px-1 py-0.5 ${r===l?"bg-accent-soft":"hover:bg-surface-soft"}`,style:{paddingLeft:`${s*14}px`},children:[e.jsx("button",{type:"button",className:"inline-flex h-6 w-6 items-center justify-center rounded border border-border bg-surface hover:bg-surface-soft",onClick:()=>{if(o){A(u=>{const d=new Set(u);return d.delete(r),d});return}A(u=>{const d=new Set(u);return d.add(r),d}),I(r)},"aria-label":o?"收起目录":"展开目录",children:o?e.jsx(ke,{className:"h-3.5 w-3.5"}):e.jsx(Se,{className:"h-3.5 w-3.5"})}),e.jsxs("button",{type:"button",className:"flex flex-1 items-center gap-1.5 rounded px-1 py-1 text-left font-mono text-xs hover:bg-surface",onClick:()=>{f(r,{push:!0,force:!1})},children:[e.jsx(Y,{className:"h-3.5 w-3.5 text-muted"}),c.name||r||"-"]})]}),o?e.jsxs(e.Fragment,{children:[(w.get(r)?.files||[]).map(u=>e.jsxs("div",{className:"flex items-center gap-1.5 py-1 text-xs text-muted",style:{paddingLeft:`${(s+1)*14}px`},children:[e.jsx(Q,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"font-mono",children:u.relative_path||u.name||"-"})]},`file-${u.relative_path}`)),V(r,s+1)]}):null]},`dir-${r}`))}return n},X=l?l.split("/"):[];return e.jsx(ve,{actions:[{href:"/search",label:"搜索"}],children:e.jsxs("div",{className:"grid gap-4 xl:grid-cols-[320px_minmax(0,1fr)]",children:[e.jsxs(Z,{className:"grid gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-medium",children:"目录树"}),e.jsxs(g,{variant:"ghost",className:"h-9 gap-2 px-3",onClick:()=>{k()},children:[e.jsx(K,{className:"h-4 w-4"}),"刷新树"]})]}),e.jsxs("div",{className:"min-h-[500px] rounded-md border border-border bg-surface p-2",children:[e.jsx("div",{className:`mb-1 flex items-center rounded-md px-1 py-1 ${l===""?"bg-accent-soft":""}`,children:e.jsxs("button",{type:"button",className:"flex flex-1 items-center gap-1.5 rounded px-1 py-1 text-left font-mono text-xs hover:bg-surface-soft",onClick:()=>{f("",{push:!0,force:!1})},children:[e.jsx(Y,{className:"h-3.5 w-3.5 text-muted"}),"/"]})}),(w.get("")?.files||[]).map(t=>e.jsxs("div",{className:"flex items-center gap-1.5 py-1 pl-4 text-xs text-muted",children:[e.jsx(Q,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"font-mono",children:t.relative_path||t.name||"-"})]},`root-file-${t.relative_path}`)),V("",1)]})]}),e.jsxs(Z,{className:"grid min-w-0 gap-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"font-mono text-xs",children:[e.jsx("a",{href:"/db",onClick:t=>{t.preventDefault(),f("",{push:!0,force:!1})},className:"text-accent",children:"/"}),X.map((t,s)=>{const a=X.slice(0,s+1).join("/");return e.jsxs("span",{children:["/"," ",e.jsx("a",{href:G(a),onClick:n=>{n.preventDefault(),f(a,{push:!0,force:!1})},className:"text-accent",children:t})]},a)})]}),e.jsx("div",{className:"text-sm text-muted",children:ne})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(g,{variant:"primary",className:"h-10 gap-2",onClick:()=>{R.current?.click()},children:[e.jsx(Fe,{className:"h-4 w-4"}),"上传 PDF"]}),e.jsx("input",{ref:R,type:"file",accept:".pdf,application/pdf",multiple:!0,className:"hidden",onChange:t=>{const s=Array.from(t.target.files||[]);ue(s)}}),e.jsxs(g,{variant:"danger",className:"h-10 gap-2",disabled:D===0,onClick:()=>{H(Array.from(N))},children:[e.jsx(De,{className:"h-4 w-4"}),"删除所选",D>0?` (${D})`:""]}),e.jsxs(g,{variant:"ghost",className:"h-10 gap-2",onClick:()=>{me()},children:[e.jsx(Me,{className:"h-4 w-4"}),"重扫当前目录"]}),e.jsxs(g,{variant:"ghost",className:"h-10 gap-2",onClick:()=>{k()},children:[e.jsx(K,{className:"h-4 w-4"}),"刷新"]})]}),e.jsxs("form",{className:"flex flex-wrap items-center gap-2",onSubmit:pe,children:[e.jsx("div",{className:"text-sm text-muted",children:"创建子目录"}),e.jsx(we,{value:z,onChange:t=>J(t.target.value),placeholder:"例如：engine",className:"max-w-[260px]"}),e.jsxs(g,{variant:"ghost",type:"submit",className:"h-10 gap-2",children:[e.jsx(_e,{className:"h-4 w-4"}),"创建"]})]}),B?e.jsx("div",{className:`text-sm ${ce?"text-danger":"text-muted"}`,children:B}):null,v.length===0?e.jsx(ye,{title:"无 PDF 文件"}):e.jsx(Ne,{children:e.jsxs(be,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(C,{className:"w-[48px]",children:e.jsx("input",{type:"checkbox","aria-label":"全选文件",checked:ie,onChange:t=>xe(t.target.checked)})}),e.jsx(C,{children:"文件名"}),e.jsx(C,{children:"入库状态"}),e.jsx(C,{children:"任务状态"}),e.jsx(C,{children:"单文件操作"})]})}),e.jsx("tbody",{children:v.map(t=>{const s=h(t.relative_path||t.name||""),a=!!t.indexed,n=L.current.get(s)||"queued",c=N.has(s);return e.jsxs("tr",{children:[e.jsx(_,{children:e.jsx("input",{type:"checkbox",checked:c,disabled:!s,onChange:()=>fe(s)})}),e.jsx(_,{className:"font-mono text-xs break-all",children:s||"-"}),e.jsx(_,{children:e.jsx(E,{variant:a?"ok":"neutral",children:a?"indexed":"pending"})}),e.jsx(_,{children:e.jsx(E,{variant:n==="success"?"ok":n==="failed"?"bad":"neutral",children:n})}),e.jsx(_,{children:e.jsx(g,{variant:"ghost",className:"h-8",disabled:!s,onClick:()=>{H([s])},children:"删除"})})]},s||t.name)})})]})}),e.jsx("div",{className:"mt-1 text-sm font-medium",children:"任务状态"}),U.length===0?e.jsx("p",{className:"text-sm text-muted",children:"暂无任务"}):e.jsx("div",{className:"grid gap-2",children:U.slice(0,20).map(t=>e.jsxs("div",{className:"flex items-center justify-between gap-3 rounded-md border border-border bg-surface p-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate font-mono text-xs text-text",children:t.pathText}),e.jsxs("div",{className:"text-xs text-muted",children:[t.kind," · ",t.status]}),t.error?e.jsx("div",{className:"truncate text-xs text-danger",children:t.error}):null]}),e.jsxs(E,{variant:t.status==="success"?"ok":t.status==="failed"?"bad":"neutral",children:[t.status==="running"?e.jsx(Ie,{className:"mr-1 h-3 w-3 animate-spin"}):null,t.status]})]},t.rowId))})]})]})})}ge.createRoot(document.getElementById("root")).render(e.jsx(je.StrictMode,{children:e.jsx(Be,{})}));
