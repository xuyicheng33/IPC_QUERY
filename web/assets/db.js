import{r,g as ie,a as ce,u as le,j as o,b as je,e as oe,d as Y,M as z,B as de,R as ue,c as $e,A as Pe}from"./chunks/AppProviders.js";import{D as _e,C as Ee}from"./chunks/Card.js";import{E as Ne,f as G,A as Ae}from"./chunks/api.js";import{u as Re,k as ne,l as Te,n as se,f as pe,g as Q,P as De,m as fe,o as Fe,e as V,q as L,i as Ie,j as U,C as re,r as me,t as ee}from"./chunks/urlState.js";import{g as Me,o as te,G as Oe,I as he,S as ze}from"./chunks/Select.js";function ae(e){return e.substring(2).toLowerCase()}function Le(e,i){return i.documentElement.clientWidth<e.clientX||i.documentElement.clientHeight<e.clientY}function Be(e){const{children:i,disableReactTree:C=!1,mouseEvent:h="onClick",onClickAway:b,touchEvent:j="onTouchEnd"}=e,d=r.useRef(!1),u=r.useRef(null),g=r.useRef(!1),A=r.useRef(!1);r.useEffect(()=>(setTimeout(()=>{g.current=!0},0),()=>{g.current=!1}),[]);const _=Re(Me(i),u),k=ne(c=>{const E=A.current;A.current=!1;const w=te(u.current);if(!g.current||!u.current||"clientX"in c&&Le(c,w))return;if(d.current){d.current=!1;return}let s;c.composedPath?s=c.composedPath().includes(u.current):s=!w.documentElement.contains(c.target)||u.current.contains(c.target),!s&&(C||!E)&&b(c)}),v=c=>E=>{A.current=!0;const w=i.props[c];w&&w(E)},F={ref:_};return j!==!1&&(F[j]=v(j)),r.useEffect(()=>{if(j!==!1){const c=ae(j),E=te(u.current),w=()=>{d.current=!0};return E.addEventListener(c,k),E.addEventListener("touchmove",w),()=>{E.removeEventListener(c,k),E.removeEventListener("touchmove",w)}}},[k,j]),h!==!1&&(F[h]=v(h)),r.useEffect(()=>{if(h!==!1){const c=ae(h),E=te(u.current);return E.addEventListener(c,k),()=>{E.removeEventListener(c,k)}}},[k,h]),r.cloneElement(i,F)}function Ue(e={}){const{autoHideDuration:i=null,disableWindowBlurListener:C=!1,onClose:h,open:b,resumeHideDuration:j}=e,d=Te();r.useEffect(()=>{if(!b)return;function s(y){y.defaultPrevented||y.key==="Escape"&&h?.(y,"escapeKeyDown")}return document.addEventListener("keydown",s),()=>{document.removeEventListener("keydown",s)}},[b,h]);const u=ne((s,y)=>{h?.(s,y)}),g=ne(s=>{!h||s==null||d.start(s,()=>{u(null,"timeout")})});r.useEffect(()=>(b&&g(i),d.clear),[b,i,g,d]);const A=s=>{h?.(s,"clickaway")},_=d.clear,k=r.useCallback(()=>{i!=null&&g(j??i*.5)},[i,j,g]),v=s=>y=>{const f=s.onBlur;f?.(y),k()},F=s=>y=>{const f=s.onFocus;f?.(y),_()},c=s=>y=>{const f=s.onMouseEnter;f?.(y),_()},E=s=>y=>{const f=s.onMouseLeave;f?.(y),k()};return r.useEffect(()=>{if(!C&&b)return window.addEventListener("focus",k),window.addEventListener("blur",_),()=>{window.removeEventListener("focus",k),window.removeEventListener("blur",_)}},[C,b,k,_]),{getRootProps:(s={})=>{const y={...se(e),...se(s)};return{role:"presentation",...s,...y,onBlur:v(y),onFocus:F(y),onMouseEnter:c(y),onMouseLeave:E(y)}},onClickAway:A}}function He(e){return ie("MuiSnackbarContent",e)}ce("MuiSnackbarContent",["root","message","action"]);const Je=e=>{const{classes:i}=e;return pe({root:["root"],action:["action"],message:["message"]},He,i)},Ke=Q(De,{name:"MuiSnackbarContent",slot:"Root"})(fe(({theme:e})=>{const i=e.palette.mode==="light"?.8:.98;return{...e.typography.body2,color:e.vars?e.vars.palette.SnackbarContent.color:e.palette.getContrastText(oe(e.palette.background.default,i)),backgroundColor:e.vars?e.vars.palette.SnackbarContent.bg:oe(e.palette.background.default,i),display:"flex",alignItems:"center",flexWrap:"wrap",padding:"6px 16px",flexGrow:1,[e.breakpoints.up("sm")]:{flexGrow:"initial",minWidth:288}}})),Ge=Q("div",{name:"MuiSnackbarContent",slot:"Message"})({padding:"8px 0"}),We=Q("div",{name:"MuiSnackbarContent",slot:"Action"})({display:"flex",alignItems:"center",marginLeft:"auto",paddingLeft:16,marginRight:-8}),Xe=r.forwardRef(function(i,C){const h=le({props:i,name:"MuiSnackbarContent"}),{action:b,className:j,message:d,role:u="alert",...g}=h,A=h,_=Je(A);return o.jsxs(Ke,{role:u,elevation:6,className:je(_.root,j),ownerState:A,ref:C,...g,children:[o.jsx(Ge,{className:_.message,ownerState:A,children:d}),b?o.jsx(We,{className:_.action,ownerState:A,children:b}):null]})});function qe(e){return ie("MuiSnackbar",e)}ce("MuiSnackbar",["root","anchorOriginTopCenter","anchorOriginBottomCenter","anchorOriginTopRight","anchorOriginBottomRight","anchorOriginTopLeft","anchorOriginBottomLeft"]);const Ve=e=>{const{classes:i,anchorOrigin:C}=e,h={root:["root",`anchorOrigin${Y(C.vertical)}${Y(C.horizontal)}`]};return pe(h,qe,i)},Ye=Q("div",{name:"MuiSnackbar",slot:"Root",overridesResolver:(e,i)=>{const{ownerState:C}=e;return[i.root,i[`anchorOrigin${Y(C.anchorOrigin.vertical)}${Y(C.anchorOrigin.horizontal)}`]]}})(fe(({theme:e})=>({zIndex:(e.vars||e).zIndex.snackbar,position:"fixed",display:"flex",left:8,right:8,justifyContent:"center",alignItems:"center",variants:[{props:({ownerState:i})=>i.anchorOrigin.vertical==="top",style:{top:8,[e.breakpoints.up("sm")]:{top:24}}},{props:({ownerState:i})=>i.anchorOrigin.vertical!=="top",style:{bottom:8,[e.breakpoints.up("sm")]:{bottom:24}}},{props:({ownerState:i})=>i.anchorOrigin.horizontal==="left",style:{justifyContent:"flex-start",[e.breakpoints.up("sm")]:{left:24,right:"auto"}}},{props:({ownerState:i})=>i.anchorOrigin.horizontal==="right",style:{justifyContent:"flex-end",[e.breakpoints.up("sm")]:{right:24,left:"auto"}}},{props:({ownerState:i})=>i.anchorOrigin.horizontal==="center",style:{[e.breakpoints.up("sm")]:{left:"50%",right:"auto",transform:"translateX(-50%)"}}}]}))),Qe=r.forwardRef(function(i,C){const h=le({props:i,name:"MuiSnackbar"}),b=Fe(),j={enter:b.transitions.duration.enteringScreen,exit:b.transitions.duration.leavingScreen},{action:d,anchorOrigin:{vertical:u,horizontal:g}={vertical:"bottom",horizontal:"left"},autoHideDuration:A=null,children:_,className:k,ClickAwayListenerProps:v,ContentProps:F,disableWindowBlurListener:c=!1,message:E,onBlur:w,onClose:s,onFocus:y,onMouseEnter:f,onMouseLeave:x,open:p,resumeHideDuration:S,slots:M={},slotProps:I={},TransitionComponent:B,transitionDuration:T=j,TransitionProps:{onEnter:$,onExited:R,...P}={},...D}=h,t={...h,anchorOrigin:{vertical:u,horizontal:g},autoHideDuration:A,disableWindowBlurListener:c,TransitionComponent:B,transitionDuration:T},a=Ve(t),{getRootProps:m,onClickAway:l}=Ue(t),[n,K]=r.useState(!0),N=W=>{K(!0),R&&R(W)},O=(W,J)=>{K(!1),$&&$(W,J)},H={slots:{transition:B,...M},slotProps:{content:F,clickAwayListener:v,transition:P,...I}},[Z,ge]=V("root",{ref:C,className:[a.root,k],elementType:Ye,getSlotProps:m,externalForwardedProps:{...H,...D},ownerState:t}),[xe,{ownerState:be,...we}]=V("clickAwayListener",{elementType:Be,externalForwardedProps:H,getSlotProps:W=>({onClickAway:(...J)=>{const ke=J[0];W.onClickAway?.(...J),!ke?.defaultMuiPrevented&&l(...J)}}),ownerState:t}),[ye,ve]=V("content",{elementType:Xe,shouldForwardComponentProp:!0,externalForwardedProps:H,additionalProps:{message:E,action:d},ownerState:t}),[Ce,Se]=V("transition",{elementType:Oe,externalForwardedProps:H,getSlotProps:W=>({onEnter:(...J)=>{W.onEnter?.(...J),O(...J)},onExited:(...J)=>{W.onExited?.(...J),N(...J)}}),additionalProps:{appear:!0,in:p,timeout:T,direction:u==="top"?"down":"up"},ownerState:t});return!p&&n?null:o.jsx(xe,{...we,...M.clickAwayListener&&{ownerState:be},children:o.jsx(Z,{...ge,children:o.jsx(Ce,{...Se,children:_||o.jsx(ye,{...ve})})})})});function Ze({items:e,selectedPaths:i,onSelectionChange:C,knownDirectories:h,capabilitiesImportEnabled:b,importDisabledReason:j,getRowActionState:d,onSetRowActionState:u,onClearRowActionState:g,onBeginRename:A,onBeginMove:_,onApplyRename:k,onApplyMove:v,onDeleteSingle:F,onOpenDirectory:c}){const[E,w]=r.useState(""),s=r.useMemo(()=>e.filter(x=>!x.is_dir).map(x=>L(x.relative_path||x.name||"")).filter(Boolean),[e]),y=x=>{C(s.filter(p=>x.has(p)))},f=(x,p)=>{if(!x)return;const S=new Set(i);if(p.shift){const M=s.indexOf(x),I=s.indexOf(E||x);if(M>=0&&I>=0){const[B,T]=I<=M?[I,M]:[M,I];S.clear();for(let $=B;$<=T;$+=1)S.add(s[$])}else S.clear(),S.add(x);w(x),y(S);return}if(p.toggle){S.has(x)?S.delete(x):S.add(x),w(x),y(S);return}S.clear(),S.add(x),w(x),y(S)};return e.length===0?o.jsx(Ne,{title:"空目录"}):o.jsx("div",{className:"overflow-hidden rounded-md border border-border bg-surface",children:o.jsx("div",{role:"list","aria-label":"数据库文件列表",children:e.map(x=>{const p=L(x.relative_path||x.name||""),S=d(p),M=L(S.value||""),I=new URLSearchParams;I.set("pdf",p),I.set("page","1"),I.set("return_to",Ie(`${window.location.pathname}${window.location.search}`));const B=`/viewer.html?${I.toString()}`,T=S.phase==="pending",$=x.is_dir,R=!$&&i.has(p),P=String(x.name||p||"-"),D=!!(p&&p!==P),t=n=>{n.preventDefault(),n.stopPropagation()},a=n=>{n.preventDefault(),n.stopPropagation()},m=n=>{S.mode==="normal"&&f(p,{shift:n.shiftKey,toggle:n.metaKey||n.ctrlKey})},l=n=>{S.mode==="normal"&&(n.key===" "||n.key==="Enter")&&(n.preventDefault(),f(p,{shift:n.shiftKey,toggle:n.metaKey||n.ctrlKey}))};return o.jsxs("div",{role:$?"button":void 0,"aria-label":$?`目录 ${P}`:`${P}${R?"（已选）":""}`,tabIndex:0,className:`group flex cursor-pointer items-center gap-2 border-b border-border px-3 py-2 last:border-b-0 focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent ${R?"bg-accent-soft":"hover:bg-surface-soft"}`,onClick:n=>{if($){c(p);return}m(n)},onKeyDown:n=>{if($){(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),c(p));return}l(n)},children:[o.jsx("div",{className:"flex w-7 items-center justify-center",children:o.jsx(z,{name:$?"folder":"description",size:20,className:$?"text-accent":"text-muted"})}),o.jsxs("div",{className:"min-w-0 flex-1",children:[o.jsx("div",{className:"truncate text-sm font-medium text-text",children:P}),D?o.jsx("div",{className:"truncate font-mono text-xs text-muted",children:p}):null]}),o.jsx("div",{className:"min-w-[170px] md:min-w-[320px]",children:$?o.jsx("div",{className:"flex justify-end text-muted",children:o.jsx(z,{name:"chevron_right",size:18})}):S.mode==="renaming"?o.jsxs("div",{className:"grid gap-1",children:[o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx(he,{name:`rename-${p}`,value:S.value,onChange:n=>u(p,{...S,value:n.target.value,error:"",phase:"idle"}),onFocus:n=>{n.target.select()},onKeyDown:n=>{n.key==="Enter"?(a(n),k(p)):n.key==="Escape"&&(a(n),g(p))},className:"h-8",placeholder:"新文件名，如 b.pdf",disabled:T,autoFocus:!0}),o.jsx(U,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:n=>{t(n),k(p)},disabled:T,"aria-label":T?"正在改名":"确认改名",title:T?"正在改名":"确认改名",startIcon:T?o.jsx(re,{size:14}):o.jsx(z,{name:"check",size:16})}),o.jsx(U,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:n=>{t(n),g(p)},disabled:T,"aria-label":"取消改名",title:"取消改名",startIcon:o.jsx(z,{name:"close",size:16})})]}),S.error?o.jsx("div",{className:"text-xs text-danger",children:S.error}):null]}):S.mode==="moving"?o.jsxs("div",{className:"grid gap-1",children:[o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx(ze,{name:`move-${p}`,value:M,className:"h-8",onChange:n=>u(p,{...S,value:L(n.target.value),error:"",phase:"idle"}),onKeyDown:n=>{n.key==="Enter"?(a(n),v(p)):n.key==="Escape"&&(a(n),g(p))},disabled:T,autoFocus:!0,children:h.map(n=>o.jsx("option",{value:n,children:n||"/"},n||"root"))}),o.jsx(U,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:n=>{t(n),v(p)},disabled:T,"aria-label":T?"正在移动":"确认移动",title:T?"正在移动":"确认移动",startIcon:T?o.jsx(re,{size:14}):o.jsx(z,{name:"check",size:16})}),o.jsx(U,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:n=>{t(n),g(p)},disabled:T,"aria-label":"取消移动",title:"取消移动",startIcon:o.jsx(z,{name:"close",size:16})})]}),S.error?o.jsx("div",{className:"text-xs text-danger",children:S.error}):null]}):o.jsxs(de,{display:"flex",justifyContent:"flex-end",alignItems:"center",flexWrap:"nowrap",gap:.5,className:"opacity-100 transition-opacity md:opacity-0 md:group-hover:opacity-100 md:group-focus-within:opacity-100",children:[o.jsx(U,{variant:"ghost",className:"h-8 gap-1.5 px-2",disabled:!p,startIcon:o.jsx(z,{name:"open_in_new",size:16}),onClick:n=>{t(n),p&&window.open(B,"_blank","noopener,noreferrer")},children:"预览"}),o.jsx(U,{variant:"ghost",className:"h-8 gap-1.5 px-2",disabled:!p||!b,title:b?void 0:j,startIcon:o.jsx(z,{name:"edit",size:16}),onClick:n=>{t(n),A(p)},children:"改名"}),o.jsx(U,{variant:"ghost",className:"h-8 gap-1.5 px-2",disabled:!p||!b,title:b?void 0:j,startIcon:o.jsx(z,{name:"drive_file_move",size:16}),onClick:n=>{t(n),_(p)},children:"移动"}),o.jsx(U,{variant:"ghost",className:"h-8 gap-1.5 px-2 text-danger",disabled:!p||!b,title:b?void 0:j,startIcon:o.jsx(z,{name:"delete",size:16}),onClick:n=>{t(n),F(p)},children:"删除"})]})})]},p||x.name)})})})}function et({currentPath:e,breadcrumbParts:i,directoryCount:C,status:h,selectedCount:b,fileCount:j,folderName:d,onFolderNameChange:u,capabilities:g,importDisabledReason:A,onNavigate:_,onUploadFiles:k,onDeleteSelected:v,onRefresh:F,onCreateFolder:c}){const E=r.useRef(null),w=!g.import_enabled||e!=="",s=g.import_enabled&&b>0,y=f=>{f.preventDefault(),c()};return o.jsxs("div",{className:"grid gap-3",children:[o.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-start lg:justify-between",children:[o.jsxs("div",{className:"min-w-0",children:[o.jsxs(de,{className:"flex flex-wrap items-center gap-2 text-sm text-text",children:[o.jsxs("a",{href:"/db",onClick:f=>{f.preventDefault(),_("")},className:"inline-flex items-center gap-1 rounded-sm px-1 py-0.5 hover:bg-surface-soft focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent",children:[o.jsx(z,{name:"folder",size:16}),"根目录"]}),i.map((f,x)=>{const p=i.slice(0,x+1).join("/");return o.jsxs(ue.Fragment,{children:[o.jsx(z,{name:"chevron_right",size:14,className:"text-muted"}),o.jsx("a",{href:me(p),onClick:S=>{S.preventDefault(),_(p)},className:"inline-flex items-center rounded-sm px-1 py-0.5 hover:bg-surface-soft focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent",children:f})]},p)})]}),o.jsxs("div",{className:"mt-1 text-xs text-muted",children:["目录 ",C," · 文件 ",j,` · 已选 ${b}`]})]}),o.jsxs("div",{className:"flex flex-wrap items-center gap-2 lg:justify-end",children:[o.jsx(U,{variant:"primary",className:"h-10 gap-1.5 px-4",disabled:!g.import_enabled,title:g.import_enabled?"上传 PDF":A,startIcon:o.jsx(z,{name:"upload_file",size:16}),onClick:()=>E.current?.click(),children:"上传 PDF"}),o.jsx("input",{ref:E,type:"file",accept:".pdf,application/pdf",multiple:!0,className:"hidden",onChange:f=>{k(Array.from(f.target.files||[])),f.currentTarget.value=""}}),o.jsxs("form",{className:"flex flex-wrap items-center gap-2",onSubmit:y,children:[o.jsx(he,{id:"db-folder-name",name:"folder_name",value:d,onChange:f=>u(f.target.value),placeholder:e?"仅根目录可创建子目录":"新建子目录名称",className:"h-10 w-[220px]",disabled:w,"aria-label":"新建子目录名称"}),o.jsx(U,{variant:"ghost",type:"submit",className:"h-10 gap-1.5 px-4",disabled:w||!d.trim(),title:g.import_enabled?e?"仅支持在根目录创建子目录":void 0:A,startIcon:o.jsx(z,{name:"create_new_folder",size:16}),children:"创建子目录"})]}),o.jsxs(U,{variant:"danger",className:"h-10 gap-1.5 px-4",disabled:!s,title:g.import_enabled?void 0:A,startIcon:o.jsx(z,{name:"delete",size:16}),onClick:v,children:["删除所选",b>0?` (${b})`:""]}),o.jsx(U,{variant:"ghost",className:"h-10 gap-1.5 px-4",startIcon:o.jsx(z,{name:"refresh",size:16}),onClick:F,children:"刷新"})]})]}),h?o.jsx("div",{className:"rounded-md border border-border bg-surface-soft px-3 py-2 text-xs text-muted",children:h}):null,o.jsx("p",{className:"text-xs text-muted",children:"提示：目录支持单击进入；文件支持 Shift / Cmd(Ctrl) 多选。"})]})}function X(e){const i=L(e||"");return i&&i.split("/")[0]||""}function tt({initialPath:e}){const[i,C]=r.useState(()=>X(e||"")),[h,b]=r.useState(()=>new Map),[j,d]=r.useState(()=>new Set([""])),[u,g]=r.useState([]),[A,_]=r.useState([]),[k,v]=r.useState(()=>new Set),[F,c]=r.useState(""),E=r.useRef(h),w=r.useMemo(()=>{const $=new Set([""]),R=h.get("");for(const P of R?.directories||[])$.add(X(P.path||""));return Array.from($.values()).sort((P,D)=>P.localeCompare(D))},[h]),s=k.size,y=i?i.split("/"):[],f=r.useCallback(async($,R=!1)=>{const P=X($||""),D=E.current.get(P);if(!R&&D)return D;const t=await G(`/api/docs/tree?path=${encodeURIComponent(P)}`),a={path:L(t.path||P),directories:Array.isArray(t.directories)?t.directories:[],files:Array.isArray(t.files)?t.files:[]};return b(m=>{const l=new Map(m);return l.set(a.path,a),a.path!==P&&l.set(P,a),E.current=l,l}),a},[]),x=r.useCallback(async($,R=!1)=>{const P=X($||"");await f("",R),P&&await f(P,R)},[f]),p=r.useCallback($=>{const R=new Set($.map(P=>L(P.relative_path||P.name||"")));v(P=>{const D=new Set;for(const t of P)R.has(t)&&D.add(t);return D})},[]),S=r.useCallback(async($,R)=>{const P=!!R?.push,D=!!R?.force,t=X($||"");c("加载中...");try{await x(t,D);const a=await f(t,D),m=X(a.path||t);C(m),g(m?[]:a.directories||[]),_(a.files||[]),p(a.files||[]),d(l=>{const n=new Set(l);return n.add(""),m&&n.add(m),n}),P&&history.pushState({},"",me(m)),c("")}catch(a){c(`加载失败：${String(a?.message||a)}`),g([]),_([])}},[f,x,p]),M=r.useCallback(async()=>{await S(i,{force:!0,push:!1})},[i,S]),I=r.useCallback($=>{const R=new Set;for(const P of $){const D=L(P||"");D&&R.add(D)}v(R)},[]),B=r.useCallback(()=>{v(new Set)},[]),T=r.useCallback(($,R)=>{d(P=>{const D=new Set(P);return R?D.add($):D.delete($),D})},[]);return{currentPath:i,treeCache:h,expandedDirs:j,directories:u,files:A,selectedPaths:k,status:F,knownDirectories:w,selectedCount:s,breadcrumbParts:y,setStatus:c,setSelection:I,loadDirectory:S,refreshCurrentDirectory:M,ensureTreeNode:f,toggleExpandDir:T,clearSelection:B}}function nt(e){return e==="success"?"success":e==="failed"?"failed":e==="running"?"running":"queued"}function ot({onAllJobsSettled:e,pollIntervalMs:i=1500}={}){const[C,h]=r.useState([]),[b,j]=r.useState(()=>new Map),d=r.useRef(new Set),u=r.useRef(""),g=r.useRef(null),A=r.useRef(!1),_=r.useCallback((w,s)=>{const y=nt(w.status),f=w,x=String(f.relative_path||f.filename||f.path||"-"),p=String(w.error||""),S=String(w.job_id||`${s}-${Date.now()}`);s==="import"&&x&&x!=="-"&&j(M=>{const I=new Map(M);return I.set(x,y),I}),h(M=>{const I=`${s}-${S}`,B=M.filter(T=>T.rowId!==I);return B.unshift({rowId:I,kind:s,status:y,pathText:x,error:p,updatedAt:Date.now()}),B.slice(0,80)})},[]),k=r.useCallback(()=>{g.current!==null&&(window.clearInterval(g.current),g.current=null)},[]),v=r.useCallback(async()=>{if(!A.current){A.current=!0;try{const w=[];for(const s of d.current.values())try{const y=await G(`/api/import/${encodeURIComponent(s)}`);_(y,"import"),["success","failed"].includes(String(y.status||""))&&w.push(s)}catch{w.push(s)}if(w.forEach(s=>d.current.delete(s)),u.current)try{const s=await G(`/api/scan/${encodeURIComponent(u.current)}`);_(s,"scan"),["success","failed"].includes(String(s.status||""))&&(u.current="")}catch{u.current=""}d.current.size===0&&!u.current&&(k(),e&&await e())}finally{A.current=!1}}},[e,k,_]),F=r.useCallback(()=>{g.current===null&&(g.current=window.setInterval(()=>{v()},i))},[i,v]),c=r.useCallback(w=>{const s=String(w||"").trim();s&&(d.current.add(s),F())},[F]),E=r.useCallback(w=>{const s=String(w||"").trim();s&&(u.current=s,F())},[F]);return r.useEffect(()=>()=>{k()},[k]),{jobs:C,jobStatusByPath:b,upsertJob:_,startImportJob:c,startScanJob:E,stopAllPolling:k}}function st(){const e=Date.now();return{upload:{phase:"idle",message:"",updatedAt:e},batchDelete:{phase:"idle",message:"",updatedAt:e},rescan:{phase:"idle",message:"",updatedAt:e},createFolder:{phase:"idle",message:"",updatedAt:e}}}function q(e,i=""){return{mode:e,value:i,error:"",phase:"idle"}}function rt({currentPath:e,visibleFiles:i,capabilities:C,importDisabledReason:h,scanDisabledReason:b,refreshCurrentDirectory:j,clearSelection:d,setStatus:u,upsertJob:g,startImportJob:A,startScanJob:_}){const[k,v]=r.useState({}),[F,c]=r.useState(()=>st()),[E,w]=r.useState(null);r.useEffect(()=>{const t=new Set(i.map(a=>L(a.relative_path||a.name||"")));v(a=>{const m={};for(const[l,n]of Object.entries(a))t.has(l)&&(m[l]=n);return m})},[i]);const s=r.useCallback((t,a,m,l)=>{c(n=>({...n,[t]:{phase:a,message:m,updatedAt:Date.now(),...l?{error:l}:{}}})),w(m?{phase:a,message:m}:null)},[]),y=r.useCallback(t=>k[t]||q("normal"),[k]),f=r.useCallback((t,a)=>{v(m=>({...m,[t]:a}))},[]),x=r.useCallback(t=>{v(a=>{const m={...a};return delete m[t],m})},[]),p=r.useCallback(t=>{const a=(t.results||[]).filter(m=>!m.ok);return a.length===0?"":a.slice(0,3).map(m=>{const l=String(m.path||"-");if(String(m.error_code||"").toUpperCase()==="CONFLICT"){const K=Array.isArray(m.details?.candidates)?m.details.candidates.slice(0,3).join(", "):"";return K?`${l}: 命名冲突，请使用完整相对路径，候选: ${K}`:`${l}: 命名冲突，请使用完整相对路径`}return`${l}: ${String(m.error||"unknown error")}`}).join(" | ")},[]),S=r.useCallback(async t=>{if(!C.import_enabled){const N=h||"导入服务不可用";s("batchDelete","error",`删除不可用：${N}`,N),u(`删除不可用：${N}`);return}const a=t.map(N=>L(N||"")).filter(Boolean);if(a.length===0)return;const m=a.slice(0,5).join(`
`),l=a.length>5?`
...`:"";if(!window.confirm(`确认删除 ${a.length} 个文件？
将删除数据库记录和磁盘文件。

示例路径：
${m}${l}`))return;const K=`正在删除 ${a.length} 个文件...`;s("batchDelete","pending",K),u(K);try{const N=await G("/api/docs/batch-delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paths:a})}),O=p(N),H=O?`删除完成：成功 ${N.deleted}/${N.total}，失败 ${N.failed}（${O}）`:`删除完成：成功 ${N.deleted}/${N.total}，失败 ${N.failed}`,Z=N.failed>0?"error":"success";s("batchDelete",Z,H,N.failed>0?O||"partial failed":void 0),u(H),d(),await j()}catch(N){const O=String(N?.message||N);s("batchDelete","error",`删除失败：${O}`,O),u(`删除失败：${O}`)}},[C.import_enabled,d,p,h,j,u,s]),M=r.useCallback(async t=>{if(!C.import_enabled){const N=h||"导入服务不可用";s("upload","error",`上传不可用：${N}`,N),u(`上传不可用：${N}`);return}if(t.length===0){u("请选择 PDF 文件");return}const a=`准备上传 ${t.length} 个文件...`;s("upload","pending",a),u(a);let m=0,l=0;for(const N of t)try{const O=await fetch(`/api/import?filename=${encodeURIComponent(N.name)}&target_dir=${encodeURIComponent(e)}`,{method:"POST",headers:{Accept:"application/json","Content-Type":N.type||"application/pdf","X-File-Name":N.name,"X-Target-Dir":e},body:N}),H=await O.json().catch(()=>({}));if(!O.ok)throw new Error(String(H.message||`${O.status} ${O.statusText}`));m+=1,g(H,"import"),A(String(H.job_id||""))}catch(O){l+=1,g({job_id:`error-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,filename:N.name,status:"failed",error:String(O?.message||O)},"import")}const n=`上传提交完成：成功 ${m}/${t.length}，失败 ${l}`,K=l>0?"error":"success";s("upload",K,n,l>0?"partial failed":void 0),u(n)},[C.import_enabled,e,h,u,A,s,g]),I=r.useCallback(async(t,a)=>{if(!C.import_enabled){const l=h||"导入服务不可用";s("createFolder","error",`创建目录不可用：${l}`,l),u(`创建目录不可用：${l}`);return}const m=t.trim();if(!m){s("createFolder","error","创建失败：请输入目录名","missing folder name");return}if(L(e)!==""){const l="仅支持在根目录创建子目录";s("createFolder","error",l,"root-only"),u(l);return}s("createFolder","pending",`正在创建目录：${m}`);try{await G("/api/folders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e,name:m})}),a?.(),await j();const l=`创建目录成功：${L(e)||"/"} / ${m}`;s("createFolder","success",l),u(l)}catch(l){const n=String(l?.message||l);s("createFolder","error",`创建失败：${n}`,n),u(`创建失败：${n}`)}},[C.import_enabled,e,h,j,u,s]),B=r.useCallback(async()=>{if(!C.scan_enabled){const t=b||"重扫服务不可用";s("rescan","error",`重扫不可用：${t}`,t),u(`重扫不可用：${t}`);return}s("rescan","pending",`正在提交重扫任务：${L(e)||"/"}`);try{const t=await G(`/api/scan?path=${encodeURIComponent(e)}`,{method:"POST"}),a=String(t.job_id||"");if(!a)throw new Error("scan job id missing");g(t,"scan"),_(a);const m=`重扫任务已提交：${a}`;s("rescan","success",m),u(m)}catch(t){const a=String(t?.message||t);s("rescan","error",`触发重扫失败：${a}`,a),u(`触发重扫失败：${a}`)}},[C.scan_enabled,e,b,u,_,s,g]),T=r.useCallback(t=>{const a=t.split("/").pop()||t;f(t,q("renaming",a))},[f]),$=r.useCallback(t=>{f(t,q("moving",e))},[e,f]),R=r.useCallback(async t=>{if(!C.import_enabled){const l=h||"导入服务不可用";f(t,{...q("renaming"),error:l,phase:"error"});return}const a=y(t),m=a.value.trim();if(!m){f(t,{...a,error:"请输入新文件名",phase:"error"});return}f(t,{...a,error:"",phase:"pending"});try{const l=await G("/api/docs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:t,new_name:m})});f(t,{...a,phase:"success"}),x(t),u(`改名成功：${l.old_path} -> ${l.new_path}`),await j()}catch(l){const n=String(l?.message||l);f(t,{...a,error:n,phase:"error"})}},[C.import_enabled,x,y,h,j,f,u]),P=r.useCallback(async t=>{if(!C.import_enabled){const l=h||"导入服务不可用";f(t,{...q("moving"),error:l,phase:"error"});return}const a=y(t),m=L(a.value||"");f(t,{...a,error:"",phase:"pending"});try{const l=await G("/api/docs/move",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:t,target_dir:m})});f(t,{...a,phase:"success"}),x(t),u(`移动成功：${l.old_path} -> ${l.new_path}`),await j()}catch(l){const n=String(l?.message||l);f(t,{...a,error:n,phase:"error"})}},[C.import_enabled,x,y,h,j,f,u]),D=r.useMemo(()=>({getRowActionState:y,setRowActionState:f,clearRowActionState:x,beginRename:T,beginMove:$,applyRename:R,applyMove:P}),[P,R,$,T,x,y,f]);return{globalActionState:F,actionFeedback:E,rowActions:D,deleteSelected:S,submitUploads:M,createFolder:I,triggerRescan:B}}function at(){const[e,i]=r.useState(""),[C,h]=r.useState(!1),[b,j]=r.useState({import_enabled:!0,scan_enabled:!0,import_reason:"",scan_reason:""}),d=tt({initialPath:ee(window.location.search)}),u=d.setStatus,g=b.import_enabled?"":String(b.import_reason||"导入服务不可用"),A=b.scan_enabled?"":String(b.scan_reason||"重扫服务不可用"),_=r.useCallback(async()=>{try{const c=await G("/api/capabilities");j({import_enabled:!!c.import_enabled,scan_enabled:!!c.scan_enabled,import_reason:String(c.import_reason||""),scan_reason:String(c.scan_reason||"")})}catch(c){const E=String(c?.message||c);u(`加载能力信息失败：${E}`)}},[u]),k=ot({onAllJobsSettled:async()=>{await d.refreshCurrentDirectory()}}),v=rt({currentPath:d.currentPath,visibleFiles:d.files,capabilities:b,importDisabledReason:g,scanDisabledReason:A,refreshCurrentDirectory:d.refreshCurrentDirectory,clearSelection:d.clearSelection,setStatus:d.setStatus,upsertJob:k.upsertJob,startImportJob:k.startImportJob,startScanJob:k.startScanJob}),F=r.useMemo(()=>{const c=d.directories.map(w=>({name:String(w.name||w.path||"").split("/").pop()||w.path||"-",relative_path:w.path,indexed:!0,is_dir:!0})),E=d.files.map(w=>({...w,is_dir:!1}));return[...c,...E]},[d.directories,d.files]);return r.useEffect(()=>{v.actionFeedback?.message&&h(!0)},[v.actionFeedback]),r.useEffect(()=>{const c=()=>{d.loadDirectory(ee(window.location.search),{push:!1,force:!1})};return window.addEventListener("popstate",c),_(),d.loadDirectory(ee(window.location.search),{push:!1,force:!0}),()=>{window.removeEventListener("popstate",c),k.stopAllPolling()}},[]),o.jsxs(_e,{actions:[{href:"/search",label:"搜索",icon:o.jsx(z,{name:"search",size:18})}],hideHeaderTitle:!0,children:[o.jsx("div",{className:"grid gap-4",children:o.jsxs(Ee,{className:"grid min-w-0 gap-4 p-4",children:[o.jsx(et,{currentPath:d.currentPath,breadcrumbParts:d.breadcrumbParts,directoryCount:d.directories.length,status:d.status,selectedCount:d.selectedCount,fileCount:d.files.length,folderName:e,onFolderNameChange:i,capabilities:b,importDisabledReason:g,onNavigate:c=>{d.loadDirectory(c,{push:!0,force:!1})},onUploadFiles:c=>{v.submitUploads(c)},onDeleteSelected:()=>{v.deleteSelected(Array.from(d.selectedPaths))},onRefresh:()=>{d.refreshCurrentDirectory()},onCreateFolder:()=>{v.createFolder(e,()=>{i("")})}}),o.jsx(Ze,{items:F,selectedPaths:d.selectedPaths,onSelectionChange:d.setSelection,knownDirectories:d.knownDirectories,capabilitiesImportEnabled:b.import_enabled,importDisabledReason:g,getRowActionState:v.rowActions.getRowActionState,onSetRowActionState:v.rowActions.setRowActionState,onClearRowActionState:v.rowActions.clearRowActionState,onBeginRename:v.rowActions.beginRename,onBeginMove:v.rowActions.beginMove,onApplyRename:c=>{v.rowActions.applyRename(c)},onApplyMove:c=>{v.rowActions.applyMove(c)},onDeleteSingle:c=>{v.deleteSelected([c])},onOpenDirectory:c=>{d.loadDirectory(c,{push:!0,force:!1})}})]})}),o.jsx(Qe,{open:C,autoHideDuration:2800,onClose:()=>h(!1),anchorOrigin:{vertical:"top",horizontal:"right"},children:o.jsx(Ae,{onClose:()=>h(!1),severity:v.actionFeedback?.phase==="error"?"error":v.actionFeedback?.phase==="pending"?"info":"success",variant:"filled",children:v.actionFeedback?.message||"操作完成"})})]})}$e.createRoot(document.getElementById("root")).render(o.jsx(ue.StrictMode,{children:o.jsx(Pe,{children:o.jsx(at,{})})}));
