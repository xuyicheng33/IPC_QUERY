import{r,g as re,a as ae,u as ie,e as Me,b as se,j as t,d as Q,f as we,M as ne,B as Ee,R as je,c as Fe,A as Oe}from"./chunks/AppProviders.js";import{u as Be,l as xe,n as De,P as ve,e as Z,g as le,h as Y,m as ce,o as Le,q as Ce,r as J,j as Ie,C as me,t as $e,k as ee,f as q,v as ge}from"./chunks/urlState.js";import{D as We,C as ze}from"./chunks/Card.js";import{T as Ue,E as He,A as Je}from"./chunks/EmptyState.js";import{g as Ke,o as he,F as ke,M as Xe,B as Ge,G as qe,I as ye,S as Ye}from"./chunks/Select.js";function Se(e){return e.substring(2).toLowerCase()}function Ve(e,n){return n.documentElement.clientWidth<e.clientX||n.documentElement.clientHeight<e.clientY}function Qe(e){const{children:n,disableReactTree:p=!1,mouseEvent:f="onClick",onClickAway:C,touchEvent:v="onTouchEnd"}=e,j=r.useRef(!1),d=r.useRef(null),b=r.useRef(!1),_=r.useRef(!1);r.useEffect(()=>(setTimeout(()=>{b.current=!0},0),()=>{b.current=!1}),[]);const g=Be(Ke(n),d),P=xe($=>{const N=_.current;_.current=!1;const D=he(d.current);if(!b.current||!d.current||"clientX"in $&&Ve($,D))return;if(j.current){j.current=!1;return}let o;$.composedPath?o=$.composedPath().includes(d.current):o=!D.documentElement.contains($.target)||d.current.contains($.target),!o&&(p||!N)&&C($)}),A=$=>N=>{_.current=!0;const D=n.props[$];D&&D(N)},F={ref:g};return v!==!1&&(F[v]=A(v)),r.useEffect(()=>{if(v!==!1){const $=Se(v),N=he(d.current),D=()=>{j.current=!0};return N.addEventListener($,P),N.addEventListener("touchmove",D),()=>{N.removeEventListener($,P),N.removeEventListener("touchmove",D)}}},[P,v]),f!==!1&&(F[f]=A(f)),r.useEffect(()=>{if(f!==!1){const $=Se(f),N=he(d.current);return N.addEventListener($,P),()=>{N.removeEventListener($,P)}}},[P,f]),r.cloneElement(n,F)}function Ze(e){return re("MuiDialog",e)}const be=ae("MuiDialog",["root","backdrop","scrollPaper","scrollBody","container","paper","paperScrollPaper","paperScrollBody","paperWidthFalse","paperWidthXs","paperWidthSm","paperWidthMd","paperWidthLg","paperWidthXl","paperFullWidth","paperFullScreen"]),Pe=r.createContext({}),et=Y(Ge,{name:"MuiDialog",slot:"Backdrop"})({zIndex:-1}),tt=e=>{const{classes:n,scroll:p,maxWidth:f,fullWidth:C,fullScreen:v}=e,j={root:["root"],backdrop:["backdrop"],container:["container",`scroll${Q(p)}`],paper:["paper",`paperScroll${Q(p)}`,`paperWidth${Q(String(f))}`,C&&"paperFullWidth",v&&"paperFullScreen"]};return le(j,Ze,n)},nt=Y(Xe,{name:"MuiDialog",slot:"Root"})({"@media print":{position:"absolute !important"}}),ot=Y("div",{name:"MuiDialog",slot:"Container",overridesResolver:(e,n)=>{const{ownerState:p}=e;return[n.container,n[`scroll${Q(p.scroll)}`]]}})({height:"100%","@media print":{height:"auto"},outline:0,variants:[{props:{scroll:"paper"},style:{display:"flex",justifyContent:"center",alignItems:"center"}},{props:{scroll:"body"},style:{overflowY:"auto",overflowX:"hidden",textAlign:"center","&::after":{content:'""',display:"inline-block",verticalAlign:"middle",height:"100%",width:"0"}}}]}),st=Y(ve,{name:"MuiDialog",slot:"Paper",overridesResolver:(e,n)=>{const{ownerState:p}=e;return[n.paper,n[`scrollPaper${Q(p.scroll)}`],n[`paperWidth${Q(String(p.maxWidth))}`],p.fullWidth&&n.paperFullWidth,p.fullScreen&&n.paperFullScreen]}})(ce(({theme:e})=>({margin:32,position:"relative",overflowY:"auto","@media print":{overflowY:"visible",boxShadow:"none"},variants:[{props:{scroll:"paper"},style:{display:"flex",flexDirection:"column",maxHeight:"calc(100% - 64px)"}},{props:{scroll:"body"},style:{display:"inline-block",verticalAlign:"middle",textAlign:"initial"}},{props:({ownerState:n})=>!n.maxWidth,style:{maxWidth:"calc(100% - 64px)"}},{props:{maxWidth:"xs"},style:{maxWidth:e.breakpoints.unit==="px"?Math.max(e.breakpoints.values.xs,444):`max(${e.breakpoints.values.xs}${e.breakpoints.unit}, 444px)`,[`&.${be.paperScrollBody}`]:{[e.breakpoints.down(Math.max(e.breakpoints.values.xs,444)+64)]:{maxWidth:"calc(100% - 64px)"}}}},...Object.keys(e.breakpoints.values).filter(n=>n!=="xs").map(n=>({props:{maxWidth:n},style:{maxWidth:`${e.breakpoints.values[n]}${e.breakpoints.unit}`,[`&.${be.paperScrollBody}`]:{[e.breakpoints.down(e.breakpoints.values[n]+64)]:{maxWidth:"calc(100% - 64px)"}}}})),{props:({ownerState:n})=>n.fullWidth,style:{width:"calc(100% - 64px)"}},{props:({ownerState:n})=>n.fullScreen,style:{margin:0,width:"100%",maxWidth:"100%",height:"100%",maxHeight:"none",borderRadius:0,[`&.${be.paperScrollBody}`]:{margin:0,maxWidth:"100%"}}}]}))),Ne=r.forwardRef(function(n,p){const f=ie({props:n,name:"MuiDialog"}),C=De(),v={enter:C.transitions.duration.enteringScreen,exit:C.transitions.duration.leavingScreen},{"aria-describedby":j,"aria-labelledby":d,"aria-modal":b=!0,BackdropComponent:_,BackdropProps:g,children:P,className:A,disableEscapeKeyDown:F=!1,fullScreen:$=!1,fullWidth:N=!1,maxWidth:D="sm",onClick:o,onClose:w,open:y,PaperComponent:T=ve,PaperProps:m={},scroll:E="paper",slots:S={},slotProps:M={},TransitionComponent:U=ke,transitionDuration:H=v,TransitionProps:I,...R}=f,x={...f,disableEscapeKeyDown:F,fullScreen:$,fullWidth:N,maxWidth:D,scroll:E},l=tt(x),h=r.useRef(),O=K=>{h.current=K.target===K.currentTarget},B=K=>{o&&o(K),h.current&&(h.current=null,w&&w(K,"backdropClick"))},i=Me(d),a=r.useMemo(()=>({titleId:i}),[i]),u={transition:U,...S},s={transition:I,paper:m,backdrop:g,...M},k={slots:u,slotProps:s},[L,z]=Z("root",{elementType:nt,shouldForwardComponentProp:!0,externalForwardedProps:k,ownerState:x,className:se(l.root,A),ref:p}),[X,W]=Z("backdrop",{elementType:et,shouldForwardComponentProp:!0,externalForwardedProps:k,ownerState:x,className:l.backdrop}),[V,c]=Z("paper",{elementType:st,shouldForwardComponentProp:!0,externalForwardedProps:k,ownerState:x,className:se(l.paper,m.className)}),[de,ue]=Z("container",{elementType:ot,externalForwardedProps:k,ownerState:x,className:l.container}),[pe,fe]=Z("transition",{elementType:ke,externalForwardedProps:k,ownerState:x,additionalProps:{appear:!0,in:y,timeout:H,role:"presentation"}});return t.jsx(L,{closeAfterTransition:!0,slots:{backdrop:X},slotProps:{backdrop:{transitionDuration:H,as:_,...W}},disableEscapeKeyDown:F,onClose:w,open:y,onClick:B,...z,...R,children:t.jsx(pe,{...fe,children:t.jsx(de,{onMouseDown:O,...ue,children:t.jsx(V,{as:T,elevation:24,role:"dialog","aria-describedby":j,"aria-labelledby":i,"aria-modal":b,...c,children:t.jsx(Pe.Provider,{value:a,children:P})})})})})});function rt(e){return re("MuiDialogActions",e)}ae("MuiDialogActions",["root","spacing"]);const at=e=>{const{classes:n,disableSpacing:p}=e;return le({root:["root",!p&&"spacing"]},rt,n)},it=Y("div",{name:"MuiDialogActions",slot:"Root",overridesResolver:(e,n)=>{const{ownerState:p}=e;return[n.root,!p.disableSpacing&&n.spacing]}})({display:"flex",alignItems:"center",padding:8,justifyContent:"flex-end",flex:"0 0 auto",variants:[{props:({ownerState:e})=>!e.disableSpacing,style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),Te=r.forwardRef(function(n,p){const f=ie({props:n,name:"MuiDialogActions"}),{className:C,disableSpacing:v=!1,...j}=f,d={...f,disableSpacing:v},b=at(d);return t.jsx(it,{className:se(b.root,C),ownerState:d,ref:p,...j})});function lt(e){return re("MuiDialogContent",e)}ae("MuiDialogContent",["root","dividers"]);function ct(e){return re("MuiDialogTitle",e)}const dt=ae("MuiDialogTitle",["root"]),ut=e=>{const{classes:n,dividers:p}=e;return le({root:["root",p&&"dividers"]},lt,n)},pt=Y("div",{name:"MuiDialogContent",slot:"Root",overridesResolver:(e,n)=>{const{ownerState:p}=e;return[n.root,p.dividers&&n.dividers]}})(ce(({theme:e})=>({flex:"1 1 auto",WebkitOverflowScrolling:"touch",overflowY:"auto",padding:"20px 24px",variants:[{props:({ownerState:n})=>n.dividers,style:{padding:"16px 24px",borderTop:`1px solid ${(e.vars||e).palette.divider}`,borderBottom:`1px solid ${(e.vars||e).palette.divider}`}},{props:({ownerState:n})=>!n.dividers,style:{[`.${dt.root} + &`]:{paddingTop:0}}}]}))),_e=r.forwardRef(function(n,p){const f=ie({props:n,name:"MuiDialogContent"}),{className:C,dividers:v=!1,...j}=f,d={...f,dividers:v},b=ut(d);return t.jsx(pt,{className:se(b.root,C),ownerState:d,ref:p,...j})}),ft=e=>{const{classes:n}=e;return le({root:["root"]},ct,n)},mt=Y(Ue,{name:"MuiDialogTitle",slot:"Root"})({padding:"16px 24px",flex:"0 0 auto"}),Ae=r.forwardRef(function(n,p){const f=ie({props:n,name:"MuiDialogTitle"}),{className:C,id:v,...j}=f,d=f,b=ft(d),{titleId:_=v}=r.useContext(Pe);return t.jsx(mt,{component:"h2",className:se(b.root,C),ownerState:d,ref:p,variant:"h6",id:v??_,...j})});function gt(e={}){const{autoHideDuration:n=null,disableWindowBlurListener:p=!1,onClose:f,open:C,resumeHideDuration:v}=e,j=Le();r.useEffect(()=>{if(!C)return;function o(w){w.defaultPrevented||w.key==="Escape"&&f?.(w,"escapeKeyDown")}return document.addEventListener("keydown",o),()=>{document.removeEventListener("keydown",o)}},[C,f]);const d=xe((o,w)=>{f?.(o,w)}),b=xe(o=>{!f||o==null||j.start(o,()=>{d(null,"timeout")})});r.useEffect(()=>(C&&b(n),j.clear),[C,n,b,j]);const _=o=>{f?.(o,"clickaway")},g=j.clear,P=r.useCallback(()=>{n!=null&&b(v??n*.5)},[n,v,b]),A=o=>w=>{const y=o.onBlur;y?.(w),P()},F=o=>w=>{const y=o.onFocus;y?.(w),g()},$=o=>w=>{const y=o.onMouseEnter;y?.(w),g()},N=o=>w=>{const y=o.onMouseLeave;y?.(w),P()};return r.useEffect(()=>{if(!p&&C)return window.addEventListener("focus",P),window.addEventListener("blur",g),()=>{window.removeEventListener("focus",P),window.removeEventListener("blur",g)}},[p,C,P,g]),{getRootProps:(o={})=>{const w={...Ce(e),...Ce(o)};return{role:"presentation",...o,...w,onBlur:A(w),onFocus:F(w),onMouseEnter:$(w),onMouseLeave:N(w)}},onClickAway:_}}function ht(e){return re("MuiSnackbarContent",e)}ae("MuiSnackbarContent",["root","message","action"]);const bt=e=>{const{classes:n}=e;return le({root:["root"],action:["action"],message:["message"]},ht,n)},xt=Y(ve,{name:"MuiSnackbarContent",slot:"Root"})(ce(({theme:e})=>{const n=e.palette.mode==="light"?.8:.98;return{...e.typography.body2,color:e.vars?e.vars.palette.SnackbarContent.color:e.palette.getContrastText(we(e.palette.background.default,n)),backgroundColor:e.vars?e.vars.palette.SnackbarContent.bg:we(e.palette.background.default,n),display:"flex",alignItems:"center",flexWrap:"wrap",padding:"6px 16px",flexGrow:1,[e.breakpoints.up("sm")]:{flexGrow:"initial",minWidth:288}}})),yt=Y("div",{name:"MuiSnackbarContent",slot:"Message"})({padding:"8px 0"}),vt=Y("div",{name:"MuiSnackbarContent",slot:"Action"})({display:"flex",alignItems:"center",marginLeft:"auto",paddingLeft:16,marginRight:-8}),wt=r.forwardRef(function(n,p){const f=ie({props:n,name:"MuiSnackbarContent"}),{action:C,className:v,message:j,role:d="alert",...b}=f,_=f,g=bt(_);return t.jsxs(xt,{role:d,elevation:6,className:se(g.root,v),ownerState:_,ref:p,...b,children:[t.jsx(yt,{className:g.message,ownerState:_,children:j}),C?t.jsx(vt,{className:g.action,ownerState:_,children:C}):null]})});function Ct(e){return re("MuiSnackbar",e)}ae("MuiSnackbar",["root","anchorOriginTopCenter","anchorOriginBottomCenter","anchorOriginTopRight","anchorOriginBottomRight","anchorOriginTopLeft","anchorOriginBottomLeft"]);const kt=e=>{const{classes:n,anchorOrigin:p}=e,f={root:["root",`anchorOrigin${Q(p.vertical)}${Q(p.horizontal)}`]};return le(f,Ct,n)},St=Y("div",{name:"MuiSnackbar",slot:"Root",overridesResolver:(e,n)=>{const{ownerState:p}=e;return[n.root,n[`anchorOrigin${Q(p.anchorOrigin.vertical)}${Q(p.anchorOrigin.horizontal)}`]]}})(ce(({theme:e})=>({zIndex:(e.vars||e).zIndex.snackbar,position:"fixed",display:"flex",left:8,right:8,justifyContent:"center",alignItems:"center",variants:[{props:({ownerState:n})=>n.anchorOrigin.vertical==="top",style:{top:8,[e.breakpoints.up("sm")]:{top:24}}},{props:({ownerState:n})=>n.anchorOrigin.vertical!=="top",style:{bottom:8,[e.breakpoints.up("sm")]:{bottom:24}}},{props:({ownerState:n})=>n.anchorOrigin.horizontal==="left",style:{justifyContent:"flex-start",[e.breakpoints.up("sm")]:{left:24,right:"auto"}}},{props:({ownerState:n})=>n.anchorOrigin.horizontal==="right",style:{justifyContent:"flex-end",[e.breakpoints.up("sm")]:{right:24,left:"auto"}}},{props:({ownerState:n})=>n.anchorOrigin.horizontal==="center",style:{[e.breakpoints.up("sm")]:{left:"50%",right:"auto",transform:"translateX(-50%)"}}}]}))),jt=r.forwardRef(function(n,p){const f=ie({props:n,name:"MuiSnackbar"}),C=De(),v={enter:C.transitions.duration.enteringScreen,exit:C.transitions.duration.leavingScreen},{action:j,anchorOrigin:{vertical:d,horizontal:b}={vertical:"bottom",horizontal:"left"},autoHideDuration:_=null,children:g,className:P,ClickAwayListenerProps:A,ContentProps:F,disableWindowBlurListener:$=!1,message:N,onBlur:D,onClose:o,onFocus:w,onMouseEnter:y,onMouseLeave:T,open:m,resumeHideDuration:E,slots:S={},slotProps:M={},TransitionComponent:U,transitionDuration:H=v,TransitionProps:{onEnter:I,onExited:R,...x}={},...l}=f,h={...f,anchorOrigin:{vertical:d,horizontal:b},autoHideDuration:_,disableWindowBlurListener:$,TransitionComponent:U,transitionDuration:H},O=kt(h),{getRootProps:B,onClickAway:i}=gt(h),[a,u]=r.useState(!0),s=K=>{u(!0),R&&R(K)},k=(K,G)=>{u(!1),I&&I(K,G)},L={slots:{transition:U,...S},slotProps:{content:F,clickAwayListener:A,transition:x,...M}},[z,X]=Z("root",{ref:p,className:[O.root,P],elementType:St,getSlotProps:B,externalForwardedProps:{...L,...l},ownerState:h}),[W,{ownerState:V,...c}]=Z("clickAwayListener",{elementType:Qe,externalForwardedProps:L,getSlotProps:K=>({onClickAway:(...G)=>{const Re=G[0];K.onClickAway?.(...G),!Re?.defaultMuiPrevented&&i(...G)}}),ownerState:h}),[de,ue]=Z("content",{elementType:wt,shouldForwardComponentProp:!0,externalForwardedProps:L,additionalProps:{message:N,action:j},ownerState:h}),[pe,fe]=Z("transition",{elementType:qe,externalForwardedProps:L,getSlotProps:K=>({onEnter:(...G)=>{K.onEnter?.(...G),k(...G)},onExited:(...G)=>{K.onExited?.(...G),s(...G)}}),additionalProps:{appear:!0,in:m,timeout:H,direction:d==="top"?"down":"up"},ownerState:h});return!m&&a?null:t.jsx(W,{...c,...S.clickAwayListener&&{ownerState:V},children:t.jsx(z,{...X,children:t.jsx(pe,{...fe,children:g||t.jsx(de,{...ue})})})})});function Dt({items:e,selectedPaths:n,onSelectionChange:p,knownDirectories:f,capabilitiesImportEnabled:C,importDisabledReason:v,getRowActionState:j,onSetRowActionState:d,onClearRowActionState:b,onBeginRename:_,onBeginMove:g,onApplyRename:P,onApplyMove:A,onDeleteSingle:F,onOpenDirectory:$,onBeginDirectoryRename:N,onApplyDirectoryRename:D,onDeleteDirectory:o}){const[w,y]=r.useState(""),[T,m]=r.useState(""),E=r.useMemo(()=>e.filter(x=>!x.is_dir).map(x=>J(x.relative_path||x.name||"")).filter(Boolean),[e]),S=r.useMemo(()=>e.filter(x=>x.is_dir).map(x=>J(x.relative_path||x.name||"")).filter(Boolean),[e]);r.useEffect(()=>{T&&(S.includes(T)||m(""))},[T,S]);const M=x=>{p(E.filter(l=>x.has(l)))},U=(x,l)=>{if(!x)return;const h=new Set(n);if(l.shift){const O=E.indexOf(x),B=E.indexOf(w||x);if(O>=0&&B>=0){const[i,a]=B<=O?[B,O]:[O,B];h.clear();for(let u=i;u<=a;u+=1)h.add(E[u])}else h.clear(),h.add(x);y(x),M(h);return}h.has(x)?h.delete(x):h.add(x),y(x),M(h)};if(e.length===0)return t.jsx(He,{title:"空目录"});const H="pointer-events-none flex items-center justify-end gap-3 text-xs text-muted opacity-0 transition-opacity duration-150 group-hover:pointer-events-auto group-hover:opacity-100 group-focus-within:pointer-events-auto group-focus-within:opacity-100",I="whitespace-nowrap bg-transparent p-0 text-xs text-muted hover:text-accent focus-visible:outline-none focus-visible:text-accent disabled:cursor-not-allowed disabled:text-muted/60",R="text-border";return t.jsx("div",{className:"overflow-hidden rounded-md border border-border bg-surface",children:t.jsx("div",{role:"list","aria-label":"数据库文件列表",children:e.map(x=>{const l=J(x.relative_path||x.name||""),h=j(l),O=J(h.value||""),B=new URLSearchParams;B.set("pdf",l),B.set("page","1"),B.set("return_to",Ie(`${window.location.pathname}${window.location.search}`));const i=`/viewer.html?${B.toString()}`,a=h.phase==="pending",u=x.is_dir,s=!u&&n.has(l),k=u&&T===l,L=String(x.name||l||"-"),z=!!(l&&l!==L),X="w-[180px] md:w-[332px]",W=c=>{c.preventDefault(),c.stopPropagation()},V=c=>{c.preventDefault(),c.stopPropagation()};return t.jsxs("div",{role:u?"button":"listitem","aria-label":u?`目录 ${L}${k?"（已选）":""}`:`${L}${s?"（已选）":""}`,tabIndex:u?0:-1,className:`group grid grid-cols-[36px_28px_minmax(0,1fr)_180px] items-center gap-2 border-b border-border px-3 py-2 last:border-b-0 focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent md:grid-cols-[36px_28px_minmax(0,1fr)_332px] ${s||k?"bg-accent-soft":"hover:bg-surface-soft"}`,onClick:c=>{u&&(c.preventDefault(),m(l))},onKeyDown:c=>{if(u){c.key==="Enter"?(c.preventDefault(),$(l)):c.key===" "&&(c.preventDefault(),m(l));return}},children:[t.jsx("div",{className:"flex w-9 items-center justify-center",children:u?t.jsx("span",{className:"h-4 w-4"}):t.jsx("input",{type:"checkbox",checked:s,"aria-label":`${L}${s?"已选中":"未选中"}`,className:"h-4 w-4",style:{accentColor:"var(--color-accent)"},onClick:c=>{c.preventDefault(),W(c),h.mode==="normal"&&U(l,{shift:c.shiftKey})},onChange:()=>{}})}),t.jsx("div",{className:"flex w-7 items-center justify-center",children:t.jsx(ne,{name:u?"folder":"description",size:20,className:u?"text-accent":"text-muted"})}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsx("div",{className:"truncate text-sm font-medium text-text",children:L}),z?t.jsx("div",{className:"truncate font-mono text-xs text-muted",children:l}):null]}),t.jsx("div",{className:X,children:u?h.mode==="renaming"?t.jsxs("div",{className:"grid w-full gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ye,{name:`rename-dir-${l}`,value:h.value,onChange:c=>d(l,{...h,value:c.target.value,error:"",phase:"idle"}),onFocus:c=>{c.target.select()},onKeyDown:c=>{c.key==="Enter"?(V(c),D(l)):c.key==="Escape"&&(V(c),b(l))},className:"h-8",placeholder:"新目录名",disabled:a,autoFocus:!0}),t.jsx("button",{type:"button",className:I,onClick:c=>{W(c),D(l)},disabled:a,"aria-label":a?"正在改名":"确认改名",title:a?"正在改名":"确认改名",children:a?t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx(me,{size:12}),"处理中"]}):"确认"}),t.jsx("button",{type:"button",className:I,onClick:c=>{W(c),b(l)},disabled:a,"aria-label":"取消改名",title:"取消改名",children:"取消"})]}),h.error?t.jsx("div",{className:"text-xs text-danger",children:h.error}):null]}):t.jsxs("div",{className:H,children:[t.jsx("button",{type:"button",className:I,disabled:!l,onClick:c=>{W(c),l&&$(l)},children:"进入"}),t.jsx("span",{className:R,children:"|"}),t.jsx("button",{type:"button",className:I,disabled:!l||!C,title:C?void 0:v,onClick:c=>{W(c),N(l)},children:"改名"}),t.jsx("span",{className:R,children:"|"}),t.jsx("button",{type:"button",className:I,disabled:!l||!C,title:C?void 0:v,onClick:c=>{W(c),o(l)},children:"删除"})]}):h.mode==="renaming"?t.jsxs("div",{className:"grid w-full gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ye,{name:`rename-${l}`,value:h.value,onChange:c=>d(l,{...h,value:c.target.value,error:"",phase:"idle"}),onFocus:c=>{c.target.select()},onKeyDown:c=>{c.key==="Enter"?(V(c),P(l)):c.key==="Escape"&&(V(c),b(l))},className:"h-8",placeholder:"新文件名，如 b.pdf",disabled:a,autoFocus:!0}),t.jsx("button",{type:"button",className:I,onClick:c=>{W(c),P(l)},disabled:a,"aria-label":a?"正在改名":"确认改名",title:a?"正在改名":"确认改名",children:a?t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx(me,{size:12}),"处理中"]}):"确认"}),t.jsx("button",{type:"button",className:I,onClick:c=>{W(c),b(l)},disabled:a,"aria-label":"取消改名",title:"取消改名",children:"取消"})]}),h.error?t.jsx("div",{className:"text-xs text-danger",children:h.error}):null]}):h.mode==="moving"?t.jsxs("div",{className:"grid w-full gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ye,{name:`move-${l}`,value:O,className:"h-8",onChange:c=>d(l,{...h,value:J(c.target.value),error:"",phase:"idle"}),onKeyDown:c=>{c.key==="Enter"?(V(c),A(l)):c.key==="Escape"&&(V(c),b(l))},disabled:a,autoFocus:!0,children:f.map(c=>t.jsx("option",{value:c,children:c||"/"},c||"root"))}),t.jsx("button",{type:"button",className:I,onClick:c=>{W(c),A(l)},disabled:a,"aria-label":a?"正在移动":"确认移动",title:a?"正在移动":"确认移动",children:a?t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx(me,{size:12}),"处理中"]}):"确认"}),t.jsx("button",{type:"button",className:I,onClick:c=>{W(c),b(l)},disabled:a,"aria-label":"取消移动",title:"取消移动",children:"取消"})]}),h.error?t.jsx("div",{className:"text-xs text-danger",children:h.error}):null]}):t.jsxs("div",{className:H,children:[t.jsx("button",{type:"button",className:I,disabled:!l,onClick:c=>{W(c),l&&window.open(i,"_blank","noopener,noreferrer")},children:"预览"}),t.jsx("span",{className:R,children:"|"}),t.jsx("button",{type:"button",className:I,disabled:!l||!C,title:C?void 0:v,onClick:c=>{W(c),_(l)},children:"改名"}),t.jsx("span",{className:R,children:"|"}),t.jsx("button",{type:"button",className:I,disabled:!l||!C,title:C?void 0:v,onClick:c=>{W(c),g(l)},children:"移动"}),t.jsx("span",{className:R,children:"|"}),t.jsx("button",{type:"button",className:I,disabled:!l||!C,title:C?void 0:v,onClick:c=>{W(c),F(l)},children:"删除"})]})})]},l||x.name)})})})}function $t({currentPath:e,breadcrumbParts:n,directoryCount:p,status:f,selectedCount:C,fileCount:v,folderName:j,onFolderNameChange:d,capabilities:b,importDisabledReason:_,onNavigate:g,onUploadFiles:P,onDeleteSelected:A,onRefresh:F,onCreateFolder:$}){const N=r.useRef(null),[D,o]=r.useState(!1),w=!b.import_enabled||e!=="",y=b.import_enabled&&C>0,T=b.import_enabled?e?"仅支持在根目录创建子目录":"":_,m=!w&&!!j.trim(),E=S=>{S.preventDefault(),m&&($(),o(!1))};return t.jsxs("div",{className:"grid gap-3",children:[t.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-start lg:justify-between",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsxs(Ee,{className:"flex flex-wrap items-center gap-2 text-sm text-text",children:[t.jsxs("a",{href:"/db.html",onClick:S=>{S.preventDefault(),g("")},className:"inline-flex items-center gap-1 rounded-sm px-1 py-0.5 hover:bg-surface-soft focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent",children:[t.jsx(ne,{name:"folder",size:16}),"根目录"]}),n.map((S,M)=>{const U=n.slice(0,M+1).join("/");return t.jsxs(je.Fragment,{children:[t.jsx(ne,{name:"chevron_right",size:14,className:"text-muted"}),t.jsx("a",{href:$e(U),onClick:H=>{H.preventDefault(),g(U)},className:"inline-flex items-center rounded-sm px-1 py-0.5 hover:bg-surface-soft focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent",children:S})]},U)})]}),t.jsxs("div",{className:"mt-1 text-xs text-muted",children:["目录 ",p," · 文件 ",v,` · 已选 ${C}`]})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 lg:justify-end",children:[t.jsx(ee,{variant:"primary",className:"h-10 gap-1.5 px-4",disabled:!b.import_enabled,title:b.import_enabled?"上传 PDF":_,startIcon:t.jsx(ne,{name:"upload_file",size:16}),onClick:()=>N.current?.click(),children:"上传 PDF"}),t.jsx("input",{ref:N,type:"file",accept:".pdf,application/pdf",multiple:!0,className:"hidden",onChange:S=>{P(Array.from(S.target.files||[])),S.currentTarget.value=""}}),t.jsx(ee,{variant:"ghost",type:"button",className:"h-10 gap-1.5 px-4",disabled:w,title:T||"创建子目录",startIcon:t.jsx(ne,{name:"create_new_folder",size:16}),onClick:()=>o(!0),children:"创建子目录"}),t.jsxs(ee,{variant:"danger",className:"h-10 gap-1.5 px-4",disabled:!y,title:b.import_enabled?void 0:_,startIcon:t.jsx(ne,{name:"delete",size:16}),onClick:A,children:["删除所选",C>0?` (${C})`:""]}),t.jsx(ee,{variant:"ghost",className:"h-10 gap-1.5 px-4",startIcon:t.jsx(ne,{name:"refresh",size:16}),onClick:F,children:"刷新"})]})]}),f?t.jsx("div",{className:"rounded-md border border-border bg-surface-soft px-3 py-2 text-xs text-muted",children:f}):null,t.jsx(Ne,{open:D,onClose:()=>o(!1),fullWidth:!0,maxWidth:"xs","aria-labelledby":"db-create-folder-title",children:t.jsxs("form",{onSubmit:E,children:[t.jsx(Ae,{id:"db-create-folder-title",children:"新建子目录"}),t.jsxs(_e,{children:[t.jsx(ye,{id:"db-folder-name",name:"folder_name",value:j,onChange:S=>d(S.target.value),placeholder:"填写新建子目录名称",className:"mt-2 w-full",disabled:w,"aria-label":"新建子目录名称",autoFocus:!0}),T?t.jsx("p",{className:"mt-2 text-xs text-muted",children:T}):null]}),t.jsxs(Te,{sx:{px:3,pb:2.5},children:[t.jsx(ee,{variant:"ghost",type:"button",onClick:()=>o(!1),children:"取消"}),t.jsx(ee,{variant:"ghost",type:"submit",disabled:!m,children:"创建"})]})]})})]})}function oe(e){const n=J(e||"");return n&&n.split("/")[0]||""}function Pt({initialPath:e}){const[n,p]=r.useState(()=>oe(e||"")),[f,C]=r.useState(()=>new Map),[v,j]=r.useState(()=>new Set([""])),[d,b]=r.useState([]),[_,g]=r.useState([]),[P,A]=r.useState(()=>new Set),[F,$]=r.useState(""),N=r.useRef(f),D=r.useRef(0),o=r.useMemo(()=>{const R=new Set([""]),x=f.get("");for(const l of x?.directories||[])R.add(oe(l.path||""));return Array.from(R.values()).sort((l,h)=>l.localeCompare(h))},[f]),w=P.size,y=n?n.split("/"):[],T=r.useCallback(async(R,x=!1)=>{const l=oe(R||""),h=N.current.get(l);if(!x&&h)return h;const O=await q(`/api/docs/tree?path=${encodeURIComponent(l)}`),B={path:J(O.path||l),directories:Array.isArray(O.directories)?O.directories:[],files:Array.isArray(O.files)?O.files:[]};return C(i=>{const a=new Map(i);return a.set(B.path,B),B.path!==l&&a.set(l,B),N.current=a,a}),B},[]),m=r.useCallback(async(R,x=!1)=>{const l=oe(R||"");await T("",x),l&&await T(l,x)},[T]),E=r.useCallback(R=>{const x=new Set(R.map(l=>J(l.relative_path||l.name||"")));A(l=>{const h=new Set;for(const O of l)x.has(O)&&h.add(O);return h})},[]),S=r.useCallback(async(R,x)=>{const l=D.current+1;D.current=l;const h=!!x?.push,O=!!x?.force,B=oe(R||"");$("加载中...");try{await m(B,O);const i=await T(B,O);if(l!==D.current)return;const a=oe(i.path||B);p(a),b(a?[]:i.directories||[]),g(i.files||[]),E(i.files||[]),j(u=>{const s=new Set(u);return s.add(""),a&&s.add(a),s}),h&&history.pushState({},"",$e(a)),$("")}catch(i){if(l!==D.current)return;$(`加载失败：${String(i?.message||i)}`),b([]),g([])}},[T,m,E]),M=r.useCallback(async()=>{await S(n,{force:!0,push:!1})},[n,S]),U=r.useCallback(R=>{const x=new Set;for(const l of R){const h=J(l||"");h&&x.add(h)}A(x)},[]),H=r.useCallback(()=>{A(new Set)},[]),I=r.useCallback((R,x)=>{j(l=>{const h=new Set(l);return x?h.add(R):h.delete(R),h})},[]);return{currentPath:n,treeCache:f,expandedDirs:v,directories:d,files:_,selectedPaths:P,status:F,knownDirectories:o,selectedCount:w,breadcrumbParts:y,setStatus:$,setSelection:U,loadDirectory:S,refreshCurrentDirectory:M,ensureTreeNode:T,toggleExpandDir:I,clearSelection:H}}function Nt(e){return e==="success"?"success":e==="failed"?"failed":e==="running"?"running":"queued"}function Tt({onAllJobsSettled:e,pollIntervalMs:n=1500}={}){const[p,f]=r.useState([]),[C,v]=r.useState(()=>new Map),j=r.useRef(new Set),d=r.useRef(""),b=r.useRef(null),_=r.useRef(!1),g=r.useCallback((D,o)=>{const w=Nt(D.status),y=D,T=String(y.relative_path||y.filename||y.path||"-"),m=String(D.error||""),E=String(D.job_id||`${o}-${Date.now()}`);o==="import"&&T&&T!=="-"&&v(S=>{const M=new Map(S);return M.set(T,w),M}),f(S=>{const M=`${o}-${E}`,U=S.filter(H=>H.rowId!==M);return U.unshift({rowId:M,kind:o,status:w,pathText:T,error:m,updatedAt:Date.now()}),U.slice(0,80)})},[]),P=r.useCallback(()=>{b.current!==null&&(window.clearInterval(b.current),b.current=null)},[]),A=r.useCallback(async()=>{if(!_.current){_.current=!0;try{const D=[];for(const o of j.current.values())try{const w=await q(`/api/import/${encodeURIComponent(o)}`);g(w,"import"),["success","failed"].includes(String(w.status||""))&&D.push(o)}catch{D.push(o)}if(D.forEach(o=>j.current.delete(o)),d.current)try{const o=await q(`/api/scan/${encodeURIComponent(d.current)}`);g(o,"scan"),["success","failed"].includes(String(o.status||""))&&(d.current="")}catch{d.current=""}j.current.size===0&&!d.current&&(P(),e&&await e())}finally{_.current=!1}}},[e,P,g]),F=r.useCallback(()=>{b.current===null&&(b.current=window.setInterval(()=>{A()},n))},[n,A]),$=r.useCallback(D=>{const o=String(D||"").trim();o&&(j.current.add(o),F())},[F]),N=r.useCallback(D=>{const o=String(D||"").trim();o&&(d.current=o,F())},[F]);return r.useEffect(()=>()=>{P()},[P]),{jobs:p,jobStatusByPath:C,upsertJob:g,startImportJob:$,startScanJob:N,stopAllPolling:P}}function _t(){const e=Date.now();return{upload:{phase:"idle",message:"",updatedAt:e},batchDelete:{phase:"idle",message:"",updatedAt:e},rescan:{phase:"idle",message:"",updatedAt:e},createFolder:{phase:"idle",message:"",updatedAt:e}}}function te(e,n=""){return{mode:e,value:n,error:"",phase:"idle"}}function At({currentPath:e,visiblePaths:n,capabilities:p,importDisabledReason:f,scanDisabledReason:C,refreshCurrentDirectory:v,clearSelection:j,setStatus:d,upsertJob:b,startImportJob:_,startScanJob:g}){const[P,A]=r.useState({}),[F,$]=r.useState(()=>_t()),[N,D]=r.useState(null);r.useEffect(()=>{const i=new Set(n.map(a=>J(a||"")).filter(Boolean));A(a=>{const u={};for(const[s,k]of Object.entries(a))i.has(s)&&(u[s]=k);return u})},[n]);const o=r.useCallback((i,a,u,s)=>{$(k=>({...k,[i]:{phase:a,message:u,updatedAt:Date.now(),...s?{error:s}:{}}})),D(u?{phase:a,message:u}:null)},[]),w=r.useCallback(i=>P[i]||te("normal"),[P]),y=r.useCallback((i,a)=>{A(u=>({...u,[i]:a}))},[]),T=r.useCallback(i=>{A(a=>{const u={...a};return delete u[i],u})},[]),m=r.useCallback(i=>{const a=(i.results||[]).filter(u=>!u.ok);return a.length===0?"":a.slice(0,3).map(u=>{const s=String(u.path||"-");if(String(u.error_code||"").toUpperCase()==="CONFLICT"){const L=Array.isArray(u.details?.candidates)?u.details.candidates.slice(0,3).join(", "):"";return L?`${s}: 命名冲突，请使用完整相对路径，候选: ${L}`:`${s}: 命名冲突，请使用完整相对路径`}return`${s}: ${String(u.error||"unknown error")}`}).join(" | ")},[]),E=r.useCallback(async i=>{if(!p.import_enabled){const s=f||"导入服务不可用";o("batchDelete","error",`删除不可用：${s}`,s),d(`删除不可用：${s}`);return}const a=i.map(s=>J(s||"")).filter(Boolean);if(a.length===0)return;const u=`正在删除 ${a.length} 个文件...`;o("batchDelete","pending",u),d(u);try{const s=await q("/api/docs/batch-delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paths:a})}),k=m(s),L=k?`删除完成：成功 ${s.deleted}/${s.total}，失败 ${s.failed}（${k}）`:`删除完成：成功 ${s.deleted}/${s.total}，失败 ${s.failed}`,z=s.failed>0?"error":"success";o("batchDelete",z,L,s.failed>0?k||"partial failed":void 0),d(L),j(),await v()}catch(s){const k=String(s?.message||s);o("batchDelete","error",`删除失败：${k}`,k),d(`删除失败：${k}`)}},[p.import_enabled,j,m,f,v,d,o]),S=r.useCallback(async i=>{if(!p.import_enabled){const z=f||"导入服务不可用";o("upload","error",`上传不可用：${z}`,z),d(`上传不可用：${z}`);return}if(i.length===0){d("请选择 PDF 文件");return}const a=`准备上传 ${i.length} 个文件...`;o("upload","pending",a),d(a);let u=0,s=0;for(const z of i)try{const X=await fetch(`/api/import?filename=${encodeURIComponent(z.name)}&target_dir=${encodeURIComponent(e)}`,{method:"POST",headers:{Accept:"application/json","Content-Type":z.type||"application/pdf","X-File-Name":z.name,"X-Target-Dir":e},body:z}),W=await X.json().catch(()=>({}));if(!X.ok)throw new Error(String(W.message||`${X.status} ${X.statusText}`));u+=1,b(W,"import"),_(String(W.job_id||""))}catch(X){s+=1,b({job_id:`error-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,filename:z.name,status:"failed",error:String(X?.message||X)},"import")}const k=`上传提交完成：成功 ${u}/${i.length}，失败 ${s}`,L=s>0?"error":"success";o("upload",L,k,s>0?"partial failed":void 0),d(k)},[p.import_enabled,e,f,d,_,o,b]),M=r.useCallback(async(i,a)=>{if(!p.import_enabled){const s=f||"导入服务不可用";o("createFolder","error",`创建目录不可用：${s}`,s),d(`创建目录不可用：${s}`);return}const u=i.trim();if(!u){o("createFolder","error","创建失败：请输入目录名","missing folder name");return}if(J(e)!==""){const s="仅支持在根目录创建子目录";o("createFolder","error",s,"root-only"),d(s);return}o("createFolder","pending",`正在创建目录：${u}`);try{await q("/api/folders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e,name:u})}),a?.(),await v();const s=`创建目录成功：${J(e)||"/"} / ${u}`;o("createFolder","success",s),d(s)}catch(s){const k=String(s?.message||s);o("createFolder","error",`创建失败：${k}`,k),d(`创建失败：${k}`)}},[p.import_enabled,e,f,v,d,o]),U=r.useCallback(i=>{const a=J(i).split("/").pop()||i;y(i,te("renaming",a))},[y]),H=r.useCallback(async i=>{if(!p.import_enabled){const s=f||"导入服务不可用";y(i,{...te("renaming"),error:s,phase:"error"});return}const a=w(i),u=a.value.trim();if(!u){y(i,{...a,error:"请输入新目录名",phase:"error"});return}if(u.includes("/")||u==="."||u===".."){y(i,{...a,error:"目录名不合法",phase:"error"});return}y(i,{...a,error:"",phase:"pending"});try{const s=await q("/api/folders/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:i,new_name:u})});y(i,{...a,phase:"success"}),T(i),d(`目录改名成功：${s.old_path} -> ${s.new_path}`),await v()}catch(s){const k=String(s?.message||s);y(i,{...a,error:k,phase:"error"})}},[p.import_enabled,T,w,f,v,y,d]),I=r.useCallback(async i=>{if(!p.import_enabled){const s=f||"导入服务不可用";o("batchDelete","error",`删除不可用：${s}`,s),d(`删除不可用：${s}`);return}const a=i.map(s=>J(s||"")).filter(Boolean);if(a.length===0)return;const u=`正在删除 ${a.length} 个目录...`;o("batchDelete","pending",u),d(u);try{const s=await q("/api/folders/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paths:a,recursive:!0})}),k=m(s),L=k?`目录删除完成：成功 ${s.deleted}/${s.total}，失败 ${s.failed}（${k}）`:`目录删除完成：成功 ${s.deleted}/${s.total}，失败 ${s.failed}`,z=s.failed>0?"error":"success";o("batchDelete",z,L,s.failed>0?k||"partial failed":void 0),d(L),await v()}catch(s){const k=String(s?.message||s);o("batchDelete","error",`目录删除失败：${k}`,k),d(`目录删除失败：${k}`)}},[p.import_enabled,m,f,v,d,o]),R=r.useCallback(async()=>{if(!p.scan_enabled){const i=C||"重扫服务不可用";o("rescan","error",`重扫不可用：${i}`,i),d(`重扫不可用：${i}`);return}o("rescan","pending",`正在提交重扫任务：${J(e)||"/"}`);try{const i=await q(`/api/scan?path=${encodeURIComponent(e)}`,{method:"POST"}),a=String(i.job_id||"");if(!a)throw new Error("scan job id missing");b(i,"scan"),g(a);const u=`重扫任务已提交：${a}`;o("rescan","success",u),d(u)}catch(i){const a=String(i?.message||i);o("rescan","error",`触发重扫失败：${a}`,a),d(`触发重扫失败：${a}`)}},[p.scan_enabled,e,C,d,g,o,b]),x=r.useCallback(i=>{const a=i.split("/").pop()||i;y(i,te("renaming",a))},[y]),l=r.useCallback(i=>{y(i,te("moving",e))},[e,y]),h=r.useCallback(async i=>{if(!p.import_enabled){const s=f||"导入服务不可用";y(i,{...te("renaming"),error:s,phase:"error"});return}const a=w(i),u=a.value.trim();if(!u){y(i,{...a,error:"请输入新文件名",phase:"error"});return}y(i,{...a,error:"",phase:"pending"});try{const s=await q("/api/docs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:i,new_name:u})});y(i,{...a,phase:"success"}),T(i),d(`改名成功：${s.old_path} -> ${s.new_path}`),await v()}catch(s){const k=String(s?.message||s);y(i,{...a,error:k,phase:"error"})}},[p.import_enabled,T,w,f,v,y,d]),O=r.useCallback(async i=>{if(!p.import_enabled){const s=f||"导入服务不可用";y(i,{...te("moving"),error:s,phase:"error"});return}const a=w(i),u=J(a.value||"");y(i,{...a,error:"",phase:"pending"});try{const s=await q("/api/docs/move",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:i,target_dir:u})});y(i,{...a,phase:"success"}),T(i),d(`移动成功：${s.old_path} -> ${s.new_path}`),await v()}catch(s){const k=String(s?.message||s);y(i,{...a,error:k,phase:"error"})}},[p.import_enabled,T,w,f,v,y,d]),B=r.useMemo(()=>({getRowActionState:w,setRowActionState:y,clearRowActionState:T,beginRename:x,beginFolderRename:U,beginMove:l,applyRename:h,applyFolderRename:H,applyMove:O}),[H,O,h,U,l,x,T,w,y]);return{globalActionState:F,actionFeedback:N,rowActions:B,deleteSelected:E,deleteFolders:I,submitUploads:S,createFolder:M,triggerRescan:R}}function Rt(){const[e,n]=r.useState(""),[p,f]=r.useState(!1),[C,v]=r.useState(!1),[j,d]=r.useState([]),[b,_]=r.useState({import_enabled:!0,scan_enabled:!0,import_reason:"",scan_reason:""}),g=Pt({initialPath:ge(window.location.search)}),P=g.setStatus,A=b.import_enabled?"":String(b.import_reason||"导入服务不可用"),F=b.scan_enabled?"":String(b.scan_reason||"重扫服务不可用"),$=r.useCallback(async()=>{try{const m=await q("/api/capabilities");_({import_enabled:!!m.import_enabled,scan_enabled:!!m.scan_enabled,import_reason:String(m.import_reason||""),scan_reason:String(m.scan_reason||"")})}catch(m){const E=String(m?.message||m);P(`加载能力信息失败：${E}`)}},[P]),N=Tt({onAllJobsSettled:async()=>{await g.refreshCurrentDirectory()}}),D=r.useMemo(()=>{const m=g.directories.map(S=>({name:String(S.name||S.path||"").split("/").pop()||S.path||"-",relative_path:S.path,indexed:!0,is_dir:!0})),E=g.files.map(S=>({...S,is_dir:!1}));return[...m,...E]},[g.directories,g.files]),o=At({currentPath:g.currentPath,visiblePaths:D.map(m=>m.relative_path),capabilities:b,importDisabledReason:A,scanDisabledReason:F,refreshCurrentDirectory:g.refreshCurrentDirectory,clearSelection:g.clearSelection,setStatus:g.setStatus,upsertJob:N.upsertJob,startImportJob:N.startImportJob,startScanJob:N.startScanJob}),w=r.useCallback(m=>{const E=m.map(S=>({path:String(S.path||"").trim(),kind:S.kind})).filter(S=>!!S.path);E.length!==0&&(d(E),v(!0))},[]),y=r.useCallback(()=>{v(!1),d([])},[]),T=r.useCallback(async()=>{const m=[...j];if(y(),m.length===0)return;const E=m.filter(M=>M.kind==="file").map(M=>M.path),S=m.filter(M=>M.kind==="directory").map(M=>M.path);E.length>0&&await o.deleteSelected(E),S.length>0&&await o.deleteFolders(S)},[y,j,o]);return r.useEffect(()=>{o.actionFeedback?.message&&f(!0)},[o.actionFeedback]),r.useEffect(()=>{const m=()=>{g.loadDirectory(ge(window.location.search),{push:!1,force:!1})};return window.addEventListener("popstate",m),$(),g.loadDirectory(ge(window.location.search),{push:!1,force:!0}),()=>{window.removeEventListener("popstate",m),N.stopAllPolling()}},[]),t.jsxs(We,{actions:[{href:"/search.html",label:"搜索"}],hideHeaderTitle:!0,backHref:g.currentPath?"/db.html":"/",children:[t.jsx("div",{className:"grid gap-4",children:t.jsxs(ze,{className:"grid min-w-0 gap-4 p-4",children:[t.jsx($t,{currentPath:g.currentPath,breadcrumbParts:g.breadcrumbParts,directoryCount:g.directories.length,status:g.status,selectedCount:g.selectedCount,fileCount:g.files.length,folderName:e,onFolderNameChange:n,capabilities:b,importDisabledReason:A,onNavigate:m=>{g.loadDirectory(m,{push:!0,force:!1})},onUploadFiles:m=>{o.submitUploads(m)},onDeleteSelected:()=>w(Array.from(g.selectedPaths).map(m=>({path:m,kind:"file"}))),onRefresh:()=>{g.refreshCurrentDirectory()},onCreateFolder:()=>{o.createFolder(e,()=>{n("")})}}),t.jsx(Dt,{items:D,selectedPaths:g.selectedPaths,onSelectionChange:g.setSelection,knownDirectories:g.knownDirectories,capabilitiesImportEnabled:b.import_enabled,importDisabledReason:A,getRowActionState:o.rowActions.getRowActionState,onSetRowActionState:o.rowActions.setRowActionState,onClearRowActionState:o.rowActions.clearRowActionState,onBeginRename:o.rowActions.beginRename,onBeginMove:o.rowActions.beginMove,onApplyRename:m=>{o.rowActions.applyRename(m)},onBeginDirectoryRename:o.rowActions.beginFolderRename,onApplyDirectoryRename:m=>{o.rowActions.applyFolderRename(m)},onApplyMove:m=>{o.rowActions.applyMove(m)},onDeleteSingle:m=>w([{path:m,kind:"file"}]),onDeleteDirectory:m=>w([{path:m,kind:"directory"}]),onOpenDirectory:m=>{g.loadDirectory(m,{push:!0,force:!1})}})]})}),t.jsxs(Ne,{open:C,onClose:y,fullWidth:!0,maxWidth:"sm","aria-labelledby":"db-delete-dialog-title",children:[t.jsx(Ae,{id:"db-delete-dialog-title",children:"确认删除"}),t.jsx(_e,{children:t.jsxs("div",{className:"mt-1 text-sm text-text",children:["将删除 ",j.length," 个条目（目录会递归删除），对应数据库记录和磁盘文件都会被移除。"]})}),t.jsxs(Te,{sx:{px:3,pb:2.5},children:[t.jsx(ee,{variant:"ghost",onClick:y,children:"取消"}),t.jsx(ee,{variant:"danger",onClick:()=>{T()},children:"确认删除"})]})]}),t.jsx(jt,{open:p,autoHideDuration:2800,onClose:()=>f(!1),anchorOrigin:{vertical:"top",horizontal:"right"},children:t.jsx(Je,{onClose:()=>f(!1),severity:o.actionFeedback?.phase==="error"?"error":o.actionFeedback?.phase==="pending"?"info":"success",variant:"filled",children:o.actionFeedback?.message||"操作完成"})})]})}Fe.createRoot(document.getElementById("root")).render(t.jsx(je.StrictMode,{children:t.jsx(Oe,{children:t.jsx(Rt,{})})}));
