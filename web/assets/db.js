import{r,h as je,n as ne,o as Ae,p as se,g as ce,a as ie,u as le,j as n,b as $e,d as de,s as Q,P as _e,m as ue,q as re,t as Pe,k as V,e as Y,M as I,B as L,v as oe,w as pe,R as me,C as Ne,c as Ee,A as Re}from"./chunks/AppProviders.js";import{A as Te}from"./chunks/AppShell.js";import{E as De,n as F,d as fe,f as W,e as ee,A as Me}from"./chunks/urlState.js";import{g as Ie,o as te,G as Fe,I as he}from"./chunks/Input.js";import{S as ze}from"./chunks/Select.js";function ae(t){return t.substring(2).toLowerCase()}function Oe(t,c){return c.documentElement.clientWidth<t.clientX||c.documentElement.clientHeight<t.clientY}function Le(t){const{children:c,disableReactTree:b=!1,mouseEvent:p="onClick",onClickAway:f,touchEvent:C="onTouchEnd"}=t,d=r.useRef(!1),i=r.useRef(null),v=r.useRef(!1),k=r.useRef(!1);r.useEffect(()=>(setTimeout(()=>{v.current=!0},0),()=>{v.current=!1}),[]);const _=je(Ie(c),i),w=ne(l=>{const A=k.current;k.current=!1;const h=te(i.current);if(!v.current||!i.current||"clientX"in l&&Oe(l,h))return;if(d.current){d.current=!1;return}let s;l.composedPath?s=l.composedPath().includes(i.current):s=!h.documentElement.contains(l.target)||i.current.contains(l.target),!s&&(b||!A)&&f(l)}),m=l=>A=>{k.current=!0;const h=c.props[l];h&&h(A)},R={ref:_};return C!==!1&&(R[C]=m(C)),r.useEffect(()=>{if(C!==!1){const l=ae(C),A=te(i.current),h=()=>{d.current=!0};return A.addEventListener(l,w),A.addEventListener("touchmove",h),()=>{A.removeEventListener(l,w),A.removeEventListener("touchmove",h)}}},[w,C]),p!==!1&&(R[p]=m(p)),r.useEffect(()=>{if(p!==!1){const l=ae(p),A=te(i.current);return A.addEventListener(l,w),()=>{A.removeEventListener(l,w)}}},[w,p]),r.cloneElement(c,R)}function Be(t={}){const{autoHideDuration:c=null,disableWindowBlurListener:b=!1,onClose:p,open:f,resumeHideDuration:C}=t,d=Ae();r.useEffect(()=>{if(!f)return;function s(g){g.defaultPrevented||g.key==="Escape"&&p?.(g,"escapeKeyDown")}return document.addEventListener("keydown",s),()=>{document.removeEventListener("keydown",s)}},[f,p]);const i=ne((s,g)=>{p?.(s,g)}),v=ne(s=>{!p||s==null||d.start(s,()=>{i(null,"timeout")})});r.useEffect(()=>(f&&v(c),d.clear),[f,c,v,d]);const k=s=>{p?.(s,"clickaway")},_=d.clear,w=r.useCallback(()=>{c!=null&&v(C??c*.5)},[c,C,v]),m=s=>g=>{const x=s.onBlur;x?.(g),w()},R=s=>g=>{const x=s.onFocus;x?.(g),_()},l=s=>g=>{const x=s.onMouseEnter;x?.(g),_()},A=s=>g=>{const x=s.onMouseLeave;x?.(g),w()};return r.useEffect(()=>{if(!b&&f)return window.addEventListener("focus",w),window.addEventListener("blur",_),()=>{window.removeEventListener("focus",w),window.removeEventListener("blur",_)}},[b,f,w,_]),{getRootProps:(s={})=>{const g={...se(t),...se(s)};return{role:"presentation",...s,...g,onBlur:m(g),onFocus:R(g),onMouseEnter:l(g),onMouseLeave:A(g)}},onClickAway:k}}function Ue(t){return ce("MuiSnackbarContent",t)}ie("MuiSnackbarContent",["root","message","action"]);const He=t=>{const{classes:c}=t;return de({root:["root"],action:["action"],message:["message"]},Ue,c)},Je=Q(_e,{name:"MuiSnackbarContent",slot:"Root"})(ue(({theme:t})=>{const c=t.palette.mode==="light"?.8:.98;return{...t.typography.body2,color:t.vars?t.vars.palette.SnackbarContent.color:t.palette.getContrastText(re(t.palette.background.default,c)),backgroundColor:t.vars?t.vars.palette.SnackbarContent.bg:re(t.palette.background.default,c),display:"flex",alignItems:"center",flexWrap:"wrap",padding:"6px 16px",flexGrow:1,[t.breakpoints.up("sm")]:{flexGrow:"initial",minWidth:288}}})),Ge=Q("div",{name:"MuiSnackbarContent",slot:"Message"})({padding:"8px 0"}),We=Q("div",{name:"MuiSnackbarContent",slot:"Action"})({display:"flex",alignItems:"center",marginLeft:"auto",paddingLeft:16,marginRight:-8}),Xe=r.forwardRef(function(c,b){const p=le({props:c,name:"MuiSnackbarContent"}),{action:f,className:C,message:d,role:i="alert",...v}=p,k=p,_=He(k);return n.jsxs(Je,{role:i,elevation:6,className:$e(_.root,C),ownerState:k,ref:b,...v,children:[n.jsx(Ge,{className:_.message,ownerState:k,children:d}),f?n.jsx(We,{className:_.action,ownerState:k,children:f}):null]})});function qe(t){return ce("MuiSnackbar",t)}ie("MuiSnackbar",["root","anchorOriginTopCenter","anchorOriginBottomCenter","anchorOriginTopRight","anchorOriginBottomRight","anchorOriginTopLeft","anchorOriginBottomLeft"]);const Ke=t=>{const{classes:c,anchorOrigin:b}=t,p={root:["root",`anchorOrigin${Y(b.vertical)}${Y(b.horizontal)}`]};return de(p,qe,c)},Ve=Q("div",{name:"MuiSnackbar",slot:"Root",overridesResolver:(t,c)=>{const{ownerState:b}=t;return[c.root,c[`anchorOrigin${Y(b.anchorOrigin.vertical)}${Y(b.anchorOrigin.horizontal)}`]]}})(ue(({theme:t})=>({zIndex:(t.vars||t).zIndex.snackbar,position:"fixed",display:"flex",left:8,right:8,justifyContent:"center",alignItems:"center",variants:[{props:({ownerState:c})=>c.anchorOrigin.vertical==="top",style:{top:8,[t.breakpoints.up("sm")]:{top:24}}},{props:({ownerState:c})=>c.anchorOrigin.vertical!=="top",style:{bottom:8,[t.breakpoints.up("sm")]:{bottom:24}}},{props:({ownerState:c})=>c.anchorOrigin.horizontal==="left",style:{justifyContent:"flex-start",[t.breakpoints.up("sm")]:{left:24,right:"auto"}}},{props:({ownerState:c})=>c.anchorOrigin.horizontal==="right",style:{justifyContent:"flex-end",[t.breakpoints.up("sm")]:{right:24,left:"auto"}}},{props:({ownerState:c})=>c.anchorOrigin.horizontal==="center",style:{[t.breakpoints.up("sm")]:{left:"50%",right:"auto",transform:"translateX(-50%)"}}}]}))),Ye=r.forwardRef(function(c,b){const p=le({props:c,name:"MuiSnackbar"}),f=Pe(),C={enter:f.transitions.duration.enteringScreen,exit:f.transitions.duration.leavingScreen},{action:d,anchorOrigin:{vertical:i,horizontal:v}={vertical:"bottom",horizontal:"left"},autoHideDuration:k=null,children:_,className:w,ClickAwayListenerProps:m,ContentProps:R,disableWindowBlurListener:l=!1,message:A,onBlur:h,onClose:s,onFocus:g,onMouseEnter:x,onMouseLeave:$,open:y,resumeHideDuration:J,slots:E={},slotProps:O={},TransitionComponent:B,transitionDuration:T=C,TransitionProps:{onEnter:z,onExited:G,...j}={},...N}=p,e={...p,anchorOrigin:{vertical:i,horizontal:v},autoHideDuration:k,disableWindowBlurListener:l,TransitionComponent:B,transitionDuration:T},o=Ke(e),{getRootProps:u,onClickAway:a}=Be(e),[P,D]=r.useState(!0),S=X=>{D(!0),G&&G(X)},M=(X,H)=>{D(!1),z&&z(X,H)},U={slots:{transition:B,...E},slotProps:{content:R,clickAwayListener:m,transition:j,...O}},[Z,ge]=V("root",{ref:b,className:[o.root,w],elementType:Ve,getSlotProps:u,externalForwardedProps:{...U,...N},ownerState:e}),[xe,{ownerState:be,...ve}]=V("clickAwayListener",{elementType:Le,externalForwardedProps:U,getSlotProps:X=>({onClickAway:(...H)=>{const ke=H[0];X.onClickAway?.(...H),!ke?.defaultMuiPrevented&&a(...H)}}),ownerState:e}),[we,ye]=V("content",{elementType:Xe,shouldForwardComponentProp:!0,externalForwardedProps:U,additionalProps:{message:A,action:d},ownerState:e}),[Ce,Se]=V("transition",{elementType:Fe,externalForwardedProps:U,getSlotProps:X=>({onEnter:(...H)=>{X.onEnter?.(...H),M(...H)},onExited:(...H)=>{X.onExited?.(...H),S(...H)}}),additionalProps:{appear:!0,in:y,timeout:T,direction:i==="top"?"down":"up"},ownerState:e});return!y&&P?null:n.jsx(xe,{...ve,...E.clickAwayListener&&{ownerState:be},children:n.jsx(Z,{...ge,children:n.jsx(Ce,{...Se,children:_||n.jsx(we,{...ye})})})})});function Qe({items:t,selectedPaths:c,selectAllChecked:b,knownDirectories:p,capabilitiesImportEnabled:f,importDisabledReason:C,getRowActionState:d,onSetRowActionState:i,onClearRowActionState:v,onToggleSelect:k,onToggleSelectAll:_,onBeginRename:w,onBeginMove:m,onApplyRename:R,onApplyMove:l,onDeleteSingle:A,onOpenDirectory:h}){const[s,g]=r.useState(""),x=r.useMemo(()=>t.some($=>!$.is_dir),[t]);return t.length===0?n.jsx(De,{title:"空目录"}):n.jsxs("div",{className:"overflow-hidden rounded-md border border-border bg-surface",children:[n.jsxs("div",{className:"flex items-center justify-between border-b border-border bg-surface-soft px-3 py-2 text-xs text-muted",children:[n.jsxs("label",{className:"inline-flex select-none items-center gap-2",children:[n.jsx("input",{type:"checkbox","aria-label":"全选文件",checked:x?b:!1,disabled:!x,onChange:$=>_($.target.checked)}),"全选文件"]}),n.jsx("span",{children:"双击文件夹进入"})]}),n.jsx("div",{children:t.map($=>{const y=F($.relative_path||$.name||""),J=c.has(y),E=d(y),O=F(E.value||""),B=`/viewer.html?pdf=${encodeURIComponent(y)}&page=1`,T=E.phase==="pending",z=$.is_dir,G=z&&s===y;return n.jsxs("div",{className:`group flex items-center gap-2 border-b border-border px-3 py-2 last:border-b-0 ${z?"cursor-pointer":""} ${G?"bg-accent-soft":"hover:bg-surface-soft"}`,onClick:()=>{z&&g(y)},onDoubleClick:()=>{z&&h(y)},children:[n.jsx("div",{className:"flex w-7 items-center justify-center",children:z?n.jsx(I,{name:"folder",size:20,className:"text-accent"}):n.jsx("input",{type:"checkbox",checked:J,disabled:!y,onChange:()=>k(y)})}),n.jsxs("div",{className:"min-w-0 flex-1",children:[n.jsx("div",{className:"truncate text-sm font-medium text-text",children:$.name||y||"-"}),n.jsx("div",{className:"truncate font-mono text-xs text-muted",children:y||"-"})]}),n.jsx("div",{className:"min-w-[320px]",children:z?n.jsx("div",{className:"flex justify-end",children:n.jsx(L,{variant:"ghost",className:"h-8 gap-1.5 px-2",onClick:()=>h(y),children:"进入"})}):E.mode==="renaming"?n.jsxs("div",{className:"grid gap-1",children:[n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(he,{value:E.value,onChange:j=>i(y,{...E,value:j.target.value,error:"",phase:"idle"}),className:"h-8",placeholder:"新文件名，如 b.pdf",disabled:T}),n.jsx(L,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:()=>R(y),disabled:T,startIcon:T?n.jsx(oe,{size:14}):n.jsx(I,{name:"check",size:16})}),n.jsx(L,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:()=>v(y),disabled:T,startIcon:n.jsx(I,{name:"close",size:16})})]}),E.error?n.jsx("div",{className:"text-xs text-danger",children:E.error}):null]}):E.mode==="moving"?n.jsxs("div",{className:"grid gap-1",children:[n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(ze,{value:O,className:"h-8",onChange:j=>i(y,{...E,value:F(j.target.value),error:"",phase:"idle"}),disabled:T,children:p.map(j=>n.jsx("option",{value:j,children:j||"/"},j||"root"))}),n.jsx(L,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:()=>l(y),disabled:T,startIcon:T?n.jsx(oe,{size:14}):n.jsx(I,{name:"check",size:16})}),n.jsx(L,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:()=>v(y),disabled:T,startIcon:n.jsx(I,{name:"close",size:16})})]}),E.error?n.jsx("div",{className:"text-xs text-danger",children:E.error}):null]}):n.jsxs(pe,{display:"flex",justifyContent:"flex-end",alignItems:"center",gap:.5,className:"opacity-100 transition-opacity md:opacity-0 md:group-hover:opacity-100 md:group-focus-within:opacity-100",children:[n.jsx("a",{href:B,target:"_blank",rel:"noreferrer",children:n.jsx(L,{variant:"ghost",className:"h-8 gap-1.5 px-2",disabled:!y,startIcon:n.jsx(I,{name:"open_in_new",size:16}),children:"预览"})}),n.jsx(L,{variant:"ghost",className:"h-8 gap-1.5 px-2",disabled:!y||!f,title:f?void 0:C,startIcon:n.jsx(I,{name:"edit",size:16}),onClick:()=>w(y),children:"改名"}),n.jsx(L,{variant:"ghost",className:"h-8 gap-1.5 px-2",disabled:!y||!f,title:f?void 0:C,startIcon:n.jsx(I,{name:"drive_file_move",size:16}),onClick:()=>m(y),children:"移动"}),n.jsx(L,{variant:"ghost",className:"h-8 gap-1.5 px-2 text-danger",disabled:!y||!f,title:f?void 0:C,startIcon:n.jsx(I,{name:"delete",size:16}),onClick:()=>{window.confirm(`确认删除 ${y}？此操作不可撤销。`)&&A(y)},children:"删除"})]})})]},y||$.name)})})]})}function Ze({currentPath:t,breadcrumbParts:c,status:b,selectedCount:p,fileCount:f,folderName:C,onFolderNameChange:d,capabilities:i,importDisabledReason:v,onNavigate:k,onUploadFiles:_,onDeleteSelected:w,onRefresh:m,onCreateFolder:R}){const l=r.useRef(null),A=!i.import_enabled||t!=="",h=s=>{s.preventDefault(),R()};return n.jsxs("div",{className:"grid gap-3",children:[n.jsxs(pe,{className:"flex flex-wrap items-center gap-2 text-sm text-text",children:[n.jsxs("a",{href:"/db",onClick:s=>{s.preventDefault(),k("")},className:"inline-flex items-center gap-1 rounded-sm px-1 py-0.5 hover:bg-surface-soft",children:[n.jsx(I,{name:"folder",size:16}),"根目录"]}),c.map((s,g)=>{const x=c.slice(0,g+1).join("/");return n.jsxs(me.Fragment,{children:[n.jsx(I,{name:"chevron_right",size:14,className:"text-muted"}),n.jsx("a",{href:fe(x),onClick:$=>{$.preventDefault(),k(x)},className:"inline-flex items-center rounded-sm px-1 py-0.5 hover:bg-surface-soft",children:s})]},x)}),n.jsxs("span",{className:"ml-2 text-xs text-muted",children:["文件 ",f," · 已选 ",p]})]}),n.jsx("div",{className:"rounded-md border border-border bg-surface-soft px-3 py-2 text-xs text-muted",children:b||`目录 ${t||"/"} · 文件 ${f}`}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[n.jsx(L,{variant:"primary",className:"h-9 gap-1.5 px-3",disabled:!i.import_enabled,title:i.import_enabled?"上传 PDF":v,startIcon:n.jsx(I,{name:"upload_file",size:16}),onClick:()=>l.current?.click(),children:"上传 PDF"}),n.jsx("input",{ref:l,type:"file",accept:".pdf,application/pdf",multiple:!0,className:"hidden",onChange:s=>{_(Array.from(s.target.files||[])),s.currentTarget.value=""}}),n.jsxs("form",{className:"flex flex-wrap items-center gap-2",onSubmit:h,children:[n.jsx(he,{value:C,onChange:s=>d(s.target.value),placeholder:t?"仅根目录可创建子目录":"新建子目录名称",className:"h-9 w-[220px]",disabled:A}),n.jsx(L,{variant:"ghost",type:"submit",className:"h-9 gap-1.5 px-3",disabled:A||!C.trim(),title:i.import_enabled?t?"仅支持在根目录创建子目录":void 0:v,startIcon:n.jsx(I,{name:"create_new_folder",size:16}),children:"创建子目录"})]}),n.jsxs(L,{variant:"danger",className:"h-9 gap-1.5 px-3",disabled:!i.import_enabled||p===0,title:i.import_enabled?void 0:v,startIcon:n.jsx(I,{name:"delete",size:16}),onClick:()=>{window.confirm(`确认删除已选的 ${p} 个文件？此操作不可撤销。`)&&w()},children:["删除所选",p>0?` (${p})`:""]}),n.jsx(L,{variant:"ghost",className:"h-9 gap-1.5 px-3",startIcon:n.jsx(I,{name:"refresh",size:16}),onClick:m,children:"刷新"})]})]})}function q(t){const c=F(t||"");return c&&c.split("/")[0]||""}function et({initialPath:t}){const[c,b]=r.useState(()=>q(t||"")),[p,f]=r.useState(()=>new Map),[C,d]=r.useState(()=>new Set([""])),[i,v]=r.useState([]),[k,_]=r.useState([]),[w,m]=r.useState(()=>new Set),[R,l]=r.useState("加载中..."),A=r.useRef(p),h=r.useMemo(()=>k.length===0?!1:k.every(j=>w.has(F(j.relative_path||j.name||""))),[k,w]),s=r.useMemo(()=>{const j=new Set([""]),N=p.get("");for(const e of N?.directories||[])j.add(q(e.path||""));return Array.from(j.values()).sort((e,o)=>e.localeCompare(o))},[p]),g=w.size,x=c?c.split("/"):[],$=r.useCallback(async(j,N=!1)=>{const e=q(j||""),o=A.current.get(e);if(!N&&o)return o;const u=await W(`/api/docs/tree?path=${encodeURIComponent(e)}`),a={path:F(u.path||e),directories:Array.isArray(u.directories)?u.directories:[],files:Array.isArray(u.files)?u.files:[]};return f(P=>{const D=new Map(P);return D.set(a.path,a),a.path!==e&&D.set(e,a),A.current=D,D}),a},[]),y=r.useCallback(async(j,N=!1)=>{const e=q(j||"");await $("",N),e&&await $(e,N)},[$]),J=r.useCallback(j=>{const N=new Set(j.map(e=>F(e.relative_path||e.name||"")));m(e=>{const o=new Set;for(const u of e)N.has(u)&&o.add(u);return o})},[]),E=r.useCallback(async(j,N)=>{const e=!!N?.push,o=!!N?.force,u=q(j||"");l("加载中...");try{await y(u,o);const a=await $(u,o),P=q(a.path||u);b(P),v(P?[]:a.directories||[]),_(a.files||[]),J(a.files||[]),d(D=>{const S=new Set(D);return S.add(""),P&&S.add(P),S}),e&&history.pushState({},"",fe(P)),l(`目录 ${P||"/"} · 文件 ${(a.files||[]).length}`)}catch(a){l(`加载失败：${String(a?.message||a)}`),v([]),_([])}},[$,y,J]),O=r.useCallback(async()=>{await E(c,{force:!0,push:!1})},[c,E]),B=r.useCallback(j=>{const N=F(j||"");N&&m(e=>{const o=new Set(e);return o.has(N)?o.delete(N):o.add(N),o})},[]),T=r.useCallback(j=>{if(!j){m(new Set);return}const N=new Set;k.forEach(e=>{const o=F(e.relative_path||e.name||"");o&&N.add(o)}),m(N)},[k]),z=r.useCallback(()=>{m(new Set)},[]),G=r.useCallback((j,N)=>{d(e=>{const o=new Set(e);return N?o.add(j):o.delete(j),o})},[]);return{currentPath:c,treeCache:p,expandedDirs:C,directories:i,files:k,selectedPaths:w,status:R,selectAllChecked:h,knownDirectories:s,selectedCount:g,breadcrumbParts:x,setStatus:l,loadDirectory:E,refreshCurrentDirectory:O,ensureTreeNode:$,toggleExpandDir:G,toggleSelect:B,toggleSelectAll:T,clearSelection:z}}function tt(t){return t==="success"?"success":t==="failed"?"failed":t==="running"?"running":"queued"}function nt({onAllJobsSettled:t,pollIntervalMs:c=1500}={}){const[b,p]=r.useState([]),[f,C]=r.useState(()=>new Map),d=r.useRef(new Set),i=r.useRef(""),v=r.useRef(null),k=r.useRef(!1),_=r.useCallback((h,s)=>{const g=tt(h.status),x=h,$=String(x.relative_path||x.filename||x.path||"-"),y=String(h.error||""),J=String(h.job_id||`${s}-${Date.now()}`);s==="import"&&$&&$!=="-"&&C(E=>{const O=new Map(E);return O.set($,g),O}),p(E=>{const O=`${s}-${J}`,B=E.filter(T=>T.rowId!==O);return B.unshift({rowId:O,kind:s,status:g,pathText:$,error:y,updatedAt:Date.now()}),B.slice(0,80)})},[]),w=r.useCallback(()=>{v.current!==null&&(window.clearInterval(v.current),v.current=null)},[]),m=r.useCallback(async()=>{if(!k.current){k.current=!0;try{const h=[];for(const s of d.current.values())try{const g=await W(`/api/import/${encodeURIComponent(s)}`);_(g,"import"),["success","failed"].includes(String(g.status||""))&&h.push(s)}catch{h.push(s)}if(h.forEach(s=>d.current.delete(s)),i.current)try{const s=await W(`/api/scan/${encodeURIComponent(i.current)}`);_(s,"scan"),["success","failed"].includes(String(s.status||""))&&(i.current="")}catch{i.current=""}d.current.size===0&&!i.current&&(w(),t&&await t())}finally{k.current=!1}}},[t,w,_]),R=r.useCallback(()=>{v.current===null&&(v.current=window.setInterval(()=>{m()},c))},[c,m]),l=r.useCallback(h=>{const s=String(h||"").trim();s&&(d.current.add(s),R())},[R]),A=r.useCallback(h=>{const s=String(h||"").trim();s&&(i.current=s,R())},[R]);return r.useEffect(()=>()=>{w()},[w]),{jobs:b,jobStatusByPath:f,upsertJob:_,startImportJob:l,startScanJob:A,stopAllPolling:w}}function st(){const t=Date.now();return{upload:{phase:"idle",message:"",updatedAt:t},batchDelete:{phase:"idle",message:"",updatedAt:t},rescan:{phase:"idle",message:"",updatedAt:t},createFolder:{phase:"idle",message:"",updatedAt:t}}}function K(t,c=""){return{mode:t,value:c,error:"",phase:"idle"}}function rt({currentPath:t,visibleFiles:c,capabilities:b,importDisabledReason:p,scanDisabledReason:f,refreshCurrentDirectory:C,clearSelection:d,setStatus:i,upsertJob:v,startImportJob:k,startScanJob:_}){const[w,m]=r.useState({}),[R,l]=r.useState(()=>st()),[A,h]=r.useState(null);r.useEffect(()=>{const e=new Set(c.map(o=>F(o.relative_path||o.name||"")));m(o=>{const u={};for(const[a,P]of Object.entries(o))e.has(a)&&(u[a]=P);return u})},[c]);const s=r.useCallback((e,o,u,a)=>{l(P=>({...P,[e]:{phase:o,message:u,updatedAt:Date.now(),...a?{error:a}:{}}})),h(u?{phase:o,message:u}:null)},[]),g=r.useCallback(e=>w[e]||K("normal"),[w]),x=r.useCallback((e,o)=>{m(u=>({...u,[e]:o}))},[]),$=r.useCallback(e=>{m(o=>{const u={...o};return delete u[e],u})},[]),y=r.useCallback(e=>{const o=(e.results||[]).filter(u=>!u.ok);return o.length===0?"":o.slice(0,3).map(u=>{const a=String(u.path||"-");if(String(u.error_code||"").toUpperCase()==="CONFLICT"){const D=Array.isArray(u.details?.candidates)?u.details.candidates.slice(0,3).join(", "):"";return D?`${a}: 命名冲突，请使用完整相对路径，候选: ${D}`:`${a}: 命名冲突，请使用完整相对路径`}return`${a}: ${String(u.error||"unknown error")}`}).join(" | ")},[]),J=r.useCallback(async e=>{if(!b.import_enabled){const S=p||"导入服务不可用";s("batchDelete","error",`删除不可用：${S}`,S),i(`删除不可用：${S}`);return}const o=e.map(S=>F(S||"")).filter(Boolean);if(o.length===0)return;const u=o.slice(0,5).join(`
`),a=o.length>5?`
...`:"";if(!window.confirm(`确认删除 ${o.length} 个文件？
将删除数据库记录和磁盘文件。

示例路径：
${u}${a}`))return;const D=`正在删除 ${o.length} 个文件...`;s("batchDelete","pending",D),i(D);try{const S=await W("/api/docs/batch-delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paths:o})}),M=y(S),U=M?`删除完成：成功 ${S.deleted}/${S.total}，失败 ${S.failed}（${M}）`:`删除完成：成功 ${S.deleted}/${S.total}，失败 ${S.failed}`,Z=S.failed>0?"error":"success";s("batchDelete",Z,U,S.failed>0?M||"partial failed":void 0),i(U),d(),await C()}catch(S){const M=String(S?.message||S);s("batchDelete","error",`删除失败：${M}`,M),i(`删除失败：${M}`)}},[b.import_enabled,d,y,p,C,i,s]),E=r.useCallback(async e=>{if(!b.import_enabled){const S=p||"导入服务不可用";s("upload","error",`上传不可用：${S}`,S),i(`上传不可用：${S}`);return}if(e.length===0){i("请选择 PDF 文件");return}const o=`准备上传 ${e.length} 个文件...`;s("upload","pending",o),i(o);let u=0,a=0;for(const S of e)try{const M=await fetch(`/api/import?filename=${encodeURIComponent(S.name)}&target_dir=${encodeURIComponent(t)}`,{method:"POST",headers:{Accept:"application/json","Content-Type":S.type||"application/pdf","X-File-Name":S.name,"X-Target-Dir":t},body:S}),U=await M.json().catch(()=>({}));if(!M.ok)throw new Error(String(U.message||`${M.status} ${M.statusText}`));u+=1,v(U,"import"),k(String(U.job_id||""))}catch(M){a+=1,v({job_id:`error-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,filename:S.name,status:"failed",error:String(M?.message||M)},"import")}const P=`上传提交完成：成功 ${u}/${e.length}，失败 ${a}`,D=a>0?"error":"success";s("upload",D,P,a>0?"partial failed":void 0),i(P)},[b.import_enabled,t,p,i,k,s,v]),O=r.useCallback(async(e,o)=>{if(!b.import_enabled){const a=p||"导入服务不可用";s("createFolder","error",`创建目录不可用：${a}`,a),i(`创建目录不可用：${a}`);return}const u=e.trim();if(!u){s("createFolder","error","创建失败：请输入目录名","missing folder name");return}if(F(t)!==""){const a="仅支持在根目录创建子目录";s("createFolder","error",a,"root-only"),i(a);return}s("createFolder","pending",`正在创建目录：${u}`);try{await W("/api/folders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:t,name:u})}),o?.(),await C();const a=`创建目录成功：${F(t)||"/"} / ${u}`;s("createFolder","success",a),i(a)}catch(a){const P=String(a?.message||a);s("createFolder","error",`创建失败：${P}`,P),i(`创建失败：${P}`)}},[b.import_enabled,t,p,C,i,s]),B=r.useCallback(async()=>{if(!b.scan_enabled){const e=f||"重扫服务不可用";s("rescan","error",`重扫不可用：${e}`,e),i(`重扫不可用：${e}`);return}s("rescan","pending",`正在提交重扫任务：${F(t)||"/"}`);try{const e=await W(`/api/scan?path=${encodeURIComponent(t)}`,{method:"POST"}),o=String(e.job_id||"");if(!o)throw new Error("scan job id missing");v(e,"scan"),_(o);const u=`重扫任务已提交：${o}`;s("rescan","success",u),i(u)}catch(e){const o=String(e?.message||e);s("rescan","error",`触发重扫失败：${o}`,o),i(`触发重扫失败：${o}`)}},[b.scan_enabled,t,f,i,_,s,v]),T=r.useCallback(e=>{const o=e.split("/").pop()||e;x(e,K("renaming",o))},[x]),z=r.useCallback(e=>{x(e,K("moving",t))},[t,x]),G=r.useCallback(async e=>{if(!b.import_enabled){const a=p||"导入服务不可用";x(e,{...K("renaming"),error:a,phase:"error"});return}const o=g(e),u=o.value.trim();if(!u){x(e,{...o,error:"请输入新文件名",phase:"error"});return}x(e,{...o,error:"",phase:"pending"});try{const a=await W("/api/docs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e,new_name:u})});x(e,{...o,phase:"success"}),$(e),i(`改名成功：${a.old_path} -> ${a.new_path}`),await C()}catch(a){const P=String(a?.message||a);x(e,{...o,error:P,phase:"error"})}},[b.import_enabled,$,g,p,C,x,i]),j=r.useCallback(async e=>{if(!b.import_enabled){const a=p||"导入服务不可用";x(e,{...K("moving"),error:a,phase:"error"});return}const o=g(e),u=F(o.value||"");x(e,{...o,error:"",phase:"pending"});try{const a=await W("/api/docs/move",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e,target_dir:u})});x(e,{...o,phase:"success"}),$(e),i(`移动成功：${a.old_path} -> ${a.new_path}`),await C()}catch(a){const P=String(a?.message||a);x(e,{...o,error:P,phase:"error"})}},[b.import_enabled,$,g,p,C,x,i]),N=r.useMemo(()=>({getRowActionState:g,setRowActionState:x,clearRowActionState:$,beginRename:T,beginMove:z,applyRename:G,applyMove:j}),[j,G,z,T,$,g,x]);return{globalActionState:R,actionFeedback:A,rowActions:N,deleteSelected:J,submitUploads:E,createFolder:O,triggerRescan:B}}function ot(){const[t,c]=r.useState(""),[b,p]=r.useState(!1),[f,C]=r.useState({import_enabled:!0,scan_enabled:!0,import_reason:"",scan_reason:""}),d=et({initialPath:ee(window.location.search)}),i=d.setStatus,v=f.import_enabled?"":String(f.import_reason||"导入服务不可用"),k=f.scan_enabled?"":String(f.scan_reason||"重扫服务不可用"),_=r.useCallback(async()=>{try{const l=await W("/api/capabilities");C({import_enabled:!!l.import_enabled,scan_enabled:!!l.scan_enabled,import_reason:String(l.import_reason||""),scan_reason:String(l.scan_reason||"")})}catch(l){const A=String(l?.message||l);i(`加载能力信息失败：${A}`)}},[i]),w=nt({onAllJobsSettled:async()=>{await d.refreshCurrentDirectory()}}),m=rt({currentPath:d.currentPath,visibleFiles:d.files,capabilities:f,importDisabledReason:v,scanDisabledReason:k,refreshCurrentDirectory:d.refreshCurrentDirectory,clearSelection:d.clearSelection,setStatus:d.setStatus,upsertJob:w.upsertJob,startImportJob:w.startImportJob,startScanJob:w.startScanJob}),R=r.useMemo(()=>{const l=d.directories.map(h=>({name:String(h.name||h.path||"").split("/").pop()||h.path||"-",relative_path:h.path,indexed:!0,is_dir:!0})),A=d.files.map(h=>({...h,is_dir:!1}));return[...l,...A]},[d.directories,d.files]);return r.useEffect(()=>{m.actionFeedback?.message&&p(!0)},[m.actionFeedback]),r.useEffect(()=>{const l=()=>{d.loadDirectory(ee(window.location.search),{push:!1,force:!1})};return window.addEventListener("popstate",l),_(),d.loadDirectory(ee(window.location.search),{push:!1,force:!0}),()=>{window.removeEventListener("popstate",l),w.stopAllPolling()}},[]),n.jsxs(Te,{actions:[{href:"/search",label:"搜索",icon:n.jsx(I,{name:"search",size:18})}],hideHeaderTitle:!0,children:[n.jsx("div",{className:"grid gap-4",children:n.jsxs(Ne,{className:"grid min-w-0 gap-4 p-4",children:[n.jsx(Ze,{currentPath:d.currentPath,breadcrumbParts:d.breadcrumbParts,status:d.status,selectedCount:d.selectedCount,fileCount:d.files.length,folderName:t,onFolderNameChange:c,capabilities:f,importDisabledReason:v,onNavigate:l=>{d.loadDirectory(l,{push:!0,force:!1})},onUploadFiles:l=>{m.submitUploads(l)},onDeleteSelected:()=>{m.deleteSelected(Array.from(d.selectedPaths))},onRefresh:()=>{d.refreshCurrentDirectory()},onCreateFolder:()=>{m.createFolder(t,()=>{c("")})}}),n.jsx(Qe,{items:R,selectedPaths:d.selectedPaths,selectAllChecked:d.selectAllChecked,knownDirectories:d.knownDirectories,capabilitiesImportEnabled:f.import_enabled,importDisabledReason:v,getRowActionState:m.rowActions.getRowActionState,onSetRowActionState:m.rowActions.setRowActionState,onClearRowActionState:m.rowActions.clearRowActionState,onToggleSelect:d.toggleSelect,onToggleSelectAll:d.toggleSelectAll,onBeginRename:m.rowActions.beginRename,onBeginMove:m.rowActions.beginMove,onApplyRename:l=>{m.rowActions.applyRename(l)},onApplyMove:l=>{m.rowActions.applyMove(l)},onDeleteSingle:l=>{m.deleteSelected([l])},onOpenDirectory:l=>{d.loadDirectory(l,{push:!0,force:!1})}})]})}),n.jsx(Ye,{open:b,autoHideDuration:2800,onClose:()=>p(!1),anchorOrigin:{vertical:"top",horizontal:"right"},children:n.jsx(Me,{onClose:()=>p(!1),severity:m.actionFeedback?.phase==="error"?"error":m.actionFeedback?.phase==="pending"?"info":"success",variant:"filled",children:m.actionFeedback?.message||"操作完成"})})]})}Ee.createRoot(document.getElementById("root")).render(n.jsx(me.StrictMode,{children:n.jsx(Re,{children:n.jsx(ot,{})})}));
