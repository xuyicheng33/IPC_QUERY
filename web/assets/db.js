import{r,g as oe,a as se,u as re,e as Ee,b as ne,j as t,d as V,f as we,M as J,B as je,R as $e,c as Fe,A as Ie}from"./chunks/AppProviders.js";import{u as Oe,k as be,l as De,P as ye,e as Q,f as ae,g as Y,m as ie,n as Be,o as ke,q as K,i as ze,j as H,C as fe,r as Pe,t as he}from"./chunks/urlState.js";import{D as Le,C as We}from"./chunks/Card.js";import{T as Ue,E as He,f as q,A as Je}from"./chunks/api.js";import{g as Ke,o as ge,F as Ce,M as Xe,B as Ge,G as qe,I as ve,S as Ye}from"./chunks/Select.js";function Se(e){return e.substring(2).toLowerCase()}function Ve(e,n){return n.documentElement.clientWidth<e.clientX||n.documentElement.clientHeight<e.clientY}function Qe(e){const{children:n,disableReactTree:d=!1,mouseEvent:u="onClick",onClickAway:v,touchEvent:x="onTouchEnd"}=e,k=r.useRef(!1),l=r.useRef(null),g=r.useRef(!1),E=r.useRef(!1);r.useEffect(()=>(setTimeout(()=>{g.current=!0},0),()=>{g.current=!1}),[]);const h=Oe(Ke(n),l),_=be(N=>{const R=E.current;E.current=!1;const $=ge(l.current);if(!g.current||!l.current||"clientX"in N&&Ve(N,$))return;if(k.current){k.current=!1;return}let o;N.composedPath?o=N.composedPath().includes(l.current):o=!$.documentElement.contains(N.target)||l.current.contains(N.target),!o&&(d||!R)&&v(N)}),B=N=>R=>{E.current=!0;const $=n.props[N];$&&$(R)},L={ref:h};return x!==!1&&(L[x]=B(x)),r.useEffect(()=>{if(x!==!1){const N=Se(x),R=ge(l.current),$=()=>{k.current=!0};return R.addEventListener(N,_),R.addEventListener("touchmove",$),()=>{R.removeEventListener(N,_),R.removeEventListener("touchmove",$)}}},[_,x]),u!==!1&&(L[u]=B(u)),r.useEffect(()=>{if(u!==!1){const N=Se(u),R=ge(l.current);return R.addEventListener(N,_),()=>{R.removeEventListener(N,_)}}},[_,u]),r.cloneElement(n,L)}function Ze(e){return oe("MuiDialog",e)}const xe=se("MuiDialog",["root","backdrop","scrollPaper","scrollBody","container","paper","paperScrollPaper","paperScrollBody","paperWidthFalse","paperWidthXs","paperWidthSm","paperWidthMd","paperWidthLg","paperWidthXl","paperFullWidth","paperFullScreen"]),Ne=r.createContext({}),et=Y(Ge,{name:"MuiDialog",slot:"Backdrop"})({zIndex:-1}),tt=e=>{const{classes:n,scroll:d,maxWidth:u,fullWidth:v,fullScreen:x}=e,k={root:["root"],backdrop:["backdrop"],container:["container",`scroll${V(d)}`],paper:["paper",`paperScroll${V(d)}`,`paperWidth${V(String(u))}`,v&&"paperFullWidth",x&&"paperFullScreen"]};return ae(k,Ze,n)},nt=Y(Xe,{name:"MuiDialog",slot:"Root"})({"@media print":{position:"absolute !important"}}),ot=Y("div",{name:"MuiDialog",slot:"Container",overridesResolver:(e,n)=>{const{ownerState:d}=e;return[n.container,n[`scroll${V(d.scroll)}`]]}})({height:"100%","@media print":{height:"auto"},outline:0,variants:[{props:{scroll:"paper"},style:{display:"flex",justifyContent:"center",alignItems:"center"}},{props:{scroll:"body"},style:{overflowY:"auto",overflowX:"hidden",textAlign:"center","&::after":{content:'""',display:"inline-block",verticalAlign:"middle",height:"100%",width:"0"}}}]}),st=Y(ye,{name:"MuiDialog",slot:"Paper",overridesResolver:(e,n)=>{const{ownerState:d}=e;return[n.paper,n[`scrollPaper${V(d.scroll)}`],n[`paperWidth${V(String(d.maxWidth))}`],d.fullWidth&&n.paperFullWidth,d.fullScreen&&n.paperFullScreen]}})(ie(({theme:e})=>({margin:32,position:"relative",overflowY:"auto","@media print":{overflowY:"visible",boxShadow:"none"},variants:[{props:{scroll:"paper"},style:{display:"flex",flexDirection:"column",maxHeight:"calc(100% - 64px)"}},{props:{scroll:"body"},style:{display:"inline-block",verticalAlign:"middle",textAlign:"initial"}},{props:({ownerState:n})=>!n.maxWidth,style:{maxWidth:"calc(100% - 64px)"}},{props:{maxWidth:"xs"},style:{maxWidth:e.breakpoints.unit==="px"?Math.max(e.breakpoints.values.xs,444):`max(${e.breakpoints.values.xs}${e.breakpoints.unit}, 444px)`,[`&.${xe.paperScrollBody}`]:{[e.breakpoints.down(Math.max(e.breakpoints.values.xs,444)+64)]:{maxWidth:"calc(100% - 64px)"}}}},...Object.keys(e.breakpoints.values).filter(n=>n!=="xs").map(n=>({props:{maxWidth:n},style:{maxWidth:`${e.breakpoints.values[n]}${e.breakpoints.unit}`,[`&.${xe.paperScrollBody}`]:{[e.breakpoints.down(e.breakpoints.values[n]+64)]:{maxWidth:"calc(100% - 64px)"}}}})),{props:({ownerState:n})=>n.fullWidth,style:{width:"calc(100% - 64px)"}},{props:({ownerState:n})=>n.fullScreen,style:{margin:0,width:"100%",maxWidth:"100%",height:"100%",maxHeight:"none",borderRadius:0,[`&.${xe.paperScrollBody}`]:{margin:0,maxWidth:"100%"}}}]}))),Te=r.forwardRef(function(n,d){const u=re({props:n,name:"MuiDialog"}),v=De(),x={enter:v.transitions.duration.enteringScreen,exit:v.transitions.duration.leavingScreen},{"aria-describedby":k,"aria-labelledby":l,"aria-modal":g=!0,BackdropComponent:E,BackdropProps:h,children:_,className:B,disableEscapeKeyDown:L=!1,fullScreen:N=!1,fullWidth:R=!1,maxWidth:$="sm",onClick:o,onClose:y,open:b,PaperComponent:T=ye,PaperProps:W={},scroll:p="paper",slots:P={},slotProps:F={},TransitionComponent:z=Ce,transitionDuration:j=x,TransitionProps:f,...w}=u,A={...u,disableEscapeKeyDown:L,fullScreen:N,fullWidth:R,maxWidth:$,scroll:p},C=tt(A),M=r.useRef(),D=X=>{M.current=X.target===X.currentTarget},O=X=>{o&&o(X),M.current&&(M.current=null,y&&y(X,"backdropClick"))},a=Ee(l),c=r.useMemo(()=>({titleId:a}),[a]),m={transition:z,...P},s={transition:f,paper:W,backdrop:h,...F},S={slots:m,slotProps:s},[I,U]=Q("root",{elementType:nt,shouldForwardComponentProp:!0,externalForwardedProps:S,ownerState:A,className:ne(C.root,B),ref:d}),[i,Z]=Q("backdrop",{elementType:et,shouldForwardComponentProp:!0,externalForwardedProps:S,ownerState:A,className:C.backdrop}),[le,ce]=Q("paper",{elementType:st,shouldForwardComponentProp:!0,externalForwardedProps:S,ownerState:A,className:ne(C.paper,W.className)}),[de,ue]=Q("container",{elementType:ot,externalForwardedProps:S,ownerState:A,className:C.container}),[pe,me]=Q("transition",{elementType:Ce,externalForwardedProps:S,ownerState:A,additionalProps:{appear:!0,in:b,timeout:j,role:"presentation"}});return t.jsx(I,{closeAfterTransition:!0,slots:{backdrop:i},slotProps:{backdrop:{transitionDuration:j,as:E,...Z}},disableEscapeKeyDown:L,onClose:y,open:b,onClick:O,...U,...w,children:t.jsx(pe,{...me,children:t.jsx(de,{onMouseDown:D,...ue,children:t.jsx(le,{as:T,elevation:24,role:"dialog","aria-describedby":k,"aria-labelledby":a,"aria-modal":g,...ce,children:t.jsx(Ne.Provider,{value:c,children:_})})})})})});function rt(e){return oe("MuiDialogActions",e)}se("MuiDialogActions",["root","spacing"]);const at=e=>{const{classes:n,disableSpacing:d}=e;return ae({root:["root",!d&&"spacing"]},rt,n)},it=Y("div",{name:"MuiDialogActions",slot:"Root",overridesResolver:(e,n)=>{const{ownerState:d}=e;return[n.root,!d.disableSpacing&&n.spacing]}})({display:"flex",alignItems:"center",padding:8,justifyContent:"flex-end",flex:"0 0 auto",variants:[{props:({ownerState:e})=>!e.disableSpacing,style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),_e=r.forwardRef(function(n,d){const u=re({props:n,name:"MuiDialogActions"}),{className:v,disableSpacing:x=!1,...k}=u,l={...u,disableSpacing:x},g=at(l);return t.jsx(it,{className:ne(g.root,v),ownerState:l,ref:d,...k})});function lt(e){return oe("MuiDialogContent",e)}se("MuiDialogContent",["root","dividers"]);function ct(e){return oe("MuiDialogTitle",e)}const dt=se("MuiDialogTitle",["root"]),ut=e=>{const{classes:n,dividers:d}=e;return ae({root:["root",d&&"dividers"]},lt,n)},pt=Y("div",{name:"MuiDialogContent",slot:"Root",overridesResolver:(e,n)=>{const{ownerState:d}=e;return[n.root,d.dividers&&n.dividers]}})(ie(({theme:e})=>({flex:"1 1 auto",WebkitOverflowScrolling:"touch",overflowY:"auto",padding:"20px 24px",variants:[{props:({ownerState:n})=>n.dividers,style:{padding:"16px 24px",borderTop:`1px solid ${(e.vars||e).palette.divider}`,borderBottom:`1px solid ${(e.vars||e).palette.divider}`}},{props:({ownerState:n})=>!n.dividers,style:{[`.${dt.root} + &`]:{paddingTop:0}}}]}))),Ae=r.forwardRef(function(n,d){const u=re({props:n,name:"MuiDialogContent"}),{className:v,dividers:x=!1,...k}=u,l={...u,dividers:x},g=ut(l);return t.jsx(pt,{className:ne(g.root,v),ownerState:l,ref:d,...k})}),mt=e=>{const{classes:n}=e;return ae({root:["root"]},ct,n)},ft=Y(Ue,{name:"MuiDialogTitle",slot:"Root"})({padding:"16px 24px",flex:"0 0 auto"}),Re=r.forwardRef(function(n,d){const u=re({props:n,name:"MuiDialogTitle"}),{className:v,id:x,...k}=u,l=u,g=mt(l),{titleId:E=x}=r.useContext(Ne);return t.jsx(ft,{component:"h2",className:ne(g.root,v),ownerState:l,ref:d,variant:"h6",id:x??E,...k})});function ht(e={}){const{autoHideDuration:n=null,disableWindowBlurListener:d=!1,onClose:u,open:v,resumeHideDuration:x}=e,k=Be();r.useEffect(()=>{if(!v)return;function o(y){y.defaultPrevented||y.key==="Escape"&&u?.(y,"escapeKeyDown")}return document.addEventListener("keydown",o),()=>{document.removeEventListener("keydown",o)}},[v,u]);const l=be((o,y)=>{u?.(o,y)}),g=be(o=>{!u||o==null||k.start(o,()=>{l(null,"timeout")})});r.useEffect(()=>(v&&g(n),k.clear),[v,n,g,k]);const E=o=>{u?.(o,"clickaway")},h=k.clear,_=r.useCallback(()=>{n!=null&&g(x??n*.5)},[n,x,g]),B=o=>y=>{const b=o.onBlur;b?.(y),_()},L=o=>y=>{const b=o.onFocus;b?.(y),h()},N=o=>y=>{const b=o.onMouseEnter;b?.(y),h()},R=o=>y=>{const b=o.onMouseLeave;b?.(y),_()};return r.useEffect(()=>{if(!d&&v)return window.addEventListener("focus",_),window.addEventListener("blur",h),()=>{window.removeEventListener("focus",_),window.removeEventListener("blur",h)}},[d,v,_,h]),{getRootProps:(o={})=>{const y={...ke(e),...ke(o)};return{role:"presentation",...o,...y,onBlur:B(y),onFocus:L(y),onMouseEnter:N(y),onMouseLeave:R(y)}},onClickAway:E}}function gt(e){return oe("MuiSnackbarContent",e)}se("MuiSnackbarContent",["root","message","action"]);const xt=e=>{const{classes:n}=e;return ae({root:["root"],action:["action"],message:["message"]},gt,n)},bt=Y(ye,{name:"MuiSnackbarContent",slot:"Root"})(ie(({theme:e})=>{const n=e.palette.mode==="light"?.8:.98;return{...e.typography.body2,color:e.vars?e.vars.palette.SnackbarContent.color:e.palette.getContrastText(we(e.palette.background.default,n)),backgroundColor:e.vars?e.vars.palette.SnackbarContent.bg:we(e.palette.background.default,n),display:"flex",alignItems:"center",flexWrap:"wrap",padding:"6px 16px",flexGrow:1,[e.breakpoints.up("sm")]:{flexGrow:"initial",minWidth:288}}})),vt=Y("div",{name:"MuiSnackbarContent",slot:"Message"})({padding:"8px 0"}),yt=Y("div",{name:"MuiSnackbarContent",slot:"Action"})({display:"flex",alignItems:"center",marginLeft:"auto",paddingLeft:16,marginRight:-8}),wt=r.forwardRef(function(n,d){const u=re({props:n,name:"MuiSnackbarContent"}),{action:v,className:x,message:k,role:l="alert",...g}=u,E=u,h=xt(E);return t.jsxs(bt,{role:l,elevation:6,className:ne(h.root,x),ownerState:E,ref:d,...g,children:[t.jsx(vt,{className:h.message,ownerState:E,children:k}),v?t.jsx(yt,{className:h.action,ownerState:E,children:v}):null]})});function kt(e){return oe("MuiSnackbar",e)}se("MuiSnackbar",["root","anchorOriginTopCenter","anchorOriginBottomCenter","anchorOriginTopRight","anchorOriginBottomRight","anchorOriginTopLeft","anchorOriginBottomLeft"]);const Ct=e=>{const{classes:n,anchorOrigin:d}=e,u={root:["root",`anchorOrigin${V(d.vertical)}${V(d.horizontal)}`]};return ae(u,kt,n)},St=Y("div",{name:"MuiSnackbar",slot:"Root",overridesResolver:(e,n)=>{const{ownerState:d}=e;return[n.root,n[`anchorOrigin${V(d.anchorOrigin.vertical)}${V(d.anchorOrigin.horizontal)}`]]}})(ie(({theme:e})=>({zIndex:(e.vars||e).zIndex.snackbar,position:"fixed",display:"flex",left:8,right:8,justifyContent:"center",alignItems:"center",variants:[{props:({ownerState:n})=>n.anchorOrigin.vertical==="top",style:{top:8,[e.breakpoints.up("sm")]:{top:24}}},{props:({ownerState:n})=>n.anchorOrigin.vertical!=="top",style:{bottom:8,[e.breakpoints.up("sm")]:{bottom:24}}},{props:({ownerState:n})=>n.anchorOrigin.horizontal==="left",style:{justifyContent:"flex-start",[e.breakpoints.up("sm")]:{left:24,right:"auto"}}},{props:({ownerState:n})=>n.anchorOrigin.horizontal==="right",style:{justifyContent:"flex-end",[e.breakpoints.up("sm")]:{right:24,left:"auto"}}},{props:({ownerState:n})=>n.anchorOrigin.horizontal==="center",style:{[e.breakpoints.up("sm")]:{left:"50%",right:"auto",transform:"translateX(-50%)"}}}]}))),jt=r.forwardRef(function(n,d){const u=re({props:n,name:"MuiSnackbar"}),v=De(),x={enter:v.transitions.duration.enteringScreen,exit:v.transitions.duration.leavingScreen},{action:k,anchorOrigin:{vertical:l,horizontal:g}={vertical:"bottom",horizontal:"left"},autoHideDuration:E=null,children:h,className:_,ClickAwayListenerProps:B,ContentProps:L,disableWindowBlurListener:N=!1,message:R,onBlur:$,onClose:o,onFocus:y,onMouseEnter:b,onMouseLeave:T,open:W,resumeHideDuration:p,slots:P={},slotProps:F={},TransitionComponent:z,transitionDuration:j=x,TransitionProps:{onEnter:f,onExited:w,...A}={},...C}=u,M={...u,anchorOrigin:{vertical:l,horizontal:g},autoHideDuration:E,disableWindowBlurListener:N,TransitionComponent:z,transitionDuration:j},D=Ct(M),{getRootProps:O,onClickAway:a}=ht(M),[c,m]=r.useState(!0),s=X=>{m(!0),w&&w(X)},S=(X,G)=>{m(!1),f&&f(X,G)},I={slots:{transition:z,...P},slotProps:{content:L,clickAwayListener:B,transition:A,...F}},[U,i]=Q("root",{ref:d,className:[D.root,_],elementType:St,getSlotProps:O,externalForwardedProps:{...I,...C},ownerState:M}),[Z,{ownerState:le,...ce}]=Q("clickAwayListener",{elementType:Qe,externalForwardedProps:I,getSlotProps:X=>({onClickAway:(...G)=>{const Me=G[0];X.onClickAway?.(...G),!Me?.defaultMuiPrevented&&a(...G)}}),ownerState:M}),[de,ue]=Q("content",{elementType:wt,shouldForwardComponentProp:!0,externalForwardedProps:I,additionalProps:{message:R,action:k},ownerState:M}),[pe,me]=Q("transition",{elementType:qe,externalForwardedProps:I,getSlotProps:X=>({onEnter:(...G)=>{X.onEnter?.(...G),S(...G)},onExited:(...G)=>{X.onExited?.(...G),s(...G)}}),additionalProps:{appear:!0,in:W,timeout:j,direction:l==="top"?"down":"up"},ownerState:M});return!W&&c?null:t.jsx(Z,{...ce,...P.clickAwayListener&&{ownerState:le},children:t.jsx(U,{...i,children:t.jsx(pe,{...me,children:h||t.jsx(de,{...ue})})})})});function $t({items:e,selectedPaths:n,onSelectionChange:d,knownDirectories:u,capabilitiesImportEnabled:v,importDisabledReason:x,getRowActionState:k,onSetRowActionState:l,onClearRowActionState:g,onBeginRename:E,onBeginMove:h,onApplyRename:_,onApplyMove:B,onDeleteSingle:L,onOpenDirectory:N,onBeginDirectoryRename:R,onApplyDirectoryRename:$,onDeleteDirectory:o}){const[y,b]=r.useState(""),[T,W]=r.useState(""),p=r.useMemo(()=>e.filter(j=>!j.is_dir).map(j=>K(j.relative_path||j.name||"")).filter(Boolean),[e]),P=r.useMemo(()=>e.filter(j=>j.is_dir).map(j=>K(j.relative_path||j.name||"")).filter(Boolean),[e]);r.useEffect(()=>{T&&(P.includes(T)||W(""))},[T,P]);const F=j=>{d(p.filter(f=>j.has(f)))},z=(j,f)=>{if(!j)return;const w=new Set(n);if(f.shift){const A=p.indexOf(j),C=p.indexOf(y||j);if(A>=0&&C>=0){const[M,D]=C<=A?[C,A]:[A,C];w.clear();for(let O=M;O<=D;O+=1)w.add(p[O])}else w.clear(),w.add(j);b(j),F(w);return}w.has(j)?w.delete(j):w.add(j),b(j),F(w)};return e.length===0?t.jsx(He,{title:"空目录"}):t.jsx("div",{className:"overflow-hidden rounded-md border border-border bg-surface",children:t.jsx("div",{role:"list","aria-label":"数据库文件列表",children:e.map(j=>{const f=K(j.relative_path||j.name||""),w=k(f),A=K(w.value||""),C=new URLSearchParams;C.set("pdf",f),C.set("page","1"),C.set("return_to",ze(`${window.location.pathname}${window.location.search}`));const M=`/viewer.html?${C.toString()}`,D=w.phase==="pending",O=j.is_dir,a=!O&&n.has(f),c=O&&T===f,m=String(j.name||f||"-"),s=!!(f&&f!==m),S="w-[180px] md:w-[332px]",I=i=>{i.preventDefault(),i.stopPropagation()},U=i=>{i.preventDefault(),i.stopPropagation()};return t.jsxs("div",{role:O?"button":"listitem","aria-label":O?`目录 ${m}${c?"（已选）":""}`:`${m}${a?"（已选）":""}`,tabIndex:O?0:-1,className:`group grid grid-cols-[36px_28px_minmax(0,1fr)_180px] items-center gap-2 border-b border-border px-3 py-2 last:border-b-0 focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent md:grid-cols-[36px_28px_minmax(0,1fr)_332px] ${a||c?"bg-accent-soft":"hover:bg-surface-soft"}`,onClick:i=>{O&&(i.preventDefault(),W(f))},onKeyDown:i=>{if(O){i.key==="Enter"?(i.preventDefault(),N(f)):i.key===" "&&(i.preventDefault(),W(f));return}},children:[t.jsx("div",{className:"flex w-9 items-center justify-center",children:O?t.jsx("span",{className:"h-4 w-4"}):t.jsx("input",{type:"checkbox",checked:a,"aria-label":`${m}${a?"已选中":"未选中"}`,className:"h-4 w-4",style:{accentColor:"var(--color-accent)"},onClick:i=>{i.preventDefault(),I(i),w.mode==="normal"&&z(f,{shift:i.shiftKey})},onChange:()=>{}})}),t.jsx("div",{className:"flex w-7 items-center justify-center",children:t.jsx(J,{name:O?"folder":"description",size:20,className:O?"text-accent":"text-muted"})}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsx("div",{className:"truncate text-sm font-medium text-text",children:m}),s?t.jsx("div",{className:"truncate font-mono text-xs text-muted",children:f}):null]}),t.jsx("div",{className:S,children:O?w.mode==="renaming"?t.jsxs("div",{className:"grid w-full gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ve,{name:`rename-dir-${f}`,value:w.value,onChange:i=>l(f,{...w,value:i.target.value,error:"",phase:"idle"}),onFocus:i=>{i.target.select()},onKeyDown:i=>{i.key==="Enter"?(U(i),$(f)):i.key==="Escape"&&(U(i),g(f))},className:"h-8",placeholder:"新目录名",disabled:D,autoFocus:!0}),t.jsx(H,{variant:"ghost",className:"h-8 min-w-8 px-2 text-xs",onClick:i=>{I(i),$(f)},disabled:D,"aria-label":D?"正在改名":"确认改名",title:D?"正在改名":"确认改名",startIcon:D?t.jsx(fe,{size:14}):t.jsx(J,{name:"check",size:16})}),t.jsx(H,{variant:"ghost",className:"h-8 min-w-8 px-2 text-xs",onClick:i=>{I(i),g(f)},disabled:D,"aria-label":"取消改名",title:"取消改名",startIcon:t.jsx(J,{name:"close",size:16})})]}),w.error?t.jsx("div",{className:"text-xs text-danger",children:w.error}):null]}):t.jsxs("div",{className:"flex h-8 items-center justify-end gap-1",children:[t.jsx(H,{variant:"ghost",className:"h-8 gap-1 px-2.5 text-xs",disabled:!f,startIcon:t.jsx(J,{name:"chevron_right",size:16}),onClick:i=>{I(i),f&&N(f)},children:"进入"}),t.jsx(H,{variant:"ghost",className:"h-8 gap-1 px-2.5 text-xs",disabled:!f||!v,title:v?void 0:x,startIcon:t.jsx(J,{name:"edit",size:16}),onClick:i=>{I(i),R(f)},children:"改名"}),t.jsx(H,{variant:"danger",className:"h-8 gap-1 px-2.5 text-xs",disabled:!f||!v,title:v?void 0:x,startIcon:t.jsx(J,{name:"delete",size:16}),onClick:i=>{I(i),o(f)},children:"删除"})]}):w.mode==="renaming"?t.jsxs("div",{className:"grid w-full gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ve,{name:`rename-${f}`,value:w.value,onChange:i=>l(f,{...w,value:i.target.value,error:"",phase:"idle"}),onFocus:i=>{i.target.select()},onKeyDown:i=>{i.key==="Enter"?(U(i),_(f)):i.key==="Escape"&&(U(i),g(f))},className:"h-8",placeholder:"新文件名，如 b.pdf",disabled:D,autoFocus:!0}),t.jsx(H,{variant:"ghost",className:"h-8 min-w-8 px-2 text-xs",onClick:i=>{I(i),_(f)},disabled:D,"aria-label":D?"正在改名":"确认改名",title:D?"正在改名":"确认改名",startIcon:D?t.jsx(fe,{size:14}):t.jsx(J,{name:"check",size:16})}),t.jsx(H,{variant:"ghost",className:"h-8 min-w-8 px-2 text-xs",onClick:i=>{I(i),g(f)},disabled:D,"aria-label":"取消改名",title:"取消改名",startIcon:t.jsx(J,{name:"close",size:16})})]}),w.error?t.jsx("div",{className:"text-xs text-danger",children:w.error}):null]}):w.mode==="moving"?t.jsxs("div",{className:"grid w-full gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ye,{name:`move-${f}`,value:A,className:"h-8",onChange:i=>l(f,{...w,value:K(i.target.value),error:"",phase:"idle"}),onKeyDown:i=>{i.key==="Enter"?(U(i),B(f)):i.key==="Escape"&&(U(i),g(f))},disabled:D,autoFocus:!0,children:u.map(i=>t.jsx("option",{value:i,children:i||"/"},i||"root"))}),t.jsx(H,{variant:"ghost",className:"h-8 min-w-8 px-2 text-xs",onClick:i=>{I(i),B(f)},disabled:D,"aria-label":D?"正在移动":"确认移动",title:D?"正在移动":"确认移动",startIcon:D?t.jsx(fe,{size:14}):t.jsx(J,{name:"check",size:16})}),t.jsx(H,{variant:"ghost",className:"h-8 min-w-8 px-2 text-xs",onClick:i=>{I(i),g(f)},disabled:D,"aria-label":"取消移动",title:"取消移动",startIcon:t.jsx(J,{name:"close",size:16})})]}),w.error?t.jsx("div",{className:"text-xs text-danger",children:w.error}):null]}):t.jsxs(je,{display:"flex",justifyContent:"flex-end",alignItems:"center",flexWrap:"nowrap",gap:.5,className:"w-full opacity-100 transition-opacity md:opacity-0 md:group-hover:opacity-100 md:group-focus-within:opacity-100",children:[t.jsx(H,{variant:"ghost",className:"h-8 gap-1 px-2.5 text-xs",disabled:!f,startIcon:t.jsx(J,{name:"open_in_new",size:16}),onClick:i=>{I(i),f&&window.open(M,"_blank","noopener,noreferrer")},children:"预览"}),t.jsx(H,{variant:"ghost",className:"h-8 gap-1 px-2.5 text-xs",disabled:!f||!v,title:v?void 0:x,startIcon:t.jsx(J,{name:"edit",size:16}),onClick:i=>{I(i),E(f)},children:"改名"}),t.jsx(H,{variant:"ghost",className:"h-8 gap-1 px-2.5 text-xs",disabled:!f||!v,title:v?void 0:x,startIcon:t.jsx(J,{name:"drive_file_move",size:16}),onClick:i=>{I(i),h(f)},children:"移动"}),t.jsx(H,{variant:"danger",className:"h-8 gap-1 px-2.5 text-xs",disabled:!f||!v,title:v?void 0:x,startIcon:t.jsx(J,{name:"delete",size:16}),onClick:i=>{I(i),L(f)},children:"删除"})]})})]},f||j.name)})})})}function Dt({currentPath:e,breadcrumbParts:n,directoryCount:d,status:u,selectedCount:v,fileCount:x,folderName:k,onFolderNameChange:l,capabilities:g,importDisabledReason:E,onNavigate:h,onUploadFiles:_,onDeleteSelected:B,onRefresh:L,onCreateFolder:N}){const R=r.useRef(null),[$,o]=r.useState(!1),y=!g.import_enabled||e!=="",b=g.import_enabled&&v>0,T=g.import_enabled?e?"仅支持在根目录创建子目录":"":E,W=!y&&!!k.trim(),p=P=>{P.preventDefault(),W&&(N(),o(!1))};return t.jsxs("div",{className:"grid gap-3",children:[t.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-start lg:justify-between",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsxs(je,{className:"flex flex-wrap items-center gap-2 text-sm text-text",children:[t.jsxs("a",{href:"/db.html",onClick:P=>{P.preventDefault(),h("")},className:"inline-flex items-center gap-1 rounded-sm px-1 py-0.5 hover:bg-surface-soft focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent",children:[t.jsx(J,{name:"folder",size:16}),"根目录"]}),n.map((P,F)=>{const z=n.slice(0,F+1).join("/");return t.jsxs($e.Fragment,{children:[t.jsx(J,{name:"chevron_right",size:14,className:"text-muted"}),t.jsx("a",{href:Pe(z),onClick:j=>{j.preventDefault(),h(z)},className:"inline-flex items-center rounded-sm px-1 py-0.5 hover:bg-surface-soft focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent",children:P})]},z)})]}),t.jsxs("div",{className:"mt-1 text-xs text-muted",children:["目录 ",d," · 文件 ",x,` · 已选 ${v}`]})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 lg:justify-end",children:[t.jsx(H,{variant:"primary",className:"h-10 gap-1.5 px-4",disabled:!g.import_enabled,title:g.import_enabled?"上传 PDF":E,startIcon:t.jsx(J,{name:"upload_file",size:16}),onClick:()=>R.current?.click(),children:"上传 PDF"}),t.jsx("input",{ref:R,type:"file",accept:".pdf,application/pdf",multiple:!0,className:"hidden",onChange:P=>{_(Array.from(P.target.files||[])),P.currentTarget.value=""}}),t.jsx(H,{variant:"ghost",type:"button",className:"h-10 gap-1.5 px-4",disabled:y,title:T||"创建子目录",startIcon:t.jsx(J,{name:"create_new_folder",size:16}),onClick:()=>o(!0),children:"创建子目录"}),t.jsxs(H,{variant:"danger",className:"h-10 gap-1.5 px-4",disabled:!b,title:g.import_enabled?void 0:E,startIcon:t.jsx(J,{name:"delete",size:16}),onClick:B,children:["删除所选",v>0?` (${v})`:""]}),t.jsx(H,{variant:"ghost",className:"h-10 gap-1.5 px-4",startIcon:t.jsx(J,{name:"refresh",size:16}),onClick:L,children:"刷新"})]})]}),u?t.jsx("div",{className:"rounded-md border border-border bg-surface-soft px-3 py-2 text-xs text-muted",children:u}):null,t.jsx(Te,{open:$,onClose:()=>o(!1),fullWidth:!0,maxWidth:"xs","aria-labelledby":"db-create-folder-title",children:t.jsxs("form",{onSubmit:p,children:[t.jsx(Re,{id:"db-create-folder-title",children:"新建子目录"}),t.jsxs(Ae,{children:[t.jsx(ve,{id:"db-folder-name",name:"folder_name",value:k,onChange:P=>l(P.target.value),placeholder:"填写新建子目录名称",className:"mt-2 w-full",disabled:y,"aria-label":"新建子目录名称",autoFocus:!0}),T?t.jsx("p",{className:"mt-2 text-xs text-muted",children:T}):null]}),t.jsxs(_e,{sx:{px:3,pb:2.5},children:[t.jsx(H,{variant:"ghost",type:"button",onClick:()=>o(!1),children:"取消"}),t.jsx(H,{variant:"ghost",type:"submit",disabled:!W,children:"创建"})]})]})})]})}function te(e){const n=K(e||"");return n&&n.split("/")[0]||""}function Pt({initialPath:e}){const[n,d]=r.useState(()=>te(e||"")),[u,v]=r.useState(()=>new Map),[x,k]=r.useState(()=>new Set([""])),[l,g]=r.useState([]),[E,h]=r.useState([]),[_,B]=r.useState(()=>new Set),[L,N]=r.useState(""),R=r.useRef(u),$=r.useRef(0),o=r.useMemo(()=>{const w=new Set([""]),A=u.get("");for(const C of A?.directories||[])w.add(te(C.path||""));return Array.from(w.values()).sort((C,M)=>C.localeCompare(M))},[u]),y=_.size,b=n?n.split("/"):[],T=r.useCallback(async(w,A=!1)=>{const C=te(w||""),M=R.current.get(C);if(!A&&M)return M;const D=await q(`/api/docs/tree?path=${encodeURIComponent(C)}`),O={path:K(D.path||C),directories:Array.isArray(D.directories)?D.directories:[],files:Array.isArray(D.files)?D.files:[]};return v(a=>{const c=new Map(a);return c.set(O.path,O),O.path!==C&&c.set(C,O),R.current=c,c}),O},[]),W=r.useCallback(async(w,A=!1)=>{const C=te(w||"");await T("",A),C&&await T(C,A)},[T]),p=r.useCallback(w=>{const A=new Set(w.map(C=>K(C.relative_path||C.name||"")));B(C=>{const M=new Set;for(const D of C)A.has(D)&&M.add(D);return M})},[]),P=r.useCallback(async(w,A)=>{const C=$.current+1;$.current=C;const M=!!A?.push,D=!!A?.force,O=te(w||"");N("加载中...");try{await W(O,D);const a=await T(O,D);if(C!==$.current)return;const c=te(a.path||O);d(c),g(c?[]:a.directories||[]),h(a.files||[]),p(a.files||[]),k(m=>{const s=new Set(m);return s.add(""),c&&s.add(c),s}),M&&history.pushState({},"",Pe(c)),N("")}catch(a){if(C!==$.current)return;N(`加载失败：${String(a?.message||a)}`),g([]),h([])}},[T,W,p]),F=r.useCallback(async()=>{await P(n,{force:!0,push:!1})},[n,P]),z=r.useCallback(w=>{const A=new Set;for(const C of w){const M=K(C||"");M&&A.add(M)}B(A)},[]),j=r.useCallback(()=>{B(new Set)},[]),f=r.useCallback((w,A)=>{k(C=>{const M=new Set(C);return A?M.add(w):M.delete(w),M})},[]);return{currentPath:n,treeCache:u,expandedDirs:x,directories:l,files:E,selectedPaths:_,status:L,knownDirectories:o,selectedCount:y,breadcrumbParts:b,setStatus:N,setSelection:z,loadDirectory:P,refreshCurrentDirectory:F,ensureTreeNode:T,toggleExpandDir:f,clearSelection:j}}function Nt(e){return e==="success"?"success":e==="failed"?"failed":e==="running"?"running":"queued"}function Tt({onAllJobsSettled:e,pollIntervalMs:n=1500}={}){const[d,u]=r.useState([]),[v,x]=r.useState(()=>new Map),k=r.useRef(new Set),l=r.useRef(""),g=r.useRef(null),E=r.useRef(!1),h=r.useCallback(($,o)=>{const y=Nt($.status),b=$,T=String(b.relative_path||b.filename||b.path||"-"),W=String($.error||""),p=String($.job_id||`${o}-${Date.now()}`);o==="import"&&T&&T!=="-"&&x(P=>{const F=new Map(P);return F.set(T,y),F}),u(P=>{const F=`${o}-${p}`,z=P.filter(j=>j.rowId!==F);return z.unshift({rowId:F,kind:o,status:y,pathText:T,error:W,updatedAt:Date.now()}),z.slice(0,80)})},[]),_=r.useCallback(()=>{g.current!==null&&(window.clearInterval(g.current),g.current=null)},[]),B=r.useCallback(async()=>{if(!E.current){E.current=!0;try{const $=[];for(const o of k.current.values())try{const y=await q(`/api/import/${encodeURIComponent(o)}`);h(y,"import"),["success","failed"].includes(String(y.status||""))&&$.push(o)}catch{$.push(o)}if($.forEach(o=>k.current.delete(o)),l.current)try{const o=await q(`/api/scan/${encodeURIComponent(l.current)}`);h(o,"scan"),["success","failed"].includes(String(o.status||""))&&(l.current="")}catch{l.current=""}k.current.size===0&&!l.current&&(_(),e&&await e())}finally{E.current=!1}}},[e,_,h]),L=r.useCallback(()=>{g.current===null&&(g.current=window.setInterval(()=>{B()},n))},[n,B]),N=r.useCallback($=>{const o=String($||"").trim();o&&(k.current.add(o),L())},[L]),R=r.useCallback($=>{const o=String($||"").trim();o&&(l.current=o,L())},[L]);return r.useEffect(()=>()=>{_()},[_]),{jobs:d,jobStatusByPath:v,upsertJob:h,startImportJob:N,startScanJob:R,stopAllPolling:_}}function _t(){const e=Date.now();return{upload:{phase:"idle",message:"",updatedAt:e},batchDelete:{phase:"idle",message:"",updatedAt:e},rescan:{phase:"idle",message:"",updatedAt:e},createFolder:{phase:"idle",message:"",updatedAt:e}}}function ee(e,n=""){return{mode:e,value:n,error:"",phase:"idle"}}function At({currentPath:e,visiblePaths:n,capabilities:d,importDisabledReason:u,scanDisabledReason:v,refreshCurrentDirectory:x,clearSelection:k,setStatus:l,upsertJob:g,startImportJob:E,startScanJob:h}){const[_,B]=r.useState({}),[L,N]=r.useState(()=>_t()),[R,$]=r.useState(null);r.useEffect(()=>{const a=new Set(n.map(c=>K(c||"")).filter(Boolean));B(c=>{const m={};for(const[s,S]of Object.entries(c))a.has(s)&&(m[s]=S);return m})},[n]);const o=r.useCallback((a,c,m,s)=>{N(S=>({...S,[a]:{phase:c,message:m,updatedAt:Date.now(),...s?{error:s}:{}}})),$(m?{phase:c,message:m}:null)},[]),y=r.useCallback(a=>_[a]||ee("normal"),[_]),b=r.useCallback((a,c)=>{B(m=>({...m,[a]:c}))},[]),T=r.useCallback(a=>{B(c=>{const m={...c};return delete m[a],m})},[]),W=r.useCallback(a=>{const c=(a.results||[]).filter(m=>!m.ok);return c.length===0?"":c.slice(0,3).map(m=>{const s=String(m.path||"-");if(String(m.error_code||"").toUpperCase()==="CONFLICT"){const I=Array.isArray(m.details?.candidates)?m.details.candidates.slice(0,3).join(", "):"";return I?`${s}: 命名冲突，请使用完整相对路径，候选: ${I}`:`${s}: 命名冲突，请使用完整相对路径`}return`${s}: ${String(m.error||"unknown error")}`}).join(" | ")},[]),p=r.useCallback(async a=>{if(!d.import_enabled){const s=u||"导入服务不可用";o("batchDelete","error",`删除不可用：${s}`,s),l(`删除不可用：${s}`);return}const c=a.map(s=>K(s||"")).filter(Boolean);if(c.length===0)return;const m=`正在删除 ${c.length} 个文件...`;o("batchDelete","pending",m),l(m);try{const s=await q("/api/docs/batch-delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paths:c})}),S=W(s),I=S?`删除完成：成功 ${s.deleted}/${s.total}，失败 ${s.failed}（${S}）`:`删除完成：成功 ${s.deleted}/${s.total}，失败 ${s.failed}`,U=s.failed>0?"error":"success";o("batchDelete",U,I,s.failed>0?S||"partial failed":void 0),l(I),k(),await x()}catch(s){const S=String(s?.message||s);o("batchDelete","error",`删除失败：${S}`,S),l(`删除失败：${S}`)}},[d.import_enabled,k,W,u,x,l,o]),P=r.useCallback(async a=>{if(!d.import_enabled){const U=u||"导入服务不可用";o("upload","error",`上传不可用：${U}`,U),l(`上传不可用：${U}`);return}if(a.length===0){l("请选择 PDF 文件");return}const c=`准备上传 ${a.length} 个文件...`;o("upload","pending",c),l(c);let m=0,s=0;for(const U of a)try{const i=await fetch(`/api/import?filename=${encodeURIComponent(U.name)}&target_dir=${encodeURIComponent(e)}`,{method:"POST",headers:{Accept:"application/json","Content-Type":U.type||"application/pdf","X-File-Name":U.name,"X-Target-Dir":e},body:U}),Z=await i.json().catch(()=>({}));if(!i.ok)throw new Error(String(Z.message||`${i.status} ${i.statusText}`));m+=1,g(Z,"import"),E(String(Z.job_id||""))}catch(i){s+=1,g({job_id:`error-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,filename:U.name,status:"failed",error:String(i?.message||i)},"import")}const S=`上传提交完成：成功 ${m}/${a.length}，失败 ${s}`,I=s>0?"error":"success";o("upload",I,S,s>0?"partial failed":void 0),l(S)},[d.import_enabled,e,u,l,E,o,g]),F=r.useCallback(async(a,c)=>{if(!d.import_enabled){const s=u||"导入服务不可用";o("createFolder","error",`创建目录不可用：${s}`,s),l(`创建目录不可用：${s}`);return}const m=a.trim();if(!m){o("createFolder","error","创建失败：请输入目录名","missing folder name");return}if(K(e)!==""){const s="仅支持在根目录创建子目录";o("createFolder","error",s,"root-only"),l(s);return}o("createFolder","pending",`正在创建目录：${m}`);try{await q("/api/folders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e,name:m})}),c?.(),await x();const s=`创建目录成功：${K(e)||"/"} / ${m}`;o("createFolder","success",s),l(s)}catch(s){const S=String(s?.message||s);o("createFolder","error",`创建失败：${S}`,S),l(`创建失败：${S}`)}},[d.import_enabled,e,u,x,l,o]),z=r.useCallback(a=>{const c=K(a).split("/").pop()||a;b(a,ee("renaming",c))},[b]),j=r.useCallback(async a=>{if(!d.import_enabled){const s=u||"导入服务不可用";b(a,{...ee("renaming"),error:s,phase:"error"});return}const c=y(a),m=c.value.trim();if(!m){b(a,{...c,error:"请输入新目录名",phase:"error"});return}if(m.includes("/")||m==="."||m===".."){b(a,{...c,error:"目录名不合法",phase:"error"});return}b(a,{...c,error:"",phase:"pending"});try{const s=await q("/api/folders/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:a,new_name:m})});b(a,{...c,phase:"success"}),T(a),l(`目录改名成功：${s.old_path} -> ${s.new_path}`),await x()}catch(s){const S=String(s?.message||s);b(a,{...c,error:S,phase:"error"})}},[d.import_enabled,T,y,u,x,b,l]),f=r.useCallback(async a=>{if(!d.import_enabled){const s=u||"导入服务不可用";o("batchDelete","error",`删除不可用：${s}`,s),l(`删除不可用：${s}`);return}const c=a.map(s=>K(s||"")).filter(Boolean);if(c.length===0)return;const m=`正在删除 ${c.length} 个目录...`;o("batchDelete","pending",m),l(m);try{const s=await q("/api/folders/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paths:c,recursive:!0})}),S=W(s),I=S?`目录删除完成：成功 ${s.deleted}/${s.total}，失败 ${s.failed}（${S}）`:`目录删除完成：成功 ${s.deleted}/${s.total}，失败 ${s.failed}`,U=s.failed>0?"error":"success";o("batchDelete",U,I,s.failed>0?S||"partial failed":void 0),l(I),await x()}catch(s){const S=String(s?.message||s);o("batchDelete","error",`目录删除失败：${S}`,S),l(`目录删除失败：${S}`)}},[d.import_enabled,W,u,x,l,o]),w=r.useCallback(async()=>{if(!d.scan_enabled){const a=v||"重扫服务不可用";o("rescan","error",`重扫不可用：${a}`,a),l(`重扫不可用：${a}`);return}o("rescan","pending",`正在提交重扫任务：${K(e)||"/"}`);try{const a=await q(`/api/scan?path=${encodeURIComponent(e)}`,{method:"POST"}),c=String(a.job_id||"");if(!c)throw new Error("scan job id missing");g(a,"scan"),h(c);const m=`重扫任务已提交：${c}`;o("rescan","success",m),l(m)}catch(a){const c=String(a?.message||a);o("rescan","error",`触发重扫失败：${c}`,c),l(`触发重扫失败：${c}`)}},[d.scan_enabled,e,v,l,h,o,g]),A=r.useCallback(a=>{const c=a.split("/").pop()||a;b(a,ee("renaming",c))},[b]),C=r.useCallback(a=>{b(a,ee("moving",e))},[e,b]),M=r.useCallback(async a=>{if(!d.import_enabled){const s=u||"导入服务不可用";b(a,{...ee("renaming"),error:s,phase:"error"});return}const c=y(a),m=c.value.trim();if(!m){b(a,{...c,error:"请输入新文件名",phase:"error"});return}b(a,{...c,error:"",phase:"pending"});try{const s=await q("/api/docs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:a,new_name:m})});b(a,{...c,phase:"success"}),T(a),l(`改名成功：${s.old_path} -> ${s.new_path}`),await x()}catch(s){const S=String(s?.message||s);b(a,{...c,error:S,phase:"error"})}},[d.import_enabled,T,y,u,x,b,l]),D=r.useCallback(async a=>{if(!d.import_enabled){const s=u||"导入服务不可用";b(a,{...ee("moving"),error:s,phase:"error"});return}const c=y(a),m=K(c.value||"");b(a,{...c,error:"",phase:"pending"});try{const s=await q("/api/docs/move",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:a,target_dir:m})});b(a,{...c,phase:"success"}),T(a),l(`移动成功：${s.old_path} -> ${s.new_path}`),await x()}catch(s){const S=String(s?.message||s);b(a,{...c,error:S,phase:"error"})}},[d.import_enabled,T,y,u,x,b,l]),O=r.useMemo(()=>({getRowActionState:y,setRowActionState:b,clearRowActionState:T,beginRename:A,beginFolderRename:z,beginMove:C,applyRename:M,applyFolderRename:j,applyMove:D}),[j,D,M,z,C,A,T,y,b]);return{globalActionState:L,actionFeedback:R,rowActions:O,deleteSelected:p,deleteFolders:f,submitUploads:P,createFolder:F,triggerRescan:w}}function Rt(){const[e,n]=r.useState(""),[d,u]=r.useState(!1),[v,x]=r.useState(!1),[k,l]=r.useState([]),[g,E]=r.useState({import_enabled:!0,scan_enabled:!0,import_reason:"",scan_reason:""}),h=Pt({initialPath:he(window.location.search)}),_=h.setStatus,B=g.import_enabled?"":String(g.import_reason||"导入服务不可用"),L=g.scan_enabled?"":String(g.scan_reason||"重扫服务不可用"),N=r.useCallback(async()=>{try{const p=await q("/api/capabilities");E({import_enabled:!!p.import_enabled,scan_enabled:!!p.scan_enabled,import_reason:String(p.import_reason||""),scan_reason:String(p.scan_reason||"")})}catch(p){const P=String(p?.message||p);_(`加载能力信息失败：${P}`)}},[_]),R=Tt({onAllJobsSettled:async()=>{await h.refreshCurrentDirectory()}}),$=r.useMemo(()=>{const p=h.directories.map(F=>({name:String(F.name||F.path||"").split("/").pop()||F.path||"-",relative_path:F.path,indexed:!0,is_dir:!0})),P=h.files.map(F=>({...F,is_dir:!1}));return[...p,...P]},[h.directories,h.files]),o=At({currentPath:h.currentPath,visiblePaths:$.map(p=>p.relative_path),capabilities:g,importDisabledReason:B,scanDisabledReason:L,refreshCurrentDirectory:h.refreshCurrentDirectory,clearSelection:h.clearSelection,setStatus:h.setStatus,upsertJob:R.upsertJob,startImportJob:R.startImportJob,startScanJob:R.startScanJob}),y=r.useMemo(()=>k.slice(0,6),[k]),b=r.useCallback(p=>{const P=p.map(F=>({path:String(F.path||"").trim(),kind:F.kind})).filter(F=>!!F.path);P.length!==0&&(l(P),x(!0))},[]),T=r.useCallback(()=>{x(!1),l([])},[]),W=r.useCallback(async()=>{const p=[...k];if(T(),p.length===0)return;const P=p.filter(z=>z.kind==="file").map(z=>z.path),F=p.filter(z=>z.kind==="directory").map(z=>z.path);P.length>0&&await o.deleteSelected(P),F.length>0&&await o.deleteFolders(F)},[T,k,o]);return r.useEffect(()=>{o.actionFeedback?.message&&u(!0)},[o.actionFeedback]),r.useEffect(()=>{const p=()=>{h.loadDirectory(he(window.location.search),{push:!1,force:!1})};return window.addEventListener("popstate",p),N(),h.loadDirectory(he(window.location.search),{push:!1,force:!0}),()=>{window.removeEventListener("popstate",p),R.stopAllPolling()}},[]),t.jsxs(Le,{actions:[{href:"/search.html",label:"搜索"}],hideHeaderTitle:!0,backHref:h.currentPath?"/db.html":"/",children:[t.jsx("div",{className:"grid gap-4",children:t.jsxs(We,{className:"grid min-w-0 gap-4 p-4",children:[t.jsx(Dt,{currentPath:h.currentPath,breadcrumbParts:h.breadcrumbParts,directoryCount:h.directories.length,status:h.status,selectedCount:h.selectedCount,fileCount:h.files.length,folderName:e,onFolderNameChange:n,capabilities:g,importDisabledReason:B,onNavigate:p=>{h.loadDirectory(p,{push:!0,force:!1})},onUploadFiles:p=>{o.submitUploads(p)},onDeleteSelected:()=>b(Array.from(h.selectedPaths).map(p=>({path:p,kind:"file"}))),onRefresh:()=>{h.refreshCurrentDirectory()},onCreateFolder:()=>{o.createFolder(e,()=>{n("")})}}),t.jsx($t,{items:$,selectedPaths:h.selectedPaths,onSelectionChange:h.setSelection,knownDirectories:h.knownDirectories,capabilitiesImportEnabled:g.import_enabled,importDisabledReason:B,getRowActionState:o.rowActions.getRowActionState,onSetRowActionState:o.rowActions.setRowActionState,onClearRowActionState:o.rowActions.clearRowActionState,onBeginRename:o.rowActions.beginRename,onBeginMove:o.rowActions.beginMove,onApplyRename:p=>{o.rowActions.applyRename(p)},onBeginDirectoryRename:o.rowActions.beginFolderRename,onApplyDirectoryRename:p=>{o.rowActions.applyFolderRename(p)},onApplyMove:p=>{o.rowActions.applyMove(p)},onDeleteSingle:p=>b([{path:p,kind:"file"}]),onDeleteDirectory:p=>b([{path:p,kind:"directory"}]),onOpenDirectory:p=>{h.loadDirectory(p,{push:!0,force:!1})}})]})}),t.jsxs(Te,{open:v,onClose:T,fullWidth:!0,maxWidth:"sm","aria-labelledby":"db-delete-dialog-title",children:[t.jsx(Re,{id:"db-delete-dialog-title",children:"确认删除"}),t.jsxs(Ae,{children:[t.jsxs("div",{className:"mt-1 text-sm text-text",children:["将删除 ",k.length," 个条目（目录会递归删除），对应数据库记录和磁盘文件都会被移除。"]}),t.jsxs("div",{className:"mt-3 rounded-md border border-border bg-surface-soft px-3 py-2",children:[t.jsx("div",{className:"text-xs text-muted",children:"示例路径："}),t.jsxs("ul",{className:"mt-1 space-y-1 text-xs text-text",children:[y.map(p=>t.jsxs("li",{className:"font-mono",children:[p.kind==="directory"?"[目录] ":"[文件] ",p.path]},`${p.kind}:${p.path}`)),k.length>y.length?t.jsx("li",{className:"text-muted",children:"..."}):null]})]})]}),t.jsxs(_e,{sx:{px:3,pb:2.5},children:[t.jsx(H,{variant:"ghost",onClick:T,children:"取消"}),t.jsx(H,{variant:"danger",onClick:()=>{W()},children:"确认删除"})]})]}),t.jsx(jt,{open:d,autoHideDuration:2800,onClose:()=>u(!1),anchorOrigin:{vertical:"top",horizontal:"right"},children:t.jsx(Je,{onClose:()=>u(!1),severity:o.actionFeedback?.phase==="error"?"error":o.actionFeedback?.phase==="pending"?"info":"success",variant:"filled",children:o.actionFeedback?.message||"操作完成"})})]})}Fe.createRoot(document.getElementById("root")).render(t.jsx($e.StrictMode,{children:t.jsx(Ie,{children:t.jsx(Rt,{})})}));
