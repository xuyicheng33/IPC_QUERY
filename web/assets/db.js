import{e as Pe,f as Ae,r as n,h as _e,g as ie,a as ce,u as le,j as t,b as Ne,i as se,d as V,T as Re,M as F,B as de,R as ue,c as Te,A as De}from"./chunks/AppProviders.js";import{g as Ie,n as B,E as Me,e as pe,f as Q,h as ee,A as Fe,d as Le}from"./chunks/urlState.js";import{u as Oe,f as ne,g as ze,h as oe,d as fe,s as Z,P as Be,m as me,i as he,b as Y,B as H,j as re,C as Ue}from"./chunks/Card.js";import{g as He,o as te,G as Je,I as ge}from"./chunks/Input.js";import{S as Ke}from"./chunks/Select.js";function Qe(e,o,m,u,k){const[f,b]=n.useState(()=>k&&m?m(e).matches:u?u(e).matches:o);return _e(()=>{if(!m)return;const d=m(e),i=()=>{b(d.matches)};return i(),d.addEventListener("change",i),()=>{d.removeEventListener("change",i)}},[e,m]),f}const Ge={...Ae},xe=Ge.useSyncExternalStore;function We(e,o,m,u,k){const f=n.useCallback(()=>o,[o]),b=n.useMemo(()=>{if(k&&m)return()=>m(e).matches;if(u!==null){const{matches:S}=u(e);return()=>S}return f},[f,e,u,k,m]),[d,i]=n.useMemo(()=>{if(m===null)return[f,()=>()=>{}];const S=m(e);return[()=>S.matches,C=>(S.addEventListener("change",C),()=>{S.removeEventListener("change",C)})]},[f,m,e]);return xe(i,d,b)}function be(e={}){const{themeId:o}=e;return function(u,k={}){let f=Pe();f&&o&&(f=f[o]||f);const b=typeof window<"u"&&typeof window.matchMedia<"u",{defaultMatches:d=!1,matchMedia:i=b?window.matchMedia:null,ssrMatchMedia:j=null,noSsr:S=!1}=Ie({name:"MuiUseMediaQuery",props:k,theme:f});let C=typeof u=="function"?u(f):u;return C=C.replace(/^@media( ?)/m,""),C.includes("print")&&console.warn(["MUI: You have provided a `print` query to the `useMediaQuery` hook.","Using the print media query to modify print styles can lead to unexpected results.","Consider using the `displayPrint` field in the `sx` prop instead.","More information about `displayPrint` on our docs: https://mui.com/system/display/#display-in-print."].join(`
`)),(xe!==void 0?We:Qe)(C,d,i,j,S)}}be();function ae(e){return e.substring(2).toLowerCase()}function Xe(e,o){return o.documentElement.clientWidth<e.clientX||o.documentElement.clientHeight<e.clientY}function Ye(e){const{children:o,disableReactTree:m=!1,mouseEvent:u="onClick",onClickAway:k,touchEvent:f="onTouchEnd"}=e,b=n.useRef(!1),d=n.useRef(null),i=n.useRef(!1),j=n.useRef(!1);n.useEffect(()=>(setTimeout(()=>{i.current=!0},0),()=>{i.current=!1}),[]);const S=Oe(He(o),d),C=ne(h=>{const _=j.current;j.current=!1;const p=te(d.current);if(!i.current||!d.current||"clientX"in h&&Xe(h,p))return;if(b.current){b.current=!1;return}let s;h.composedPath?s=h.composedPath().includes(d.current):s=!p.documentElement.contains(h.target)||d.current.contains(h.target),!s&&(m||!_)&&k(h)}),D=h=>_=>{j.current=!0;const p=o.props[h];p&&p(_)},T={ref:S};return f!==!1&&(T[f]=D(f)),n.useEffect(()=>{if(f!==!1){const h=ae(f),_=te(d.current),p=()=>{b.current=!0};return _.addEventListener(h,C),_.addEventListener("touchmove",p),()=>{_.removeEventListener(h,C),_.removeEventListener("touchmove",p)}}},[C,f]),u!==!1&&(T[u]=D(u)),n.useEffect(()=>{if(u!==!1){const h=ae(u),_=te(d.current);return _.addEventListener(h,C),()=>{_.removeEventListener(h,C)}}},[C,u]),n.cloneElement(o,T)}function Ve(e={}){const{autoHideDuration:o=null,disableWindowBlurListener:m=!1,onClose:u,open:k,resumeHideDuration:f}=e,b=ze();n.useEffect(()=>{if(!k)return;function s(w){w.defaultPrevented||w.key==="Escape"&&u?.(w,"escapeKeyDown")}return document.addEventListener("keydown",s),()=>{document.removeEventListener("keydown",s)}},[k,u]);const d=ne((s,w)=>{u?.(s,w)}),i=ne(s=>{!u||s==null||b.start(s,()=>{d(null,"timeout")})});n.useEffect(()=>(k&&i(o),b.clear),[k,o,i,b]);const j=s=>{u?.(s,"clickaway")},S=b.clear,C=n.useCallback(()=>{o!=null&&i(f??o*.5)},[o,f,i]),D=s=>w=>{const y=s.onBlur;y?.(w),C()},T=s=>w=>{const y=s.onFocus;y?.(w),S()},h=s=>w=>{const y=s.onMouseEnter;y?.(w),S()},_=s=>w=>{const y=s.onMouseLeave;y?.(w),C()};return n.useEffect(()=>{if(!m&&k)return window.addEventListener("focus",C),window.addEventListener("blur",S),()=>{window.removeEventListener("focus",C),window.removeEventListener("blur",S)}},[m,k,C,S]),{getRootProps:(s={})=>{const w={...oe(e),...oe(s)};return{role:"presentation",...s,...w,onBlur:D(w),onFocus:T(w),onMouseEnter:h(w),onMouseLeave:_(w)}},onClickAway:j}}function Ze(e){return ie("MuiSnackbarContent",e)}ce("MuiSnackbarContent",["root","message","action"]);const qe=e=>{const{classes:o}=e;return fe({root:["root"],action:["action"],message:["message"]},Ze,o)},et=Z(Be,{name:"MuiSnackbarContent",slot:"Root"})(me(({theme:e})=>{const o=e.palette.mode==="light"?.8:.98;return{...e.typography.body2,color:e.vars?e.vars.palette.SnackbarContent.color:e.palette.getContrastText(se(e.palette.background.default,o)),backgroundColor:e.vars?e.vars.palette.SnackbarContent.bg:se(e.palette.background.default,o),display:"flex",alignItems:"center",flexWrap:"wrap",padding:"6px 16px",flexGrow:1,[e.breakpoints.up("sm")]:{flexGrow:"initial",minWidth:288}}})),tt=Z("div",{name:"MuiSnackbarContent",slot:"Message"})({padding:"8px 0"}),nt=Z("div",{name:"MuiSnackbarContent",slot:"Action"})({display:"flex",alignItems:"center",marginLeft:"auto",paddingLeft:16,marginRight:-8}),st=n.forwardRef(function(o,m){const u=le({props:o,name:"MuiSnackbarContent"}),{action:k,className:f,message:b,role:d="alert",...i}=u,j=u,S=qe(j);return t.jsxs(et,{role:d,elevation:6,className:Ne(S.root,f),ownerState:j,ref:m,...i,children:[t.jsx(tt,{className:S.message,ownerState:j,children:b}),k?t.jsx(nt,{className:S.action,ownerState:j,children:k}):null]})});function ot(e){return ie("MuiSnackbar",e)}ce("MuiSnackbar",["root","anchorOriginTopCenter","anchorOriginBottomCenter","anchorOriginTopRight","anchorOriginBottomRight","anchorOriginTopLeft","anchorOriginBottomLeft"]);const rt=e=>{const{classes:o,anchorOrigin:m}=e,u={root:["root",`anchorOrigin${V(m.vertical)}${V(m.horizontal)}`]};return fe(u,ot,o)},at=Z("div",{name:"MuiSnackbar",slot:"Root",overridesResolver:(e,o)=>{const{ownerState:m}=e;return[o.root,o[`anchorOrigin${V(m.anchorOrigin.vertical)}${V(m.anchorOrigin.horizontal)}`]]}})(me(({theme:e})=>({zIndex:(e.vars||e).zIndex.snackbar,position:"fixed",display:"flex",left:8,right:8,justifyContent:"center",alignItems:"center",variants:[{props:({ownerState:o})=>o.anchorOrigin.vertical==="top",style:{top:8,[e.breakpoints.up("sm")]:{top:24}}},{props:({ownerState:o})=>o.anchorOrigin.vertical!=="top",style:{bottom:8,[e.breakpoints.up("sm")]:{bottom:24}}},{props:({ownerState:o})=>o.anchorOrigin.horizontal==="left",style:{justifyContent:"flex-start",[e.breakpoints.up("sm")]:{left:24,right:"auto"}}},{props:({ownerState:o})=>o.anchorOrigin.horizontal==="right",style:{justifyContent:"flex-end",[e.breakpoints.up("sm")]:{right:24,left:"auto"}}},{props:({ownerState:o})=>o.anchorOrigin.horizontal==="center",style:{[e.breakpoints.up("sm")]:{left:"50%",right:"auto",transform:"translateX(-50%)"}}}]}))),it=n.forwardRef(function(o,m){const u=le({props:o,name:"MuiSnackbar"}),k=he(),f={enter:k.transitions.duration.enteringScreen,exit:k.transitions.duration.leavingScreen},{action:b,anchorOrigin:{vertical:d,horizontal:i}={vertical:"bottom",horizontal:"left"},autoHideDuration:j=null,children:S,className:C,ClickAwayListenerProps:D,ContentProps:T,disableWindowBlurListener:h=!1,message:_,onBlur:p,onClose:s,onFocus:w,onMouseEnter:y,onMouseLeave:A,open:L,resumeHideDuration:z,slots:$={},slotProps:g={},TransitionComponent:E,transitionDuration:O=f,TransitionProps:{onEnter:N,onExited:P,...v}={},...R}=u,r={...u,anchorOrigin:{vertical:d,horizontal:i},autoHideDuration:j,disableWindowBlurListener:h,TransitionComponent:E,transitionDuration:O},c=rt(r),{getRootProps:x,onClickAway:l}=Ve(r),[I,U]=n.useState(!0),a=G=>{U(!0),P&&P(G)},M=(G,K)=>{U(!1),N&&N(G,K)},J={slots:{transition:E,...$},slotProps:{content:T,clickAwayListener:D,transition:v,...g}},[q,we]=Y("root",{ref:m,className:[c.root,C],elementType:at,getSlotProps:x,externalForwardedProps:{...J,...R},ownerState:r}),[ve,{ownerState:ye,...Se}]=Y("clickAwayListener",{elementType:Ye,externalForwardedProps:J,getSlotProps:G=>({onClickAway:(...K)=>{const Ee=K[0];G.onClickAway?.(...K),!Ee?.defaultMuiPrevented&&l(...K)}}),ownerState:r}),[Ce,ke]=Y("content",{elementType:st,shouldForwardComponentProp:!0,externalForwardedProps:J,additionalProps:{message:_,action:b},ownerState:r}),[je,$e]=Y("transition",{elementType:Je,externalForwardedProps:J,getSlotProps:G=>({onEnter:(...K)=>{G.onEnter?.(...K),M(...K)},onExited:(...K)=>{G.onExited?.(...K),a(...K)}}),additionalProps:{appear:!0,in:L,timeout:O,direction:d==="top"?"down":"up"},ownerState:r});return!L&&I?null:t.jsx(ve,{...Se,...$.clickAwayListener&&{ownerState:ye},children:t.jsx(q,{...we,children:t.jsx(je,{...$e,children:S||t.jsx(Ce,{...ke})})})})}),ct=be({themeId:Re});function lt({items:e,isMobile:o,selectedPaths:m,onSelectionChange:u,knownDirectories:k,capabilitiesImportEnabled:f,importDisabledReason:b,getRowActionState:d,onSetRowActionState:i,onClearRowActionState:j,onBeginRename:S,onBeginMove:C,onApplyRename:D,onApplyMove:T,onDeleteSingle:h,onOpenDirectory:_}){const[p,s]=n.useState(""),[w,y]=n.useState(""),A=n.useMemo(()=>e.filter($=>!$.is_dir).map($=>B($.relative_path||$.name||"")).filter(Boolean),[e]),L=$=>{u(A.filter(g=>$.has(g)))},z=($,g)=>{if(o||!$)return;const E=new Set(m);if(g.shift){const O=A.indexOf($),N=A.indexOf(w||$);if(O>=0&&N>=0){const[P,v]=N<=O?[N,O]:[O,N];E.clear();for(let R=P;R<=v;R+=1)E.add(A[R])}else E.clear(),E.add($);y($),L(E);return}if(g.toggle){E.has($)?E.delete($):E.add($),y($),L(E);return}E.clear(),E.add($),y($),L(E)};return e.length===0?t.jsx(Me,{title:"空目录"}):t.jsx("div",{className:"overflow-hidden rounded-md border border-border bg-surface",children:t.jsx("div",{role:"list","aria-label":"数据库文件列表",children:e.map($=>{const g=B($.relative_path||$.name||""),E=d(g),O=B(E.value||""),N=`/viewer.html?pdf=${encodeURIComponent(g)}&page=1`,P=E.phase==="pending",v=$.is_dir,R=v&&p===g,r=!v&&m.has(g),c=String($.name||g||"-"),x=!!(g&&g!==c),l=a=>{a.preventDefault(),a.stopPropagation()},I=a=>{E.mode==="normal"&&z(g,{shift:a.shiftKey,toggle:a.metaKey||a.ctrlKey})},U=a=>{E.mode==="normal"&&(a.key===" "||a.key==="Enter")&&(a.preventDefault(),z(g,{shift:a.shiftKey,toggle:a.metaKey||a.ctrlKey}))};return t.jsxs("div",{role:v?"button":void 0,"aria-label":v?`目录 ${c}`:`${c}${r?"（已选）":""}`,tabIndex:0,className:`group flex gap-2 border-b border-border px-3 py-2 last:border-b-0 focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent ${o&&!v?"flex-col items-stretch":"items-center"} ${v||!o?"cursor-pointer":""} ${v&&R||r?"bg-accent-soft":"hover:bg-surface-soft"}`,onClick:a=>{if(v){if(o){_(g);return}s(g);return}I(a)},onDoubleClick:()=>{v&&!o&&_(g)},onKeyDown:a=>{if(v){(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),_(g));return}U(a)},children:[t.jsx("div",{className:"flex w-7 items-center justify-center",children:t.jsx(F,{name:v?"folder":"description",size:20,className:v?"text-accent":"text-muted"})}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsx("div",{className:"truncate text-sm font-medium text-text",children:c}),x?t.jsx("div",{className:"truncate font-mono text-xs text-muted",children:g}):null]}),t.jsx("div",{className:o&&!v?"w-full":"min-w-[170px] md:min-w-[320px]",children:v?t.jsx("div",{className:"flex justify-end text-muted",children:t.jsx(F,{name:"chevron_right",size:18})}):E.mode==="renaming"?t.jsxs("div",{className:"grid gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ge,{name:`rename-${g}`,value:E.value,onChange:a=>i(g,{...E,value:a.target.value,error:"",phase:"idle"}),className:"h-8",placeholder:"新文件名，如 b.pdf",disabled:P}),t.jsx(H,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:a=>{l(a),D(g)},disabled:P,startIcon:P?t.jsx(re,{size:14}):t.jsx(F,{name:"check",size:16})}),t.jsx(H,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:a=>{l(a),j(g)},disabled:P,startIcon:t.jsx(F,{name:"close",size:16})})]}),E.error?t.jsx("div",{className:"text-xs text-danger",children:E.error}):null]}):E.mode==="moving"?t.jsxs("div",{className:"grid gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ke,{name:`move-${g}`,value:O,className:"h-8",onChange:a=>i(g,{...E,value:B(a.target.value),error:"",phase:"idle"}),disabled:P,children:k.map(a=>t.jsx("option",{value:a,children:a||"/"},a||"root"))}),t.jsx(H,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:a=>{l(a),T(g)},disabled:P,startIcon:P?t.jsx(re,{size:14}):t.jsx(F,{name:"check",size:16})}),t.jsx(H,{variant:"ghost",className:"h-8 min-w-8 px-2",onClick:a=>{l(a),j(g)},disabled:P,startIcon:t.jsx(F,{name:"close",size:16})})]}),E.error?t.jsx("div",{className:"text-xs text-danger",children:E.error}):null]}):t.jsxs(de,{display:"flex",justifyContent:"flex-end",alignItems:"center",flexWrap:o?"wrap":"nowrap",gap:.5,className:o?"opacity-100":"opacity-100 transition-opacity md:opacity-0 md:group-hover:opacity-100 md:group-focus-within:opacity-100",children:[t.jsx(H,{variant:"ghost",className:"h-8 gap-1.5 px-2",disabled:!g,startIcon:t.jsx(F,{name:"open_in_new",size:16}),onClick:a=>{l(a),g&&window.open(N,"_blank","noopener,noreferrer")},children:"预览"}),t.jsx(H,{variant:"ghost",className:"h-8 gap-1.5 px-2",disabled:!g||!f,title:f?void 0:b,startIcon:t.jsx(F,{name:"edit",size:16}),onClick:a=>{l(a),S(g)},children:"改名"}),t.jsx(H,{variant:"ghost",className:"h-8 gap-1.5 px-2",disabled:!g||!f,title:f?void 0:b,startIcon:t.jsx(F,{name:"drive_file_move",size:16}),onClick:a=>{l(a),C(g)},children:"移动"}),t.jsx(H,{variant:"ghost",className:"h-8 gap-1.5 px-2 text-danger",disabled:!g||!f,title:f?void 0:b,startIcon:t.jsx(F,{name:"delete",size:16}),onClick:a=>{l(a),window.confirm(`确认删除 ${g}？此操作不可撤销。`)&&h(g)},children:"删除"})]})})]},g||$.name)})})})}function dt({currentPath:e,breadcrumbParts:o,directoryCount:m,status:u,selectedCount:k,fileCount:f,isMobile:b,folderName:d,onFolderNameChange:i,capabilities:j,importDisabledReason:S,onNavigate:C,onUploadFiles:D,onDeleteSelected:T,onRefresh:h,onCreateFolder:_}){const p=n.useRef(null),s=!j.import_enabled||e!=="",w=j.import_enabled&&k>0&&!b,y=A=>{A.preventDefault(),_()};return t.jsxs("div",{className:"grid gap-3",children:[t.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-start lg:justify-between",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsxs(de,{className:"flex flex-wrap items-center gap-2 text-sm text-text",children:[t.jsxs("a",{href:"/db",onClick:A=>{A.preventDefault(),C("")},className:"inline-flex items-center gap-1 rounded-sm px-1 py-0.5 hover:bg-surface-soft focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent",children:[t.jsx(F,{name:"folder",size:16}),"根目录"]}),o.map((A,L)=>{const z=o.slice(0,L+1).join("/");return t.jsxs(ue.Fragment,{children:[t.jsx(F,{name:"chevron_right",size:14,className:"text-muted"}),t.jsx("a",{href:pe(z),onClick:$=>{$.preventDefault(),C(z)},className:"inline-flex items-center rounded-sm px-1 py-0.5 hover:bg-surface-soft focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent",children:A})]},z)})]}),t.jsxs("div",{className:"mt-1 text-xs text-muted",children:["目录 ",m," · 文件 ",f,b?"":` · 已选 ${k}`]})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 lg:justify-end",children:[t.jsx(H,{variant:"primary",className:"h-10 gap-1.5 px-4",disabled:!j.import_enabled,title:j.import_enabled?"上传 PDF":S,startIcon:t.jsx(F,{name:"upload_file",size:16}),onClick:()=>p.current?.click(),children:"上传 PDF"}),t.jsx("input",{ref:p,type:"file",accept:".pdf,application/pdf",multiple:!0,className:"hidden",onChange:A=>{D(Array.from(A.target.files||[])),A.currentTarget.value=""}}),t.jsxs("form",{className:"flex flex-wrap items-center gap-2",onSubmit:y,children:[t.jsx(ge,{id:"db-folder-name",name:"folder_name",value:d,onChange:A=>i(A.target.value),placeholder:e?"仅根目录可创建子目录":"新建子目录名称",className:"h-10 w-[220px]",disabled:s,"aria-label":"新建子目录名称"}),t.jsx(H,{variant:"ghost",type:"submit",className:"h-10 gap-1.5 px-4",disabled:s||!d.trim(),title:j.import_enabled?e?"仅支持在根目录创建子目录":void 0:S,startIcon:t.jsx(F,{name:"create_new_folder",size:16}),children:"创建子目录"})]}),b?null:t.jsxs(H,{variant:"danger",className:"h-10 gap-1.5 px-4",disabled:!w,title:j.import_enabled?void 0:S,startIcon:t.jsx(F,{name:"delete",size:16}),onClick:()=>{window.confirm(`确认删除已选的 ${k} 个文件？此操作不可撤销。`)&&T()},children:["删除所选",k>0?` (${k})`:""]}),t.jsx(H,{variant:"ghost",className:"h-10 gap-1.5 px-4",startIcon:t.jsx(F,{name:"refresh",size:16}),onClick:h,children:"刷新"})]})]}),u?t.jsx("div",{className:"rounded-md border border-border bg-surface-soft px-3 py-2 text-xs text-muted",children:u}):null,b?null:t.jsx("p",{className:"text-xs text-muted",children:"提示：按住 Shift / Cmd(Ctrl) 点击文件可进行多选。"})]})}function W(e){const o=B(e||"");return o&&o.split("/")[0]||""}function ut({initialPath:e}){const[o,m]=n.useState(()=>W(e||"")),[u,k]=n.useState(()=>new Map),[f,b]=n.useState(()=>new Set([""])),[d,i]=n.useState([]),[j,S]=n.useState([]),[C,D]=n.useState(()=>new Set),[T,h]=n.useState(""),_=n.useRef(u),p=n.useMemo(()=>{const N=new Set([""]),P=u.get("");for(const v of P?.directories||[])N.add(W(v.path||""));return Array.from(N.values()).sort((v,R)=>v.localeCompare(R))},[u]),s=C.size,w=o?o.split("/"):[],y=n.useCallback(async(N,P=!1)=>{const v=W(N||""),R=_.current.get(v);if(!P&&R)return R;const r=await Q(`/api/docs/tree?path=${encodeURIComponent(v)}`),c={path:B(r.path||v),directories:Array.isArray(r.directories)?r.directories:[],files:Array.isArray(r.files)?r.files:[]};return k(x=>{const l=new Map(x);return l.set(c.path,c),c.path!==v&&l.set(v,c),_.current=l,l}),c},[]),A=n.useCallback(async(N,P=!1)=>{const v=W(N||"");await y("",P),v&&await y(v,P)},[y]),L=n.useCallback(N=>{const P=new Set(N.map(v=>B(v.relative_path||v.name||"")));D(v=>{const R=new Set;for(const r of v)P.has(r)&&R.add(r);return R})},[]),z=n.useCallback(async(N,P)=>{const v=!!P?.push,R=!!P?.force,r=W(N||"");h("加载中...");try{await A(r,R);const c=await y(r,R),x=W(c.path||r);m(x),i(x?[]:c.directories||[]),S(c.files||[]),L(c.files||[]),b(l=>{const I=new Set(l);return I.add(""),x&&I.add(x),I}),v&&history.pushState({},"",pe(x)),h("")}catch(c){h(`加载失败：${String(c?.message||c)}`),i([]),S([])}},[y,A,L]),$=n.useCallback(async()=>{await z(o,{force:!0,push:!1})},[o,z]),g=n.useCallback(N=>{const P=new Set;for(const v of N){const R=B(v||"");R&&P.add(R)}D(P)},[]),E=n.useCallback(()=>{D(new Set)},[]),O=n.useCallback((N,P)=>{b(v=>{const R=new Set(v);return P?R.add(N):R.delete(N),R})},[]);return{currentPath:o,treeCache:u,expandedDirs:f,directories:d,files:j,selectedPaths:C,status:T,knownDirectories:p,selectedCount:s,breadcrumbParts:w,setStatus:h,setSelection:g,loadDirectory:z,refreshCurrentDirectory:$,ensureTreeNode:y,toggleExpandDir:O,clearSelection:E}}function pt(e){return e==="success"?"success":e==="failed"?"failed":e==="running"?"running":"queued"}function ft({onAllJobsSettled:e,pollIntervalMs:o=1500}={}){const[m,u]=n.useState([]),[k,f]=n.useState(()=>new Map),b=n.useRef(new Set),d=n.useRef(""),i=n.useRef(null),j=n.useRef(!1),S=n.useCallback((p,s)=>{const w=pt(p.status),y=p,A=String(y.relative_path||y.filename||y.path||"-"),L=String(p.error||""),z=String(p.job_id||`${s}-${Date.now()}`);s==="import"&&A&&A!=="-"&&f($=>{const g=new Map($);return g.set(A,w),g}),u($=>{const g=`${s}-${z}`,E=$.filter(O=>O.rowId!==g);return E.unshift({rowId:g,kind:s,status:w,pathText:A,error:L,updatedAt:Date.now()}),E.slice(0,80)})},[]),C=n.useCallback(()=>{i.current!==null&&(window.clearInterval(i.current),i.current=null)},[]),D=n.useCallback(async()=>{if(!j.current){j.current=!0;try{const p=[];for(const s of b.current.values())try{const w=await Q(`/api/import/${encodeURIComponent(s)}`);S(w,"import"),["success","failed"].includes(String(w.status||""))&&p.push(s)}catch{p.push(s)}if(p.forEach(s=>b.current.delete(s)),d.current)try{const s=await Q(`/api/scan/${encodeURIComponent(d.current)}`);S(s,"scan"),["success","failed"].includes(String(s.status||""))&&(d.current="")}catch{d.current=""}b.current.size===0&&!d.current&&(C(),e&&await e())}finally{j.current=!1}}},[e,C,S]),T=n.useCallback(()=>{i.current===null&&(i.current=window.setInterval(()=>{D()},o))},[o,D]),h=n.useCallback(p=>{const s=String(p||"").trim();s&&(b.current.add(s),T())},[T]),_=n.useCallback(p=>{const s=String(p||"").trim();s&&(d.current=s,T())},[T]);return n.useEffect(()=>()=>{C()},[C]),{jobs:m,jobStatusByPath:k,upsertJob:S,startImportJob:h,startScanJob:_,stopAllPolling:C}}function mt(){const e=Date.now();return{upload:{phase:"idle",message:"",updatedAt:e},batchDelete:{phase:"idle",message:"",updatedAt:e},rescan:{phase:"idle",message:"",updatedAt:e},createFolder:{phase:"idle",message:"",updatedAt:e}}}function X(e,o=""){return{mode:e,value:o,error:"",phase:"idle"}}function ht({currentPath:e,visibleFiles:o,capabilities:m,importDisabledReason:u,scanDisabledReason:k,refreshCurrentDirectory:f,clearSelection:b,setStatus:d,upsertJob:i,startImportJob:j,startScanJob:S}){const[C,D]=n.useState({}),[T,h]=n.useState(()=>mt()),[_,p]=n.useState(null);n.useEffect(()=>{const r=new Set(o.map(c=>B(c.relative_path||c.name||"")));D(c=>{const x={};for(const[l,I]of Object.entries(c))r.has(l)&&(x[l]=I);return x})},[o]);const s=n.useCallback((r,c,x,l)=>{h(I=>({...I,[r]:{phase:c,message:x,updatedAt:Date.now(),...l?{error:l}:{}}})),p(x?{phase:c,message:x}:null)},[]),w=n.useCallback(r=>C[r]||X("normal"),[C]),y=n.useCallback((r,c)=>{D(x=>({...x,[r]:c}))},[]),A=n.useCallback(r=>{D(c=>{const x={...c};return delete x[r],x})},[]),L=n.useCallback(r=>{const c=(r.results||[]).filter(x=>!x.ok);return c.length===0?"":c.slice(0,3).map(x=>{const l=String(x.path||"-");if(String(x.error_code||"").toUpperCase()==="CONFLICT"){const U=Array.isArray(x.details?.candidates)?x.details.candidates.slice(0,3).join(", "):"";return U?`${l}: 命名冲突，请使用完整相对路径，候选: ${U}`:`${l}: 命名冲突，请使用完整相对路径`}return`${l}: ${String(x.error||"unknown error")}`}).join(" | ")},[]),z=n.useCallback(async r=>{if(!m.import_enabled){const a=u||"导入服务不可用";s("batchDelete","error",`删除不可用：${a}`,a),d(`删除不可用：${a}`);return}const c=r.map(a=>B(a||"")).filter(Boolean);if(c.length===0)return;const x=c.slice(0,5).join(`
`),l=c.length>5?`
...`:"";if(!window.confirm(`确认删除 ${c.length} 个文件？
将删除数据库记录和磁盘文件。

示例路径：
${x}${l}`))return;const U=`正在删除 ${c.length} 个文件...`;s("batchDelete","pending",U),d(U);try{const a=await Q("/api/docs/batch-delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paths:c})}),M=L(a),J=M?`删除完成：成功 ${a.deleted}/${a.total}，失败 ${a.failed}（${M}）`:`删除完成：成功 ${a.deleted}/${a.total}，失败 ${a.failed}`,q=a.failed>0?"error":"success";s("batchDelete",q,J,a.failed>0?M||"partial failed":void 0),d(J),b(),await f()}catch(a){const M=String(a?.message||a);s("batchDelete","error",`删除失败：${M}`,M),d(`删除失败：${M}`)}},[m.import_enabled,b,L,u,f,d,s]),$=n.useCallback(async r=>{if(!m.import_enabled){const a=u||"导入服务不可用";s("upload","error",`上传不可用：${a}`,a),d(`上传不可用：${a}`);return}if(r.length===0){d("请选择 PDF 文件");return}const c=`准备上传 ${r.length} 个文件...`;s("upload","pending",c),d(c);let x=0,l=0;for(const a of r)try{const M=await fetch(`/api/import?filename=${encodeURIComponent(a.name)}&target_dir=${encodeURIComponent(e)}`,{method:"POST",headers:{Accept:"application/json","Content-Type":a.type||"application/pdf","X-File-Name":a.name,"X-Target-Dir":e},body:a}),J=await M.json().catch(()=>({}));if(!M.ok)throw new Error(String(J.message||`${M.status} ${M.statusText}`));x+=1,i(J,"import"),j(String(J.job_id||""))}catch(M){l+=1,i({job_id:`error-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,filename:a.name,status:"failed",error:String(M?.message||M)},"import")}const I=`上传提交完成：成功 ${x}/${r.length}，失败 ${l}`,U=l>0?"error":"success";s("upload",U,I,l>0?"partial failed":void 0),d(I)},[m.import_enabled,e,u,d,j,s,i]),g=n.useCallback(async(r,c)=>{if(!m.import_enabled){const l=u||"导入服务不可用";s("createFolder","error",`创建目录不可用：${l}`,l),d(`创建目录不可用：${l}`);return}const x=r.trim();if(!x){s("createFolder","error","创建失败：请输入目录名","missing folder name");return}if(B(e)!==""){const l="仅支持在根目录创建子目录";s("createFolder","error",l,"root-only"),d(l);return}s("createFolder","pending",`正在创建目录：${x}`);try{await Q("/api/folders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e,name:x})}),c?.(),await f();const l=`创建目录成功：${B(e)||"/"} / ${x}`;s("createFolder","success",l),d(l)}catch(l){const I=String(l?.message||l);s("createFolder","error",`创建失败：${I}`,I),d(`创建失败：${I}`)}},[m.import_enabled,e,u,f,d,s]),E=n.useCallback(async()=>{if(!m.scan_enabled){const r=k||"重扫服务不可用";s("rescan","error",`重扫不可用：${r}`,r),d(`重扫不可用：${r}`);return}s("rescan","pending",`正在提交重扫任务：${B(e)||"/"}`);try{const r=await Q(`/api/scan?path=${encodeURIComponent(e)}`,{method:"POST"}),c=String(r.job_id||"");if(!c)throw new Error("scan job id missing");i(r,"scan"),S(c);const x=`重扫任务已提交：${c}`;s("rescan","success",x),d(x)}catch(r){const c=String(r?.message||r);s("rescan","error",`触发重扫失败：${c}`,c),d(`触发重扫失败：${c}`)}},[m.scan_enabled,e,k,d,S,s,i]),O=n.useCallback(r=>{const c=r.split("/").pop()||r;y(r,X("renaming",c))},[y]),N=n.useCallback(r=>{y(r,X("moving",e))},[e,y]),P=n.useCallback(async r=>{if(!m.import_enabled){const l=u||"导入服务不可用";y(r,{...X("renaming"),error:l,phase:"error"});return}const c=w(r),x=c.value.trim();if(!x){y(r,{...c,error:"请输入新文件名",phase:"error"});return}y(r,{...c,error:"",phase:"pending"});try{const l=await Q("/api/docs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:r,new_name:x})});y(r,{...c,phase:"success"}),A(r),d(`改名成功：${l.old_path} -> ${l.new_path}`),await f()}catch(l){const I=String(l?.message||l);y(r,{...c,error:I,phase:"error"})}},[m.import_enabled,A,w,u,f,y,d]),v=n.useCallback(async r=>{if(!m.import_enabled){const l=u||"导入服务不可用";y(r,{...X("moving"),error:l,phase:"error"});return}const c=w(r),x=B(c.value||"");y(r,{...c,error:"",phase:"pending"});try{const l=await Q("/api/docs/move",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:r,target_dir:x})});y(r,{...c,phase:"success"}),A(r),d(`移动成功：${l.old_path} -> ${l.new_path}`),await f()}catch(l){const I=String(l?.message||l);y(r,{...c,error:I,phase:"error"})}},[m.import_enabled,A,w,u,f,y,d]),R=n.useMemo(()=>({getRowActionState:w,setRowActionState:y,clearRowActionState:A,beginRename:O,beginMove:N,applyRename:P,applyMove:v}),[v,P,N,O,A,w,y]);return{globalActionState:T,actionFeedback:_,rowActions:R,deleteSelected:z,submitUploads:$,createFolder:g,triggerRescan:E}}function gt(){const[e,o]=n.useState(""),[m,u]=n.useState(!1),k=he(),f=ct(k.breakpoints.down("sm")),[b,d]=n.useState({import_enabled:!0,scan_enabled:!0,import_reason:"",scan_reason:""}),i=ut({initialPath:ee(window.location.search)}),j=i.setStatus,S=b.import_enabled?"":String(b.import_reason||"导入服务不可用"),C=b.scan_enabled?"":String(b.scan_reason||"重扫服务不可用"),D=n.useCallback(async()=>{try{const p=await Q("/api/capabilities");d({import_enabled:!!p.import_enabled,scan_enabled:!!p.scan_enabled,import_reason:String(p.import_reason||""),scan_reason:String(p.scan_reason||"")})}catch(p){const s=String(p?.message||p);j(`加载能力信息失败：${s}`)}},[j]),T=ft({onAllJobsSettled:async()=>{await i.refreshCurrentDirectory()}}),h=ht({currentPath:i.currentPath,visibleFiles:i.files,capabilities:b,importDisabledReason:S,scanDisabledReason:C,refreshCurrentDirectory:i.refreshCurrentDirectory,clearSelection:i.clearSelection,setStatus:i.setStatus,upsertJob:T.upsertJob,startImportJob:T.startImportJob,startScanJob:T.startScanJob}),_=n.useMemo(()=>{const p=i.directories.map(w=>({name:String(w.name||w.path||"").split("/").pop()||w.path||"-",relative_path:w.path,indexed:!0,is_dir:!0})),s=i.files.map(w=>({...w,is_dir:!1}));return[...p,...s]},[i.directories,i.files]);return n.useEffect(()=>{h.actionFeedback?.message&&u(!0)},[h.actionFeedback]),n.useEffect(()=>{f&&i.selectedCount!==0&&i.clearSelection()},[i.clearSelection,i.selectedCount,f]),n.useEffect(()=>{const p=()=>{i.loadDirectory(ee(window.location.search),{push:!1,force:!1})};return window.addEventListener("popstate",p),D(),i.loadDirectory(ee(window.location.search),{push:!1,force:!0}),()=>{window.removeEventListener("popstate",p),T.stopAllPolling()}},[]),t.jsxs(Fe,{actions:[{href:"/search",label:"搜索",icon:t.jsx(F,{name:"search",size:18})}],hideHeaderTitle:!0,children:[t.jsx("div",{className:"grid gap-4",children:t.jsxs(Ue,{className:"grid min-w-0 gap-4 p-4",children:[t.jsx(dt,{currentPath:i.currentPath,breadcrumbParts:i.breadcrumbParts,directoryCount:i.directories.length,status:i.status,selectedCount:i.selectedCount,fileCount:i.files.length,isMobile:f,folderName:e,onFolderNameChange:o,capabilities:b,importDisabledReason:S,onNavigate:p=>{i.loadDirectory(p,{push:!0,force:!1})},onUploadFiles:p=>{h.submitUploads(p)},onDeleteSelected:()=>{h.deleteSelected(Array.from(i.selectedPaths))},onRefresh:()=>{i.refreshCurrentDirectory()},onCreateFolder:()=>{h.createFolder(e,()=>{o("")})}}),t.jsx(lt,{items:_,isMobile:f,selectedPaths:i.selectedPaths,onSelectionChange:i.setSelection,knownDirectories:i.knownDirectories,capabilitiesImportEnabled:b.import_enabled,importDisabledReason:S,getRowActionState:h.rowActions.getRowActionState,onSetRowActionState:h.rowActions.setRowActionState,onClearRowActionState:h.rowActions.clearRowActionState,onBeginRename:h.rowActions.beginRename,onBeginMove:h.rowActions.beginMove,onApplyRename:p=>{h.rowActions.applyRename(p)},onApplyMove:p=>{h.rowActions.applyMove(p)},onDeleteSingle:p=>{h.deleteSelected([p])},onOpenDirectory:p=>{i.loadDirectory(p,{push:!0,force:!1})}})]})}),t.jsx(it,{open:m,autoHideDuration:2800,onClose:()=>u(!1),anchorOrigin:{vertical:"top",horizontal:"right"},children:t.jsx(Le,{onClose:()=>u(!1),severity:h.actionFeedback?.phase==="error"?"error":h.actionFeedback?.phase==="pending"?"info":"success",variant:"filled",children:h.actionFeedback?.message||"操作完成"})})]})}Te.createRoot(document.getElementById("root")).render(t.jsx(ue.StrictMode,{children:t.jsx(De,{children:t.jsx(gt,{})})}));
