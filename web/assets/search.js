import{r as o,j as s,C as R,B as w,M as k,c as K,R as O,A as V}from"./chunks/AppProviders.js";import{A as X}from"./chunks/AppShell.js";import{s as $,n as f,B as Y,E as ee,c as se,f as C,b as B,a as te}from"./chunks/urlState.js";import{E as ae}from"./chunks/ErrorState.js";import{I as re}from"./chunks/Input.js";import{S as E}from"./chunks/Select.js";import{T as ne,a as ce,b as _,c as S}from"./chunks/Table.js";function U(a,n){const c=Number.parseInt(String(a??""),10);return Number.isFinite(c)&&c>0?c:Math.max(1,n)}function A(a,n){const c=Math.max(0,Number(a)||0),x=Math.max(1,Number(n)||1);return Math.max(1,Math.ceil(c/x))}function G(a,n){const c=Math.max(1,Number(a)||1),x=Math.max(1,Number(n)||1);return Math.min(c,x)}function ie(a,n,c){return Math.max(0,Number(c)||0)>0&&a!==n}const p=60;function oe(){const[a,n]=o.useState(()=>$(window.location.search)),[c,x]=o.useState([]),[z,N]=o.useState([]),[y,M]=o.useState(0),[D,H]=o.useState(p),[j,T]=o.useState(!1),[I,q]=o.useState(""),[J,b]=o.useState(""),L=o.useMemo(()=>{const e=new Set([""]);for(const t of c){const r=f(t.relative_dir||"");e.add(r)}return Array.from(e.values()).sort((t,r)=>t.localeCompare(r))},[c]),Q=o.useMemo(()=>{const e=a.source_dir;return c.filter(t=>{const r=f(t.relative_dir||"");return!e||r===e})},[c,a.source_dir]),P=o.useMemo(()=>A(y,D),[y,D]),F=e=>{const t=te(e,p);history.replaceState({...e},"",t)},W=async()=>{const e=await C("/api/docs"),t=Array.isArray(e)?e:e.documents||[];x(t),n(r=>{const m=!r.source_dir||t.some(d=>f(d.relative_dir||"")===r.source_dir)?r.source_dir:"",l=t.filter(d=>{const h=f(d.relative_dir||"");return!m||h===m}),g=!r.source_pdf||l.some(d=>String(d.relative_path||d.pdf_name||"")===r.source_pdf)?r.source_pdf:"";return{...r,source_dir:m,source_pdf:g}})},v=async e=>{if(F(e),q(""),!e.q){N([]),M(0),b(""),n(e);return}T(!0),b("查询中...");try{const t=e.page;let r=B(e,p),i=await C(`/api/search?${r.toString()}`),m=Array.isArray(i.results)?i.results:[],l=Math.max(0,Number(i.total||0)),u=U(i.page_size,p),g=A(l,u);const d=G(t,g);if(ie(t,d,l)){const h={...e,page:d};F(h),r=B(h,p),i=await C(`/api/search?${r.toString()}`),m=Array.isArray(i.results)?i.results:[],l=Math.max(0,Number(i.total||0)),u=U(i.page_size,p),g=A(l,u),e=h}e={...e,page:G(e.page,g)},N(m),M(l),H(u),b(`match=${i.match||e.match}`),n(e)}catch(t){N([]),M(0),q(String(t?.message||t)),b("查询失败"),n(e)}finally{T(!1)}};o.useEffect(()=>{W().then(()=>v($(window.location.search)))},[]);const Z=async e=>{e.preventDefault(),await v({...a,q:a.q.trim(),page:1})};return s.jsx(X,{children:s.jsxs("div",{className:"grid gap-4 min-w-0",children:[s.jsx(R,{children:s.jsxs("form",{className:"grid gap-3",onSubmit:Z,children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(re,{value:a.q,onChange:e=>n(t=>({...t,q:e.target.value})),className:"h-11 flex-1",placeholder:"输入件号或术语关键字","aria-label":"搜索关键字"}),s.jsx(w,{variant:"primary",className:"h-11 gap-2 px-5",type:"submit",disabled:j,startIcon:s.jsx(k,{name:"search",size:18}),children:j?"查询中":"搜索"})]}),s.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-5",children:[s.jsxs("label",{className:"grid gap-1 text-xs text-muted",children:["匹配模式",s.jsxs(E,{value:a.match,onChange:e=>n(t=>({...t,match:e.target.value})),children:[s.jsx("option",{value:"pn",children:"件号"}),s.jsx("option",{value:"term",children:"术语"}),s.jsx("option",{value:"all",children:"全部"})]})]}),s.jsxs("label",{className:"grid gap-1 text-xs text-muted",children:["来源目录",s.jsx(E,{value:a.source_dir,onChange:e=>n(t=>({...t,source_dir:f(e.target.value),source_pdf:""})),children:L.map(e=>s.jsx("option",{value:e,children:e||"全部目录"},e||"root"))})]}),s.jsxs("label",{className:"grid gap-1 text-xs text-muted",children:["来源文档",s.jsxs(E,{value:a.source_pdf,onChange:e=>n(t=>({...t,source_pdf:e.target.value.trim()})),children:[s.jsx("option",{value:"",children:"全部文档"}),Q.map(e=>{const t=String(e.relative_path||e.pdf_name||""),r=String(e.pdf_name||t);return s.jsx("option",{value:t,children:r},t)})]})]}),s.jsxs("label",{className:"flex items-center gap-2 self-end rounded-md border border-border bg-surface px-3 py-2 text-sm text-text",children:[s.jsx("input",{type:"checkbox",checked:a.include_notes,onChange:e=>n(t=>({...t,include_notes:e.target.checked}))}),"包含备注行"]}),s.jsx("div",{className:"flex items-end justify-start xl:justify-end",children:s.jsxs(Y,{variant:"neutral",className:"h-10 items-center",children:[s.jsx(k,{name:"tune",size:16,sx:{mr:.5}}),"总计 ",y," 条"]})})]})]})}),s.jsxs(R,{children:[s.jsxs("div",{className:"mb-3 flex items-center justify-between gap-3",children:[s.jsx("div",{className:"text-sm text-muted",children:J||"等待查询"}),s.jsxs("div",{className:"text-sm text-muted",children:["第 ",a.page," / ",P," 页"]})]}),I?s.jsx(ae,{message:I}):z.length===0?s.jsx(ee,{title:a.q?"暂无结果":"请输入查询词"}):s.jsx(ne,{children:s.jsxs(ce,{children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx(_,{children:"件号"}),s.jsx(_,{children:"来源 PDF"}),s.jsx(_,{children:"页码"}),s.jsx(_,{children:"术语摘要"})]})}),s.jsx("tbody",{children:z.map(e=>{const t=se(a).toString(),r=`/part/${encodeURIComponent(String(e.id))}${t?`?${t}`:""}`,i=String(e.part_number_canonical||e.part_number_cell||"-"),m=String(e.source_relative_path||e.source_pdf||"-"),l=String(e.page_num??"-"),u=String(e.nomenclature_preview||"");return s.jsxs("tr",{className:"cursor-pointer transition-colors duration-fast ease-premium hover:bg-surface-soft",onClick:()=>{window.location.href=r},children:[s.jsx(S,{className:"font-mono text-[13px]",children:i}),s.jsx(S,{className:"max-w-[320px] whitespace-nowrap overflow-hidden text-ellipsis",children:m}),s.jsx(S,{className:"font-mono text-[13px]",children:l}),s.jsx(S,{className:"max-w-[520px] whitespace-nowrap overflow-hidden text-ellipsis",children:u})]},e.id)})})]})}),s.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[s.jsx(w,{variant:"ghost",disabled:a.page<=1||j,onClick:()=>{v({...a,page:Math.max(1,a.page-1)})},children:"上一页"}),s.jsx(w,{variant:"ghost",disabled:a.page>=P||j,onClick:()=>{v({...a,page:Math.min(P,a.page+1)})},children:"下一页"})]})]})]})})}K.createRoot(document.getElementById("root")).render(s.jsx(O.StrictMode,{children:s.jsx(V,{children:s.jsx(oe,{})})}));
