import{r as o,j as e,M as U,R as $,c as B,A as H}from"./chunks/AppProviders.js";import{s as I,A as Q,E as D,b as k,f as q,c as G,a as J}from"./chunks/urlState.js";import{C as _,B as P}from"./chunks/Card.js";import{E as L,r as Z}from"./chunks/keyword.js";import{I as K}from"./chunks/Input.js";function T(t,s){const c=Number.parseInt(String(t??""),10);return Number.isFinite(c)&&c>0?c:Math.max(1,s)}function E(t,s){const c=Math.max(0,Number(t)||0),l=Math.max(1,Number(s)||1);return Math.max(1,Math.ceil(c/l))}function F(t,s){const c=Math.max(1,Number(t)||1),l=Math.max(1,Number(s)||1);return Math.min(c,l)}function V(t,s,c){return Math.max(0,Number(c)||0)>0&&t!==s}const m=60,W=[{value:"all",label:"全部"},{value:"pn",label:"按件号查询"},{value:"term",label:"按术语查询"}],X=[{value:"relevance",label:"按相关性排序"},{value:"name",label:"按名称排序"}];function Y(){const[t,s]=o.useState(()=>I(window.location.search)),[c,l]=o.useState([]),[u,x]=o.useState(0),[g,f]=o.useState(m),[i,d]=o.useState(!1),[p,C]=o.useState(""),v=o.useMemo(()=>E(u,g),[u,g]),N=a=>{const r=J(a,m);history.replaceState({...a},"",r)},h=async a=>{if(N(a),C(""),s(a),!a.q){l([]),x(0);return}d(!0);try{const r=a.page;let S=k(a,m),n=await q(`/api/search?${S.toString()}`),w=Array.isArray(n.results)?n.results:[],b=Math.max(0,Number(n.total||0)),j=T(n.page_size,m),y=E(b,j);const A=F(r,y);if(V(r,A,b)){const M={...a,page:A};N(M),S=k(M,m),n=await q(`/api/search?${S.toString()}`),w=Array.isArray(n.results)?n.results:[],b=Math.max(0,Number(n.total||0)),j=T(n.page_size,m),y=E(b,j),a=M}const z={...a,page:F(a.page,y),sort:n.sort||a.sort};l(w),x(b),f(j),s(z),N(z)}catch(r){l([]),x(0),C(String(r?.message||r))}finally{d(!1)}};o.useEffect(()=>{h(I(window.location.search))},[]);const O=async a=>{a.preventDefault();const r={...t,q:t.q.trim(),page:1};await h(r)},R=a=>{const r={...t,...a,page:1};h(r)};return e.jsx(Q,{children:e.jsxs("div",{className:"grid gap-4 min-w-0",children:[e.jsx(_,{className:"border border-border bg-surface px-5 py-4",children:e.jsxs("form",{className:"flex items-center gap-3",onSubmit:O,children:[e.jsx(K,{value:t.q,onChange:a=>s(r=>({...r,q:a.target.value})),className:"h-12 flex-1",placeholder:"输入件号或术语关键字","aria-label":"搜索关键字"}),e.jsx(P,{variant:"primary",className:"h-12 min-w-[126px] gap-2 px-6",type:"submit",disabled:i,startIcon:e.jsx(U,{name:"search",size:18}),children:i?"查询中":"搜索"})]})}),e.jsxs("div",{className:"grid min-w-0 grid-cols-[280px_minmax(0,1fr)] gap-4",children:[e.jsxs(_,{className:"border border-border bg-surface p-4",children:[e.jsx("div",{className:"mb-2 text-xs font-semibold uppercase tracking-wider text-muted",children:"查询模式"}),e.jsx("div",{className:"grid gap-2",children:W.map(a=>{const r=t.match===a.value;return e.jsx("button",{type:"button",disabled:i,className:`h-10 rounded-lg border px-3 text-left text-sm font-medium transition-colors ${r?"border-accent bg-accent-soft text-accent":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>R({match:a.value}),children:a.label},a.value)})}),e.jsx("div",{className:"my-4 border-t border-border"}),e.jsx("div",{className:"mb-2 text-xs font-semibold uppercase tracking-wider text-muted",children:"排序方式"}),e.jsx("div",{className:"grid gap-2",children:X.map(a=>{const r=t.sort===a.value;return e.jsx("button",{type:"button",disabled:i,className:`h-10 rounded-lg border px-3 text-left text-sm font-medium transition-colors ${r?"border-accent bg-accent-soft text-accent":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>R({sort:a.value}),children:a.label},a.value)})})]}),e.jsxs(_,{className:"border border-border bg-surface p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-5 py-4",children:[e.jsxs("div",{className:"text-sm text-muted",children:["共找到 ",u," 条结果"]}),e.jsxs("div",{className:"text-sm text-muted",children:["第 ",t.page," / ",v," 页"]})]}),p?e.jsx("div",{className:"p-5",children:e.jsx(L,{message:p})}):c.length===0?e.jsx("div",{className:"p-5",children:e.jsx(D,{title:t.q?"暂无结果":"请输入查询词"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"divide-y divide-border",children:c.map(a=>e.jsx(ee,{row:a,state:t},a.id))}),v>1?e.jsxs("div",{className:"flex items-center justify-between border-t border-border px-5 py-4",children:[e.jsx(P,{variant:"ghost",disabled:t.page<=1||i,onClick:()=>{h({...t,page:Math.max(1,t.page-1)})},children:"上一页"}),e.jsx(P,{variant:"ghost",disabled:t.page>=v||i,onClick:()=>{h({...t,page:Math.min(v,t.page+1)})},children:"下一页"})]}):null]})]})]})]})})}function ee({row:t,state:s}){const c=G(s).toString(),l=`/part/${encodeURIComponent(String(t.id))}${c?`?${c}`:""}`,u=String(t.part_number_canonical||t.part_number_cell||"-"),x=String(t.source_relative_path||t.source_pdf||"-"),g=String(t.page_num??"-"),f=String((s.match==="pn"?t.nomenclature_preview:t.nomenclature_hit_snippet||t.nomenclature_preview)||"-"),i=s.match==="pn"?[{text:f,hit:!1}]:Z(f,s.q);return e.jsxs("a",{href:l,className:"block px-5 py-4 transition-colors hover:bg-surface-soft",children:[e.jsxs("div",{className:"mb-2 flex items-center gap-3",children:[e.jsx("div",{className:"font-mono text-[17px] font-semibold text-text",children:u}),e.jsx("div",{className:"rounded-full bg-accent-soft px-2.5 py-0.5 text-xs font-medium text-accent",children:s.match==="pn"?"件号匹配":s.match==="term"?"术语匹配":"综合匹配"})]}),e.jsx("p",{className:"mb-2 max-h-[5.4rem] overflow-hidden text-sm leading-6 text-text",children:i.map((d,p)=>d.hit?e.jsx("mark",{className:"rounded bg-accent-soft px-1 text-text",children:d.text},p):e.jsx($.Fragment,{children:d.text},p))}),e.jsxs("div",{className:"text-xs text-muted",children:["来源: ",x," · 页码: ",g]})]})}B.createRoot(document.getElementById("root")).render(e.jsx($.StrictMode,{children:e.jsx(H,{children:e.jsx(Y,{})})}));
