import{r as l,j as e,M as Q,R as U,c as W,A as B}from"./chunks/AppProviders.js";import{s as F,E as D,b as z,f as I,c as G,a as J}from"./chunks/urlState.js";import{E as Z,r as K}from"./chunks/keyword.js";function $(t,s){const a=Number.parseInt(String(t??""),10);return Number.isFinite(a)&&a>0?a:Math.max(1,s)}function A(t,s){const a=Math.max(0,Number(t)||0),c=Math.max(1,Number(s)||1);return Math.max(1,Math.ceil(a/c))}function O(t,s){const a=Math.max(1,Number(t)||1),c=Math.max(1,Number(s)||1);return Math.min(a,c)}function V(t,s,a){return Math.max(0,Number(a)||0)>0&&t!==s}const h=10,X=[{value:"all",label:"全部"},{value:"pn",label:"按件号查询"},{value:"term",label:"按术语查询"}],Y=[{value:"relevance",label:"按相关性排序"},{value:"name",label:"按名称排序"}];function ee(t,s,a=10){if(s<=0)return[];if(s<=a)return Array.from({length:s},(g,u)=>u+1);const c=Math.floor(a/2);let o=Math.max(1,t-c),i=o+a-1;return i>s&&(i=s,o=Math.max(1,i-a+1)),Array.from({length:i-o+1},(g,u)=>o+u)}function te(){const[t,s]=l.useState(()=>F(window.location.search)),[a,c]=l.useState([]),[o,i]=l.useState(0),[g,u]=l.useState(h),[x,N]=l.useState(!1),[b,f]=l.useState(""),m=l.useRef(0),M=l.useRef(null),p=l.useMemo(()=>A(o,g),[o,g]),L=l.useMemo(()=>ee(t.page,p,10),[t.page,p]),_=r=>{const n=J(r,h);history.replaceState({...r},"",n)},v=async r=>{const n=m.current+1;m.current=n,M.current?.abort();const P=new AbortController;if(M.current=P,_(r),f(""),s(r),!r.q){if(n!==m.current)return;N(!1),c([]),i(0),u(h);return}N(!0);try{const j=r.page;let E=z(r,h),d=await I(`/api/search?${E.toString()}`,{signal:P.signal});if(n!==m.current)return;let C=Array.isArray(d.results)?d.results:[],y=Math.max(0,Number(d.total||0)),S=$(d.page_size,h),R=A(y,S);const k=O(j,R);if(V(j,k,y)){const w={...r,page:k};if(_(w),E=z(w,h),d=await I(`/api/search?${E.toString()}`,{signal:P.signal}),n!==m.current)return;C=Array.isArray(d.results)?d.results:[],y=Math.max(0,Number(d.total||0)),S=$(d.page_size,h),R=A(y,S),r=w}const T={...r,page:O(r.page,R),sort:d.sort||r.sort};c(C),i(y),u(S),s(T),_(T)}catch(j){if(j?.name==="AbortError"||n!==m.current)return;c([]),i(0),f(String(j?.message||j))}finally{n===m.current&&N(!1)}};l.useEffect(()=>(v(F(window.location.search)),()=>{M.current?.abort()}),[]);const H=async r=>{r.preventDefault();const n={...t,q:t.q.trim(),page:1};await v(n)},q=r=>{const n={...t,...r,page:1};v(n)};return e.jsxs("main",{className:"min-h-screen bg-bg text-text",children:[e.jsx("header",{className:"border-b border-border bg-surface",children:e.jsxs("div",{className:"mx-auto grid h-16 w-full max-w-[1360px] grid-cols-[1fr_minmax(0,760px)_1fr] items-center gap-5 px-6",children:[e.jsx("div",{}),e.jsxs("form",{onSubmit:H,className:"flex h-11 min-w-0 items-center rounded-full border border-border bg-surface px-3",children:[e.jsx("input",{value:t.q,onChange:r=>s(n=>({...n,q:r.target.value})),className:"h-full min-w-0 flex-1 border-none bg-transparent px-2 text-base text-text placeholder:text-muted focus:outline-none",placeholder:"输入件号 / 术语...","aria-label":"搜索关键字"}),e.jsx("button",{type:"submit",className:"inline-flex h-9 w-9 shrink-0 items-center justify-center rounded-full bg-accent text-white transition-colors hover:bg-accent-hover","aria-label":"开始搜索",disabled:x,children:e.jsx(Q,{name:"search",size:18})})]}),e.jsx("div",{className:"justify-self-end",children:e.jsx("a",{href:"/db.html",className:"inline-flex h-10 items-center justify-center px-2 text-sm font-semibold text-text transition-colors hover:text-accent",children:"数据库"})})]})}),e.jsxs("div",{className:"mx-auto grid w-full max-w-[1360px] grid-cols-[250px_minmax(0,1fr)] gap-8 px-6 py-8",children:[e.jsxs("aside",{className:"pt-1",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-text",children:"查询模式"}),e.jsx("div",{className:"grid gap-2",children:X.map(r=>{const n=t.match===r.value;return e.jsx("button",{type:"button",disabled:x,className:`h-10 rounded-lg border px-3 text-left text-sm font-medium transition-colors ${n?"border-accent bg-accent-soft text-accent":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>q({match:r.value}),children:r.label},r.value)})}),e.jsx("div",{className:"my-6 border-t border-border"}),e.jsx("div",{className:"mb-3 text-sm font-semibold text-text",children:"排序方式"}),e.jsx("div",{className:"grid gap-2",children:Y.map(r=>{const n=t.sort===r.value;return e.jsx("button",{type:"button",disabled:x,className:`h-10 rounded-lg border px-3 text-left text-sm font-medium transition-colors ${n?"border-accent bg-accent-soft text-accent":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>q({sort:r.value}),children:r.label},r.value)})})]}),e.jsxs("section",{className:"min-w-0",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-muted",children:["共找到 ",o," 条结果"]}),e.jsxs("div",{className:"text-sm text-muted",children:["第 ",t.page," / ",p," 页"]})]}),b?e.jsx(Z,{message:b}):a.length===0?e.jsx(D,{title:t.q?"暂无结果":"请输入查询词"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"divide-y divide-border border-y border-border bg-surface",children:a.map(r=>e.jsx(re,{row:r,state:t},r.id))}),p>1?e.jsxs("div",{className:"mt-6 flex items-center justify-center gap-2",children:[e.jsx("button",{type:"button",disabled:t.page<=1||x,className:"inline-flex h-10 items-center rounded-full border border-border bg-surface px-4 text-sm text-text disabled:opacity-40",onClick:()=>{v({...t,page:Math.max(1,t.page-1)})},children:"上一页"}),L.map(r=>{const n=r===t.page;return e.jsx("button",{type:"button",className:`inline-flex h-10 w-10 items-center justify-center rounded-full border text-sm font-semibold ${n?"border-accent bg-accent text-white":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>{r!==t.page&&v({...t,page:r})},children:r},r)}),e.jsx("button",{type:"button",disabled:t.page>=p||x,className:"inline-flex h-10 items-center rounded-full border border-border bg-surface px-4 text-sm text-text disabled:opacity-40",onClick:()=>{v({...t,page:Math.min(p,t.page+1)})},children:"下一页"})]}):null]})]})]})]})}function re({row:t,state:s}){const a=G(s).toString(),c=new URLSearchParams;c.set("id",String(t.id)),a&&new URLSearchParams(a).forEach((f,m)=>c.set(m,f));const o=`/part.html?${c.toString()}`,i=String(t.part_number_canonical||t.part_number_cell||"-"),g=String(t.source_relative_path||t.source_pdf||"-"),u=String(t.page_num??"-"),x=String((s.match==="pn"?t.nomenclature_preview:t.nomenclature_hit_snippet||t.nomenclature_preview)||"-"),N=s.match==="pn"?[{text:x,hit:!1}]:K(x,s.q);return e.jsxs("a",{href:o,className:"block px-4 py-4 transition-colors hover:bg-surface-soft",children:[e.jsx("div",{className:"mb-2 font-mono text-[26px] text-base font-semibold text-text",children:i}),e.jsx("p",{className:"mb-2 max-h-[5.4rem] overflow-hidden text-sm leading-6 text-text",children:N.map((b,f)=>b.hit?e.jsx("mark",{className:"rounded bg-accent-soft px-1 text-text",children:b.text},f):e.jsx(U.Fragment,{children:b.text},f))}),e.jsxs("div",{className:"text-xs text-muted",children:["来源 ",g," · 页码 ",u]})]})}W.createRoot(document.getElementById("root")).render(e.jsx(U.StrictMode,{children:e.jsx(B,{children:e.jsx(te,{})})}));
