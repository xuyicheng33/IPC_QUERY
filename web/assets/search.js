import{r as d,j as e,M as O,R as z,c as U,A as L}from"./chunks/AppProviders.js";import{E as H,f as C}from"./chunks/api.js";import{E as Q,r as W}from"./chunks/keyword.js";import{s as k,b as q,c as B,a as D}from"./chunks/urlState.js";function T(t,s){const r=Number.parseInt(String(t??""),10);return Number.isFinite(r)&&r>0?r:Math.max(1,s)}function P(t,s){const r=Math.max(0,Number(t)||0),c=Math.max(1,Number(s)||1);return Math.max(1,Math.ceil(r/c))}function F(t,s){const r=Math.max(1,Number(t)||1),c=Math.max(1,Number(s)||1);return Math.min(r,c)}function G(t,s,r){return Math.max(0,Number(r)||0)>0&&t!==s}const g=10,J=[{value:"all",label:"全部"},{value:"pn",label:"按件号查询"},{value:"term",label:"按术语查询"}],Z=[{value:"relevance",label:"按相关性排序"},{value:"name",label:"按名称排序"}];function K(t,s,r=10){if(s<=0)return[];if(s<=r)return Array.from({length:s},(f,x)=>x+1);const c=Math.floor(r/2);let l=Math.max(1,t-c),o=l+r-1;return o>s&&(o=s,l=Math.max(1,o-r+1)),Array.from({length:o-l+1},(f,x)=>l+x)}function V(){const[t,s]=d.useState(()=>k(window.location.search)),[r,c]=d.useState([]),[l,o]=d.useState(0),[f,x]=d.useState(g),[m,j]=d.useState(!1),[b,h]=d.useState(""),u=d.useMemo(()=>P(l,f),[l,f]),$=d.useMemo(()=>K(t.page,u,10),[t.page,u]),y=a=>{const n=D(a,g);history.replaceState({...a},"",n)},p=async a=>{if(y(a),h(""),s(a),!a.q){c([]),o(0);return}j(!0);try{const n=a.page;let S=q(a,g),i=await C(`/api/search?${S.toString()}`),w=Array.isArray(i.results)?i.results:[],v=Math.max(0,Number(i.total||0)),N=T(i.page_size,g),M=P(v,N);const R=F(n,M);if(G(n,R,v)){const _={...a,page:R};y(_),S=q(_,g),i=await C(`/api/search?${S.toString()}`),w=Array.isArray(i.results)?i.results:[],v=Math.max(0,Number(i.total||0)),N=T(i.page_size,g),M=P(v,N),a=_}const A={...a,page:F(a.page,M),sort:i.sort||a.sort};c(w),o(v),x(N),s(A),y(A)}catch(n){c([]),o(0),h(String(n?.message||n))}finally{j(!1)}};d.useEffect(()=>{p(k(window.location.search))},[]);const I=async a=>{a.preventDefault();const n={...t,q:t.q.trim(),page:1};await p(n)},E=a=>{const n={...t,...a,page:1};p(n)};return e.jsxs("main",{className:"min-h-screen bg-bg text-text",children:[e.jsx("header",{className:"border-b border-border bg-surface",children:e.jsxs("div",{className:"mx-auto grid h-16 w-full max-w-[1360px] grid-cols-[1fr_minmax(0,760px)_1fr] items-center gap-5 px-6",children:[e.jsx("div",{}),e.jsxs("form",{onSubmit:I,className:"flex h-11 min-w-0 items-center rounded-full border border-border bg-surface px-3",children:[e.jsx("input",{value:t.q,onChange:a=>s(n=>({...n,q:a.target.value})),className:"h-full min-w-0 flex-1 border-none bg-transparent px-2 text-base text-text placeholder:text-muted focus:outline-none",placeholder:"输入件号 / 术语...","aria-label":"搜索关键字"}),e.jsx("button",{type:"submit",className:"inline-flex h-9 w-9 shrink-0 items-center justify-center rounded-full bg-accent text-white transition-colors hover:bg-accent-hover","aria-label":"开始搜索",disabled:m,children:e.jsx(O,{name:"search",size:18})})]}),e.jsx("div",{className:"justify-self-end",children:e.jsx("a",{href:"/db.html",className:"inline-flex h-10 items-center justify-center px-2 text-sm font-semibold text-text transition-colors hover:text-accent",children:"数据库"})})]})}),e.jsxs("div",{className:"mx-auto grid w-full max-w-[1360px] grid-cols-[250px_minmax(0,1fr)] gap-8 px-6 py-8",children:[e.jsxs("aside",{className:"pt-1",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-text",children:"查询模式"}),e.jsx("div",{className:"grid gap-2",children:J.map(a=>{const n=t.match===a.value;return e.jsx("button",{type:"button",disabled:m,className:`h-10 rounded-lg border px-3 text-left text-sm font-medium transition-colors ${n?"border-accent bg-accent-soft text-accent":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>E({match:a.value}),children:a.label},a.value)})}),e.jsx("div",{className:"my-6 border-t border-border"}),e.jsx("div",{className:"mb-3 text-sm font-semibold text-text",children:"排序方式"}),e.jsx("div",{className:"grid gap-2",children:Z.map(a=>{const n=t.sort===a.value;return e.jsx("button",{type:"button",disabled:m,className:`h-10 rounded-lg border px-3 text-left text-sm font-medium transition-colors ${n?"border-accent bg-accent-soft text-accent":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>E({sort:a.value}),children:a.label},a.value)})})]}),e.jsxs("section",{className:"min-w-0",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-muted",children:["共找到 ",l," 条结果"]}),e.jsxs("div",{className:"text-sm text-muted",children:["第 ",t.page," / ",u," 页"]})]}),b?e.jsx(Q,{message:b}):r.length===0?e.jsx(H,{title:t.q?"暂无结果":"请输入查询词"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"divide-y divide-border border-y border-border bg-surface",children:r.map(a=>e.jsx(X,{row:a,state:t},a.id))}),u>1?e.jsxs("div",{className:"mt-6 flex items-center justify-center gap-2",children:[e.jsx("button",{type:"button",disabled:t.page<=1||m,className:"inline-flex h-10 items-center rounded-full border border-border bg-surface px-4 text-sm text-text disabled:opacity-40",onClick:()=>{p({...t,page:Math.max(1,t.page-1)})},children:"上一页"}),$.map(a=>{const n=a===t.page;return e.jsx("button",{type:"button",className:`inline-flex h-10 w-10 items-center justify-center rounded-full border text-sm font-semibold ${n?"border-accent bg-accent text-white":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>{a!==t.page&&p({...t,page:a})},children:a},a)}),e.jsx("button",{type:"button",disabled:t.page>=u||m,className:"inline-flex h-10 items-center rounded-full border border-border bg-surface px-4 text-sm text-text disabled:opacity-40",onClick:()=>{p({...t,page:Math.min(u,t.page+1)})},children:"下一页"})]}):null]})]})]})]})}function X({row:t,state:s}){const r=B(s).toString(),c=new URLSearchParams;c.set("id",String(t.id)),r&&new URLSearchParams(r).forEach((h,u)=>c.set(u,h));const l=`/part.html?${c.toString()}`,o=String(t.part_number_canonical||t.part_number_cell||"-"),f=String(t.source_relative_path||t.source_pdf||"-"),x=String(t.page_num??"-"),m=String((s.match==="pn"?t.nomenclature_preview:t.nomenclature_hit_snippet||t.nomenclature_preview)||"-"),j=s.match==="pn"?[{text:m,hit:!1}]:W(m,s.q);return e.jsxs("a",{href:l,className:"block px-4 py-4 transition-colors hover:bg-surface-soft",children:[e.jsx("div",{className:"mb-2 font-mono text-[26px] text-base font-semibold text-text",children:o}),e.jsx("p",{className:"mb-2 max-h-[5.4rem] overflow-hidden text-sm leading-6 text-text",children:j.map((b,h)=>b.hit?e.jsx("mark",{className:"rounded bg-accent-soft px-1 text-text",children:b.text},h):e.jsx(z.Fragment,{children:b.text},h))}),e.jsxs("div",{className:"text-xs text-muted",children:["来源 ",f," · 页码 ",x]})]})}U.createRoot(document.getElementById("root")).render(e.jsx(z.StrictMode,{children:e.jsx(L,{children:e.jsx(V,{})})}));
