import{c as W,r as o,j as s,C as S,B as q,a as oe,R as ie}from"./chunks/Card.js";import{s as U,n as g,A as le,S as de,c as Q,b as G,a as ue}from"./chunks/urlState.js";import{B as me,E as he,f as E}from"./chunks/api.js";import{E as pe}from"./chunks/ErrorState.js";import{I as xe}from"./chunks/Input.js";import{S as I}from"./chunks/Select.js";import{T as ge,a as fe,b as _,c as v}from"./chunks/Table.js";import{m as je,r as be,a as _e,w as ve,b as Ne}from"./chunks/storageCompat.js";const ye=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],Se=W("funnel",ye);const we=[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]],Me=W("star",we);function J(a,c){const i=Number.parseInt(String(a??""),10);return Number.isFinite(i)&&i>0?i:Math.max(1,c)}function F(a,c){const i=Math.max(0,Number(a)||0),j=Math.max(1,Number(c)||1);return Math.max(1,Math.ceil(i/j))}function K(a,c){const i=Math.max(1,Number(a)||1),j=Math.max(1,Number(c)||1);return Math.min(i,j)}function $e(a,c,i){return Math.max(0,Number(i)||0)>0&&a!==c}const f=60;function V(a){return`${a.q}|${a.match}|${a.include_notes?1:0}|${a.source_dir}|${a.source_pdf}`}function Ce(){const[a,c]=o.useState(()=>U(window.location.search)),[i,j]=o.useState([]),[k,w]=o.useState([]),[M,$]=o.useState(0),[A,Z]=o.useState(f),[N,D]=o.useState(!1),[T,z]=o.useState(""),[O,y]=o.useState(""),[C,H]=o.useState([]),[p,L]=o.useState([]);o.useEffect(()=>{je(),H(be()),L(_e())},[]);const X=o.useMemo(()=>{const e=new Set([""]);for(const t of i){const r=g(t.relative_dir||"");e.add(r)}return Array.from(e.values()).sort((t,r)=>t.localeCompare(r))},[i]),Y=o.useMemo(()=>{const e=a.source_dir;return i.filter(t=>{const r=g(t.relative_dir||"");return!e||r===e})},[i,a.source_dir]),P=o.useMemo(()=>F(M,A),[M,A]),R=e=>{const t=ue(e,f);history.replaceState({...e},"",t)},ee=async()=>{const e=await E("/api/docs"),t=Array.isArray(e)?e:e.documents||[];j(t),c(r=>{const d=!r.source_dir||t.some(l=>g(l.relative_dir||"")===r.source_dir)?r.source_dir:"",u=t.filter(l=>{const x=g(l.relative_dir||"");return!d||x===d}),h=!r.source_pdf||u.some(l=>String(l.relative_path||l.pdf_name||"")===r.source_pdf)?r.source_pdf:"";return{...r,source_dir:d,source_pdf:h}})},se=e=>{H(e),Ne(e)},B=e=>{L(e),ve(e)},te=e=>{if(!e.q)return;const t={q:e.q,match:e.match,include_notes:!!e.include_notes,source_dir:e.source_dir||"",source_pdf:e.source_pdf||"",ts:Date.now()},r=V(t),n=[t,...C.filter(d=>V(d)!==r)].slice(0,30);se(n)},ae=e=>p.some(t=>Number(t.id)===Number(e)),re=e=>{const t=p.findIndex(n=>Number(n.id)===Number(e.id));if(t>=0){const n=[...p];n.splice(t,1),B(n);return}const r=[{id:Number(e.id),pn:String(e.part_number_canonical||e.part_number_cell||"-"),source:String(e.source_relative_path||e.source_pdf||"-"),page:Number(e.page_num||0)},...p].slice(0,200);B(r)},b=async e=>{if(R(e),z(""),!e.q){w([]),$(0),y(""),c(e);return}D(!0),y("查询中...");try{const t=e.page;let r=G(e,f),n=await E(`/api/search?${r.toString()}`),d=Array.isArray(n.results)?n.results:[],u=Math.max(0,Number(n.total||0)),m=J(n.page_size,f),h=F(u,m);const l=K(t,h);if($e(t,l,u)){const x={...e,page:l};R(x),r=G(x,f),n=await E(`/api/search?${r.toString()}`),d=Array.isArray(n.results)?n.results:[],u=Math.max(0,Number(n.total||0)),m=J(n.page_size,f),h=F(u,m),e=x}e={...e,page:K(e.page,h)},w(d),$(u),Z(m),y(`match=${n.match||e.match}`),c(e),te(e)}catch(t){w([]),$(0),z(String(t?.message||t)),y("查询失败"),c(e)}finally{D(!1)}};o.useEffect(()=>{ee().then(()=>b(U(window.location.search)))},[]);const ne=async e=>{e.preventDefault(),await b({...a,q:a.q.trim(),page:1})},ce=async e=>{const t={q:String(e.q||"").trim(),match:e.match,page:1,include_notes:!!e.include_notes,source_dir:g(e.source_dir||""),source_pdf:String(e.source_pdf||"")};await b(t)};return s.jsx(le,{children:s.jsxs("div",{className:"grid gap-4 min-w-0",children:[s.jsx(S,{children:s.jsxs("form",{className:"grid gap-3",onSubmit:ne,children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(xe,{value:a.q,onChange:e=>c(t=>({...t,q:e.target.value})),className:"h-11 flex-1",placeholder:"输入件号或术语关键字","aria-label":"搜索关键字"}),s.jsxs(q,{variant:"primary",className:"h-11 gap-2 px-5",type:"submit",disabled:N,children:[s.jsx(de,{className:"h-4 w-4","aria-hidden":"true"}),N?"查询中":"搜索"]})]}),s.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-5",children:[s.jsxs("label",{className:"grid gap-1 text-xs text-muted",children:["匹配模式",s.jsxs(I,{value:a.match,onChange:e=>c(t=>({...t,match:e.target.value})),children:[s.jsx("option",{value:"pn",children:"件号"}),s.jsx("option",{value:"term",children:"术语"}),s.jsx("option",{value:"all",children:"全部"})]})]}),s.jsxs("label",{className:"grid gap-1 text-xs text-muted",children:["来源目录",s.jsx(I,{value:a.source_dir,onChange:e=>c(t=>({...t,source_dir:g(e.target.value),source_pdf:""})),children:X.map(e=>s.jsx("option",{value:e,children:e||"全部目录"},e||"root"))})]}),s.jsxs("label",{className:"grid gap-1 text-xs text-muted",children:["来源文档",s.jsxs(I,{value:a.source_pdf,onChange:e=>c(t=>({...t,source_pdf:e.target.value.trim()})),children:[s.jsx("option",{value:"",children:"全部文档"}),Y.map(e=>{const t=String(e.relative_path||e.pdf_name||""),r=String(e.pdf_name||t);return s.jsx("option",{value:t,children:r},t)})]})]}),s.jsxs("label",{className:"flex items-center gap-2 self-end rounded-md border border-border bg-surface px-3 py-2 text-sm text-text",children:[s.jsx("input",{type:"checkbox",checked:a.include_notes,onChange:e=>c(t=>({...t,include_notes:e.target.checked}))}),"包含备注行"]}),s.jsx("div",{className:"flex items-end justify-start xl:justify-end",children:s.jsxs(me,{variant:"neutral",className:"h-10 items-center",children:[s.jsx(Se,{className:"mr-1.5 h-3.5 w-3.5","aria-hidden":"true"}),"总计 ",M," 条"]})})]})]})}),s.jsxs(S,{children:[s.jsxs("div",{className:"mb-3 flex items-center justify-between gap-3",children:[s.jsx("div",{className:"text-sm text-muted",children:O||"等待查询"}),s.jsxs("div",{className:"text-sm text-muted",children:["第 ",a.page," / ",P," 页"]})]}),T?s.jsx(pe,{message:T}):k.length===0?s.jsx(he,{title:a.q?"暂无结果":"请输入查询词"}):s.jsx(ge,{children:s.jsxs(fe,{children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx(_,{children:"收藏"}),s.jsx(_,{children:"件号"}),s.jsx(_,{children:"来源 PDF"}),s.jsx(_,{children:"页码"}),s.jsx(_,{children:"术语摘要"})]})}),s.jsx("tbody",{children:k.map(e=>{const t=ae(Number(e.id)),r=Q(a).toString(),n=`/part/${encodeURIComponent(String(e.id))}${r?`?${r}`:""}`,d=String(e.part_number_canonical||e.part_number_cell||"-"),u=String(e.source_relative_path||e.source_pdf||"-"),m=String(e.page_num??"-"),h=String(e.nomenclature_preview||"");return s.jsxs("tr",{className:"cursor-pointer transition-colors duration-fast ease-premium hover:bg-surface-soft",onClick:()=>{window.location.href=n},children:[s.jsx(v,{className:"w-[72px]",children:s.jsx("button",{type:"button",className:"inline-flex h-8 w-8 items-center justify-center rounded-md border border-border bg-surface transition-colors duration-fast ease-premium hover:bg-accent-soft",onClick:l=>{l.stopPropagation(),re(e)},"aria-label":t?"取消收藏":"收藏",children:s.jsx(Me,{className:`h-4 w-4 ${t?"fill-accent text-accent":"text-muted"}`})})}),s.jsx(v,{className:"font-mono text-[13px]",children:d}),s.jsx(v,{className:"max-w-[320px] whitespace-nowrap overflow-hidden text-ellipsis",children:u}),s.jsx(v,{className:"font-mono text-[13px]",children:m}),s.jsx(v,{className:"max-w-[520px] whitespace-nowrap overflow-hidden text-ellipsis",children:h})]},e.id)})})]})}),s.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[s.jsx(q,{variant:"ghost",disabled:a.page<=1||N,onClick:()=>{b({...a,page:Math.max(1,a.page-1)})},children:"上一页"}),s.jsx(q,{variant:"ghost",disabled:a.page>=P||N,onClick:()=>{b({...a,page:Math.min(P,a.page+1)})},children:"下一页"})]})]}),s.jsxs("div",{className:"grid gap-4 lg:grid-cols-2",children:[s.jsxs(S,{children:[s.jsx("div",{className:"mb-2 text-sm font-medium",children:"搜索历史"}),C.length===0?s.jsx("p",{className:"text-sm text-muted",children:"暂无历史"}):s.jsx("div",{className:"grid gap-2",children:C.slice(0,12).map((e,t)=>{const r=e.include_notes?"含备注":"不含备注",n=[e.match,r,e.source_dir,e.source_pdf].filter(Boolean).join(" · ");return s.jsxs("button",{type:"button",className:"w-full rounded-md border border-border bg-surface px-3 py-2 text-left text-sm transition-colors duration-fast ease-premium hover:bg-surface-soft",onClick:()=>{ce(e)},children:[s.jsx("div",{className:"font-medium text-text",children:e.q}),s.jsx("div",{className:"text-xs text-muted",children:n})]},`${e.q}-${t}`)})})]}),s.jsxs(S,{children:[s.jsx("div",{className:"mb-2 text-sm font-medium",children:"收藏结果"}),p.length===0?s.jsx("p",{className:"text-sm text-muted",children:"暂无收藏"}):s.jsx("div",{className:"grid gap-2",children:p.slice(0,20).map(e=>{const t=Q(a).toString(),r=`/part/${encodeURIComponent(String(e.id))}${t?`?${t}`:""}`;return s.jsxs("a",{href:r,className:"rounded-md border border-border bg-surface px-3 py-2 text-sm transition-colors duration-fast ease-premium hover:bg-surface-soft",children:[s.jsx("div",{className:"font-medium text-text",children:e.pn}),s.jsxs("div",{className:"text-xs text-muted",children:[e.source," · p.",e.page||"-"]})]},e.id)})})]})]})]})})}oe.createRoot(document.getElementById("root")).render(s.jsx(ie.StrictMode,{children:s.jsx(Ce,{})}));
