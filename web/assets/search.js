import{r as l,j as r,D as B,M as F,R as D,c as G,A as J}from"./chunks/AppProviders.js";import{s as I,E as Z,b as $,f as O,c as K,a as V}from"./chunks/urlState.js";import{E as X,r as Y}from"./chunks/keyword.js";function U(t,s){const a=Number.parseInt(String(t??""),10);return Number.isFinite(a)&&a>0?a:Math.max(1,s)}function A(t,s){const a=Math.max(0,Number(t)||0),c=Math.max(1,Number(s)||1);return Math.max(1,Math.ceil(a/c))}function Q(t,s){const a=Math.max(1,Number(t)||1),c=Math.max(1,Number(s)||1);return Math.min(a,c)}function ee(t,s,a){return Math.max(0,Number(a)||0)>0&&t!==s}const g=10,te=[{value:"all",label:"全部"},{value:"pn",label:"按件号查询"},{value:"term",label:"按术语查询"}],re=[{value:"relevance",label:"按相关性排序"},{value:"name",label:"按名称排序"}];function se(t,s,a=10){if(s<=0)return[];if(s<=a)return Array.from({length:s},(p,x)=>x+1);const c=Math.floor(a/2);let o=Math.max(1,t-c),i=o+a-1;return i>s&&(i=s,o=Math.max(1,i-a+1)),Array.from({length:i-o+1},(p,x)=>o+x)}function ae(){const[t,s]=l.useState(()=>I(window.location.search)),[a,c]=l.useState([]),[o,i]=l.useState(0),[p,x]=l.useState(g),[m,N]=l.useState(!1),[b,f]=l.useState(""),u=l.useRef(0),_=l.useRef(null),v=l.useMemo(()=>A(o,p),[o,p]),L=l.useMemo(()=>se(t.page,v,10),[t.page,v]),H=t.q.trim().length>0,P=e=>{const n=V(e,g);history.replaceState({...e},"",n)},j=async e=>{const n=e.q.trim();n!==e.q&&(e={...e,q:n});const h=u.current+1;u.current=h,_.current?.abort();const q=new AbortController;if(_.current=q,P(e),f(""),s(e),!e.q){if(h!==u.current)return;N(!1),c([]),i(0),x(g);return}N(!0);try{const y=e.page;let E=$(e,g),d=await O(`/api/search?${E.toString()}`,{signal:q.signal});if(h!==u.current)return;let k=Array.isArray(d.results)?d.results:[],S=Math.max(0,Number(d.total||0)),M=U(d.page_size,g),R=A(S,M);const z=Q(y,R);if(ee(y,z,S)){const w={...e,page:z};if(P(w),E=$(w,g),d=await O(`/api/search?${E.toString()}`,{signal:q.signal}),h!==u.current)return;k=Array.isArray(d.results)?d.results:[],S=Math.max(0,Number(d.total||0)),M=U(d.page_size,g),R=A(S,M),e=w}const T={...e,page:Q(e.page,R),sort:d.sort||e.sort};c(k),i(S),x(M),s(T),P(T)}catch(y){if(y?.name==="AbortError"||h!==u.current)return;c([]),i(0),f(String(y?.message||y))}finally{h===u.current&&N(!1)}};l.useEffect(()=>(j(I(window.location.search)),()=>{_.current?.abort()}),[]);const W=async e=>{e.preventDefault();const n=t.q.trim();if(!n)return;const h={...t,q:n,page:1};await j(h)},C=e=>{const n={...t,...e,page:1};j(n)};return r.jsx(B,{actions:[{href:"/db.html",label:"数据库"}],contentClassName:"py-8",children:r.jsxs("div",{className:"grid gap-6",children:[r.jsxs("form",{onSubmit:W,className:"mx-auto flex h-11 w-full max-w-[760px] min-w-0 items-center rounded-full border border-border bg-surface px-3",children:[r.jsx("input",{id:"search-query-input",name:"q",value:t.q,onChange:e=>s(n=>({...n,q:e.target.value})),className:"h-full min-w-0 flex-1 border-none bg-transparent px-2 text-base text-text placeholder:text-muted focus:outline-none",placeholder:"输入件号 / 术语...","aria-label":"搜索关键字"}),r.jsx("button",{type:"submit",className:"inline-flex h-9 w-9 shrink-0 items-center justify-center rounded-full bg-accent text-white transition-colors hover:bg-accent-hover","aria-label":"开始搜索",disabled:!H||m,children:r.jsx(F,{name:"search",size:18})})]}),r.jsxs("div",{className:"grid w-full grid-cols-[250px_minmax(0,1fr)] gap-8",children:[r.jsxs("aside",{className:"pt-1",children:[r.jsx("div",{className:"mb-3 text-sm font-semibold text-text",children:"查询模式"}),r.jsx("div",{className:"grid gap-2",children:te.map(e=>{const n=t.match===e.value;return r.jsx("button",{type:"button",disabled:m,className:`h-10 rounded-lg border px-3 text-left text-sm font-medium transition-colors ${n?"border-accent bg-accent-soft text-accent":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>C({match:e.value}),children:e.label},e.value)})}),r.jsx("div",{className:"my-6 border-t border-border"}),r.jsx("div",{className:"mb-3 text-sm font-semibold text-text",children:"排序方式"}),r.jsx("div",{className:"grid gap-2",children:re.map(e=>{const n=t.sort===e.value;return r.jsx("button",{type:"button",disabled:m,className:`h-10 rounded-lg border px-3 text-left text-sm font-medium transition-colors ${n?"border-accent bg-accent-soft text-accent":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>C({sort:e.value}),children:e.label},e.value)})})]}),r.jsxs("section",{className:"min-w-0",children:[r.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[r.jsxs("div",{className:"text-sm text-muted",children:["共找到 ",o," 条结果"]}),r.jsxs("div",{className:"text-sm text-muted",children:["第 ",t.page," / ",v," 页"]})]}),m&&a.length===0&&!b?r.jsx("div",{className:"rounded-md border border-border bg-surface px-4 py-8 text-sm text-muted",children:r.jsxs("span",{className:"inline-flex items-center gap-2",children:[r.jsx(F,{name:"progress_activity",size:18,className:"animate-spin"}),"正在加载结果..."]})}):b?r.jsx(X,{message:b}):a.length===0?r.jsx(Z,{title:t.q?"暂无结果":"请输入查询词"}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"divide-y divide-border border-y border-border bg-surface",children:a.map(e=>r.jsx(ne,{row:e,state:t},e.id))}),v>1?r.jsxs("div",{className:"mt-6 flex items-center justify-center gap-2",children:[r.jsx("button",{type:"button",disabled:t.page<=1||m,className:"inline-flex h-10 items-center rounded-full border border-border bg-surface px-4 text-sm text-text disabled:opacity-40",onClick:()=>{j({...t,page:Math.max(1,t.page-1)})},children:"上一页"}),L.map(e=>{const n=e===t.page;return r.jsx("button",{type:"button",className:`inline-flex h-10 w-10 items-center justify-center rounded-full border text-sm font-semibold ${n?"border-accent bg-accent text-white":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>{e!==t.page&&j({...t,page:e})},children:e},e)}),r.jsx("button",{type:"button",disabled:t.page>=v||m,className:"inline-flex h-10 items-center rounded-full border border-border bg-surface px-4 text-sm text-text disabled:opacity-40",onClick:()=>{j({...t,page:Math.min(v,t.page+1)})},children:"下一页"})]}):null]})]})]})]})})}function ne({row:t,state:s}){const a=K(s).toString(),c=new URLSearchParams;c.set("id",String(t.id)),a&&new URLSearchParams(a).forEach((f,u)=>c.set(u,f));const o=`/part.html?${c.toString()}`,i=String(t.part_number_canonical||t.part_number_cell||"-"),p=String(t.source_relative_path||t.source_pdf||"-"),x=String(t.page_num??"-"),m=String((s.match==="pn"?t.nomenclature_preview:t.nomenclature_hit_snippet||t.nomenclature_preview)||"-"),N=s.match==="pn"?[{text:m,hit:!1}]:Y(m,s.q);return r.jsxs("a",{href:o,className:"block px-4 py-4 transition-colors hover:bg-surface-soft",children:[r.jsx("div",{className:"mb-2 font-mono text-[26px] font-semibold text-text",children:i}),r.jsx("p",{className:"mb-2 max-h-[5.4rem] overflow-hidden text-sm leading-6 text-text",children:N.map((b,f)=>b.hit?r.jsx("mark",{className:"kw-hit",children:b.text},f):r.jsx(D.Fragment,{children:b.text},f))}),r.jsxs("div",{className:"text-xs text-muted",children:["来源 ",p," · 页码 ",x]})]})}G.createRoot(document.getElementById("root")).render(r.jsx(D.StrictMode,{children:r.jsx(J,{children:r.jsx(ae,{})})}));
