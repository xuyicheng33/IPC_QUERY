import{r as l,g as L,a as J,u as G,j as t,b as Q,d as X,s as Z,m as ae,e as z,C as K,B as I,M as O,c as ie,R as le,A as ce}from"./chunks/AppProviders.js";import{A as de}from"./chunks/AppShell.js";import{B as pe,E as ue}from"./chunks/ErrorState.js";import{s as V,n as $,E as me,c as ge,f as q,b as Y,a as xe}from"./chunks/urlState.js";import{I as he}from"./chunks/Input.js";import{S as F}from"./chunks/Select.js";const re=l.createContext();function fe(e){return L("MuiTable",e)}J("MuiTable",["root","stickyHeader"]);const be=e=>{const{classes:a,stickyHeader:o}=e;return X({root:["root",o&&"stickyHeader"]},fe,a)},ye=Z("table",{name:"MuiTable",slot:"Root",overridesResolver:(e,a)=>{const{ownerState:o}=e;return[a.root,o.stickyHeader&&a.stickyHeader]}})(ae(({theme:e})=>({display:"table",width:"100%",borderCollapse:"collapse",borderSpacing:0,"& caption":{...e.typography.body2,padding:e.spacing(2),color:(e.vars||e).palette.text.secondary,textAlign:"left",captionSide:"bottom"},variants:[{props:({ownerState:a})=>a.stickyHeader,style:{borderCollapse:"separate"}}]}))),ee="table",ve=l.forwardRef(function(a,o){const c=G({props:a,name:"MuiTable"}),{className:m,component:d=ee,padding:p="normal",size:u="medium",stickyHeader:h=!1,...P}=c,g={...c,component:d,padding:p,size:u,stickyHeader:h},N=be(g),T=l.useMemo(()=>({padding:p,size:u,stickyHeader:h}),[p,u,h]);return t.jsx(re.Provider,{value:T,children:t.jsx(ye,{as:d,role:d===ee?null:"table",ref:o,className:Q(N.root,m),ownerState:g,...P})})}),je=l.createContext();function Ce(e){return L("MuiTableCell",e)}const Se=J("MuiTableCell",["root","head","body","footer","sizeSmall","sizeMedium","paddingCheckbox","paddingNone","alignLeft","alignCenter","alignRight","alignJustify","stickyHeader"]),_e=e=>{const{classes:a,variant:o,align:c,padding:m,size:d,stickyHeader:p}=e,u={root:["root",o,p&&"stickyHeader",c!=="inherit"&&`align${z(c)}`,m!=="normal"&&`padding${z(m)}`,`size${z(d)}`]};return X(u,Ce,a)},Ne=Z("td",{name:"MuiTableCell",slot:"Root",overridesResolver:(e,a)=>{const{ownerState:o}=e;return[a.root,a[o.variant],a[`size${z(o.size)}`],o.padding!=="normal"&&a[`padding${z(o.padding)}`],o.align!=="inherit"&&a[`align${z(o.align)}`],o.stickyHeader&&a.stickyHeader]}})(ae(({theme:e})=>({...e.typography.body2,display:"table-cell",verticalAlign:"inherit",borderBottom:e.vars?`1px solid ${e.vars.palette.TableCell.border}`:`1px solid
    ${e.palette.mode==="light"?e.lighten(e.alpha(e.palette.divider,1),.88):e.darken(e.alpha(e.palette.divider,1),.68)}`,textAlign:"left",padding:16,variants:[{props:{variant:"head"},style:{color:(e.vars||e).palette.text.primary,lineHeight:e.typography.pxToRem(24),fontWeight:e.typography.fontWeightMedium}},{props:{variant:"body"},style:{color:(e.vars||e).palette.text.primary}},{props:{variant:"footer"},style:{color:(e.vars||e).palette.text.secondary,lineHeight:e.typography.pxToRem(21),fontSize:e.typography.pxToRem(12)}},{props:{size:"small"},style:{padding:"6px 16px",[`&.${Se.paddingCheckbox}`]:{width:24,padding:"0 12px 0 16px","& > *":{padding:0}}}},{props:{padding:"checkbox"},style:{width:48,padding:"0 0 0 4px"}},{props:{padding:"none"},style:{padding:0}},{props:{align:"left"},style:{textAlign:"left"}},{props:{align:"center"},style:{textAlign:"center"}},{props:{align:"right"},style:{textAlign:"right",flexDirection:"row-reverse"}},{props:{align:"justify"},style:{textAlign:"justify"}},{props:({ownerState:a})=>a.stickyHeader,style:{position:"sticky",top:0,zIndex:2,backgroundColor:(e.vars||e).palette.background.default}}]}))),oe=l.forwardRef(function(a,o){const c=G({props:a,name:"MuiTableCell"}),{align:m="inherit",className:d,component:p,padding:u,scope:h,size:P,sortDirection:g,variant:N,...T}=c,x=l.useContext(re),M=l.useContext(je),C=M&&M.variant==="head";let S;p?S=p:S=C?"th":"td";let y=h;S==="td"?y=void 0:!y&&C&&(y="col");const A=N||M&&M.variant,_={...c,align:m,component:S,padding:u||(x&&x.padding?x.padding:"normal"),size:P||(x&&x.size?x.size:"medium"),sortDirection:g,stickyHeader:A==="head"&&x&&x.stickyHeader,variant:A},H=_e(_);let D=null;return g&&(D=g==="asc"?"ascending":"descending"),t.jsx(Ne,{as:S,ref:o,className:Q(H.root,d),"aria-sort":D,scope:y,ownerState:_,...T})});function Te(e){return L("MuiTableContainer",e)}J("MuiTableContainer",["root"]);const Me=e=>{const{classes:a}=e;return X({root:["root"]},Te,a)},we=Z("div",{name:"MuiTableContainer",slot:"Root"})({width:"100%",overflowX:"auto"}),ke=l.forwardRef(function(a,o){const c=G({props:a,name:"MuiTableContainer"}),{className:m,component:d="div",...p}=c,u={...c,component:d},h=Me(u);return t.jsx(we,{ref:o,as:d,className:Q(h.root,m),ownerState:u,...p})});function ze(...e){return e.filter(Boolean).join(" ")}function Pe({className:e,children:a}){return t.jsx(ke,{component:"div",className:e,sx:{borderRadius:3},children:a})}function Re({className:e,children:a}){return t.jsx(ve,{size:"small",className:e,children:a})}function U({className:e,children:a}){return t.jsx(oe,{className:e,sx:{py:1.2,px:1.5,bgcolor:"action.hover",borderBottomColor:"divider",fontSize:12,fontWeight:700,letterSpacing:.4},children:a})}function B({className:e,children:a}){return t.jsx(oe,{className:ze("align-top",e),sx:{py:1.2,px:1.5,borderBottomColor:"divider"},children:a})}function te(e,a){const o=Number.parseInt(String(e??""),10);return Number.isFinite(o)&&o>0?o:Math.max(1,a)}function W(e,a){const o=Math.max(0,Number(e)||0),c=Math.max(1,Number(a)||1);return Math.max(1,Math.ceil(o/c))}function se(e,a){const o=Math.max(1,Number(e)||1),c=Math.max(1,Number(a)||1);return Math.min(o,c)}function $e(e,a,o){return Math.max(0,Number(o)||0)>0&&e!==a}const k=60;function Ae(){const[e,a]=l.useState(()=>V(window.location.search)),[o,c]=l.useState([]),[m,d]=l.useState([]),[p,u]=l.useState(0),[h,P]=l.useState(k),[g,N]=l.useState(!1),[T,x]=l.useState(""),[M,C]=l.useState(""),S=l.useMemo(()=>{const s=new Set([""]);for(const r of o){const n=$(r.relative_dir||"");s.add(n)}return Array.from(s.values()).sort((r,n)=>r.localeCompare(n))},[o]),y=l.useMemo(()=>{const s=e.source_dir;return o.filter(r=>{const n=$(r.relative_dir||"");return!s||n===s})},[o,e.source_dir]),A=l.useMemo(()=>{const s=new Map;for(const n of y){const i=String(n.pdf_name||n.relative_path||"").trim();i&&s.set(i,(s.get(i)||0)+1)}const r=new Set;for(const[n,i]of s.entries())i>1&&r.add(n);return r},[y]),_=l.useMemo(()=>W(p,h),[p,h]),H=s=>{const r=xe(s,k);history.replaceState({...s},"",r)},D=async()=>{const s=await q("/api/docs"),r=Array.isArray(s)?s:s.documents||[];c(r),a(n=>{const v=!n.source_dir||r.some(b=>$(b.relative_dir||"")===n.source_dir)?n.source_dir:"",f=r.filter(b=>{const w=$(b.relative_dir||"");return!v||w===v}),R=!n.source_pdf||f.some(b=>String(b.relative_path||b.pdf_name||"")===n.source_pdf)?n.source_pdf:"";return{...n,source_dir:v,source_pdf:R}})},E=async s=>{if(H(s),x(""),!s.q){d([]),u(0),C(""),a(s);return}N(!0),C("查询中...");try{const r=s.page;let n=Y(s,k),i=await q(`/api/search?${n.toString()}`),v=Array.isArray(i.results)?i.results:[],f=Math.max(0,Number(i.total||0)),j=te(i.page_size,k),R=W(f,j);const b=se(r,R);if($e(r,b,f)){const w={...s,page:b};H(w),n=Y(w,k),i=await q(`/api/search?${n.toString()}`),v=Array.isArray(i.results)?i.results:[],f=Math.max(0,Number(i.total||0)),j=te(i.page_size,k),R=W(f,j),s=w}s={...s,page:se(s.page,R)},d(v),u(f),P(j),C(`match=${i.match||s.match}`),a(s)}catch(r){d([]),u(0),x(String(r?.message||r)),C("查询失败"),a(s)}finally{N(!1)}};l.useEffect(()=>{D().then(()=>E(V(window.location.search)))},[]);const ne=async s=>{s.preventDefault(),await E({...e,q:e.q.trim(),page:1})};return t.jsx(de,{children:t.jsxs("div",{className:"grid gap-4 min-w-0",children:[t.jsx(K,{children:t.jsxs("form",{className:"grid gap-3",onSubmit:ne,children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(he,{value:e.q,onChange:s=>a(r=>({...r,q:s.target.value})),className:"h-11 flex-1",placeholder:"输入件号或术语关键字","aria-label":"搜索关键字"}),t.jsx(I,{variant:"primary",className:"h-11 gap-2 px-5",type:"submit",disabled:g,startIcon:t.jsx(O,{name:"search",size:18}),children:g?"查询中":"搜索"})]}),t.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-5",children:[t.jsxs("label",{className:"grid gap-1 text-xs text-muted",children:["匹配模式",t.jsxs(F,{value:e.match,onChange:s=>a(r=>({...r,match:s.target.value})),children:[t.jsx("option",{value:"pn",children:"件号"}),t.jsx("option",{value:"term",children:"术语"}),t.jsx("option",{value:"all",children:"全部"})]})]}),t.jsxs("label",{className:"grid gap-1 text-xs text-muted",children:["来源目录",t.jsx(F,{value:e.source_dir,onChange:s=>a(r=>({...r,source_dir:$(s.target.value),source_pdf:""})),children:S.map(s=>t.jsx("option",{value:s,children:s||"全部目录"},s||"root"))})]}),t.jsxs("label",{className:"grid gap-1 text-xs text-muted",children:["来源文档",t.jsxs(F,{value:e.source_pdf,onChange:s=>a(r=>({...r,source_pdf:s.target.value.trim()})),children:[t.jsx("option",{value:"",children:"全部文档"}),y.map(s=>{const r=String(s.relative_path||s.pdf_name||""),n=String(s.pdf_name||r||"-"),i=A.has(n)&&r&&r!==n?`${n} (${r})`:n;return t.jsx("option",{value:r,children:i},r)})]})]}),t.jsxs("label",{className:"flex items-center gap-2 self-end rounded-md border border-border bg-surface px-3 py-2 text-sm text-text",children:[t.jsx("input",{type:"checkbox",checked:e.include_notes,onChange:s=>a(r=>({...r,include_notes:s.target.checked}))}),"包含备注行"]}),t.jsx("div",{className:"flex items-end justify-start xl:justify-end",children:t.jsxs(pe,{variant:"neutral",className:"h-10 items-center",children:[t.jsx(O,{name:"tune",size:16,sx:{mr:.5}}),"总计 ",p," 条"]})})]})]})}),t.jsxs(K,{children:[t.jsxs("div",{className:"mb-3 flex items-center justify-between gap-3",children:[t.jsx("div",{className:"text-sm text-muted",children:M||"等待查询"}),t.jsxs("div",{className:"text-sm text-muted",children:["第 ",e.page," / ",_," 页"]})]}),T?t.jsx(ue,{message:T}):m.length===0?t.jsx(me,{title:e.q?"暂无结果":"请输入查询词"}):t.jsx(Pe,{children:t.jsxs(Re,{children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx(U,{children:"件号"}),t.jsx(U,{children:"来源 PDF"}),t.jsx(U,{children:"页码"}),t.jsx(U,{children:"术语摘要"})]})}),t.jsx("tbody",{children:m.map(s=>{const r=ge(e).toString(),n=`/part/${encodeURIComponent(String(s.id))}${r?`?${r}`:""}`,i=String(s.part_number_canonical||s.part_number_cell||"-"),v=String(s.source_relative_path||s.source_pdf||"-"),f=String(s.page_num??"-"),j=String(s.nomenclature_preview||"");return t.jsxs("tr",{className:"cursor-pointer transition-colors duration-fast ease-premium hover:bg-surface-soft",onClick:()=>{window.location.href=n},children:[t.jsx(B,{className:"font-mono text-[13px]",children:i}),t.jsx(B,{className:"max-w-[320px] whitespace-nowrap overflow-hidden text-ellipsis",children:v}),t.jsx(B,{className:"font-mono text-[13px]",children:f}),t.jsx(B,{className:"max-w-[520px] whitespace-nowrap overflow-hidden text-ellipsis",title:j,children:j})]},s.id)})})]})}),_>1&&t.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[t.jsx(I,{variant:"ghost",disabled:e.page<=1||g,onClick:()=>{E({...e,page:Math.max(1,e.page-1)})},children:"上一页"}),t.jsx(I,{variant:"ghost",disabled:e.page>=_||g,onClick:()=>{E({...e,page:Math.min(_,e.page+1)})},children:"下一页"})]})]})]})})}ie.createRoot(document.getElementById("root")).render(t.jsx(le.StrictMode,{children:t.jsx(ce,{children:t.jsx(Ae,{})})}));
