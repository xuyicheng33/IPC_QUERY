import{r as i,j as s,C as R,B as C,M as k,c as O,R as V,A as X}from"./chunks/AppProviders.js";import{A as Y}from"./chunks/AppShell.js";import{s as B,n as f,B as ee,E as se,c as te,f as E,b as U,a as ae}from"./chunks/urlState.js";import{E as re}from"./chunks/ErrorState.js";import{I as ne}from"./chunks/Input.js";import{S as A}from"./chunks/Select.js";import{T as ce,a as oe,b as _,c as S}from"./chunks/Table.js";function L(r,c){const o=Number.parseInt(String(r??""),10);return Number.isFinite(o)&&o>0?o:Math.max(1,c)}function D(r,c){const o=Math.max(0,Number(r)||0),x=Math.max(1,Number(c)||1);return Math.max(1,Math.ceil(o/x))}function G(r,c){const o=Math.max(1,Number(r)||1),x=Math.max(1,Number(c)||1);return Math.min(o,x)}function ie(r,c,o){return Math.max(0,Number(o)||0)>0&&r!==c}const p=60;function le(){const[r,c]=i.useState(()=>B(window.location.search)),[o,x]=i.useState([]),[z,N]=i.useState([]),[y,M]=i.useState(0),[T,H]=i.useState(p),[j,I]=i.useState(!1),[$,q]=i.useState(""),[J,b]=i.useState(""),Q=i.useMemo(()=>{const e=new Set([""]);for(const t of o){const a=f(t.relative_dir||"");e.add(a)}return Array.from(e.values()).sort((t,a)=>t.localeCompare(a))},[o]),w=i.useMemo(()=>{const e=r.source_dir;return o.filter(t=>{const a=f(t.relative_dir||"");return!e||a===e})},[o,r.source_dir]),W=i.useMemo(()=>{const e=new Map;for(const a of w){const n=String(a.pdf_name||a.relative_path||"").trim();n&&e.set(n,(e.get(n)||0)+1)}const t=new Set;for(const[a,n]of e.entries())n>1&&t.add(a);return t},[w]),P=i.useMemo(()=>D(y,T),[y,T]),F=e=>{const t=ae(e,p);history.replaceState({...e},"",t)},Z=async()=>{const e=await E("/api/docs"),t=Array.isArray(e)?e:e.documents||[];x(t),c(a=>{const m=!a.source_dir||t.some(d=>f(d.relative_dir||"")===a.source_dir)?a.source_dir:"",l=t.filter(d=>{const h=f(d.relative_dir||"");return!m||h===m}),g=!a.source_pdf||l.some(d=>String(d.relative_path||d.pdf_name||"")===a.source_pdf)?a.source_pdf:"";return{...a,source_dir:m,source_pdf:g}})},v=async e=>{if(F(e),q(""),!e.q){N([]),M(0),b(""),c(e);return}I(!0),b("查询中...");try{const t=e.page;let a=U(e,p),n=await E(`/api/search?${a.toString()}`),m=Array.isArray(n.results)?n.results:[],l=Math.max(0,Number(n.total||0)),u=L(n.page_size,p),g=D(l,u);const d=G(t,g);if(ie(t,d,l)){const h={...e,page:d};F(h),a=U(h,p),n=await E(`/api/search?${a.toString()}`),m=Array.isArray(n.results)?n.results:[],l=Math.max(0,Number(n.total||0)),u=L(n.page_size,p),g=D(l,u),e=h}e={...e,page:G(e.page,g)},N(m),M(l),H(u),b(`match=${n.match||e.match}`),c(e)}catch(t){N([]),M(0),q(String(t?.message||t)),b("查询失败"),c(e)}finally{I(!1)}};i.useEffect(()=>{Z().then(()=>v(B(window.location.search)))},[]);const K=async e=>{e.preventDefault(),await v({...r,q:r.q.trim(),page:1})};return s.jsx(Y,{children:s.jsxs("div",{className:"grid gap-4 min-w-0",children:[s.jsx(R,{children:s.jsxs("form",{className:"grid gap-3",onSubmit:K,children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(ne,{value:r.q,onChange:e=>c(t=>({...t,q:e.target.value})),className:"h-11 flex-1",placeholder:"输入件号或术语关键字","aria-label":"搜索关键字"}),s.jsx(C,{variant:"primary",className:"h-11 gap-2 px-5",type:"submit",disabled:j,startIcon:s.jsx(k,{name:"search",size:18}),children:j?"查询中":"搜索"})]}),s.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-5",children:[s.jsxs("label",{className:"grid gap-1 text-xs text-muted",children:["匹配模式",s.jsxs(A,{value:r.match,onChange:e=>c(t=>({...t,match:e.target.value})),children:[s.jsx("option",{value:"pn",children:"件号"}),s.jsx("option",{value:"term",children:"术语"}),s.jsx("option",{value:"all",children:"全部"})]})]}),s.jsxs("label",{className:"grid gap-1 text-xs text-muted",children:["来源目录",s.jsx(A,{value:r.source_dir,onChange:e=>c(t=>({...t,source_dir:f(e.target.value),source_pdf:""})),children:Q.map(e=>s.jsx("option",{value:e,children:e||"全部目录"},e||"root"))})]}),s.jsxs("label",{className:"grid gap-1 text-xs text-muted",children:["来源文档",s.jsxs(A,{value:r.source_pdf,onChange:e=>c(t=>({...t,source_pdf:e.target.value.trim()})),children:[s.jsx("option",{value:"",children:"全部文档"}),w.map(e=>{const t=String(e.relative_path||e.pdf_name||""),a=String(e.pdf_name||t||"-"),n=W.has(a)&&t&&t!==a?`${a} (${t})`:a;return s.jsx("option",{value:t,children:n},t)})]})]}),s.jsxs("label",{className:"flex items-center gap-2 self-end rounded-md border border-border bg-surface px-3 py-2 text-sm text-text",children:[s.jsx("input",{type:"checkbox",checked:r.include_notes,onChange:e=>c(t=>({...t,include_notes:e.target.checked}))}),"包含备注行"]}),s.jsx("div",{className:"flex items-end justify-start xl:justify-end",children:s.jsxs(ee,{variant:"neutral",className:"h-10 items-center",children:[s.jsx(k,{name:"tune",size:16,sx:{mr:.5}}),"总计 ",y," 条"]})})]})]})}),s.jsxs(R,{children:[s.jsxs("div",{className:"mb-3 flex items-center justify-between gap-3",children:[s.jsx("div",{className:"text-sm text-muted",children:J||"等待查询"}),s.jsxs("div",{className:"text-sm text-muted",children:["第 ",r.page," / ",P," 页"]})]}),$?s.jsx(re,{message:$}):z.length===0?s.jsx(se,{title:r.q?"暂无结果":"请输入查询词"}):s.jsx(ce,{children:s.jsxs(oe,{children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx(_,{children:"件号"}),s.jsx(_,{children:"来源 PDF"}),s.jsx(_,{children:"页码"}),s.jsx(_,{children:"术语摘要"})]})}),s.jsx("tbody",{children:z.map(e=>{const t=te(r).toString(),a=`/part/${encodeURIComponent(String(e.id))}${t?`?${t}`:""}`,n=String(e.part_number_canonical||e.part_number_cell||"-"),m=String(e.source_relative_path||e.source_pdf||"-"),l=String(e.page_num??"-"),u=String(e.nomenclature_preview||"");return s.jsxs("tr",{className:"cursor-pointer transition-colors duration-fast ease-premium hover:bg-surface-soft",onClick:()=>{window.location.href=a},children:[s.jsx(S,{className:"font-mono text-[13px]",children:n}),s.jsx(S,{className:"max-w-[320px] whitespace-nowrap overflow-hidden text-ellipsis",children:m}),s.jsx(S,{className:"font-mono text-[13px]",children:l}),s.jsx(S,{className:"max-w-[520px] whitespace-nowrap overflow-hidden text-ellipsis",children:u})]},e.id)})})]})}),s.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[s.jsx(C,{variant:"ghost",disabled:r.page<=1||j,onClick:()=>{v({...r,page:Math.max(1,r.page-1)})},children:"上一页"}),s.jsx(C,{variant:"ghost",disabled:r.page>=P||j,onClick:()=>{v({...r,page:Math.min(P,r.page+1)})},children:"下一页"})]})]})]})})}O.createRoot(document.getElementById("root")).render(s.jsx(V.StrictMode,{children:s.jsx(X,{children:s.jsx(le,{})})}));
