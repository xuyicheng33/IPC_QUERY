import{r as d,j as e,M as O,R as F,c as U,A as H}from"./chunks/AppProviders.js";import{E as Q,f as C}from"./chunks/api.js";import{E as W,r as B}from"./chunks/keyword.js";import{s as k,b as q,c as D,a as G}from"./chunks/urlState.js";function T(t,a){const r=Number.parseInt(String(t??""),10);return Number.isFinite(r)&&r>0?r:Math.max(1,a)}function _(t,a){const r=Math.max(0,Number(t)||0),c=Math.max(1,Number(a)||1);return Math.max(1,Math.ceil(r/c))}function $(t,a){const r=Math.max(1,Number(t)||1),c=Math.max(1,Number(a)||1);return Math.min(r,c)}function J(t,a,r){return Math.max(0,Number(r)||0)>0&&t!==a}const p=10,L=[{value:"all",label:"全部"},{value:"pn",label:"按件号查询"},{value:"term",label:"按术语查询"}],Z=[{value:"relevance",label:"按相关性排序"},{value:"name",label:"按名称排序"}];function K(t,a,r=10){if(a<=0)return[];if(a<=r)return Array.from({length:a},(x,m)=>m+1);const c=Math.floor(r/2);let l=Math.max(1,t-c),o=l+r-1;return o>a&&(o=a,l=Math.max(1,o-r+1)),Array.from({length:o-l+1},(x,m)=>l+m)}function V(){const[t,a]=d.useState(()=>k(window.location.search)),[r,c]=d.useState([]),[l,o]=d.useState(0),[x,m]=d.useState(p),[u,b]=d.useState(!1),[g,P]=d.useState(""),h=d.useMemo(()=>_(l,x),[l,x]),z=d.useMemo(()=>K(t.page,h,10),[t.page,h]),N=s=>{const n=G(s,p);history.replaceState({...s},"",n)},f=async s=>{if(N(s),P(""),a(s),!s.q){c([]),o(0);return}b(!0);try{const n=s.page;let y=q(s,p),i=await C(`/api/search?${y.toString()}`),w=Array.isArray(i.results)?i.results:[],v=Math.max(0,Number(i.total||0)),j=T(i.page_size,p),S=_(v,j);const R=$(n,S);if(J(n,R,v)){const M={...s,page:R};N(M),y=q(M,p),i=await C(`/api/search?${y.toString()}`),w=Array.isArray(i.results)?i.results:[],v=Math.max(0,Number(i.total||0)),j=T(i.page_size,p),S=_(v,j),s=M}const A={...s,page:$(s.page,S),sort:i.sort||s.sort};c(w),o(v),m(j),a(A),N(A)}catch(n){c([]),o(0),P(String(n?.message||n))}finally{b(!1)}};d.useEffect(()=>{f(k(window.location.search))},[]);const I=async s=>{s.preventDefault();const n={...t,q:t.q.trim(),page:1};await f(n)},E=s=>{const n={...t,...s,page:1};f(n)};return e.jsxs("main",{className:"min-h-screen bg-bg text-text",children:[e.jsx("header",{className:"border-b border-border bg-surface",children:e.jsxs("div",{className:"mx-auto grid h-16 w-full max-w-[1360px] grid-cols-[1fr_minmax(0,760px)_1fr] items-center gap-5 px-6",children:[e.jsx("div",{}),e.jsxs("form",{onSubmit:I,className:"flex h-11 min-w-0 items-center rounded-full border border-border bg-surface px-3",children:[e.jsx("input",{value:t.q,onChange:s=>a(n=>({...n,q:s.target.value})),className:"h-full min-w-0 flex-1 border-none bg-transparent px-2 text-base text-text placeholder:text-muted focus:outline-none",placeholder:"输入件号 / 术语...","aria-label":"搜索关键字"}),e.jsx("button",{type:"submit",className:"inline-flex h-9 w-9 shrink-0 items-center justify-center rounded-full bg-accent text-white transition-colors hover:bg-accent-hover","aria-label":"开始搜索",disabled:u,children:e.jsx(O,{name:"search",size:18})})]}),e.jsx("div",{className:"justify-self-end",children:e.jsx("a",{href:"/db",className:"inline-flex h-10 items-center justify-center px-2 text-sm font-semibold text-text transition-colors hover:text-accent",children:"数据库"})})]})}),e.jsxs("div",{className:"mx-auto grid w-full max-w-[1360px] grid-cols-[250px_minmax(0,1fr)] gap-8 px-6 py-8",children:[e.jsxs("aside",{className:"pt-1",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-text",children:"查询模式"}),e.jsx("div",{className:"grid gap-2",children:L.map(s=>{const n=t.match===s.value;return e.jsx("button",{type:"button",disabled:u,className:`h-10 rounded-lg border px-3 text-left text-sm font-medium transition-colors ${n?"border-accent bg-accent-soft text-accent":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>E({match:s.value}),children:s.label},s.value)})}),e.jsx("div",{className:"my-6 border-t border-border"}),e.jsx("div",{className:"mb-3 text-sm font-semibold text-text",children:"排序方式"}),e.jsx("div",{className:"grid gap-2",children:Z.map(s=>{const n=t.sort===s.value;return e.jsx("button",{type:"button",disabled:u,className:`h-10 rounded-lg border px-3 text-left text-sm font-medium transition-colors ${n?"border-accent bg-accent-soft text-accent":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>E({sort:s.value}),children:s.label},s.value)})})]}),e.jsxs("section",{className:"min-w-0",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-muted",children:["共找到 ",l," 条结果"]}),e.jsxs("div",{className:"text-sm text-muted",children:["第 ",t.page," / ",h," 页"]})]}),g?e.jsx(W,{message:g}):r.length===0?e.jsx(Q,{title:t.q?"暂无结果":"请输入查询词"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"divide-y divide-border border-y border-border bg-surface",children:r.map(s=>e.jsx(X,{row:s,state:t},s.id))}),h>1?e.jsxs("div",{className:"mt-6 flex items-center justify-center gap-2",children:[e.jsx("button",{type:"button",disabled:t.page<=1||u,className:"inline-flex h-10 items-center rounded-full border border-border bg-surface px-4 text-sm text-text disabled:opacity-40",onClick:()=>{f({...t,page:Math.max(1,t.page-1)})},children:"上一页"}),z.map(s=>{const n=s===t.page;return e.jsx("button",{type:"button",className:`inline-flex h-10 w-10 items-center justify-center rounded-full border text-sm font-semibold ${n?"border-accent bg-accent text-white":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>{s!==t.page&&f({...t,page:s})},children:s},s)}),e.jsx("button",{type:"button",disabled:t.page>=h||u,className:"inline-flex h-10 items-center rounded-full border border-border bg-surface px-4 text-sm text-text disabled:opacity-40",onClick:()=>{f({...t,page:Math.min(h,t.page+1)})},children:"下一页"})]}):null]})]})]})]})}function X({row:t,state:a}){const r=D(a).toString(),c=`/part/${encodeURIComponent(String(t.id))}${r?`?${r}`:""}`,l=String(t.part_number_canonical||t.part_number_cell||"-"),o=String(t.source_relative_path||t.source_pdf||"-"),x=String(t.page_num??"-"),m=String((a.match==="pn"?t.nomenclature_preview:t.nomenclature_hit_snippet||t.nomenclature_preview)||"-"),u=a.match==="pn"?[{text:m,hit:!1}]:B(m,a.q);return e.jsxs("a",{href:c,className:"block px-4 py-4 transition-colors hover:bg-surface-soft",children:[e.jsx("div",{className:"mb-2 font-mono text-[26px] text-base font-semibold text-text",children:l}),e.jsx("p",{className:"mb-2 max-h-[5.4rem] overflow-hidden text-sm leading-6 text-text",children:u.map((b,g)=>b.hit?e.jsx("mark",{className:"rounded bg-accent-soft px-1 text-text",children:b.text},g):e.jsx(F.Fragment,{children:b.text},g))}),e.jsxs("div",{className:"text-xs text-muted",children:["来源 ",o," · 页码 ",x]})]})}U.createRoot(document.getElementById("root")).render(e.jsx(F.StrictMode,{children:e.jsx(H,{children:e.jsx(V,{})})}));
