import{r as d,j as e,M as O,R as F,c as U,A as H}from"./chunks/AppProviders.js";import{E as Q,f as C}from"./chunks/api.js";import{E as W,r as B}from"./chunks/keyword.js";import{s as k,b as q,c as D,a as G}from"./chunks/urlState.js";function T(t,s){const a=Number.parseInt(String(t??""),10);return Number.isFinite(a)&&a>0?a:Math.max(1,s)}function _(t,s){const a=Math.max(0,Number(t)||0),c=Math.max(1,Number(s)||1);return Math.max(1,Math.ceil(a/c))}function $(t,s){const a=Math.max(1,Number(t)||1),c=Math.max(1,Number(s)||1);return Math.min(a,c)}function J(t,s,a){return Math.max(0,Number(a)||0)>0&&t!==s}const g=10,L=[{value:"all",label:"全部"},{value:"pn",label:"按件号查询"},{value:"term",label:"按术语查询"}],Z=[{value:"relevance",label:"按相关性排序"},{value:"name",label:"按名称排序"}];function K(t,s,a=10){if(s<=0)return[];if(s<=a)return Array.from({length:s},(x,m)=>m+1);const c=Math.floor(a/2);let l=Math.max(1,t-c),o=l+a-1;return o>s&&(o=s,l=Math.max(1,o-a+1)),Array.from({length:o-l+1},(x,m)=>l+m)}function V(){const[t,s]=d.useState(()=>k(window.location.search)),[a,c]=d.useState([]),[l,o]=d.useState(0),[x,m]=d.useState(g),[u,b]=d.useState(!1),[p,P]=d.useState(""),h=d.useMemo(()=>_(l,x),[l,x]),z=d.useMemo(()=>K(t.page,h,10),[t.page,h]),N=r=>{const n=G(r,g);history.replaceState({...r},"",n)},f=async r=>{if(N(r),P(""),s(r),!r.q){c([]),o(0);return}b(!0);try{const n=r.page;let y=q(r,g),i=await C(`/api/search?${y.toString()}`),w=Array.isArray(i.results)?i.results:[],v=Math.max(0,Number(i.total||0)),j=T(i.page_size,g),S=_(v,j);const R=$(n,S);if(J(n,R,v)){const M={...r,page:R};N(M),y=q(M,g),i=await C(`/api/search?${y.toString()}`),w=Array.isArray(i.results)?i.results:[],v=Math.max(0,Number(i.total||0)),j=T(i.page_size,g),S=_(v,j),r=M}const A={...r,page:$(r.page,S),sort:i.sort||r.sort};c(w),o(v),m(j),s(A),N(A)}catch(n){c([]),o(0),P(String(n?.message||n))}finally{b(!1)}};d.useEffect(()=>{f(k(window.location.search))},[]);const I=async r=>{r.preventDefault();const n={...t,q:t.q.trim(),page:1};await f(n)},E=r=>{const n={...t,...r,page:1};f(n)};return e.jsxs("main",{className:"min-h-screen bg-bg text-text",children:[e.jsx("header",{className:"border-b border-border bg-surface",children:e.jsxs("div",{className:"mx-auto grid h-16 w-full max-w-[1360px] grid-cols-[1fr_minmax(0,760px)_1fr] items-center gap-5 px-6",children:[e.jsx("div",{}),e.jsxs("form",{onSubmit:I,className:"flex h-11 min-w-0 items-center rounded-full border border-border bg-surface px-3",children:[e.jsx("input",{value:t.q,onChange:r=>s(n=>({...n,q:r.target.value})),className:"h-full min-w-0 flex-1 border-none bg-transparent px-2 text-base text-text placeholder:text-muted focus:outline-none",placeholder:"输入件号 / 术语...","aria-label":"搜索关键字"}),e.jsx("button",{type:"submit",className:"inline-flex h-9 w-9 shrink-0 items-center justify-center rounded-full bg-accent text-white transition-colors hover:bg-accent-hover","aria-label":"开始搜索",disabled:u,children:e.jsx(O,{name:"search",size:18})})]}),e.jsx("div",{className:"justify-self-end",children:e.jsx("a",{href:"/db",className:"inline-flex h-10 items-center justify-center rounded-full border border-border bg-surface px-5 text-sm font-semibold text-text transition-colors hover:bg-surface-soft",children:"数据库"})})]})}),e.jsxs("div",{className:"mx-auto grid w-full max-w-[1360px] grid-cols-[250px_minmax(0,1fr)] gap-8 px-6 py-8",children:[e.jsxs("aside",{className:"pt-1",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-text",children:"查询模式"}),e.jsx("div",{className:"grid gap-2",children:L.map(r=>{const n=t.match===r.value;return e.jsx("button",{type:"button",disabled:u,className:`h-10 rounded-lg border px-3 text-left text-sm font-medium transition-colors ${n?"border-accent bg-accent-soft text-accent":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>E({match:r.value}),children:r.label},r.value)})}),e.jsx("div",{className:"my-6 border-t border-border"}),e.jsx("div",{className:"mb-3 text-sm font-semibold text-text",children:"排序方式"}),e.jsx("div",{className:"grid gap-2",children:Z.map(r=>{const n=t.sort===r.value;return e.jsx("button",{type:"button",disabled:u,className:`h-10 rounded-lg border px-3 text-left text-sm font-medium transition-colors ${n?"border-accent bg-accent-soft text-accent":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>E({sort:r.value}),children:r.label},r.value)})})]}),e.jsxs("section",{className:"min-w-0",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-muted",children:["共找到 ",l," 条结果"]}),e.jsxs("div",{className:"text-sm text-muted",children:["第 ",t.page," / ",h," 页"]})]}),p?e.jsx(W,{message:p}):a.length===0?e.jsx(Q,{title:t.q?"暂无结果":"请输入查询词"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"divide-y divide-border border-y border-border bg-surface",children:a.map(r=>e.jsx(X,{row:r,state:t},r.id))}),h>1?e.jsxs("div",{className:"mt-6 flex items-center justify-center gap-2",children:[e.jsx("button",{type:"button",disabled:t.page<=1||u,className:"inline-flex h-10 items-center rounded-full border border-border bg-surface px-4 text-sm text-text disabled:opacity-40",onClick:()=>{f({...t,page:Math.max(1,t.page-1)})},children:"上一页"}),z.map(r=>{const n=r===t.page;return e.jsx("button",{type:"button",className:`inline-flex h-10 w-10 items-center justify-center rounded-full border text-sm font-semibold ${n?"border-accent bg-accent text-white":"border-border bg-surface text-text hover:bg-surface-soft"}`,onClick:()=>{r!==t.page&&f({...t,page:r})},children:r},r)}),e.jsx("button",{type:"button",disabled:t.page>=h||u,className:"inline-flex h-10 items-center rounded-full border border-border bg-surface px-4 text-sm text-text disabled:opacity-40",onClick:()=>{f({...t,page:Math.min(h,t.page+1)})},children:"下一页"})]}):null]})]})]})]})}function X({row:t,state:s}){const a=D(s).toString(),c=`/part/${encodeURIComponent(String(t.id))}${a?`?${a}`:""}`,l=String(t.part_number_canonical||t.part_number_cell||"-"),o=String(t.source_relative_path||t.source_pdf||"-"),x=String(t.page_num??"-"),m=String((s.match==="pn"?t.nomenclature_preview:t.nomenclature_hit_snippet||t.nomenclature_preview)||"-"),u=s.match==="pn"?[{text:m,hit:!1}]:B(m,s.q);return e.jsxs("a",{href:c,className:"block px-4 py-4 transition-colors hover:bg-surface-soft",children:[e.jsx("div",{className:"mb-2 font-mono text-[26px] text-base font-semibold text-text",children:l}),e.jsx("p",{className:"mb-2 max-h-[5.4rem] overflow-hidden text-sm leading-6 text-text",children:u.map((b,p)=>b.hit?e.jsx("mark",{className:"rounded bg-accent-soft px-1 text-text",children:b.text},p):e.jsx(F.Fragment,{children:b.text},p))}),e.jsxs("div",{className:"text-xs text-muted",children:["来源 ",o," · 页码 ",x]})]})}U.createRoot(document.getElementById("root")).render(e.jsx(F.StrictMode,{children:e.jsx(H,{children:e.jsx(V,{})})}));
