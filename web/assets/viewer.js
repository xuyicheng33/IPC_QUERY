import{r as n,j as e,M as m,c as D,R as A,A as L}from"./chunks/AppProviders.js";import{D as F,C as U}from"./chunks/Card.js";import{p as B,f as G,k as X}from"./chunks/urlState.js";import{I as C}from"./chunks/Input.js";function j(d,o){const s=Number.parseInt(String(d||""),10);return Number.isFinite(s)&&s>0?s:o}function M(d){return Number.isFinite(d)?Math.min(180,Math.max(60,Math.round(d))):100}const q=3;function H(){const d=n.useMemo(()=>new URLSearchParams(window.location.search||""),[]),o=String(d.get("pdf")||""),s=!!o.trim(),E=encodeURIComponent(o),p=n.useMemo(()=>B(window.location.search,"/search.html"),[]),[r,c]=n.useState(()=>j(d.get("page"),1)),[l,R]=n.useState(()=>M(j(d.get("size"),100))),[f,h]=n.useState(s?"loading":"idle"),[z,x]=n.useState(""),[a,N]=n.useState(0),[$,v]=n.useState(""),[w,_]=n.useState(0),g=a>0?`${r}/${a}`:`${r}/?`,P=s&&r>1,b=s&&(a<=0||r<a),I={width:`${l}%`,maxWidth:"none"},u="inline-flex items-center gap-1 whitespace-nowrap bg-transparent p-0 text-xs font-medium text-muted transition-colors hover:text-accent focus-visible:outline-none focus-visible:text-accent disabled:cursor-not-allowed disabled:text-muted/50";n.useEffect(()=>{let t=!1;return s?(G(`/api/pdf/meta?pdf=${encodeURIComponent(o)}`).then(i=>{if(t)return;const k=Math.max(0,Number.parseInt(String(i.page_count||0),10)||0);N(k),v("")}).catch(i=>{t||(N(0),v(String(i?.message||i)))}),()=>{t=!0}):(N(0),v(""),()=>{t=!0})},[s,o,w]),n.useEffect(()=>{a<=0||r<=a||c(a)},[r,a]),n.useEffect(()=>{const t=new URLSearchParams;o&&t.set("pdf",o),t.set("page",String(r)),l!==100&&t.set("size",String(l)),p&&t.set("return_to",p),history.replaceState(null,"",`${window.location.pathname}?${t.toString()}`)},[p,o,r,l]),n.useEffect(()=>{if(!s){h("idle"),x("缺少 `pdf` 参数，请从零件详情页进入预览。");return}h("loading"),x(`正在加载第 ${g} 页...`)},[s,g,w]),n.useEffect(()=>{const t=i=>{if(!s)return;const S=i.target?.tagName||"";S==="INPUT"||S==="TEXTAREA"||S==="SELECT"||(i.key==="ArrowLeft"&&c(y=>Math.max(1,y-1)),i.key==="ArrowRight"&&b&&c(y=>y+1))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[b,s]);const T=`/render/${E}/${r}.png?scale=${q}&t=${w}`;return e.jsx(F,{backHref:p,contentClassName:"py-6",children:e.jsxs(U,{className:"grid gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3 rounded-md border border-border bg-surface-soft px-3 py-2",children:[e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsxs("button",{type:"button",className:u,disabled:!P,onClick:()=>c(t=>Math.max(1,t-1)),children:[e.jsx(m,{name:"chevron_left",size:16}),"上一页"]}),e.jsx("span",{className:"text-border",children:"|"}),e.jsxs("button",{type:"button",className:u,disabled:!b,onClick:()=>c(t=>t+1),children:["下一页",e.jsx(m,{name:"chevron_right",size:16})]})]}),e.jsx("div",{className:"h-5 w-px bg-border"}),e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted",children:"第"}),e.jsx(C,{type:"number",inputProps:{min:1,max:a>0?a:void 0,step:1},className:"w-[88px]",value:r,onChange:t=>{const i=Math.max(1,j(t.target.value,r));if(a>0){c(Math.min(a,i));return}c(i)},disabled:!s,"aria-label":"页码"}),e.jsxs("span",{className:"text-xs text-muted",children:["/ ",a>0?a:"?"]})]}),e.jsx("div",{className:"h-5 w-px bg-border"}),e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted",children:"预览大小"}),e.jsx(C,{type:"number",inputProps:{min:60,max:180,step:5},className:"w-[92px]",value:l,onChange:t=>R(M(j(t.target.value,l))),disabled:!s,"aria-label":"预览大小百分比"}),e.jsx("span",{className:"text-xs text-muted",children:"%"})]}),e.jsx("div",{className:"h-5 w-px bg-border"}),e.jsxs("a",{href:s?`/pdf/${E}?p=${r}#page=${r}`:"#",target:"_blank",rel:"noreferrer",className:`${u} ${s?"":"pointer-events-none"}`,"aria-disabled":!s,children:[e.jsx(m,{name:"description",size:16}),"原 PDF"]})]}),s?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-auto rounded-md border border-border",children:e.jsx("div",{className:"flex min-w-full justify-center",children:e.jsx("img",{src:T,alt:"PDF page preview",className:"block bg-surface",style:I,onLoad:()=>{h("ready"),x(`${o} · 第 ${g} 页`)},onError:()=>{if(h("error"),a>0&&r>a){x(`预览加载失败：当前页超出范围（1-${a}）`);return}x("预览加载失败：可能页码超出范围，或 PDF 未找到")}})})}),e.jsxs("div",{className:"flex items-center justify-between gap-3 text-sm text-muted",children:[e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx(m,{name:f==="loading"?"progress_activity":f==="error"?"warning":"task_alt",size:16,className:f==="loading"?"animate-spin":""}),z||"准备完成",$?`（总页数读取失败：${$}）`:null]}),f==="error"?e.jsx(X,{variant:"ghost",onClick:()=>_(t=>t+1),children:"重试"}):null]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-3 rounded-md border border-border bg-surface-soft px-3 py-2",children:[e.jsxs("button",{type:"button",className:u,disabled:!P,onClick:()=>c(t=>Math.max(1,t-1)),children:[e.jsx(m,{name:"chevron_left",size:16}),"上一页"]}),e.jsx("span",{className:"text-border",children:"|"}),e.jsxs("span",{className:"text-xs text-muted",children:["第 ",g," 页"]}),e.jsx("span",{className:"text-border",children:"|"}),e.jsxs("button",{type:"button",className:u,disabled:!b,onClick:()=>c(t=>t+1),children:["下一页",e.jsx(m,{name:"chevron_right",size:16})]})]})]}):e.jsx("div",{className:"rounded-md border border-dashed border-border bg-surface-soft px-6 py-8 text-sm text-muted",children:"缺少 `pdf` 参数，请从零件详情页进入预览。"})]})})}D.createRoot(document.getElementById("root")).render(e.jsx(A.StrictMode,{children:e.jsx(L,{children:e.jsx(H,{})})}));
