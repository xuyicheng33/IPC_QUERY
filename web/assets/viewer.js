import{r,j as e,M as g,c as _,R as D,A as U}from"./chunks/AppProviders.js";import{D as z,C as B}from"./chunks/Card.js";import{p as G,f as O,k as q}from"./chunks/urlState.js";import{I as H,S as J}from"./chunks/Select.js";function C(l,i){const s=Number.parseInt(String(l||""),10);return Number.isFinite(s)&&s>0?s:i}function M(l,i){const s=Number.parseFloat(String(l||""));return Number.isFinite(s)&&s>0?s:i}const K=[1,1.5,2,3,4];function V(){const l=r.useMemo(()=>new URLSearchParams(window.location.search||""),[]),i=String(l.get("pdf")||""),s=!!i.trim(),y=encodeURIComponent(i),u=r.useMemo(()=>G(window.location.search,"/search.html"),[]),[n,d]=r.useState(()=>C(l.get("page"),1)),[c,R]=r.useState(()=>M(l.get("scale"),2)),[p,f]=r.useState(s?"loading":"idle"),[I,m]=r.useState(""),[a,h]=r.useState(0),[E,b]=r.useState(""),[j,k]=r.useState("fit-width"),[w,T]=r.useState(0),N=a>0?`${n}/${a}`:`${n}/?`,F=s&&n>1,S=s&&(a<=0||n<a),A=j==="fit-width"?"block w-full bg-surface":"block w-auto max-w-none bg-surface",x="inline-flex items-center gap-1 whitespace-nowrap bg-transparent p-0 text-xs font-medium text-muted transition-colors hover:text-accent focus-visible:outline-none focus-visible:text-accent disabled:cursor-not-allowed disabled:text-muted/50";r.useEffect(()=>{let t=!1;return s?(O(`/api/pdf/meta?pdf=${encodeURIComponent(i)}`).then(o=>{if(t)return;const P=Math.max(0,Number.parseInt(String(o.page_count||0),10)||0);h(P),b("")}).catch(o=>{t||(h(0),b(String(o?.message||o)))}),()=>{t=!0}):(h(0),b(""),()=>{t=!0})},[s,i,w]),r.useEffect(()=>{a<=0||n<=a||d(a)},[n,a]),r.useEffect(()=>{const t=new URLSearchParams;i&&t.set("pdf",i),t.set("page",String(n)),c!==2&&t.set("scale",String(c)),u&&t.set("return_to",u),history.replaceState(null,"",`${window.location.pathname}?${t.toString()}`)},[u,i,n,c]),r.useEffect(()=>{if(!s){f("idle"),m("缺少 `pdf` 参数，请从零件详情页进入预览。");return}f("loading"),m(`正在加载第 ${N} 页（x${c}）...`)},[s,N,c,w]),r.useEffect(()=>{const t=o=>{if(!s)return;const v=o.target?.tagName||"";v==="INPUT"||v==="TEXTAREA"||v==="SELECT"||(o.key==="ArrowLeft"&&d($=>Math.max(1,$-1)),o.key==="ArrowRight"&&S&&d($=>$+1))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[S,s]);const L=`/render/${y}/${n}.png?scale=${encodeURIComponent(String(c))}&t=${w}`;return e.jsx(z,{backHref:u,contentClassName:"py-6",children:e.jsxs(B,{className:"grid gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3 rounded-md border border-border bg-surface-soft px-3 py-2",children:[e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsxs("button",{type:"button",className:x,disabled:!F,onClick:()=>d(t=>Math.max(1,t-1)),children:[e.jsx(g,{name:"chevron_left",size:16}),"上一页"]}),e.jsx("span",{className:"text-border",children:"|"}),e.jsxs("button",{type:"button",className:x,disabled:!S,onClick:()=>d(t=>t+1),children:["下一页",e.jsx(g,{name:"chevron_right",size:16})]})]}),e.jsx("div",{className:"h-5 w-px bg-border"}),e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted",children:"第"}),e.jsx(H,{type:"number",inputProps:{min:1,max:a>0?a:void 0,step:1},className:"w-[88px]",value:n,onChange:t=>{const o=Math.max(1,C(t.target.value,n));if(a>0){d(Math.min(a,o));return}d(o)},disabled:!s,"aria-label":"页码"}),e.jsxs("span",{className:"text-xs text-muted",children:["/ ",a>0?a:"?"]})]}),e.jsx("div",{className:"h-5 w-px bg-border"}),e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted",children:"缩放"}),e.jsx(J,{className:"w-[104px]",value:String(c),onChange:t=>R(M(t.target.value,2)),disabled:!s,"aria-label":"缩放",children:K.map(t=>e.jsxs("option",{value:t,children:["x",t]},t))})]}),e.jsx("div",{className:"h-5 w-px bg-border"}),e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx("button",{type:"button",className:x,disabled:!s,onClick:()=>k("fit-width"),"aria-pressed":j==="fit-width",children:"适应宽度"}),e.jsx("span",{className:"text-border",children:"|"}),e.jsx("button",{type:"button",className:x,disabled:!s,onClick:()=>k("natural"),"aria-pressed":j==="natural",children:"原始尺寸"})]}),e.jsx("div",{className:"h-5 w-px bg-border"}),e.jsxs("a",{href:s?`/pdf/${y}?p=${n}#page=${n}`:"#",target:"_blank",rel:"noreferrer",className:`${x} ${s?"":"pointer-events-none"}`,"aria-disabled":!s,children:[e.jsx(g,{name:"description",size:16}),"原 PDF"]})]}),s?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-auto rounded-md border border-border",children:e.jsx("img",{src:L,alt:"PDF page preview",className:A,onLoad:()=>{f("ready"),m(`${i} · 第 ${N} 页 · x${c}`)},onError:()=>{if(f("error"),a>0&&n>a){m(`预览加载失败：当前页超出范围（1-${a}）`);return}m("预览加载失败：可能页码超出范围，或 PDF 未找到")}})}),e.jsxs("div",{className:"flex items-center justify-between gap-3 text-sm text-muted",children:[e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx(g,{name:p==="loading"?"progress_activity":p==="error"?"warning":"task_alt",size:16,className:p==="loading"?"animate-spin":""}),I||"准备完成",E?`（总页数读取失败：${E}）`:null]}),p==="error"?e.jsx(q,{variant:"ghost",onClick:()=>T(t=>t+1),children:"重试"}):null]})]}):e.jsx("div",{className:"rounded-md border border-dashed border-border bg-surface-soft px-6 py-8 text-sm text-muted",children:"缺少 `pdf` 参数，请从零件详情页进入预览。"})]})})}_.createRoot(document.getElementById("root")).render(e.jsx(D.StrictMode,{children:e.jsx(U,{children:e.jsx(V,{})})}));
