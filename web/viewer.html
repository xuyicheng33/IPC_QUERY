<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>页预览</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      body {
        overflow: hidden;
      }

      .viewerRoot {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .viewerTop {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border-bottom: 0.5px solid var(--hairline);
      }

      .viewerTopInner {
        max-width: var(--maxw);
        margin: 0 auto;
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .viewerTitle {
        font-weight: 700;
        font-size: 14px;
      }

      .viewerControls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .ctl {
        min-height: 44px;
        border-radius: 10px;
        border: 0.5px solid var(--hairline);
        background: rgba(0, 0, 0, 0.04);
        padding: 10px 12px;
        font-family: var(--font);
        font-size: 14px;
        outline: none;
      }

      .ctl:focus-visible {
        box-shadow: 0 0 0 4px var(--focus);
      }

      .viewerMain {
        flex: 1;
        overflow: auto;
        padding: 16px;
        background: var(--panel);
      }

      .viewerCard {
        max-width: var(--maxw);
        margin: 0 auto;
        background: var(--panel2);
        border: 0.5px solid var(--hairline);
        border-radius: 16px;
        box-shadow: var(--shadow2);
        padding: 14px;
      }

      #img {
        display: block;
        width: 100%;
        height: auto;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.04);
      }

      #status {
        margin-top: 10px;
        color: var(--muted);
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="viewerRoot">
      <div class="viewerTop">
        <div class="viewerTopInner">
          <div class="viewerTitle" id="title">页预览</div>
          <div class="viewerControls">
            <button class="btn ghost neutral" id="btnPrev" type="button">上一页</button>
            <input class="ctl" id="pageInput" type="number" min="1" step="1" inputmode="numeric" style="width: 92px" />
            <button class="btn ghost neutral" id="btnNext" type="button">下一页</button>
            <select class="ctl" id="scaleSelect" style="width: 96px">
              <option value="1">x1</option>
              <option value="1.5">x1.5</option>
              <option value="2" selected>x2</option>
              <option value="3">x3</option>
              <option value="4">x4</option>
            </select>
            <a class="btn ghost" id="rawLink" target="_blank" rel="noreferrer">原 PDF</a>
          </div>
        </div>
      </div>

      <div class="viewerMain">
        <div class="viewerCard">
          <img id="img" alt="page preview" />
          <div id="status"></div>
        </div>
      </div>
    </div>

    <script>
      function $(sel) {
        return document.querySelector(sel);
      }

      function toInt(v, def) {
        const n = Number.parseInt(String(v ?? ""), 10);
        return Number.isFinite(n) && n > 0 ? n : def;
      }

      function toFloat(v, def) {
        const n = Number.parseFloat(String(v ?? ""));
        return Number.isFinite(n) && n > 0 ? n : def;
      }

      const params = new URLSearchParams(window.location.search || "");
      const pdf = (params.get("pdf") || "").toString();
      const hasPdf = Boolean(pdf.trim());
      const pdfEnc = encodeURIComponent(pdf);

      let page = toInt(params.get("page"), 1);
      let scale = toFloat(params.get("scale"), 2);

      const titleEl = $("#title");
      const pageInput = $("#pageInput");
      const scaleSelect = $("#scaleSelect");
      const btnPrev = $("#btnPrev");
      const btnNext = $("#btnNext");
      const rawLink = $("#rawLink");
      const img = $("#img");
      const statusEl = $("#status");

      function setControlsDisabled(disabled) {
        const controls = [btnPrev, btnNext, pageInput, scaleSelect];
        for (const control of controls) {
          control.disabled = Boolean(disabled);
        }
        if (!rawLink) return;
        if (disabled) {
          rawLink.removeAttribute("href");
          rawLink.setAttribute("aria-disabled", "true");
        } else {
          rawLink.removeAttribute("aria-disabled");
        }
      }

      function updateUrl(replace) {
        const p = new URLSearchParams();
        if (pdf) p.set("pdf", pdf);
        if (page) p.set("page", String(page));
        if (scale && scale !== 2) p.set("scale", String(scale));
        const url = `${window.location.pathname}?${p.toString()}`;
        if (replace) history.replaceState(null, "", url);
      }

      function setStatus(s) {
        statusEl.textContent = (s || "").toString();
      }

      function refresh() {
        pageInput.value = String(page);
        if (!hasPdf) {
          setControlsDisabled(true);
          if (titleEl) titleEl.textContent = "页预览（缺少 pdf 参数）";
          img.removeAttribute("src");
          setStatus("缺少 pdf 参数，请从零件详情页进入预览");
          return;
        }

        setControlsDisabled(false);
        if (titleEl) titleEl.textContent = `页预览：${pdf}（第 ${page} 页）`;

        const rawUrl = `/pdf/${pdfEnc}?p=${page}#page=${page}`;
        rawLink.href = rawUrl;

        const imgUrl = `/render/${pdfEnc}/${page}.png?scale=${encodeURIComponent(String(scale))}`;
        setStatus("加载中…");
        img.src = imgUrl;
      }

      img.onload = () => setStatus(pdf ? `${pdf} · 第 ${page} 页 · x${scale}` : `第 ${page} 页 · x${scale}`);
      img.onerror = () => setStatus("预览加载失败：可能页码超出范围，或 PDF 未在服务器上找到");

      btnPrev.addEventListener("click", () => {
        if (!hasPdf) return;
        page = Math.max(1, page - 1);
        updateUrl(true);
        refresh();
      });

      btnNext.addEventListener("click", () => {
        if (!hasPdf) return;
        page = Math.max(1, page + 1);
        updateUrl(true);
        refresh();
      });

      pageInput.addEventListener("change", () => {
        if (!hasPdf) return;
        page = Math.max(1, toInt(pageInput.value, page));
        updateUrl(true);
        refresh();
      });

      pageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") pageInput.blur();
      });

      scaleSelect.addEventListener("change", () => {
        if (!hasPdf) return;
        scale = toFloat(scaleSelect.value, 2);
        updateUrl(true);
        refresh();
      });

      window.addEventListener("keydown", (e) => {
        if (!hasPdf) return;
        if (e.key === "ArrowLeft") btnPrev.click();
        if (e.key === "ArrowRight") btnNext.click();
      });

      const scaleOpt = String(scale);
      for (const opt of Array.from(scaleSelect.options)) {
        if (String(opt.value) === scaleOpt) opt.selected = true;
      }

      updateUrl(true);
      refresh();
    </script>
  </body>
</html>
